<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QLD Property Viewer - Direct Tiles</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; overflow: hidden; }
        #map { width: 100vw; height: 100vh; }
        
        .panel {
            position: absolute;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        
        .info { top: 10px; left: 10px; max-width: 300px; }
        .info h2 { font-size: 16px; margin-bottom: 8px; color: #333; }
        .info p { font-size: 13px; color: #666; margin: 5px 0; }
        .warning { background: #fff3cd; padding: 8px; border-radius: 4px; margin-top: 8px; font-size: 12px; color: #856404; }
        
        .controls { top: 10px; right: 10px; }
        .controls button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        .controls button:hover { background: #1976D2; }
        
        .search { top: 140px; left: 10px; width: 280px; }
        .search input {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
        }
        .search button {
            width: 100%;
            margin-top: 8px;
            padding: 8px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .status { bottom: 10px; left: 10px; padding: 8px 12px; font-size: 12px; max-width: 250px; }
        
        .popup {
            position: absolute;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            min-width: 280px;
            bottom: 12px;
            left: -50px;
            z-index: 1001;
        }
        .popup-closer {
            position: absolute;
            top: 5px;
            right: 8px;
            cursor: pointer;
            font-size: 18px;
            color: #999;
        }
        .popup h3 { font-size: 14px; margin-bottom: 10px; }
        .popup .detail { font-size: 12px; margin: 6px 0; color: #555; }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="panel info">
        <h2>üó∫Ô∏è QLD Property Boundaries</h2>
        <p>Zoom in to see property boundaries appear as lines on the map.</p>
        <div class="warning">
            <strong>Note:</strong> Property boundaries show at zoom 13+. Try the "Test Brisbane" button to jump to an area with visible boundaries.
        </div>
    </div>
    
    <div class="panel controls">
        <button id="testBtn">üéØ Test Brisbane CBD</button>
        <button id="locateBtn">üìç My Location</button>
    </div>
    
    <div class="panel search">
        <input type="text" id="search" placeholder="Search address..." />
        <button id="searchBtn">Search</button>
    </div>
    
    <div class="panel status" id="status">Initializing...</div>
    
    <div id="popup" class="popup" style="display:none;">
        <span class="popup-closer" id="closer">√ó</span>
        <div id="popup-content"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
    <script>
        // Try multiple tile URL formats to see which one works
        
        // Format 1: Direct tile access
        var tileUrl1 = 'https://spatial-gis.information.qld.gov.au/arcgis/rest/services/PlanningCadastre/LandParcelPropertyFramework/MapServer/tile/{z}/{y}/{x}';
        
        // Format 2: Export with layers
        function getTileUrl2(tileCoord) {
            var z = tileCoord[0];
            var x = tileCoord[1];
            var y = tileCoord[2];
            var tileSize = 256;
            var extent = this.getTileGrid().getTileCoordExtent(tileCoord);
            return 'https://spatial-gis.information.qld.gov.au/arcgis/rest/services/PlanningCadastre/LandParcelPropertyFramework/MapServer/export?' +
                   'bbox=' + extent.join(',') + '&' +
                   'bboxSR=3857&' +
                   'size=' + tileSize + ',' + tileSize + '&' +
                   'dpi=96&' +
                   'format=png32&' +
                   'transparent=true&' +
                   'layers=show:4,5,6,7,8,9,10&' +
                   'f=image';
        }
        
        var map, cadastralLayer, statusEl = document.getElementById('status');
        var popup = document.getElementById('popup');
        var popupContent = document.getElementById('popup-content');
        
        var overlay = new ol.Overlay({
            element: popup,
            autoPan: true
        });
        
        document.getElementById('closer').onclick = function() {
            popup.style.display = 'none';
        };
        
        // Base map
        var baseLayer = new ol.layer.Tile({
            source: new ol.source.OSM()
        });
        
        // Cadastral layer - try the tile URL format
        cadastralLayer = new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: tileUrl1,
                crossOrigin: 'anonymous',
                tileLoadFunction: function(tile, src) {
                    // Try to load the tile
                    tile.getImage().src = src;
                }
            }),
            opacity: 0.7,
            visible: true
        });
        
        var tilesLoading = 0, tilesLoaded = 0, tilesError = 0;
        
        cadastralLayer.getSource().on('tileloadstart', function() {
            tilesLoading++;
            statusEl.textContent = 'Loading property boundaries...';
            statusEl.style.background = '#fff3cd';
        });
        
        cadastralLayer.getSource().on('tileloadend', function() {
            tilesLoaded++;
            statusEl.textContent = 'Boundaries loaded ‚úì (Zoom 13+ to see)';
            statusEl.style.background = '#d4edda';
        });
        
        cadastralLayer.getSource().on('tileloaderror', function(e) {
            tilesError++;
            console.error('Tile error:', e);
            if (tilesError === 1) {
                statusEl.textContent = '‚ö†Ô∏è Boundary tiles not loading. The QLD service may be down or have CORS restrictions.';
                statusEl.style.background = '#f8d7da';
                statusEl.style.fontSize = '11px';
                
                // Try alternative source
                console.log('Trying alternative tile source...');
                cadastralLayer.setSource(new ol.source.TileWMS({
                    url: 'https://spatial-gis.information.qld.gov.au/arcgis/services/PlanningCadastre/LandParcelPropertyFramework/MapServer/WMSServer',
                    params: {
                        'LAYERS': '4,5,6,7,8,9,10',
                        'TILED': true,
                        'FORMAT': 'image/png',
                        'TRANSPARENT': true
                    },
                    serverType: 'mapserver'
                }));
            }
        });
        
        // User location marker
        var vectorSource = new ol.source.Vector();
        var vectorLayer = new ol.layer.Vector({
            source: vectorSource,
            style: new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 8,
                    fill: new ol.style.Fill({ color: '#2196F3' }),
                    stroke: new ol.style.Stroke({ color: 'white', width: 3 })
                })
            })
        });
        
        // Create map
        map = new ol.Map({
            target: 'map',
            layers: [baseLayer, cadastralLayer, vectorLayer],
            overlays: [overlay],
            view: new ol.View({
                center: ol.proj.fromLonLat([153.025, -27.470]),  // Brisbane
                zoom: 12
            })
        });
        
        // Test button - go to Brisbane CBD where we know there are properties
        document.getElementById('testBtn').onclick = function() {
            map.getView().animate({
                center: ol.proj.fromLonLat([153.0251, -27.4698]),  // Brisbane CBD
                zoom: 17,
                duration: 1500
            });
            statusEl.textContent = 'Zooming to Brisbane CBD test area...';
        };
        
        // Location button
        document.getElementById('locateBtn').onclick = function() {
            if (navigator.geolocation) {
                statusEl.textContent = 'Getting location...';
                navigator.geolocation.getCurrentPosition(function(pos) {
                    var coords = ol.proj.fromLonLat([pos.coords.longitude, pos.coords.latitude]);
                    map.getView().animate({ center: coords, zoom: 17, duration: 1000 });
                    
                    vectorSource.clear();
                    vectorSource.addFeature(new ol.Feature({
                        geometry: new ol.geom.Point(coords)
                    }));
                }, function() {
                    statusEl.textContent = 'Could not get location';
                });
            }
        };
        
        // Search
        document.getElementById('searchBtn').onclick = function() {
            var query = document.getElementById('search').value.trim();
            if (!query) return;
            
            fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + 
                  encodeURIComponent(query + ', Queensland, Australia') + '&limit=1')
                .then(r => r.json())
                .then(data => {
                    if (data && data.length > 0) {
                        var coords = ol.proj.fromLonLat([parseFloat(data[0].lon), parseFloat(data[0].lat)]);
                        map.getView().animate({ center: coords, zoom: 17, duration: 1000 });
                        
                        vectorSource.clear();
                        vectorSource.addFeature(new ol.Feature({ geometry: new ol.geom.Point(coords) }));
                    }
                });
        };
        
        document.getElementById('search').onkeypress = function(e) {
            if (e.key === 'Enter') document.getElementById('searchBtn').click();
        };
        
        // Click to get property info
        map.on('singleclick', function(evt) {
            var zoom = map.getView().getZoom();
            if (zoom < 14) {
                popupContent.innerHTML = '<h3>Zoom In</h3><p>Zoom to 14+ to query properties. Current: ' + Math.round(zoom) + '</p>';
                popup.style.display = 'block';
                overlay.setPosition(evt.coordinate);
                return;
            }
            
            // Try to query using REST identify
            var mapExtent = map.getView().calculateExtent(map.getSize());
            var url = 'https://spatial-gis.information.qld.gov.au/arcgis/rest/services/PlanningCadastre/LandParcelPropertyFramework/MapServer/identify?' +
                     'geometry=' + evt.coordinate.join(',') + '&' +
                     'geometryType=esriGeometryPoint&' +
                     'sr=3857&' +
                     'layers=all:4,5,6,7,8,9,10&' +
                     'tolerance=5&' +
                     'mapExtent=' + mapExtent.join(',') + '&' +
                     'imageDisplay=' + map.getSize().join(',') + ',96&' +
                     'returnGeometry=false&' +
                     'f=json';
            
            statusEl.textContent = 'Querying property...';
            
            fetch(url)
                .then(r => r.json())
                .then(data => {
                    console.log('Property query result:', data);
                    statusEl.textContent = 'Ready';
                    
                    if (data.results && data.results.length > 0) {
                        var attrs = data.results[0].attributes;
                        var html = '<h3>Property Information</h3>';
                        if (attrs.LOT) html += '<div class="detail"><strong>Lot:</strong> ' + attrs.LOT + '</div>';
                        if (attrs.PLAN) html += '<div class="detail"><strong>Plan:</strong> ' + attrs.PLAN + '</div>';
                        if (attrs.AREA_SQMS) html += '<div class="detail"><strong>Area:</strong> ' + attrs.AREA_SQMS.toLocaleString() + ' m¬≤</div>';
                        if (attrs.LOCALITY) html += '<div class="detail"><strong>Locality:</strong> ' + attrs.LOCALITY + '</div>';
                        
                        popupContent.innerHTML = html;
                        popup.style.display = 'block';
                        overlay.setPosition(evt.coordinate);
                    } else {
                        popupContent.innerHTML = '<h3>No Property Found</h3><p>Try clicking on a visible boundary line.</p>';
                        popup.style.display = 'block';
                        overlay.setPosition(evt.coordinate);
                    }
                })
                .catch(e => {
                    console.error('Query error:', e);
                    statusEl.textContent = 'Query failed';
                });
        });
        
        console.log('Map initialized. Click "Test Brisbane CBD" to see property boundaries.');
    </script>
</body>
</html>
