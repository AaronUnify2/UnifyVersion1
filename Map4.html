<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QLD Property Viewer - Shapefile Support</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; overflow: hidden; }
        #map { width: 100vw; height: 100vh; }
        
        .panel {
            position: absolute;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        
        .info { top: 10px; left: 10px; max-width: 320px; }
        .info h2 { font-size: 16px; margin-bottom: 8px; color: #333; }
        .info p { font-size: 13px; color: #666; margin: 5px 0; line-height: 1.4; }
        .info .note { background: #e7f3ff; padding: 8px; border-radius: 4px; margin-top: 8px; font-size: 12px; color: #004085; }
        
        .controls { top: 10px; right: 10px; }
        .controls label {
            display: block;
            font-size: 13px;
            margin: 8px 0 4px 0;
            color: #333;
        }
        .controls input[type="range"] {
            width: 100%;
        }
        .controls .value {
            font-size: 11px;
            color: #666;
        }
        .controls button {
            width: 100%;
            padding: 10px;
            margin: 10px 0 5px 0;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        .controls button:hover { background: #1976D2; }
        
        .search { top: 160px; left: 10px; width: 300px; }
        .search input {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
        }
        .search button {
            width: 100%;
            margin-top: 8px;
            padding: 8px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .file-upload { top: 260px; left: 10px; width: 300px; }
        .file-upload input[type="file"] {
            width: 100%;
            padding: 8px;
            border: 2px dashed #2196F3;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            background: white;
        }
        .file-upload .hint {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
            line-height: 1.4;
        }
        
        .status { bottom: 10px; left: 10px; padding: 8px 12px; font-size: 12px; max-width: 300px; }
        
        .popup {
            position: absolute;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            min-width: 300px;
            max-width: 400px;
            bottom: 12px;
            left: -50px;
            z-index: 1001;
            max-height: 400px;
            overflow-y: auto;
        }
        .popup-closer {
            position: absolute;
            top: 5px;
            right: 8px;
            cursor: pointer;
            font-size: 20px;
            color: #999;
        }
        .popup-closer:hover { color: #333; }
        .popup h3 { font-size: 15px; margin-bottom: 10px; color: #333; }
        .popup .detail { font-size: 13px; margin: 6px 0; color: #555; line-height: 1.4; }
        .popup .detail strong { color: #333; }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="panel info">
        <h2>üó∫Ô∏è QLD Property Viewer</h2>
        <p>Load cadastral data from Shapefile or GeoJSON</p>
        <div class="note">
            <strong>Supported formats:</strong><br>
            ‚Ä¢ Shapefile (.zip containing .shp, .dbf, .shx)<br>
            ‚Ä¢ GeoJSON (.geojson, .json)<br>
            <br>
            <strong>Download from QLD:</strong><br>
            Choose "Shapefile - SHP" format and upload the .zip file below
        </div>
    </div>
    
    <div class="panel controls">
        <label>Boundary Opacity: <span id="opacityValue" class="value">80%</span></label>
        <input type="range" id="opacitySlider" min="10" max="100" value="80">
        
        <label>Boundary Color:</label>
        <select id="colorSelect" style="width:100%; padding:8px; border-radius:4px; margin-bottom:10px;">
            <option value="#e74c3c">Red</option>
            <option value="#3498db">Blue</option>
            <option value="#2ecc71">Green</option>
            <option value="#f39c12">Orange</option>
            <option value="#9b59b6">Purple</option>
            <option value="#000000" selected>Black</option>
        </select>
        
        <button id="locateBtn">üìç Find My Location</button>
        <button id="fitBtn">üîç Zoom to Data</button>
    </div>
    
    <div class="panel search">
        <input type="text" id="search" placeholder="Search address..." />
        <button id="searchBtn">Search</button>
    </div>
    
    <div class="panel file-upload">
        <input type="file" id="fileInput" accept=".zip,.geojson,.json,.shp" />
        <div class="hint">
            <strong>Upload:</strong> Shapefile (.zip) or GeoJSON (.geojson)<br>
            The .zip should contain .shp, .dbf, and .shx files
        </div>
    </div>
    
    <div class="panel status" id="status">Ready - Upload cadastral data</div>
    
    <div id="popup" class="popup" style="display:none;">
        <span class="popup-closer" id="closer">‚úñ</span>
        <div id="popup-content"></div>
    </div>

    <!-- OpenLayers -->
    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
    
    <!-- Shapefile.js for parsing shapefiles -->
    <script src="https://unpkg.com/shapefile@0.6.6/dist/shapefile.js"></script>
    
    <!-- JSZip for handling zip files -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    
    <script>
        var map, cadastralLayer, vectorSource;
        var popup = document.getElementById('popup');
        var popupContent = document.getElementById('popup-content');
        var statusEl = document.getElementById('status');
        
        var overlay = new ol.Overlay({
            element: popup,
            autoPan: { animation: { duration: 250 } }
        });
        
        document.getElementById('closer').onclick = function() {
            popup.style.display = 'none';
        };
        
        // Base map
        var baseLayer = new ol.layer.Tile({
            source: new ol.source.OSM()
        });
        
        // Vector source for cadastral data
        vectorSource = new ol.source.Vector();
        
        // Cadastral layer
        cadastralLayer = new ol.layer.Vector({
            source: vectorSource,
            style: function(feature) {
                return new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: document.getElementById('colorSelect').value,
                        width: 2
                    }),
                    fill: new ol.style.Fill({
                        color: 'rgba(0, 0, 0, 0.05)'
                    })
                });
            },
            opacity: 0.8
        });
        
        // User location marker
        var markerSource = new ol.source.Vector();
        var markerLayer = new ol.layer.Vector({
            source: markerSource,
            style: new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 8,
                    fill: new ol.style.Fill({ color: '#2196F3' }),
                    stroke: new ol.style.Stroke({ color: 'white', width: 3 })
                })
            })
        });
        
        // Create map
        map = new ol.Map({
            target: 'map',
            layers: [baseLayer, cadastralLayer, markerLayer],
            overlays: [overlay],
            view: new ol.View({
                center: ol.proj.fromLonLat([153.025, -27.470]),
                zoom: 12
            })
        });
        
        // Function to process GeoJSON
        function processGeoJSON(geojsonData) {
            try {
                statusEl.textContent = 'Processing GeoJSON data...';
                statusEl.style.background = '#fff3cd';
                
                var features = new ol.format.GeoJSON().readFeatures(geojsonData, {
                    featureProjection: 'EPSG:3857'
                });
                
                if (features.length === 0) {
                    statusEl.textContent = '‚ö†Ô∏è No features found in GeoJSON';
                    statusEl.style.background = '#fff3cd';
                    return;
                }
                
                vectorSource.clear();
                vectorSource.addFeatures(features);
                
                statusEl.textContent = '‚úì Loaded ' + features.length.toLocaleString() + ' properties';
                statusEl.style.background = '#d4edda';
                
                // Zoom to data extent
                var extent = vectorSource.getExtent();
                map.getView().fit(extent, {
                    padding: [50, 50, 50, 50],
                    maxZoom: 16,
                    duration: 1000
                });
                
                console.log('Loaded', features.length, 'GeoJSON features');
            } catch (error) {
                console.error('Error processing GeoJSON:', error);
                statusEl.textContent = '‚ùå Error processing GeoJSON: ' + error.message;
                statusEl.style.background = '#f8d7da';
            }
        }
        
        // Function to process Shapefile from zip
        async function processShapefileZip(zipFile) {
            try {
                statusEl.textContent = 'Extracting Shapefile from zip...';
                statusEl.style.background = '#fff3cd';
                
                var zip = await JSZip.loadAsync(zipFile);
                
                // Find the required shapefile components
                var shpFile = null, dbfFile = null;
                
                zip.forEach(function(relativePath, file) {
                    var lowerPath = relativePath.toLowerCase();
                    if (lowerPath.endsWith('.shp') && !lowerPath.includes('__macosx')) {
                        shpFile = file;
                    } else if (lowerPath.endsWith('.dbf') && !lowerPath.includes('__macosx')) {
                        dbfFile = file;
                    }
                });
                
                if (!shpFile) {
                    throw new Error('No .shp file found in zip');
                }
                if (!dbfFile) {
                    throw new Error('No .dbf file found in zip');
                }
                
                statusEl.textContent = 'Reading Shapefile data...';
                
                // Get the file contents as ArrayBuffers
                var shpBuffer = await shpFile.async('arraybuffer');
                var dbfBuffer = await dbfFile.async('arraybuffer');
                
                // Parse the shapefile using shapefile.js
                statusEl.textContent = 'Parsing Shapefile...';
                
                var geojsonFeatures = [];
                var featureCount = 0;
                
                await shapefile.open(shpBuffer, dbfBuffer)
                    .then(source => source.read()
                        .then(function log(result) {
                            if (result.done) return;
                            geojsonFeatures.push(result.value);
                            featureCount++;
                            if (featureCount % 100 === 0) {
                                statusEl.textContent = 'Loaded ' + featureCount + ' features...';
                            }
                            return source.read().then(log);
                        })
                    );
                
                if (geojsonFeatures.length === 0) {
                    throw new Error('No features found in Shapefile');
                }
                
                // Convert to OpenLayers features
                statusEl.textContent = 'Converting to map features...';
                
                var geojson = {
                    type: 'FeatureCollection',
                    features: geojsonFeatures
                };
                
                processGeoJSON(geojson);
                
            } catch (error) {
                console.error('Error processing Shapefile:', error);
                statusEl.textContent = '‚ùå Error: ' + error.message;
                statusEl.style.background = '#f8d7da';
            }
        }
        
        // File upload handler
        document.getElementById('fileInput').addEventListener('change', async function(e) {
            var file = e.target.files[0];
            if (!file) return;
            
            var fileName = file.name.toLowerCase();
            
            if (fileName.endsWith('.zip')) {
                // Handle Shapefile zip
                statusEl.textContent = 'Loading Shapefile zip...';
                statusEl.style.background = '#fff3cd';
                await processShapefileZip(file);
                
            } else if (fileName.endsWith('.geojson') || fileName.endsWith('.json')) {
                // Handle GeoJSON
                statusEl.textContent = 'Loading GeoJSON...';
                statusEl.style.background = '#fff3cd';
                
                var reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        var geojsonData = JSON.parse(event.target.result);
                        processGeoJSON(geojsonData);
                    } catch (error) {
                        statusEl.textContent = '‚ùå Invalid GeoJSON file';
                        statusEl.style.background = '#f8d7da';
                    }
                };
                reader.readAsText(file);
                
            } else if (fileName.endsWith('.shp')) {
                statusEl.textContent = '‚ùå Please upload the Shapefile as a .zip file containing all components (.shp, .dbf, .shx)';
                statusEl.style.background = '#f8d7da';
            } else {
                statusEl.textContent = '‚ùå Unsupported file format. Use .zip (Shapefile) or .geojson';
                statusEl.style.background = '#f8d7da';
            }
        });
        
        // Opacity control
        document.getElementById('opacitySlider').addEventListener('input', function(e) {
            var opacity = e.target.value / 100;
            cadastralLayer.setOpacity(opacity);
            document.getElementById('opacityValue').textContent = e.target.value + '%';
        });
        
        // Color control
        document.getElementById('colorSelect').addEventListener('change', function() {
            cadastralLayer.changed();
        });
        
        // Location button
        document.getElementById('locateBtn').onclick = function() {
            if (navigator.geolocation) {
                statusEl.textContent = 'Getting location...';
                navigator.geolocation.getCurrentPosition(function(pos) {
                    var coords = ol.proj.fromLonLat([pos.coords.longitude, pos.coords.latitude]);
                    map.getView().animate({ center: coords, zoom: 17, duration: 1000 });
                    
                    markerSource.clear();
                    markerSource.addFeature(new ol.Feature({
                        geometry: new ol.geom.Point(coords)
                    }));
                    
                    statusEl.textContent = 'Location found';
                    statusEl.style.background = '#d4edda';
                }, function() {
                    statusEl.textContent = 'Could not get location';
                    statusEl.style.background = '#f8d7da';
                });
            }
        };
        
        // Fit to data button
        document.getElementById('fitBtn').onclick = function() {
            if (vectorSource.getFeatures().length > 0) {
                var extent = vectorSource.getExtent();
                map.getView().fit(extent, {
                    padding: [50, 50, 50, 50],
                    maxZoom: 16,
                    duration: 1000
                });
            }
        };
        
        // Search
        document.getElementById('searchBtn').onclick = function() {
            var query = document.getElementById('search').value.trim();
            if (!query) return;
            
            statusEl.textContent = 'Searching...';
            
            fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + 
                  encodeURIComponent(query + ', Queensland, Australia') + '&limit=1')
                .then(r => r.json())
                .then(data => {
                    if (data && data.length > 0) {
                        var coords = ol.proj.fromLonLat([parseFloat(data[0].lon), parseFloat(data[0].lat)]);
                        map.getView().animate({ center: coords, zoom: 17, duration: 1000 });
                        
                        markerSource.clear();
                        markerSource.addFeature(new ol.Feature({ 
                            geometry: new ol.geom.Point(coords) 
                        }));
                        
                        statusEl.textContent = 'Location found';
                        statusEl.style.background = '#d4edda';
                    } else {
                        statusEl.textContent = 'Location not found';
                        statusEl.style.background = '#fff3cd';
                    }
                })
                .catch(error => {
                    statusEl.textContent = 'Search error';
                    statusEl.style.background = '#f8d7da';
                });
        };
        
        document.getElementById('search').onkeypress = function(e) {
            if (e.key === 'Enter') document.getElementById('searchBtn').click();
        };
        
        // Click to get property info
        map.on('singleclick', function(evt) {
            var feature = map.forEachFeatureAtPixel(evt.pixel, function(feature) {
                return feature;
            }, {
                layerFilter: function(layer) {
                    return layer === cadastralLayer;
                }
            });
            
            if (feature) {
                var props = feature.getProperties();
                var html = '<h3>üìã Property Information</h3>';
                
                // Common property field names (handle both uppercase and lowercase)
                var fieldMappings = {
                    'LOT': ['LOT', 'lot', 'Lot'],
                    'PLAN': ['PLAN', 'plan', 'Plan'],
                    'LOTPLAN': ['LOTPLAN', 'lotplan', 'LotPlan', 'LOT_PLAN'],
                    'AREA_SQMS': ['AREA_SQMS', 'area_sqms', 'AREA', 'area', 'Area'],
                    'LOCALITY': ['LOCALITY', 'locality', 'Locality'],
                    'LGA': ['LOCAL_GOVERNMENT_AREA', 'LGA', 'lga', 'Lga'],
                    'TENURE': ['TENURE', 'tenure', 'Tenure'],
                    'PARCEL_TYPE': ['PARCEL_TYPE', 'parcel_type', 'ParcelType'],
                    'LAND_TYPE': ['LAND_TYPE', 'land_type', 'LandType']
                };
                
                var displayFields = {
                    'LOT': 'Lot',
                    'PLAN': 'Plan',
                    'LOTPLAN': 'Lot/Plan',
                    'AREA_SQMS': 'Area',
                    'LOCALITY': 'Locality',
                    'LGA': 'LGA',
                    'TENURE': 'Tenure',
                    'PARCEL_TYPE': 'Parcel Type',
                    'LAND_TYPE': 'Land Type'
                };
                
                var hasData = false;
                
                Object.keys(fieldMappings).forEach(function(key) {
                    var value = null;
                    fieldMappings[key].forEach(function(fieldName) {
                        if (props[fieldName] !== undefined && props[fieldName] !== null) {
                            value = props[fieldName];
                        }
                    });
                    
                    if (value !== null) {
                        if (key === 'AREA_SQMS') {
                            var hectares = (parseFloat(value) / 10000).toFixed(2);
                            value = parseFloat(value).toLocaleString() + ' m¬≤ (' + hectares + ' ha)';
                        }
                        html += '<div class="detail"><strong>' + displayFields[key] + ':</strong> ' + value + '</div>';
                        hasData = true;
                    }
                });
                
                if (!hasData) {
                    html += '<div class="detail"><em>Available fields:</em></div>';
                    for (var key in props) {
                        if (key !== 'geometry' && props[key] !== null && props[key] !== undefined) {
                            html += '<div class="detail"><strong>' + key + ':</strong> ' + props[key] + '</div>';
                        }
                    }
                }
                
                popupContent.innerHTML = html;
                popup.style.display = 'block';
                overlay.setPosition(evt.coordinate);
            } else {
                popup.style.display = 'none';
            }
        });
        
        // Change cursor on hover
        map.on('pointermove', function(evt) {
            var hit = map.hasFeatureAtPixel(evt.pixel, {
                layerFilter: function(layer) {
                    return layer === cadastralLayer;
                }
            });
            map.getTarget().style.cursor = hit ? 'pointer' : '';
        });
        
        console.log('QLD Property Viewer - Shapefile & GeoJSON Support');
        console.log('Upload a Shapefile (.zip) or GeoJSON (.geojson) file to load cadastral data');
    </script>
</body>
</html>
