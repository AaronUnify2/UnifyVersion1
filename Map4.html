<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QLD Property Viewer - Vector Data</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; overflow: hidden; }
        #map { width: 100vw; height: 100vh; }
        
        .panel {
            position: absolute;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        
        .info { top: 10px; left: 10px; max-width: 320px; }
        .info h2 { font-size: 16px; margin-bottom: 8px; color: #333; }
        .info p { font-size: 13px; color: #666; margin: 5px 0; line-height: 1.4; }
        .info .tip { background: #e3f2fd; padding: 8px; border-radius: 4px; margin-top: 8px; font-size: 12px; color: #1565c0; }
        
        .controls { top: 10px; right: 10px; min-width: 180px; }
        .controls button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
        }
        .controls button:hover { background: #1976D2; }
        .controls button:disabled { background: #ccc; cursor: not-allowed; }
        
        .search { top: 170px; left: 10px; width: 300px; }
        .search input {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 8px;
        }
        .search input:focus { outline: none; border-color: #2196F3; }
        .search button {
            width: 100%;
            padding: 8px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        .search button:hover { background: #1976D2; }
        
        .status { 
            bottom: 10px; 
            left: 10px; 
            padding: 10px 12px; 
            font-size: 12px; 
            max-width: 300px;
            transition: all 0.3s;
        }
        .status.loading { background: #fff3cd; color: #856404; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        
        .zoom-info { bottom: 50px; left: 10px; padding: 8px 12px; font-size: 12px; color: #666; }
        
        .popup {
            position: absolute;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            min-width: 300px;
            max-width: 400px;
            bottom: 12px;
            left: -50px;
            z-index: 1001;
        }
        .popup:after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50px;
            border: 10px solid transparent;
            border-top-color: white;
        }
        .popup-closer {
            position: absolute;
            top: 5px;
            right: 8px;
            cursor: pointer;
            font-size: 20px;
            color: #999;
            font-weight: bold;
        }
        .popup-closer:hover { color: #333; }
        .popup h3 { font-size: 15px; margin-bottom: 10px; color: #333; }
        .popup .detail { font-size: 13px; margin: 7px 0; color: #555; }
        .popup .detail strong { color: #333; font-weight: 600; }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="panel info">
        <h2>üó∫Ô∏è QLD Property Viewer</h2>
        <p><strong>Vector Data Mode</strong></p>
        <p>Property boundaries download automatically when you zoom in (level 14+).</p>
        <div class="tip">
            üí° <strong>Tip:</strong> Click "Load Brisbane" to see property boundaries immediately, then click any property line for details.
        </div>
    </div>
    
    <div class="panel controls">
        <button id="loadBtn">üì• Load Boundaries</button>
        <button id="testBtn">üéØ Load Brisbane</button>
        <button id="locateBtn">üìç My Location</button>
        <button id="clearBtn">üóëÔ∏è Clear Boundaries</button>
    </div>
    
    <div class="panel search">
        <input type="text" id="search" placeholder="Search address in QLD..." />
        <button id="searchBtn">Search & Load</button>
    </div>
    
    <div class="panel status" id="status">Ready - Zoom to 14+ and click "Load Boundaries"</div>
    <div class="panel zoom-info" id="zoomInfo">Zoom: 12</div>
    
    <div id="popup" class="popup" style="display:none;">
        <span class="popup-closer" id="closer">√ó</span>
        <div id="popup-content"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
    <script>
        var map, vectorLayer, vectorSource;
        var statusEl = document.getElementById('status');
        var zoomEl = document.getElementById('zoomInfo');
        var loadBtn = document.getElementById('loadBtn');
        
        // Popup
        var popup = document.getElementById('popup');
        var popupContent = document.getElementById('popup-content');
        var overlay = new ol.Overlay({
            element: popup,
            autoPan: { animation: { duration: 250 } }
        });
        
        document.getElementById('closer').onclick = function() {
            popup.style.display = 'none';
        };
        
        // Base map
        var baseLayer = new ol.layer.Tile({
            source: new ol.source.OSM()
        });
        
        // Vector layer for property boundaries
        vectorSource = new ol.source.Vector();
        vectorLayer = new ol.layer.Vector({
            source: vectorSource,
            style: new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: '#e91e63',
                    width: 2
                }),
                fill: new ol.style.Fill({
                    color: 'rgba(233, 30, 99, 0.1)'
                })
            })
        });
        
        // User location marker
        var markerSource = new ol.source.Vector();
        var markerLayer = new ol.layer.Vector({
            source: markerSource,
            style: new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 8,
                    fill: new ol.style.Fill({ color: '#2196F3' }),
                    stroke: new ol.style.Stroke({ color: 'white', width: 3 })
                })
            })
        });
        
        // Create map
        map = new ol.Map({
            target: 'map',
            layers: [baseLayer, vectorLayer, markerLayer],
            overlays: [overlay],
            view: new ol.View({
                center: ol.proj.fromLonLat([153.025, -27.470]),  // Brisbane
                zoom: 12
            })
        });
        
        // Update zoom display
        function updateZoom() {
            var zoom = Math.round(map.getView().getZoom());
            zoomEl.textContent = 'Zoom: ' + zoom;
            
            if (zoom >= 14) {
                loadBtn.disabled = false;
            } else {
                loadBtn.disabled = true;
            }
        }
        map.getView().on('change:resolution', updateZoom);
        updateZoom();
        
        // Function to load property boundaries
        function loadBoundaries() {
            var zoom = map.getView().getZoom();
            if (zoom < 14) {
                setStatus('error', '‚ö†Ô∏è Zoom to level 14+ before loading boundaries');
                return;
            }
            
            // Get map extent
            var extent = map.getView().calculateExtent(map.getSize());
            var bottomLeft = ol.proj.toLonLat([extent[0], extent[1]]);
            var topRight = ol.proj.toLonLat([extent[2], extent[3]]);
            
            // Create bbox string
            var bbox = bottomLeft[0] + ',' + bottomLeft[1] + ',' + topRight[0] + ',' + topRight[1];
            
            setStatus('loading', 'üì• Downloading property boundaries...');
            loadBtn.disabled = true;
            
            // Queensland's REST API query endpoint
            // Using layer 4 (one of the parcel layers)
            var url = 'https://spatial-gis.information.qld.gov.au/arcgis/rest/services/PlanningCadastre/LandParcelPropertyFramework/MapServer/4/query?' +
                     'geometry=' + encodeURIComponent(bbox) + '&' +
                     'geometryType=esriGeometryEnvelope&' +
                     'spatialRel=esriSpatialRelIntersects&' +
                     'outFields=*&' +
                     'returnGeometry=true&' +
                     'returnIdsOnly=false&' +
                     'returnCountOnly=false&' +
                     'returnZ=false&' +
                     'returnM=false&' +
                     'f=geojson';
            
            console.log('Fetching:', url);
            
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error('HTTP ' + response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Received data:', data);
                    
                    if (!data.features || data.features.length === 0) {
                        setStatus('error', '‚ö†Ô∏è No properties found in this area. Try a different location.');
                        loadBtn.disabled = false;
                        return;
                    }
                    
                    // Parse GeoJSON and add to map
                    var features = new ol.format.GeoJSON().readFeatures(data, {
                        dataProjection: 'EPSG:4326',
                        featureProjection: 'EPSG:3857'
                    });
                    
                    vectorSource.addFeatures(features);
                    
                    setStatus('success', '‚úì Loaded ' + features.length + ' properties');
                    loadBtn.disabled = false;
                    
                    // Auto-hide success message
                    setTimeout(() => {
                        if (statusEl.classList.contains('success')) {
                            statusEl.textContent = 'Ready - Click properties for info';
                            statusEl.className = 'panel status';
                        }
                    }, 3000);
                })
                .catch(error => {
                    console.error('Error loading boundaries:', error);
                    setStatus('error', '‚ùå Error: ' + error.message + '. The service may be unavailable.');
                    loadBtn.disabled = false;
                });
        }
        
        function setStatus(type, message) {
            statusEl.className = 'panel status ' + type;
            statusEl.textContent = message;
        }
        
        // Load button
        loadBtn.onclick = loadBoundaries;
        
        // Test button - Load Brisbane CBD
        document.getElementById('testBtn').onclick = function() {
            map.getView().animate({
                center: ol.proj.fromLonLat([153.0251, -27.4698]),
                zoom: 17,
                duration: 1000
            });
            
            setTimeout(() => {
                loadBoundaries();
            }, 1100);
        };
        
        // Clear button
        document.getElementById('clearBtn').onclick = function() {
            vectorSource.clear();
            popup.style.display = 'none';
            setStatus('', 'Boundaries cleared. Zoom and click "Load Boundaries" to reload.');
        };
        
        // Location button
        document.getElementById('locateBtn').onclick = function() {
            if (navigator.geolocation) {
                setStatus('loading', 'Getting location...');
                navigator.geolocation.getCurrentPosition(function(pos) {
                    var coords = ol.proj.fromLonLat([pos.coords.longitude, pos.coords.latitude]);
                    
                    map.getView().animate({ 
                        center: coords, 
                        zoom: 17, 
                        duration: 1000 
                    });
                    
                    markerSource.clear();
                    markerSource.addFeature(new ol.Feature({
                        geometry: new ol.geom.Point(coords)
                    }));
                    
                    setStatus('success', '‚úì Location found');
                    
                    setTimeout(() => {
                        loadBoundaries();
                    }, 1100);
                }, function() {
                    setStatus('error', '‚ùå Could not get location');
                });
            } else {
                setStatus('error', '‚ùå Geolocation not supported');
            }
        };
        
        // Search
        document.getElementById('searchBtn').onclick = function() {
            var query = document.getElementById('search').value.trim();
            if (!query) return;
            
            setStatus('loading', 'Searching...');
            
            fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + 
                  encodeURIComponent(query + ', Queensland, Australia') + '&limit=1')
                .then(r => r.json())
                .then(data => {
                    if (data && data.length > 0) {
                        var coords = ol.proj.fromLonLat([parseFloat(data[0].lon), parseFloat(data[0].lat)]);
                        
                        map.getView().animate({ 
                            center: coords, 
                            zoom: 17, 
                            duration: 1000 
                        });
                        
                        markerSource.clear();
                        markerSource.addFeature(new ol.Feature({
                            geometry: new ol.geom.Point(coords)
                        }));
                        
                        setStatus('success', '‚úì Location found');
                        
                        setTimeout(() => {
                            loadBoundaries();
                        }, 1100);
                    } else {
                        setStatus('error', '‚ùå Location not found');
                    }
                })
                .catch(() => {
                    setStatus('error', '‚ùå Search failed');
                });
        };
        
        document.getElementById('search').onkeypress = function(e) {
            if (e.key === 'Enter') document.getElementById('searchBtn').click();
        };
        
        // Click on property to get info
        map.on('singleclick', function(evt) {
            var features = map.getFeaturesAtPixel(evt.pixel);
            
            if (features && features.length > 0) {
                var feature = features[0];
                var props = feature.getProperties();
                
                var html = '<h3>üìã Property Information</h3>';
                
                // Try various field name formats
                var lot = props.LOT || props.Lot || props.lot || props.LOT_NUMBER;
                var plan = props.PLAN || props.Plan || props.plan || props.PLAN_NUMBER;
                var lotplan = props.LOTPLAN || props.LotPlan || props.LOT_PLAN;
                var area = props.AREA_SQMS || props.AreaSqm || props.AREA || props.Area || props.AREA_SQM;
                var locality = props.LOCALITY || props.Locality || props.locality;
                var lga = props.LOCAL_GOVERNMENT_AREA || props.LGA || props.Lga;
                var tenure = props.TENURE || props.Tenure || props.tenure;
                var parcelType = props.PARCEL_TYPE || props.ParcelType;
                
                if (lot) html += '<div class="detail"><strong>Lot:</strong> ' + lot + '</div>';
                if (plan) html += '<div class="detail"><strong>Plan:</strong> ' + plan + '</div>';
                if (lotplan) html += '<div class="detail"><strong>Lot/Plan:</strong> ' + lotplan + '</div>';
                
                if (area) {
                    var hectares = (parseFloat(area) / 10000).toFixed(2);
                    html += '<div class="detail"><strong>Area:</strong> ' + parseFloat(area).toLocaleString() + ' m¬≤ (' + hectares + ' ha)</div>';
                }
                
                if (locality) html += '<div class="detail"><strong>Locality:</strong> ' + locality + '</div>';
                if (lga) html += '<div class="detail"><strong>LGA:</strong> ' + lga + '</div>';
                if (tenure) html += '<div class="detail"><strong>Tenure:</strong> ' + tenure + '</div>';
                if (parcelType) html += '<div class="detail"><strong>Type:</strong> ' + parcelType + '</div>';
                
                // If we didn't find standard fields, show all available
                if (!lot && !plan && !lotplan) {
                    html += '<div class="detail"><strong>Available fields:</strong><br><small>';
                    for (var key in props) {
                        if (key !== 'geometry') {
                            html += key + ': ' + props[key] + '<br>';
                        }
                    }
                    html += '</small></div>';
                }
                
                popupContent.innerHTML = html;
                popup.style.display = 'block';
                overlay.setPosition(evt.coordinate);
            } else {
                popup.style.display = 'none';
            }
        });
        
        // Change cursor on hover
        map.on('pointermove', function(evt) {
            var hit = map.hasFeatureAtPixel(evt.pixel);
            map.getTarget().style.cursor = hit ? 'pointer' : '';
        });
        
        console.log('Vector-based property viewer initialized');
        console.log('Click "Load Brisbane" to test, or zoom to your area and click "Load Boundaries"');
    </script>
</body>
</html>
