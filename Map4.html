<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QLD Property Viewer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; overflow: hidden; }
        
        #map { 
            width: 100vw; 
            height: 100vh; 
            background: #f0f0f0;
        }
        
        .panel {
            position: absolute;
            background: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            font-size: 13px;
        }
        
        .info { 
            top: 10px; 
            left: 10px; 
            max-width: 280px;
        }
        .info h2 { font-size: 15px; margin-bottom: 6px; }
        
        .controls { 
            top: 10px; 
            right: 10px;
            max-width: 200px;
        }
        .controls label {
            display: block;
            font-size: 12px;
            margin: 6px 0 3px 0;
        }
        .controls input[type="range"] { width: 100%; }
        .controls select {
            width: 100%;
            padding: 6px;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .controls button {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .file-upload { 
            bottom: 10px; 
            left: 10px; 
            right: 10px;
            max-width: 500px;
            margin: 0 auto;
        }
        .file-upload input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px dashed #2196F3;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            background: white;
        }
        .file-upload .hint {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }
        
        .status { 
            bottom: 80px; 
            left: 10px; 
            right: 10px;
            max-width: 500px;
            margin: 0 auto;
            padding: 10px;
            font-size: 12px;
            text-align: center;
            font-weight: 600;
        }
        
        .popup {
            position: absolute;
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            min-width: 250px;
            max-width: 350px;
            max-height: 300px;
            overflow-y: auto;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            font-size: 12px;
        }
        .popup-closer {
            position: absolute;
            top: 5px;
            right: 8px;
            cursor: pointer;
            font-size: 18px;
            color: #999;
        }
        .popup h3 { font-size: 14px; margin-bottom: 8px; }
        .popup .detail { margin: 5px 0; }
        .popup .detail strong { color: #333; }
        
        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .loading-screen h2 { margin-bottom: 20px; }
        .loading-screen .progress { margin: 10px 0; font-size: 14px; }
    </style>
</head>
<body>
    <div id="loadingScreen" class="loading-screen">
        <h2>üó∫Ô∏è Loading Map...</h2>
        <div class="progress" id="loadProgress">Initializing...</div>
    </div>
    
    <div id="map"></div>
    
    <div class="panel info" style="display:none;" id="infoPanel">
        <h2>QLD Property Viewer</h2>
        <p style="font-size:11px; margin:5px 0;">Upload your Shapefile (.zip) to view properties</p>
    </div>
    
    <div class="panel controls" style="display:none;" id="controlPanel">
        <label>Opacity: <span id="opacityValue">80%</span></label>
        <input type="range" id="opacitySlider" min="10" max="100" value="80">
        
        <label>Color:</label>
        <select id="colorSelect">
            <option value="#e74c3c">Red</option>
            <option value="#000000" selected>Black</option>
            <option value="#3498db">Blue</option>
        </select>
        
        <button id="fitBtn">üîç Zoom to Data</button>
    </div>
    
    <div class="panel file-upload" style="display:none;" id="uploadPanel">
        <input type="file" id="fileInput" accept=".zip,.geojson,.json" />
        <div class="hint">Upload Shapefile (.zip) or GeoJSON</div>
    </div>
    
    <div class="panel status" id="status" style="display:none;">Ready</div>
    
    <div id="popup" class="popup" style="display:none;">
        <span class="popup-closer" id="closer">‚úñ</span>
        <div id="popup-content"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
    <script src="https://unpkg.com/shapefile@0.6.6/dist/shapefile.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    
    <script>
        var map, cadastralLayer, vectorSource, overlay;
        var loadProgress = document.getElementById('loadProgress');
        var loadingScreen = document.getElementById('loadingScreen');
        var statusEl = document.getElementById('status');
        
        // Check if libraries loaded
        loadProgress.textContent = 'Checking libraries...';
        
        setTimeout(function() {
            try {
                if (typeof ol === 'undefined') {
                    throw new Error('OpenLayers failed to load');
                }
                if (typeof shapefile === 'undefined') {
                    throw new Error('Shapefile.js failed to load');
                }
                if (typeof JSZip === 'undefined') {
                    throw new Error('JSZip failed to load');
                }
                
                loadProgress.textContent = 'Libraries loaded ‚úì Creating map...';
                initializeMap();
                
            } catch (error) {
                loadProgress.textContent = '‚ùå Error: ' + error.message;
                loadProgress.style.color = 'red';
                console.error('Initialization error:', error);
            }
        }, 500);
        
        function initializeMap() {
            try {
                // Create overlay for popup
                overlay = new ol.Overlay({
                    element: document.getElementById('popup'),
                    autoPan: true
                });
                
                document.getElementById('closer').onclick = function() {
                    document.getElementById('popup').style.display = 'none';
                };
                
                // Vector source for cadastral data
                vectorSource = new ol.source.Vector();
                
                // Cadastral layer
                cadastralLayer = new ol.layer.Vector({
                    source: vectorSource,
                    style: function() {
                        return new ol.style.Style({
                            stroke: new ol.style.Stroke({
                                color: document.getElementById('colorSelect').value,
                                width: 2
                            }),
                            fill: new ol.style.Fill({
                                color: 'rgba(0, 0, 0, 0.05)'
                            })
                        });
                    },
                    opacity: 0.8
                });
                
                loadProgress.textContent = 'Creating base map...';
                
                // Base map with error handling
                var baseLayer = new ol.layer.Tile({
                    source: new ol.source.OSM()
                });
                
                // Create map
                map = new ol.Map({
                    target: 'map',
                    layers: [baseLayer, cadastralLayer],
                    overlays: [overlay],
                    view: new ol.View({
                        center: ol.proj.fromLonLat([151.95, -27.56]), // Southern Downs approx
                        zoom: 10
                    })
                });
                
                // Wait for map to render
                map.once('postrender', function() {
                    loadProgress.textContent = 'Map loaded ‚úì Ready!';
                    setTimeout(function() {
                        loadingScreen.style.display = 'none';
                        document.getElementById('infoPanel').style.display = 'block';
                        document.getElementById('controlPanel').style.display = 'block';
                        document.getElementById('uploadPanel').style.display = 'block';
                        document.getElementById('status').style.display = 'block';
                        statusEl.textContent = 'Upload your Shapefile zip';
                        statusEl.style.background = '#e7f3ff';
                    }, 500);
                });
                
                // Setup controls
                setupControls();
                
                // Setup file upload
                setupFileUpload();
                
                // Setup map interactions
                setupMapInteractions();
                
            } catch (error) {
                loadProgress.textContent = '‚ùå Map creation failed: ' + error.message;
                loadProgress.style.color = 'red';
                console.error('Map initialization error:', error);
            }
        }
        
        function setupControls() {
            document.getElementById('opacitySlider').addEventListener('input', function(e) {
                cadastralLayer.setOpacity(e.target.value / 100);
                document.getElementById('opacityValue').textContent = e.target.value + '%';
            });
            
            document.getElementById('colorSelect').addEventListener('change', function() {
                cadastralLayer.changed();
            });
            
            document.getElementById('fitBtn').onclick = function() {
                if (vectorSource.getFeatures().length > 0) {
                    map.getView().fit(vectorSource.getExtent(), {
                        padding: [20, 20, 20, 20],
                        maxZoom: 16,
                        duration: 1000
                    });
                }
            };
        }
        
        function setupFileUpload() {
            document.getElementById('fileInput').addEventListener('change', async function(e) {
                var file = e.target.files[0];
                if (!file) return;
                
                var fileName = file.name.toLowerCase();
                
                if (fileName.endsWith('.zip')) {
                    await processShapefileZip(file);
                } else if (fileName.endsWith('.geojson') || fileName.endsWith('.json')) {
                    processGeoJSONFile(file);
                } else {
                    statusEl.textContent = '‚ùå Use .zip (Shapefile) or .geojson';
                    statusEl.style.background = '#f8d7da';
                }
            });
        }
        
        async function processShapefileZip(zipFile) {
            try {
                statusEl.textContent = 'Reading zip file...';
                statusEl.style.background = '#fff3cd';
                
                var zip = await JSZip.loadAsync(zipFile);
                
                var shpFile = null, dbfFile = null;
                
                zip.forEach(function(relativePath, file) {
                    var lower = relativePath.toLowerCase();
                    if (lower.endsWith('.shp') && !lower.includes('__macosx')) {
                        shpFile = file;
                    } else if (lower.endsWith('.dbf') && !lower.includes('__macosx')) {
                        dbfFile = file;
                    }
                });
                
                if (!shpFile || !dbfFile) {
                    throw new Error('Zip must contain .shp and .dbf files');
                }
                
                statusEl.textContent = 'Extracting shapefile...';
                
                var shpBuffer = await shpFile.async('arraybuffer');
                var dbfBuffer = await dbfFile.async('arraybuffer');
                
                statusEl.textContent = 'Parsing shapefile...';
                
                var geojsonFeatures = [];
                var count = 0;
                
                await shapefile.open(shpBuffer, dbfBuffer)
                    .then(source => source.read()
                        .then(function log(result) {
                            if (result.done) return;
                            geojsonFeatures.push(result.value);
                            count++;
                            if (count % 50 === 0) {
                                statusEl.textContent = 'Loading: ' + count + ' properties...';
                            }
                            return source.read().then(log);
                        })
                    );
                
                if (geojsonFeatures.length === 0) {
                    throw new Error('No features found in shapefile');
                }
                
                statusEl.textContent = 'Converting to map format...';
                
                var geojson = {
                    type: 'FeatureCollection',
                    features: geojsonFeatures
                };
                
                processGeoJSON(geojson);
                
            } catch (error) {
                console.error('Shapefile error:', error);
                statusEl.textContent = '‚ùå Error: ' + error.message;
                statusEl.style.background = '#f8d7da';
            }
        }
        
        function processGeoJSONFile(file) {
            statusEl.textContent = 'Reading GeoJSON...';
            statusEl.style.background = '#fff3cd';
            
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var data = JSON.parse(e.target.result);
                    processGeoJSON(data);
                } catch (error) {
                    statusEl.textContent = '‚ùå Invalid GeoJSON';
                    statusEl.style.background = '#f8d7da';
                }
            };
            reader.readAsText(file);
        }
        
        function processGeoJSON(geojsonData) {
            try {
                statusEl.textContent = 'Adding to map...';
                
                var features = new ol.format.GeoJSON().readFeatures(geojsonData, {
                    featureProjection: 'EPSG:3857'
                });
                
                vectorSource.clear();
                vectorSource.addFeatures(features);
                
                statusEl.textContent = '‚úì Loaded ' + features.length.toLocaleString() + ' properties';
                statusEl.style.background = '#d4edda';
                
                // Zoom to data
                var extent = vectorSource.getExtent();
                map.getView().fit(extent, {
                    padding: [50, 50, 50, 50],
                    maxZoom: 16,
                    duration: 1000
                });
                
                console.log('Loaded', features.length, 'features');
                
            } catch (error) {
                console.error('GeoJSON error:', error);
                statusEl.textContent = '‚ùå Error: ' + error.message;
                statusEl.style.background = '#f8d7da';
            }
        }
        
        function setupMapInteractions() {
            // Click to show property info
            map.on('singleclick', function(evt) {
                var feature = map.forEachFeatureAtPixel(evt.pixel, function(f) {
                    return f;
                }, {
                    layerFilter: function(layer) {
                        return layer === cadastralLayer;
                    }
                });
                
                if (feature) {
                    var props = feature.getProperties();
                    var html = '<h3>Property Info</h3>';
                    
                    var fields = ['LOT', 'PLAN', 'LOTPLAN', 'AREA_SQMS', 'LOCALITY', 'LOCAL_GOVERNMENT_AREA', 'TENURE'];
                    var found = false;
                    
                    fields.forEach(function(field) {
                        if (props[field]) {
                            var value = props[field];
                            if (field === 'AREA_SQMS') {
                                var ha = (value / 10000).toFixed(2);
                                value = value.toLocaleString() + ' m¬≤ (' + ha + ' ha)';
                            }
                            html += '<div class="detail"><strong>' + field + ':</strong> ' + value + '</div>';
                            found = true;
                        }
                    });
                    
                    if (!found) {
                        for (var key in props) {
                            if (key !== 'geometry' && props[key]) {
                                html += '<div class="detail"><strong>' + key + ':</strong> ' + props[key] + '</div>';
                            }
                        }
                    }
                    
                    document.getElementById('popup-content').innerHTML = html;
                    document.getElementById('popup').style.display = 'block';
                    overlay.setPosition(evt.coordinate);
                } else {
                    document.getElementById('popup').style.display = 'none';
                }
            });
            
            // Cursor change on hover
            map.on('pointermove', function(evt) {
                var hit = map.hasFeatureAtPixel(evt.pixel, {
                    layerFilter: function(layer) {
                        return layer === cadastralLayer;
                    }
                });
                map.getTarget().style.cursor = hit ? 'pointer' : '';
            });
        }
        
        console.log('QLD Property Viewer initialized');
    </script>
</body>
</html>
