<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Warren Buffett's Bubble Pop Adventure</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            background: #1a1a1a;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            touch-action: none;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        /* Screen Management */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: none;
            z-index: 1;
        }

        .screen.active {
            display: block;
        }

        /* Main Menu */
        #mainMenu {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .menu-title {
            color: #f39c12;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            line-height: 1.2;
        }

        .menu-subtitle {
            color: #ecf0f1;
            font-size: 14px;
            text-align: center;
            margin-bottom: 40px;
            max-width: 80%;
        }

        .menu-button {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
        }

        .menu-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }

        /* Game Screen */
        #gameScreen {
            display: grid;
            grid-template-areas: 
                "topbar topbar topbar"
                "game game powerups"
                "next next powerups"
                "quotes quotes quotes";
            grid-template-rows: 60px 2fr 80px 1fr;
            grid-template-columns: 1fr 1fr 80px;
        }

        #topBar {
            grid-area: topbar;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            padding: 8px;
            border-bottom: 2px solid #34495e;
        }

        .stat-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .stat-title {
            font-size: 12px;
            color: #bdc3c7;
            margin-bottom: 2px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: bold;
        }

        #booksValue { color: #3498db; }
        #yearValue { color: #f39c12; }
        #cashValue { color: #2ecc71; }

        #gameArea {
            grid-area: game;
            position: relative;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            overflow: hidden;
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
            touch-action: none;
            cursor: crosshair;
        }

        #powerUps {
            grid-area: powerups;
            background: rgba(0, 0, 0, 0.8);
            border-left: 2px solid #34495e;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 5px;
        }

        #livesContainer {
            display: flex;
            gap: 3px;
            margin-bottom: 10px;
        }

        .life {
            width: 12px;
            height: 12px;
            background: #e74c3c;
            border-radius: 50%;
            border: 1px solid #fff;
        }

        .powerup-slot {
            width: 50px;
            height: 50px;
            background: rgba(52, 73, 94, 0.5);
            border: 2px solid #7f8c8d;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .powerup-slot:hover {
            border-color: #f39c12;
            background: rgba(243, 156, 18, 0.2);
        }

        .powerup-slot.active {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.3);
        }

        .powerup-icon {
            font-size: 20px;
            line-height: 1;
        }

        .powerup-count {
            font-size: 10px;
            color: white;
            background: rgba(243, 156, 18, 0.9);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: -2px;
            right: -2px;
            font-weight: bold;
        }

        #nextBubbles {
            grid-area: next;
            background: rgba(0, 0, 0, 0.8);
            border-top: 2px solid #34495e;
            display: flex;
            align-items: center;
            padding: 10px;
        }

        .next-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .cannon-display {
            width: 60px;
            height: 40px;
            background: #34495e;
            border: 2px solid #fff;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .cannon-sugar-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(0deg, #e74c3c, #f39c12);
            transition: height 0.3s ease;
            height: 100%;
        }

        .next-bubbles-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .next-bubble {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            font-weight: bold;
        }

        .next-label {
            color: #bdc3c7;
            font-size: 12px;
            margin-right: 10px;
        }

        .bubbles-remaining {
            color: #f39c12;
            font-size: 14px;
            font-weight: bold;
            margin-left: auto;
            margin-right: 20px;
        }

        #quotes {
            grid-area: quotes;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(44, 62, 80, 0.8));
            border-top: 3px solid #f39c12;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 15px;
            overflow: hidden;
            position: relative;
        }

        #quotes::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" x="10" font-size="60" opacity="0.1" fill="%23f39c12">"</text><text y="50" x="80" font-size="60" opacity="0.1" fill="%23f39c12">"</text></svg>');
            background-size: 200px 100px;
            background-repeat: no-repeat;
            background-position: 10px center, calc(100% - 10px) center;
            pointer-events: none;
        }

        #quoteText {
            color: #ecf0f1;
            font-size: 14px;
            text-align: center;
            font-style: italic;
            line-height: 1.4;
            max-width: 90%;
            animation: fadeIn 0.5s ease-in;
            z-index: 1;
            margin-bottom: 8px;
        }

        #quoteAuthor {
            color: #f39c12;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            z-index: 1;
        }

        .quote-category {
            position: absolute;
            top: 8px;
            right: 15px;
            background: rgba(243, 156, 18, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            z-index: 1;
        }

        /* Store Screen */
        #storeScreen {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .store-header {
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #f39c12;
        }

        .store-title {
            font-size: 20px;
            font-weight: bold;
            color: #f39c12;
        }

        .store-stats {
            display: flex;
            gap: 20px;
            font-size: 14px;
        }

        .store-content {
            flex: 1;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            overflow-y: auto;
        }

        .store-section {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #34495e;
        }

        .section-title {
            color: #f39c12;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }

        .store-item {
            background: rgba(52, 73, 94, 0.5);
            border: 2px solid #7f8c8d;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .store-item:hover {
            border-color: #f39c12;
            background: rgba(243, 156, 18, 0.2);
        }

        .store-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .store-item.disabled:hover {
            border-color: #7f8c8d;
            background: rgba(52, 73, 94, 0.5);
        }

        .item-name {
            color: #ecf0f1;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .item-description {
            color: #bdc3c7;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .item-price {
            color: #2ecc71;
            font-weight: bold;
        }

        .continue-button {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
        }

        .continue-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }

        /* Investment Screen */
        #investmentScreen {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            display: flex;
            flex-direction: column;
        }

        .investment-header {
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #3498db;
        }

        .investment-title {
            font-size: 20px;
            font-weight: bold;
            color: #3498db;
        }

        .investment-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .market-closed {
            text-align: center;
            color: #e74c3c;
            font-size: 18px;
            font-weight: bold;
            margin-top: 50px;
        }

        .stock-item {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #34495e;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: center;
        }

        .stock-info {
            color: #ecf0f1;
        }

        .stock-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .stock-symbol {
            color: #bdc3c7;
            font-size: 12px;
        }

        .stock-price {
            text-align: center;
        }

        .current-price {
            font-size: 18px;
            font-weight: bold;
            color: #f39c12;
        }

        .price-change {
            font-size: 12px;
            margin-top: 5px;
        }

        .price-change.positive {
            color: #2ecc71;
        }

        .price-change.negative {
            color: #e74c3c;
        }

        .holdings {
            text-align: center;
            color: #ecf0f1;
        }

        .shares-owned {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .holdings-value {
            font-size: 12px;
            color: #bdc3c7;
        }

        .stock-actions {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .buy-button, .sell-button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
        }

        .buy-button {
            background: #2ecc71;
            color: white;
        }

        .buy-button:hover {
            background: #27ae60;
        }

        .sell-button {
            background: #e74c3c;
            color: white;
        }

        .sell-button:hover {
            background: #c0392b;
        }

        .buy-button:disabled, .sell-button:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }

        /* Level Complete Screen */
        .level-complete {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            border: 3px solid #f39c12;
            z-index: 100;
            max-width: 80%;
        }

        .level-complete h2 {
            color: #f39c12;
            margin-bottom: 20px;
        }

        .level-results {
            margin: 20px 0;
            line-height: 1.6;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 600px) {
            #gameScreen {
                grid-template-columns: 1fr 1fr 60px;
                grid-template-rows: 50px 2fr 70px 1fr;
            }
            
            .stat-title { font-size: 10px; }
            .stat-value { font-size: 14px; }
            .powerup-slot { width: 40px; height: 40px; }
            .powerup-icon { font-size: 16px; }
            .powerup-count { font-size: 8px; width: 12px; height: 12px; }
            #quoteText { font-size: 12px; }
            #quoteAuthor { font-size: 10px; }
            
            .store-content {
                grid-template-columns: 1fr;
            }
            
            .stock-item {
                grid-template-columns: 1fr;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- Main Menu Screen -->
    <div id="mainMenu" class="screen active">
        <div class="menu-title">Warren Buffett's<br>Bubble Pop Adventure</div>
        <div class="menu-subtitle">
            Learn investing principles while popping bubbles through 70 years of market history
        </div>
        <button class="menu-button" onclick="game.startNewGame()">New Game</button>
        <button class="menu-button" onclick="game.showInstructions()">Instructions</button>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="screen">
        <div id="topBar">
            <div class="stat-section">
                <div class="stat-title">BOOKS</div>
                <div class="stat-value" id="booksValue">📚 5</div>
            </div>
            <div class="stat-section">
                <div class="stat-title">YEAR</div>
                <div class="stat-value" id="yearValue">1955</div>
            </div>
            <div class="stat-section">
                <div class="stat-title">$CASH</div>
                <div class="stat-value" id="cashValue">$100</div>
            </div>
        </div>

        <div id="gameArea">
            <canvas id="gameCanvas"></canvas>
        </div>

        <div id="powerUps">
            <div id="livesContainer">
                <div class="life"></div>
                <div class="life"></div>
                <div class="life"></div>
            </div>

            <div class="powerup-slot" id="lollapalooza">
                <div class="powerup-icon">💥</div>
                <div class="powerup-count">0</div>
            </div>
            <div class="powerup-slot" id="grahamNets">
                <div class="powerup-icon">🕸️</div>
                <div class="powerup-count">0</div>
            </div>
            <div class="powerup-slot" id="coke">
                <div class="powerup-icon">🥤</div>
                <div class="powerup-count">0</div>
            </div>
        </div>

        <div id="nextBubbles">
            <div class="next-section">
                <div class="cannon-display">
                    <div class="cannon-sugar-fill" id="cannonSugarFill"></div>
                </div>
                <div class="next-label">Sugar:</div>
                <div class="next-bubbles-container" id="nextBubblesContainer">
                    <div class="next-bubble" style="background: #e74c3c;">1</div>
                    <div class="next-bubble" style="background: #3498db;">2</div>
                    <div class="next-bubble" style="background: #2ecc71;">3</div>
                </div>
            </div>
            <div class="bubbles-remaining">
                Shots: <span id="bubblesRemaining">3</span>
            </div>
        </div>

        <div id="quotes">
            <div class="quote-category" id="quoteCategory">WISDOM</div>
            <div id="quoteText">
                The stock market is a device for transferring money from the impatient to the patient.
            </div>
            <div id="quoteAuthor">- Warren Buffett</div>
        </div>
    </div>

    <!-- Store Screen -->
    <div id="storeScreen" class="screen">
        <div class="store-header">
            <div class="store-title">Buffett's General Store</div>
            <div class="store-stats">
                <span>Year: <span id="storeYear">1955</span></span>
                <span>Cash: $<span id="storeCash">100</span></span>
                <span>Books: 📚<span id="storeBooks">5</span></span>
            </div>
        </div>
        
        <div class="store-content">
            <div class="store-section">
                <div class="section-title">📚 Books (Purchase with Book Currency)</div>
                <div id="booksForSale"></div>
            </div>
            
            <div class="store-section">
                <div class="section-title">🏢 Subsidiaries</div>
                <div id="subsidiariesForSale"></div>
            </div>
            
            <div class="store-section">
                <div class="section-title">⚡ Power-ups</div>
                <div id="powerupsForSale"></div>
            </div>
            
            <div class="store-section">
                <div class="section-title">🔧 Upgrades</div>
                <div id="upgradesForSale"></div>
            </div>
        </div>
        
        <button class="continue-button" onclick="game.continueToInvestments()">Continue to Investments →</button>
    </div>

    <!-- Investment Screen -->
    <div id="investmentScreen" class="screen">
        <div class="investment-header">
            <div class="investment-title">Investment Board</div>
            <div class="store-stats">
                <span>Year: <span id="investmentYear">1955</span></span>
                <span>Cash: $<span id="investmentCash">100</span></span>
                <span>Portfolio Value: $<span id="portfolioValue">0</span></span>
            </div>
        </div>
        
        <div class="investment-content">
            <div id="marketClosed" class="market-closed" style="display: none;">
                <h2>Stock Market Opens in 1963</h2>
                <p>Focus on building your bubble-popping skills and saving capital!</p>
            </div>
            
            <div id="stocksList"></div>
            <div id="subsidiariesOwned"></div>
        </div>
        
        <button class="continue-button" onclick="game.continueToNextYear()">Continue to Next Year →</button>
    </div>

    <script>
        // Stock market data
        const STOCK_DATA = {
            DIS: {
                name: "Disney",
                symbol: "DIS",
                startYear: 1963,
                prices: {
                    1963: 0.07, 1964: 0.08, 1965: 0.10, 1966: 0.13, 1967: 0.19,
                    1968: 0.29, 1969: 0.45, 1970: 0.48, 1971: 0.93, 1972: 1.60,
                    1973: 0.64, 1974: 0.29, 1975: 0.67, 1976: 0.64, 1977: 0.54,
                    1978: 0.54, 1979: 0.61, 1980: 0.69, 1981: 0.71, 1982: 0.87,
                    1983: 0.74, 1984: 0.86, 1985: 1.64, 1986: 2.53, 1987: 3.49,
                    1988: 3.90, 1989: 6.67, 1990: 6.08, 1991: 6.90, 1992: 10.42,
                    1993: 10.39, 1994: 11.29, 1995: 14.57, 1996: 17.35, 1997: 24.79,
                    1998: 22.68, 1999: 22.36, 2000: 22.27, 2001: 16.11, 2002: 12.84,
                    2003: 18.55, 2004: 22.30, 2005: 19.43, 2006: 28.03, 2007: 27.05,
                    2008: 19.30, 2009: 27.75, 2010: 32.63, 2011: 33.17, 2012: 44.71,
                    2013: 69.45, 2014: 86.72, 2015: 97.93, 2016: 98.59, 2017: 103.28,
                    2018: 107.00, 2019: 142.87, 2020: 178.97, 2021: 153.00, 2022: 85.82,
                    2023: 89.48, 2024: 111.35, 2025: 92.49
                }
            }
        };

        // Subsidiaries data
        const SUBSIDIARIES = {
            "See's Candies": {
                price: 2500,
                yearlyIncome: 150,
                gameplayPerk: "Sugar depletes 25% slower",
                perkDescription: "Quality candy extends energy",
                unlocks: ["GEICO"],
                availableFrom: 1972,
                bookRequirement: "Poor Charlie's Almanack"
            },
            "GEICO": {
                price: 8000,
                yearlyIncome: 400,
                gameplayPerk: "+2 starting bubbles per level",
                perkDescription: "Insurance provides backup shots",
                unlocks: ["Dairy Queen"],
                availableFrom: 1976,
                requires: ["See's Candies"]
            },
            "Dairy Queen": {
                price: 15000,
                yearlyIncome: 600,
                gameplayPerk: "+20% trajectory line length",
                perkDescription: "Smooth operations improve aiming precision",
                unlocks: ["Nebraska Furniture Mart"],
                availableFrom: 1998,
                requires: ["GEICO"]
            },
            "Nebraska Furniture Mart": {
                price: 25000,
                yearlyIncome: 800,
                gameplayPerk: "Remove yellow bubbles permanently from game",
                perkDescription: "Furniture efficiency eliminates one color complexity",
                unlocks: ["Fruit of the Loom"],
                availableFrom: 1983,
                requires: ["Dairy Queen"]
            },
            "Fruit of the Loom": {
                price: 40000,
                yearlyIncome: 1000,
                gameplayPerk: "Bubble scroll speed reduced by 15%",
                perkDescription: "Textile quality slows the rush of time",
                unlocks: ["Gillette"],
                availableFrom: 2002,
                requires: ["Nebraska Furniture Mart"]
            },
            "Gillette": {
                price: 65000,
                yearlyIncome: 1500,
                gameplayPerk: "Start each level with 1 Graham Net powerup",
                perkDescription: "Precision engineering provides strategic tools",
                unlocks: ["Duracell"],
                availableFrom: 2005,
                requires: ["Fruit of the Loom"]
            },
            "Duracell": {
                price: 90000,
                yearlyIncome: 2000,
                gameplayPerk: "Start each level with 1 Lollapalooza powerup",
                perkDescription: "Long-lasting power energizes explosive potential",
                unlocks: ["BNSF Railway"],
                availableFrom: 2014,
                requires: ["Gillette"]
            },
            "BNSF Railway": {
                price: 150000,
                yearlyIncome: 3500,
                gameplayPerk: "+3 starting bubbles AND remove orange bubbles permanently",
                perkDescription: "Transportation empire delivers maximum efficiency",
                availableFrom: 2009,
                requires: ["Duracell"],
                finalSubsidiary: true
            }
        };

        // Books data
        const BOOKS = {
            "The Intelligent Investor": {
                price: 10, // book currency
                bookValue: 50,
                unlocks: ["Graham's Nets"]
            },
            "Common Stocks and Uncommon Profits": {
                price: 15,
                bookValue: 75
            },
            "Poor Charlie's Almanack": {
                price: 20,
                bookValue: 100,
                unlocks: ["See's Candies", "Munger's Lollapaloozas"]
            },
            "The Little Book of Common Sense Investing": {
                price: 8,
                bookValue: 40
            },
            "Essays of Warren Buffett": {
                price: 25,
                bookValue: 100
            }
        };

        // Power-ups data
        const POWERUPS = {
            "Coke": {
                effect: "Restore 20% sugar (consumable)",
                price: 50,
                maxPurchases: 99
            },
            "Munger's Lollapaloozas": {
                type: "explosive",
                effect: "Destroys 3x3 area",
                price: 200,
                requires: ["Poor Charlie's Almanack"]
            },
            "Graham's Nets": {
                type: "converter",
                effect: "Turns hit bubbles grey for chain pops",
                price: 300,
                requires: ["The Intelligent Investor"]
            }
        };

        class GameManager {
            constructor() {
                this.gameState = {
                    year: 1955,
                    cash: 100,
                    books: 5,
                    lives: 3,
                    ownedBooks: [],
                    ownedSubsidiaries: [],
                    portfolio: {},
                    powerups: {
                        lollapalooza: 0,
                        grahamNets: 0,
                        coke: 0
                    },
                    gameplayModifiers: {
                        sugarDepletion: 1.0,
                        startingBubbles: 3,
                        trajectoryLength: 1.0,
                        removedColors: [],
                        scrollSpeedModifier: 1.0
                    }
                };
                
                this.currentScreen = 'mainMenu';
                this.bubbleGame = null;
                this.setupEventListeners();
            }

            setupEventListeners() {
                // Setup any global event listeners here
            }

            startNewGame() {
                this.gameState = {
                    year: 1955,
                    cash: 100,
                    books: 5,
                    lives: 3,
                    ownedBooks: [],
                    ownedSubsidiaries: [],
                    portfolio: {},
                    powerups: {
                        lollapalooza: 0,
                        grahamNets: 0,
                        coke: 0
                    },
                    gameplayModifiers: {
                        sugarDepletion: 1.0,
                        startingBubbles: 3,
                        trajectoryLength: 1.0,
                        removedColors: [],
                        scrollSpeedModifier: 1.0
                    }
                };
                
                this.showScreen('gameScreen');
                this.startBubbleGame();
            }

            showInstructions() {
                alert("Pop bubbles to earn money and books!\n\nMatch 3+ bubbles of the same color to clear them.\nCollect falling items for bonuses.\nManage your sugar energy carefully.\n\nAfter each level, visit the store and make investments.\nBuild your portfolio and business empire like Warren Buffett!");
            }

            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.getElementById(screenId).classList.add('active');
                this.currentScreen = screenId;
            }

            startBubbleGame() {
                if (this.bubbleGame) {
                    this.bubbleGame.cleanup();
                }
                this.bubbleGame = new BubbleGame(this);
            }

            onLevelComplete(earnings) {
                this.gameState.cash += earnings.cash;
                this.gameState.books += earnings.books;
                
                // Apply subsidiary income
                for (let subsidiary of this.gameState.ownedSubsidiaries) {
                    this.gameState.cash += SUBSIDIARIES[subsidiary].yearlyIncome;
                }
                
                this.showStore();
            }

            showStore() {
                this.showScreen('storeScreen');
                this.updateStoreDisplay();
            }

            updateStoreDisplay() {
                // Update header stats
                document.getElementById('storeYear').textContent = this.gameState.year;
                document.getElementById('storeCash').textContent = this.gameState.cash.toLocaleString();
                document.getElementById('storeBooks').textContent = this.gameState.books;

                // Update books section
                this.updateBooksSection();
                this.updateSubsidiariesSection();
                this.updatePowerupsSection();
                this.updateUpgradesSection();
            }

            updateBooksSection() {
                const container = document.getElementById('booksForSale');
                container.innerHTML = '';

                for (let [name, book] of Object.entries(BOOKS)) {
                    if (this.gameState.ownedBooks.includes(name)) continue;

                    const item = document.createElement('div');
                    item.className = `store-item ${this.gameState.books >= book.price ? '' : 'disabled'}`;
                    item.innerHTML = `
                        <div class="item-name">${name}</div>
                        <div class="item-description">Unlocks investment opportunities</div>
                        <div class="item-price">📚 ${book.price} Books</div>
                    `;

                    if (this.gameState.books >= book.price) {
                        item.onclick = () => this.buyBook(name);
                    }

                    container.appendChild(item);
                }
            }

            updateSubsidiariesSection() {
                const container = document.getElementById('subsidiariesForSale');
                container.innerHTML = '';

                for (let [name, subsidiary] of Object.entries(SUBSIDIARIES)) {
                    if (this.gameState.ownedSubsidiaries.includes(name)) continue;
                    if (this.gameState.year < subsidiary.availableFrom) continue;
                    if (!this.meetsSubsidiaryRequirements(subsidiary)) continue;

                    const item = document.createElement('div');
                    item.className = `store-item ${this.gameState.cash >= subsidiary.price ? '' : 'disabled'}`;
                    item.innerHTML = `
                        <div class="item-name">${name}</div>
                        <div class="item-description">${subsidiary.perkDescription}<br>Income: $${subsidiary.yearlyIncome}/year</div>
                        <div class="item-price">$${subsidiary.price.toLocaleString()}</div>
                    `;

                    if (this.gameState.cash >= subsidiary.price) {
                        item.onclick = () => this.buySubsidiary(name);
                    }

                    container.appendChild(item);
                }
            }

            updatePowerupsSection() {
                const container = document.getElementById('powerupsForSale');
                container.innerHTML = '';

                for (let [name, powerup] of Object.entries(POWERUPS)) {
                    if (powerup.requires && !powerup.requires.every(req => this.gameState.ownedBooks.includes(req))) {
                        continue;
                    }

                    const item = document.createElement('div');
                    item.className = `store-item ${this.gameState.cash >= powerup.price ? '' : 'disabled'}`;
                    item.innerHTML = `
                        <div class="item-name">${name}</div>
                        <div class="item-description">${powerup.effect}</div>
                        <div class="item-price">$${powerup.price}</div>
                    `;

                    if (this.gameState.cash >= powerup.price) {
                        item.onclick = () => this.buyPowerup(name);
                    }

                    container.appendChild(item);
                }
            }

            updateUpgradesSection() {
                const container = document.getElementById('upgradesForSale');
                container.innerHTML = '<div class="item-description">Permanent upgrades coming soon!</div>';
            }

            meetsSubsidiaryRequirements(subsidiary) {
                if (subsidiary.bookRequirement && !this.gameState.ownedBooks.includes(subsidiary.bookRequirement)) {
                    return false;
                }
                if (subsidiary.requires && !subsidiary.requires.every(req => this.gameState.ownedSubsidiaries.includes(req))) {
                    return false;
                }
                return true;
            }

            buyBook(name) {
                const book = BOOKS[name];
                if (this.gameState.books >= book.price) {
                    this.gameState.books -= book.price;
                    this.gameState.ownedBooks.push(name);
                    this.updateStoreDisplay();
                    
                    // Show acquisition message
                    this.showQuote(`Acquired "${name}"! Knowledge is the best investment.`, 'Warren Buffett', 'BUSINESS');
                }
            }

            buySubsidiary(name) {
                const subsidiary = SUBSIDIARIES[name];
                if (this.gameState.cash >= subsidiary.price) {
                    this.gameState.cash -= subsidiary.price;
                    this.gameState.ownedSubsidiaries.push(name);
                    this.applySubsidiaryPerk(name);
                    this.updateStoreDisplay();
                    
                    // Show acquisition message
                    this.showQuote(`Acquired ${name}! ${subsidiary.perkDescription}`, 'Warren Buffett', 'BUSINESS');
                }
            }

            buyPowerup(name) {
                const powerup = POWERUPS[name];
                if (this.gameState.cash >= powerup.price) {
                    this.gameState.cash -= powerup.price;
                    
                    if (name === 'Coke') {
                        this.gameState.powerups.coke++;
                    } else if (name === "Munger's Lollapaloozas") {
                        this.gameState.powerups.lollapalooza++;
                    } else if (name === "Graham's Nets") {
                        this.gameState.powerups.grahamNets++;
                    }
                    
                    this.updateStoreDisplay();
                }
            }

            applySubsidiaryPerk(name) {
                const subsidiary = SUBSIDIARIES[name];
                switch (name) {
                    case "See's Candies":
                        this.gameState.gameplayModifiers.sugarDepletion = 0.75;
                        break;
                    case "GEICO":
                        this.gameState.gameplayModifiers.startingBubbles += 2;
                        break;
                    case "Dairy Queen":
                        this.gameState.gameplayModifiers.trajectoryLength = 1.2;
                        break;
                    case "Nebraska Furniture Mart":
                        this.gameState.gameplayModifiers.removedColors.push('#f39c12'); // Remove yellow
                        break;
                    case "Fruit of the Loom":
                        this.gameState.gameplayModifiers.scrollSpeedModifier = 0.85;
                        break;
                    case "Gillette":
                        // Applied at level start
                        break;
                    case "Duracell":
                        // Applied at level start
                        break;
                    case "BNSF Railway":
                        this.gameState.gameplayModifiers.startingBubbles += 3;
                        this.gameState.gameplayModifiers.removedColors.push('#e67e22'); // Remove orange
                        break;
                }
            }

            continueToInvestments() {
                this.showScreen('investmentScreen');
                this.updateInvestmentDisplay();
            }

            updateInvestmentDisplay() {
                document.getElementById('investmentYear').textContent = this.gameState.year;
                document.getElementById('investmentCash').textContent = this.gameState.cash.toLocaleString();
                
                if (this.gameState.year < 1963) {
                    document.getElementById('marketClosed').style.display = 'block';
                    document.getElementById('stocksList').style.display = 'none';
                } else {
                    document.getElementById('marketClosed').style.display = 'none';
                    document.getElementById('stocksList').style.display = 'block';
                    this.updateStocksList();
                }
                
                this.updatePortfolioValue();
                this.updateSubsidiariesDisplay();
            }

            updateStocksList() {
                const container = document.getElementById('stocksList');
                container.innerHTML = '';

                for (let [symbol, stock] of Object.entries(STOCK_DATA)) {
                    if (this.gameState.year < stock.startYear) continue;

                    const currentPrice = stock.prices[this.gameState.year];
                    const prevPrice = stock.prices[this.gameState.year - 1];
                    const priceChange = prevPrice ? ((currentPrice - prevPrice) / prevPrice * 100).toFixed(2) : 0;

                    const ownedShares = this.gameState.portfolio[symbol] || 0;
                    const holdingValue = ownedShares * currentPrice;

                    const stockDiv = document.createElement('div');
                    stockDiv.className = 'stock-item';
                    stockDiv.innerHTML = `
                        <div class="stock-info">
                            <div class="stock-name">${stock.name}</div>
                            <div class="stock-symbol">${symbol}</div>
                        </div>
                        <div class="stock-price">
                            <div class="current-price">$${currentPrice.toFixed(2)}</div>
                            <div class="price-change ${priceChange >= 0 ? 'positive' : 'negative'}">
                                ${priceChange >= 0 ? '+' : ''}${priceChange}%
                            </div>
                        </div>
                        <div class="holdings">
                            <div class="shares-owned">${ownedShares} shares</div>
                            <div class="holdings-value">$${holdingValue.toFixed(2)}</div>
                        </div>
                        <div class="stock-actions">
                            <button class="buy-button" onclick="game.buyStock('${symbol}', 1)" 
                                    ${this.gameState.cash >= currentPrice ? '' : 'disabled'}>
                                Buy 1
                            </button>
                            <button class="sell-button" onclick="game.sellStock('${symbol}', 1)"
                                    ${ownedShares > 0 ? '' : 'disabled'}>
                                Sell 1
                            </button>
                        </div>
                    `;

                    container.appendChild(stockDiv);
                }
            }

            updateSubsidiariesDisplay() {
                const container = document.getElementById('subsidiariesOwned');
                if (this.gameState.ownedSubsidiaries.length === 0) return;

                container.innerHTML = '<h3 style="color: #f39c12; margin-top: 20px;">Owned Subsidiaries</h3>';

                for (let name of this.gameState.ownedSubsidiaries) {
                    const subsidiary = SUBSIDIARIES[name];
                    const div = document.createElement('div');
                    div.className = 'stock-item';
                    div.style.background = 'rgba(243, 156, 18, 0.1)';
                    div.style.borderColor = '#f39c12';
                    div.innerHTML = `
                        <div class="stock-info">
                            <div class="stock-name">${name}</div>
                            <div class="stock-symbol">Subsidiary</div>
                        </div>
                        <div class="stock-price">
                            <div class="current-price">$${subsidiary.yearlyIncome}/year</div>
                        </div>
                        <div class="holdings">
                            <div class="shares-owned">Owned</div>
                            <div class="holdings-value">${subsidiary.gameplayPerk}</div>
                        </div>
                        <div class="stock-actions">
                            <div style="color: #2ecc71; font-weight: bold;">FOREVER HOLD</div>
                        </div>
                    `;
                    container.appendChild(div);
                }
            }

            buyStock(symbol, shares) {
                const stock = STOCK_DATA[symbol];
                const price = stock.prices[this.gameState.year];
                const totalCost = price * shares;

                if (this.gameState.cash >= totalCost) {
                    this.gameState.cash -= totalCost;
                    this.gameState.portfolio[symbol] = (this.gameState.portfolio[symbol] || 0) + shares;
                    this.updateInvestmentDisplay();
                }
            }

            sellStock(symbol, shares) {
                const currentShares = this.gameState.portfolio[symbol] || 0;
                if (currentShares >= shares) {
                    const stock = STOCK_DATA[symbol];
                    const price = stock.prices[this.gameState.year];
                    const totalValue = price * shares;

                    this.gameState.cash += totalValue;
                    this.gameState.portfolio[symbol] -= shares;
                    if (this.gameState.portfolio[symbol] === 0) {
                        delete this.gameState.portfolio[symbol];
                    }
                    this.updateInvestmentDisplay();
                }
            }

            updatePortfolioValue() {
                let totalValue = 0;
                for (let [symbol, shares] of Object.entries(this.gameState.portfolio)) {
                    const stock = STOCK_DATA[symbol];
                    const currentPrice = stock.prices[this.gameState.year];
                    totalValue += shares * currentPrice;
                }
                document.getElementById('portfolioValue').textContent = totalValue.toFixed(0);
            }

            continueToNextYear() {
                this.gameState.year++;
                
                // Apply start-of-level powerups from subsidiaries
                if (this.gameState.ownedSubsidiaries.includes('Gillette')) {
                    this.gameState.powerups.grahamNets++;
                }
                if (this.gameState.ownedSubsidiaries.includes('Duracell')) {
                    this.gameState.powerups.lollapalooza++;
                }
                
                this.showScreen('gameScreen');
                this.startBubbleGame();
            }

            showQuote(text, author, category) {
                if (this.currentScreen === 'gameScreen' && this.bubbleGame) {
                    this.bubbleGame.showQuote(text, author, category);
                }
            }
        }

        // Initialize the game manager
        const game = new GameManager();

        // Bubble Game Class (simplified for space)
        class BubbleGame {
            constructor(gameManager) {
                this.gameManager = gameManager;
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                
                this.setupCanvas();
                this.initGameState();
                this.setupEventListeners();
                this.generateInitialBubbles();
                
                this.lastTime = 0;
                this.gameLoop();
            }
            
            cleanup() {
                // Clean up event listeners and stop game loop
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                }
            }
            
            setupCanvas() {
                const gameArea = document.getElementById('gameArea');
                this.canvas.width = gameArea.clientWidth || 800;
                this.canvas.height = gameArea.clientHeight || 600;
                
                window.addEventListener('resize', () => {
                    const gameArea = document.getElementById('gameArea');
                    this.canvas.width = gameArea.clientWidth || 800;
                    this.canvas.height = gameArea.clientHeight || 600;
                    this.cannon.x = this.canvas.width / 2;
                    this.cannon.y = this.canvas.height - 30;
                });
            }
            
            initGameState() {
                const modifiers = this.gameManager.gameState.gameplayModifiers;
                
                this.year = this.gameManager.gameState.year;
                this.books = this.gameManager.gameState.books;
                this.sugar = 60;
                this.maxSugar = 60;
                this.lives = this.gameManager.gameState.lives;
                this.cash = this.gameManager.gameState.cash;
                this.bubblesRemaining = modifiers.startingBubbles;
                this.gameRunning = true;
                
                this.bubbles = [];
                this.activeBubble = null;
                this.nextBubbles = [];
                this.collectibles = [];
                
                this.bubbleRadius = Math.max(12, Math.min(18, this.canvas.width / 25));
                this.scrollSpeed = 30 * modifiers.scrollSpeedModifier;
                this.spawnTimer = 0;
                this.spawnInterval = 0.8;
                this.sugarDepletionRate = modifiers.sugarDepletion;
                
                this.cannon = {
                    x: this.canvas.width / 2,
                    y: this.canvas.height - 30,
                    angle: -Math.PI / 2,
                    power: 300
                };
                
                // Set up colors (removing colors based on subsidiaries)
                this.colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6'].filter(color => 
                    !modifiers.removedColors.includes(color)
                );
                
                this.isAiming = false;
                this.trajectory = [];
                this.trajectoryLength = modifiers.trajectoryLength;
                
                this.powerups = {
                    lollapalooza: this.gameManager.gameState.powerups.lollapalooza,
                    grahamNets: this.gameManager.gameState.powerups.grahamNets,
                    coke: this.gameManager.gameState.powerups.coke
                };
                
                this.specialAmmo = [];
                this.currentBubbleType = 'normal';
                
                for (let i = 0; i < 3; i++) {
                    this.nextBubbles.push(Math.floor(Math.random() * Math.min(3, this.colors.length)));
                }
                
                this.updateUI();
                this.showQuote(`Welcome to ${this.year}! Use your shots wisely!`, 'Warren Buffett', 'WISDOM');
            }
            
            setupEventListeners() {
                this.canvas.addEventListener('contextmenu', e => e.preventDefault());
                
                // Mouse events
                this.mouseDown = (e) => this.startAiming(e);
                this.mouseMove = (e) => this.updateAiming(e);
                this.mouseUp = (e) => this.fire(e);
                
                this.canvas.addEventListener('mousedown', this.mouseDown);
                this.canvas.addEventListener('mousemove', this.mouseMove);
                this.canvas.addEventListener('mouseup', this.mouseUp);
                
                // Touch events
                this.touchStart = (e) => {
                    e.preventDefault();
                    this.startAiming(e.touches[0]);
                };
                this.touchMove = (e) => {
                    e.preventDefault();
                    this.updateAiming(e.touches[0]);
                };
                this.touchEnd = (e) => {
                    e.preventDefault();
                    this.fire(e);
                };
                
                this.canvas.addEventListener('touchstart', this.touchStart);
                this.canvas.addEventListener('touchmove', this.touchMove);
                this.canvas.addEventListener('touchend', this.touchEnd);

                // Powerup buttons
                this.lollapaloozaClick = () => {
                    if (this.powerups.lollapalooza > 0) {
                        this.powerups.lollapalooza--;
                        this.gameManager.gameState.powerups.lollapalooza--;
                        
                        if (this.currentBubbleType === 'normal') {
                            this.currentBubbleType = 'explosive';
                            this.showQuote('Lollapalooza loaded! Current shot will explode!', 'Charlie Munger', 'POWERUP');
                        } else {
                            this.specialAmmo.push('explosive');
                            this.showQuote('Lollapalooza queued! Next shot will explode!', 'Charlie Munger', 'POWERUP');
                        }
                        
                        this.updatePowerupCounts();
                    }
                };
                
                this.grahamNetsClick = () => {
                    if (this.powerups.grahamNets > 0) {
                        this.powerups.grahamNets--;
                        this.gameManager.gameState.powerups.grahamNets--;
                        
                        if (this.currentBubbleType === 'normal') {
                            this.currentBubbleType = 'converter';
                            this.showQuote('Graham Nets loaded! Current shot creates chain reactions!', 'Benjamin Graham', 'POWERUP');
                        } else {
                            this.specialAmmo.push('converter');
                            this.showQuote('Graham Nets queued! Next shot creates chain reactions!', 'Benjamin Graham', 'POWERUP');
                        }
                        
                        this.updatePowerupCounts();
                    }
                };
                
                this.cokeClick = () => {
                    if (this.powerups.coke > 0) {
                        this.powerups.coke--;
                        this.gameManager.gameState.powerups.coke--;
                        this.sugar = Math.min(this.maxSugar, this.sugar + 20);
                        this.showQuote('Refreshing Coke! Sugar restored!', 'Warren Buffett', 'POWERUP');
                        this.updatePowerupCounts();
                    }
                };
                
                document.getElementById('lollapalooza').addEventListener('click', this.lollapaloozaClick);
                document.getElementById('grahamNets').addEventListener('click', this.grahamNetsClick);
                document.getElementById('coke').addEventListener('click', this.cokeClick);
            }

            // Simplified bubble game methods (keeping core functionality)
            generateInitialBubbles() {
                this.bubbles = [];
                
                const cols = Math.floor(this.canvas.width / (this.bubbleRadius * 2)) + 5;
                const rows = 6;
                
                for (let col = 0; col < cols; col++) {
                    for (let row = 0; row < rows; row++) {
                        if (Math.random() < 0.7) {
                            const x = col * (this.bubbleRadius * 2) + this.bubbleRadius + (row % 2 ? this.bubbleRadius : 0);
                            const y = row * (this.bubbleRadius * 1.5) + this.bubbleRadius + 20;
                            
                            this.bubbles.push({
                                x: x,
                                y: y,
                                color: Math.floor(Math.random() * this.colors.length),
                                radius: this.bubbleRadius,
                                gridX: col,
                                gridY: row
                            });
                        }
                    }
                }
            }

            update(deltaTime) {
                if (!this.gameRunning) return;
                
                this.sugar -= deltaTime * this.sugarDepletionRate;
                if (this.sugar <= 0) {
                    this.endLevel(false);
                    return;
                }
                
                // Bubble scrolling and spawning logic (simplified)
                this.bubbles.forEach(bubble => {
                    bubble.x -= this.scrollSpeed * deltaTime;
                });
                
                this.bubbles = this.bubbles.filter(bubble => bubble.x > -this.bubbleRadius);
                
                // Active bubble movement
                if (this.activeBubble) {
                    this.activeBubble.x += this.activeBubble.vx * deltaTime;
                    this.activeBubble.y += this.activeBubble.vy * deltaTime;
                    
                    if (this.activeBubble.x <= this.bubbleRadius || 
                        this.activeBubble.x >= this.canvas.width - this.bubbleRadius) {
                        this.activeBubble.vx = -this.activeBubble.vx;
                        this.activeBubble.x = Math.max(this.bubbleRadius, 
                            Math.min(this.canvas.width - this.bubbleRadius, this.activeBubble.x));
                    }
                    
                    this.checkCollisions();
                    
                    if (this.activeBubble && this.activeBubble.y <= -this.bubbleRadius) {
                        this.activeBubble = null;
                    }
                }
                
                // Check level end conditions
                if (this.bubbles.length === 0) {
                    this.endLevel(true);
                } else if (this.bubblesRemaining <= 0 && !this.activeBubble) {
                    this.endLevel(false);
                }
                
                this.updateUI();
            }

            // Additional simplified methods would go here...
            getPointerPos(e) {
                const rect = this.canvas.getBoundingClientRect();
                return {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            }
            
            startAiming(e) {
                if (!this.gameRunning || this.activeBubble) return;
                this.isAiming = true;
                this.updateAiming(e);
            }
            
            updateAiming(e) {
                if (!this.isAiming) return;
                
                const pos = this.getPointerPos(e);
                const dx = pos.x - this.cannon.x;
                const dy = pos.y - this.cannon.y;
                
                let angle = Math.atan2(dy, dx);
                const maxAngle = Math.PI * 0.1;
                const minAngle = -Math.PI + maxAngle;
                angle = Math.max(minAngle, Math.min(maxAngle, angle));
                
                this.cannon.angle = angle;
                this.calculateTrajectory();
            }
            
            fire(e) {
                if (!this.isAiming || this.activeBubble || this.bubblesRemaining <= 0) return;
                
                this.isAiming = false;
                this.trajectory = [];
                
                this.activeBubble = {
                    x: this.cannon.x,
                    y: this.cannon.y,
                    vx: Math.cos(this.cannon.angle) * this.cannon.power,
                    vy: Math.sin(this.cannon.angle) * this.cannon.power,
                    color: this.nextBubbles.shift(),
                    radius: this.bubbleRadius,
                    type: this.currentBubbleType
                };
                
                this.nextBubbles.push(Math.floor(Math.random() * this.colors.length));
                this.bubblesRemaining--;
                
                this.loadNextAmmo();
                this.updateUI();
            }
            
            calculateTrajectory() {
                this.trajectory = [];
                if (!this.isAiming) return;
                
                let x = this.cannon.x;
                let y = this.cannon.y;
                let vx = Math.cos(this.cannon.angle) * this.cannon.power / 60;
                let vy = Math.sin(this.cannon.angle) * this.cannon.power / 60;
                
                const maxPoints = Math.floor(30 * this.trajectoryLength);
                
                for (let i = 0; i < maxPoints; i++) {
                    x += vx;
                    y += vy;
                    
                    if (x <= this.bubbleRadius || x >= this.canvas.width - this.bubbleRadius) {
                        vx = -vx;
                        x = Math.max(this.bubbleRadius, Math.min(this.canvas.width - this.bubbleRadius, x));
                    }
                    
                    this.trajectory.push({ x, y });
                    
                    if (y <= 0) break;
                }
            }

            checkCollisions() {
                if (!this.activeBubble) return;
                
                for (let bubble of this.bubbles) {
                    const dist = Math.sqrt(
                        Math.pow(this.activeBubble.x - bubble.x, 2) + 
                        Math.pow(this.activeBubble.y - bubble.y, 2)
                    );
                    
                    if (dist < this.bubbleRadius * 1.8) {
                        this.attachBubble(bubble);
                        return;
                    }
                }
            }
            
            attachBubble(nearBubble) {
                // Simplified bubble attachment and matching logic
                const newBubble = {
                    x: this.activeBubble.x,
                    y: this.activeBubble.y,
                    color: this.activeBubble.color,
                    radius: this.bubbleRadius
                };
                
                this.bubbles.push(newBubble);
                this.activeBubble = null;
                
                // Simple match finding (would be more complex in full implementation)
                const matches = this.findSimpleMatches(newBubble);
                if (matches.length >= 3) {
                    this.popBubbles(matches);
                }
            }
            
            findSimpleMatches(bubble) {
                // Simplified matching logic
                return this.bubbles.filter(b => 
                    b.color === bubble.color && 
                    Math.sqrt(Math.pow(b.x - bubble.x, 2) + Math.pow(b.y - bubble.y, 2)) < this.bubbleRadius * 3
                );
            }
            
            popBubbles(matches) {
                for (let bubble of matches) {
                    const index = this.bubbles.indexOf(bubble);
                    if (index !== -1) {
                        this.bubbles.splice(index, 1);
                    }
                }
                
                // Add earnings
                const earnings = matches.length * 50;
                this.cash += earnings;
                
                if (Math.random() < 0.1) {
                    this.books += 1;
                }
            }

            loadNextAmmo() {
                if (this.specialAmmo.length > 0) {
                    this.currentBubbleType = this.specialAmmo.shift();
                } else {
                    this.currentBubbleType = 'normal';
                }
            }

            updatePowerupCounts() {
                document.querySelector('#lollapalooza .powerup-count').textContent = this.powerups.lollapalooza;
                document.querySelector('#grahamNets .powerup-count').textContent = this.powerups.grahamNets;
                document.querySelector('#coke .powerup-count').textContent = this.powerups.coke;
            }
            
            endLevel(won) {
                this.gameRunning = false;
                
                // Calculate earnings
                const earnings = {
                    cash: Math.max(0, this.cash - this.gameManager.gameState.cash),
                    books: Math.max(0, this.books - this.gameManager.gameState.books)
                };
                
                // Clean up event listeners
                this.canvas.removeEventListener('mousedown', this.mouseDown);
                this.canvas.removeEventListener('mousemove', this.mouseMove);
                this.canvas.removeEventListener('mouseup', this.mouseUp);
                this.canvas.removeEventListener('touchstart', this.touchStart);
                this.canvas.removeEventListener('touchmove', this.touchMove);
                this.canvas.removeEventListener('touchend', this.touchEnd);
                
                document.getElementById('lollapalooza').removeEventListener('click', this.lollapaloozaClick);
                document.getElementById('grahamNets').removeEventListener('click', this.grahamNetsClick);
                document.getElementById('coke').removeEventListener('click', this.cokeClick);
                
                if (won || earnings.cash > 0 || earnings.books > 0) {
                    setTimeout(() => {
                        this.gameManager.onLevelComplete(earnings);
                    }, 1000);
                } else {
                    this.gameManager.gameState.lives--;
                    if (this.gameManager.gameState.lives <= 0) {
                        setTimeout(() => {
                            this.gameManager.showScreen('mainMenu');
                        }, 2000);
                    } else {
                        setTimeout(() => {
                            this.gameManager.startBubbleGame();
                        }, 1500);
                    }
                }
            }
            
            showQuote(text, author, category) {
                document.getElementById('quoteText').textContent = text;
                document.getElementById('quoteAuthor').textContent = author ? '- ' + author : '';
                document.getElementById('quoteCategory').textContent = category || 'GAME';
                
                const categoryEl = document.getElementById('quoteCategory');
                switch(category) {
                    case 'WISDOM':
                        categoryEl.style.background = 'rgba(243, 156, 18, 0.8)';
                        break;
                    case 'BUSINESS':
                        categoryEl.style.background = 'rgba(46, 204, 113, 0.8)';
                        break;
                    case 'POWERUP':
                        categoryEl.style.background = 'rgba(155, 89, 182, 0.8)';
                        break;
                    default:
                        categoryEl.style.background = 'rgba(52, 152, 219, 0.8)';
                }
            }
            
            updateUI() {
                document.getElementById('booksValue').textContent = '📚 ' + this.books;
                document.getElementById('yearValue').textContent = this.year;
                document.getElementById('cashValue').textContent = '$' + this.cash.toLocaleString();
                
                document.getElementById('cannonSugarFill').style.height = ((this.sugar / this.maxSugar) * 100) + '%';
                document.getElementById('bubblesRemaining').textContent = this.bubblesRemaining;
                
                const livesContainer = document.getElementById('livesContainer');
                livesContainer.innerHTML = '';
                for (let i = 0; i < this.lives; i++) {
                    const life = document.createElement('div');
                    life.className = 'life';
                    livesContainer.appendChild(life);
                }
                
                const container = document.getElementById('nextBubblesContainer');
                container.innerHTML = '';
                for (let i = 0; i < this.nextBubbles.length; i++) {
                    const bubble = document.createElement('div');
                    bubble.className = 'next-bubble';
                    bubble.style.background = this.colors[this.nextBubbles[i]];
                    bubble.textContent = i + 1;
                    container.appendChild(bubble);
                }
            }
            
            render() {
                this.ctx.fillStyle = '#2c3e50';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Draw bubbles
                for (let bubble of this.bubbles) {
                    this.drawBubble(bubble);
                }
                
                if (this.activeBubble) {
                    this.drawBubble(this.activeBubble);
                }
                
                // Draw trajectory
                if (this.isAiming && this.trajectory.length > 0) {
                    this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
                    this.ctx.lineWidth = 2;
                    this.ctx.setLineDash([5, 5]);
                    this.ctx.beginPath();
                    this.ctx.moveTo(this.cannon.x, this.cannon.y);
                    for (let point of this.trajectory) {
                        this.ctx.lineTo(point.x, point.y);
                    }
                    this.ctx.stroke();
                    this.ctx.setLineDash([]);
                }
                
                // Draw cannon
                this.ctx.save();
                this.ctx.translate(this.cannon.x, this.cannon.y);
                this.ctx.rotate(this.cannon.angle);
                this.ctx.fillStyle = '#34495e';
                this.ctx.fillRect(-5, -8, 25, 6);
                this.ctx.restore();
                
                this.ctx.beginPath();
                this.ctx.arc(this.cannon.x, this.cannon.y, 15, 0, Math.PI * 2);
                this.ctx.fillStyle = '#2c3e50';
                this.ctx.fill();
                
                // Draw loaded bubble
                if (this.nextBubbles.length > 0) {
                    const loadedBubble = {
                        x: this.cannon.x,
                        y: this.cannon.y - 5,
                        radius: this.bubbleRadius * 0.8,
                        color: this.nextBubbles[0]
                    };
                    this.drawCannonBubble(loadedBubble);
                }
            }
            
            drawBubble(bubble) {
                this.ctx.beginPath();
                this.ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                this.ctx.fillStyle = this.colors[bubble.color];
                this.ctx.fill();
                
                // Highlight
                this.ctx.beginPath();
                this.ctx.arc(bubble.x - bubble.radius * 0.3, bubble.y - bubble.radius * 0.3, 
                    bubble.radius * 0.3, 0, Math.PI * 2);
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
                this.ctx.fill();
                
                // Border
                this.ctx.beginPath();
                this.ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                this.ctx.lineWidth = 1;
                this.ctx.stroke();
            }
            
            drawCannonBubble(bubble) {
                this.ctx.beginPath();
                this.ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                this.ctx.fillStyle = this.colors[bubble.color];
                this.ctx.fill();
                
                // Special type indicators
                if (this.currentBubbleType === 'explosive') {
                    this.ctx.beginPath();
                    this.ctx.arc(bubble.x, bubble.y, bubble.radius + 3, 0, Math.PI * 2);
                    this.ctx.strokeStyle = '#e74c3c';
                    this.ctx.lineWidth = 3;
                    this.ctx.stroke();
                } else if (this.currentBubbleType === 'converter') {
                    this.ctx.beginPath();
                    this.ctx.arc(bubble.x, bubble.y, bubble.radius + 3, 0, Math.PI * 2);
                    this.ctx.strokeStyle = '#f1c40f';
                    this.ctx.lineWidth = 3;
                    this.ctx.stroke();
                }
            }
            
            gameLoop() {
                if (this.gameManager.currentScreen !== 'gameScreen') {
                    return;
                }
                
                const now = performance.now();
                const deltaTime = this.lastTime ? (now - this.lastTime) / 1000 : 0;
                this.lastTime = now;
                
                this.update(Math.min(deltaTime, 0.016));
                this.render();
                
                this.animationId = requestAnimationFrame(() => this.gameLoop());
            }
        }
    </script>
</body>
</html>
