<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Warren Buffett's Bubble Pop Adventure</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            background: #1a1a1a;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            touch-action: none;
            position: fixed;
            width: 100%;
            height: 100%;
        }



        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: grid;
            grid-template-areas: 
                "topbar topbar topbar"
                "game game powerups"
                "next next powerups"
                "quotes quotes quotes";
            grid-template-rows: 60px 2fr 80px 1fr;
            grid-template-columns: 1fr 1fr 80px;
            z-index: 1;
        }

        #storeMenu, #investmentMenu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 500;
            display: none;
            overflow-y: auto;
            padding: 20px;
        }

        .menu-header {
            color: #f39c12;
            font-size: 24px;
            text-align: center;
            margin-bottom: 30px;
        }

        .menu-section {
            background: rgba(52, 73, 94, 0.8);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #34495e;
        }

        .section-title {
            color: #3498db;
            font-size: 18px;
            margin-bottom: 15px;
            border-bottom: 1px solid #34495e;
            padding-bottom: 5px;
        }

        .store-item, .investment-item {
            background: rgba(44, 62, 80, 0.9);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #7f8c8d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-info h4 {
            color: #ecf0f1;
            margin-bottom: 5px;
        }

        .item-info p {
            color: #bdc3c7;
            font-size: 12px;
        }

        .item-price {
            color: #f39c12;
            font-weight: bold;
            margin-right: 10px;
        }

        .buy-btn, .sell-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
        }

        .sell-btn {
            background: #e74c3c;
        }

        .buy-btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }

        .menu-nav {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 600;
        }

        .nav-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
        }

        .nav-btn:hover {
            background: #2980b9;
        }

        #topBar {
            grid-area: topbar;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            padding: 8px;
            border-bottom: 2px solid #34495e;
        }

        .stat-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .stat-title {
            font-size: 12px;
            color: #bdc3c7;
            margin-bottom: 2px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: bold;
        }

        #booksValue { color: #3498db; }
        #yearValue { color: #f39c12; }
        #cashValue { color: #2ecc71; }
        #portfolioValue { color: #9b59b6; }

        #gameArea {
            grid-area: game;
            position: relative;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            overflow: hidden;
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
            touch-action: none;
            cursor: crosshair;
        }

        #powerUps {
            grid-area: powerups;
            background: rgba(0, 0, 0, 0.8);
            border-left: 2px solid #34495e;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 5px;
        }

        .powerup-slot {
            width: 50px;
            height: 50px;
            background: rgba(52, 73, 94, 0.5);
            border: 2px solid #7f8c8d;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .powerup-slot:hover {
            border-color: #f39c12;
            background: rgba(243, 156, 18, 0.2);
        }

        .powerup-icon {
            font-size: 20px;
            line-height: 1;
        }

        .powerup-count {
            font-size: 10px;
            color: white;
            background: rgba(243, 156, 18, 0.9);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: -2px;
            right: -2px;
            font-weight: bold;
        }

        #nextBubbles {
            grid-area: next;
            background: rgba(0, 0, 0, 0.8);
            border-top: 2px solid #34495e;
            display: flex;
            align-items: center;
            padding: 10px;
        }

        .next-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .cannon-display {
            width: 60px;
            height: 40px;
            background: #34495e;
            border: 2px solid #fff;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .cannon-sugar-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(0deg, #e74c3c, #f39c12);
            transition: height 0.3s ease;
            height: 100%;
        }

        .next-bubbles-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .next-bubble {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            font-weight: bold;
        }

        .next-label {
            color: #bdc3c7;
            font-size: 12px;
            margin-right: 10px;
        }

        .bubbles-remaining {
            color: #f39c12;
            font-size: 14px;
            font-weight: bold;
            margin-left: auto;
            margin-right: 20px;
        }

        #quotes {
            grid-area: quotes;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(44, 62, 80, 0.8));
            border-top: 3px solid #f39c12;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 15px;
            overflow: hidden;
            position: relative;
        }

        #quotes::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" x="10" font-size="60" opacity="0.1" fill="%23f39c12">"</text><text y="50" x="80" font-size="60" opacity="0.1" fill="%23f39c12">"</text></svg>');
            background-size: 200px 100px;
            background-repeat: no-repeat;
            background-position: 10px center, calc(100% - 10px) center;
            pointer-events: none;
        }

        #quoteText {
            color: #ecf0f1;
            font-size: 14px;
            text-align: center;
            font-style: italic;
            line-height: 1.4;
            max-width: 90%;
            animation: fadeIn 0.5s ease-in;
            z-index: 1;
            margin-bottom: 8px;
        }

        #quoteAuthor {
            color: #f39c12;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            z-index: 1;
        }

        .quote-category {
            position: absolute;
            top: 8px;
            right: 15px;
            background: rgba(243, 156, 18, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            z-index: 1;
        }

        .portfolio-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 5px;
            background: rgba(44, 62, 80, 0.7);
            border-radius: 5px;
        }

        .portfolio-info {
            flex: 1;
        }

        .portfolio-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .share-input {
            width: 60px;
            padding: 5px;
            border: 1px solid #7f8c8d;
            border-radius: 3px;
            background: #2c3e50;
            color: white;
            text-align: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 600px) {
            #gameContainer {
                grid-template-columns: 1fr 1fr 60px;
                grid-template-rows: 50px 2fr 70px 1fr;
            }
            
            .stat-title { font-size: 10px; }
            .stat-value { font-size: 14px; }
            .powerup-slot { width: 40px; height: 40px; }
            .powerup-icon { font-size: 16px; }
            .powerup-count { font-size: 8px; width: 12px; height: 12px; }
            #quoteText { font-size: 12px; }
            #quoteAuthor { font-size: 10px; }
        }


    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="topBar">
            <div class="stat-section">
                <div class="stat-title">BOOKS</div>
                <div class="stat-value" id="booksValue">üìö 5</div>
            </div>
            <div class="stat-section">
                <div class="stat-title">YEAR</div>
                <div class="stat-value" id="yearValue">1955</div>
            </div>
            <div class="stat-section">
                <div class="stat-title">$CASH</div>
                <div class="stat-value" id="cashValue">$0</div>
            </div>
            <div class="stat-section">
                <div class="stat-title">PORTFOLIO</div>
                <div class="stat-value" id="portfolioValue">$0</div>
            </div>
        </div>

        <div id="gameArea">
            <canvas id="gameCanvas"></canvas>
        </div>

        <div id="powerUps">
            <div class="powerup-slot" id="lollapalooza">
                <div class="powerup-icon">üí•</div>
                <div class="powerup-count">0</div>
            </div>
            <div class="powerup-slot" id="grahamNets">
                <div class="powerup-icon">üï∏Ô∏è</div>
                <div class="powerup-count">0</div>
            </div>
            <div class="powerup-slot" id="coke">
                <div class="powerup-icon">ü•§</div>
                <div class="powerup-count">0</div>
            </div>
        </div>

        <div id="nextBubbles">
            <div class="next-section">
                <div class="cannon-display">
                    <div class="cannon-sugar-fill" id="cannonSugarFill"></div>
                </div>
                <div class="next-label">Sugar:</div>
                <div class="next-bubbles-container" id="nextBubblesContainer">
                    <div class="next-bubble" style="background: #e74c3c;">1</div>
                    <div class="next-bubble" style="background: #3498db;">2</div>
                    <div class="next-bubble" style="background: #2ecc71;">3</div>
                </div>
            </div>
            <div class="bubbles-remaining">
                Shots: <span id="bubblesRemaining">10</span>
            </div>
        </div>

        <div id="quotes">
            <div class="quote-category" id="quoteCategory">WISDOM</div>
            <div id="quoteText">
                Welcome to 1955! Start building your capital for the journey ahead.
            </div>
            <div id="quoteAuthor">- Warren Buffett</div>
        </div>
    </div>

    <div id="storeMenu">
        <h2 class="menu-header">Buffett's Store - Year <span id="storeYear">1955</span></h2>
        
        <div class="menu-section">
            <h3 class="section-title">üí• Power-ups</h3>
            <div id="powerupsSection"></div>
        </div>

        <div class="menu-section">
            <h3 class="section-title">üìö Books</h3>
            <div id="booksSection"></div>
        </div>

        <div class="menu-section">
            <h3 class="section-title">üè¢ Business Acquisitions</h3>
            <div id="acquisitionsSection"></div>
        </div>

        <div class="menu-nav">
            <button class="nav-btn" id="storeToInvestments">Investments</button>
        </div>
    </div>

    <div id="investmentMenu">
        <h2 class="menu-header">Investment Board - Year <span id="investmentYear">1955</span></h2>
        
        <div class="menu-section">
            <h3 class="section-title">üìà Stocks</h3>
            <div id="stocksSection"></div>
        </div>

        <div class="menu-section">
            <h3 class="section-title">üè¢ Owned Subsidiaries</h3>
            <div id="subsidiariesSection"></div>
        </div>

        <div class="menu-nav">
            <button class="nav-btn" id="investmentToNext">1956</button>
        </div>
    </div>

    <script>
        // Historical stock data
        const stockData = {
            'KO': {
                name: 'Coca-Cola',
                startYear: 1963,
                prices: {
                    1963: 0.06, 1964: 0.08, 1965: 0.09, 1966: 0.10, 1967: 0.14, 1968: 0.16, 1969: 0.18, 1970: 0.19,
                    1971: 0.27, 1972: 0.34, 1973: 0.29, 1974: 0.13, 1975: 0.20, 1976: 0.20, 1977: 0.19, 1978: 0.24,
                    1979: 0.20, 1980: 0.20, 1981: 0.23, 1982: 0.36, 1983: 0.40, 1984: 0.48, 1985: 0.68, 1986: 0.94,
                    1987: 0.98, 1988: 1.18, 1989: 2.08, 1990: 2.56, 1991: 4.49, 1992: 4.74, 1993: 5.14, 1994: 6.03,
                    1995: 8.82, 1996: 12.64, 1997: 16.16, 1998: 16.37, 1999: 14.38, 2000: 15.24, 2001: 11.97, 2002: 11.31,
                    2003: 13.36, 2004: 11.21, 2005: 11.13, 2006: 13.70, 2007: 17.88, 2008: 13.57, 2009: 17.68, 2010: 21.04,
                    2011: 23.03, 2012: 24.54, 2013: 28.77, 2014: 30.28, 2015: 31.84, 2016: 31.72, 2017: 36.29, 2018: 38.74,
                    2019: 46.72, 2020: 47.88, 2021: 53.32, 2022: 58.98, 2023: 56.36, 2024: 61.37, 2025: 68.84
                }
            },
            'DIS': {
                name: 'Disney',
                startYear: 1963,
                prices: {
                    1963: 0.07, 1964: 0.08, 1965: 0.10, 1966: 0.13, 1967: 0.19, 1968: 0.29, 1969: 0.45, 1970: 0.48,
                    1971: 0.93, 1972: 1.60, 1973: 0.64, 1974: 0.29, 1975: 0.67, 1976: 0.64, 1977: 0.54, 1978: 0.54,
                    1979: 0.61, 1980: 0.69, 1981: 0.71, 1982: 0.87, 1983: 0.74, 1984: 0.86, 1985: 1.64, 1986: 2.53,
                    1987: 3.49, 1988: 3.90, 1989: 6.67, 1990: 6.08, 1991: 6.90, 1992: 10.42, 1993: 10.39, 1994: 11.29,
                    1995: 14.57, 1996: 17.35, 1997: 24.79, 1998: 22.68, 1999: 22.36, 2000: 22.27, 2001: 16.11, 2002: 12.84,
                    2003: 18.55, 2004: 22.30, 2005: 19.43, 2006: 28.03, 2007: 27.05, 2008: 19.30, 2009: 27.75, 2010: 32.63,
                    2011: 33.17, 2012: 44.71, 2013: 69.45, 2014: 86.72, 2015: 97.93, 2016: 98.59, 2017: 103.28, 2018: 107.00,
                    2019: 142.87, 2020: 178.97, 2021: 153.00, 2022: 85.82, 2023: 89.48, 2024: 111.35, 2025: 92.49
                }
            },
            'AAPL': {
                name: 'Apple',
                startYear: 1981,
                prices: {
                    1981: 0.08, 1982: 0.10, 1983: 0.08, 1984: 0.10, 1985: 0.08, 1986: 0.14, 1987: 0.29, 1988: 0.28,
                    1989: 0.25, 1990: 0.31, 1991: 0.40, 1992: 0.43, 1993: 0.21, 1994: 0.29, 1995: 0.24, 1996: 0.16,
                    1997: 0.10, 1998: 0.31, 1999: 0.77, 2000: 0.22, 2001: 0.33, 2002: 0.22, 2003: 0.32, 2004: 0.97,
                    2005: 2.16, 2006: 2.55, 2007: 5.96, 2008: 2.57, 2009: 6.34, 2010: 9.71, 2011: 12.19, 2012: 16.16,
                    2013: 17.46, 2014: 24.55, 2015: 23.81, 2016: 26.79, 2017: 39.77, 2018: 37.62, 2019: 71.09, 2020: 129.61,
                    2021: 174.52, 2022: 128.44, 2023: 191.38, 2024: 250.15, 2025: 202.52
                }
            },
            'BRK.A': {
                name: 'Berkshire Hathaway',
                startYear: 1981,
                prices: {
                    1981: 560, 1982: 775, 1983: 1310, 1984: 1275, 1985: 2470, 1986: 2820, 1987: 2950, 1988: 4700,
                    1989: 8675, 1990: 6675, 1991: 9050, 1992: 11750, 1993: 16325, 1994: 20400, 1995: 32100, 1996: 34100,
                    1997: 46000, 1998: 70000, 1999: 56100, 2000: 71000, 2001: 75600, 2002: 72750, 2003: 84250, 2004: 87900,
                    2005: 88620, 2006: 109990, 2007: 141600, 2008: 96600, 2009: 99200, 2010: 120450, 2011: 114755, 2012: 134060,
                    2013: 177900, 2014: 226000, 2015: 197800, 2016: 244121, 2017: 297600, 2018: 306000, 2019: 339590, 2020: 347815,
                    2021: 450662, 2022: 468711, 2023: 542625, 2024: 680920, 2025: 795000
                }
            },
            'BAC': {
                name: 'Bank of America',
                startYear: 1985,
                prices: {
                    1985: 1.86, 1986: 1.82, 1987: 1.52, 1988: 2.50, 1989: 4.35, 1990: 2.25, 1991: 4.15, 1992: 5.43,
                    1993: 5.35, 1994: 5.12, 1995: 8.17, 1996: 11.81, 1997: 15.03, 1998: 15.22, 1999: 13.09, 2000: 12.50,
                    2001: 17.84, 2002: 20.43, 2003: 24.55, 2004: 29.84, 2005: 30.55, 2006: 36.88, 2007: 29.93, 2008: 11.05,
                    2009: 11.87, 2010: 10.55, 2011: 4.42, 2012: 9.27, 2013: 12.47, 2014: 14.43, 2015: 13.74, 2016: 18.33,
                    2017: 24.87, 2018: 21.14, 2019: 30.91, 2020: 27.31, 2021: 40.86, 2022: 31.13, 2023: 32.63, 2024: 43.67,
                    2025: 43.20
                }
            }
        };

        const subsidiaries = {
            "See's Candies": {
                price: 2500,
                yearlyIncome: 150,
                gameplayPerk: "Sugar depletes 25% slower",
                perkDescription: "Quality candy extends energy",
                unlocks: ["GEICO"],
                availableFrom: 1972,
                bookRequirement: "Poor Charlie's Almanack"
            },
            "GEICO": {
                price: 8000,
                yearlyIncome: 400,
                gameplayPerk: "+2 starting bubbles per level",
                perkDescription: "Insurance provides backup shots",
                unlocks: ["Dairy Queen"],
                availableFrom: 1976,
                requires: ["See's Candies"]
            },
            "Dairy Queen": {
                price: 15000,
                yearlyIncome: 600,
                gameplayPerk: "+20% trajectory line length",
                perkDescription: "Smooth operations improve aiming precision",
                unlocks: ["Nebraska Furniture Mart"],
                availableFrom: 1998,
                requires: ["GEICO"]
            },
            "Nebraska Furniture Mart": {
                price: 25000,
                yearlyIncome: 800,
                gameplayPerk: "Remove yellow bubbles permanently from game",
                perkDescription: "Furniture efficiency eliminates one color complexity",
                unlocks: ["Fruit of the Loom"],
                availableFrom: 1983,
                requires: ["Dairy Queen"]
            },
            "Fruit of the Loom": {
                price: 40000,
                yearlyIncome: 1000,
                gameplayPerk: "Bubble scroll speed reduced by 15%",
                perkDescription: "Textile quality slows the rush of time",
                unlocks: ["Gillette"],
                availableFrom: 2002,
                requires: ["Nebraska Furniture Mart"]
            },
            "Gillette": {
                price: 65000,
                yearlyIncome: 1500,
                gameplayPerk: "Start each level with 1 Graham Net powerup",
                perkDescription: "Precision engineering provides strategic tools",
                unlocks: ["Duracell"],
                availableFrom: 2005,
                requires: ["Fruit of the Loom"]
            },
            "Duracell": {
                price: 90000,
                yearlyIncome: 2000,
                gameplayPerk: "Start each level with 1 Lollapalooza powerup",
                perkDescription: "Long-lasting power energizes explosive potential",
                unlocks: ["BNSF Railway"],
                availableFrom: 2014,
                requires: ["Gillette"]
            },
            "BNSF Railway": {
                price: 150000,
                yearlyIncome: 3500,
                gameplayPerk: "+3 starting bubbles AND remove orange bubbles permanently",
                perkDescription: "Transportation empire delivers maximum efficiency",
                availableFrom: 2009,
                requires: ["Duracell"],
                finalSubsidiary: true
            }
        };

        const books = {
            "The Intelligent Investor": {
                price: 50,
                bookValue: 50,
                unlocks: "Graham's Nets powerup"
            },
            "Common Stocks and Uncommon Profits": {
                price: 75,
                bookValue: 75,
                unlocks: "Better bubble distribution"
            },
            "Poor Charlie's Almanack": {
                price: 100,
                bookValue: 100,
                unlocks: "See's Candies acquisition"
            },
            "The Little Book of Common Sense Investing": {
                price: 40,
                bookValue: 40,
                unlocks: "Portfolio analysis"
            },
            "Essays of Warren Buffett": {
                price: 100,
                bookValue: 100,
                unlocks: "Advanced investing wisdom"
            }
        };

        const powerups = {
            "Coke": {
                effect: "Restore 20% sugar (consumable)",
                basePrice: 50,
                priceMultiplier: 1.2,
                maxPurchases: 99
            },
            "Munger's Lollapaloozas": {
                type: "explosive",
                effect: "Destroys 3x3 area",
                price: 200,
                requires: "The Intelligent Investor"
            },
            "Graham's Nets": {
                type: "converter",
                effect: "Turns hit bubbles grey for chain pops",
                price: 300,
                requires: "The Intelligent Investor"
            }
        };

        const permanentUpgrades = {
            "Partner with Charlie": {
                effect: "+1 starting bubble",
                price: 500,
                maxLevel: 1
            },
            "Ditch the Cigar Butts": {
                effect: "Better bubble colors distribution", 
                price: 1000,
                requires: "Poor Charlie's Almanack"
            },
            "Remove Investment Bankers": {
                effect: "+5 explosive bubbles per level",
                price: 2000
            },
            "Ted and Todd Recruited": {
                effect: "+1 starting bubble",
                price: 5000
            }
        };

        // Historical market conditions data
        const marketHistory = {
            1955: 'bull', 1956: 'bull', 1957: 'bear', 1958: 'bull', 1959: 'bull', 1960: 'bull',
            1961: 'bull', 1962: 'bear', 1963: 'bull', 1964: 'bull', 1965: 'bull', 1966: 'bear',
            1967: 'bull', 1968: 'bull', 1969: 'bear', 1970: 'bear', 1971: 'bull', 1972: 'bull',
            1973: 'bear', 1974: 'bear', 1975: 'bull', 1976: 'bull', 1977: 'bear', 1978: 'bear',
            1979: 'bear', 1980: 'bull', 1981: 'bear', 1982: 'bull', 1983: 'bull', 1984: 'bull',
            1985: 'bull', 1986: 'bull', 1987: 'bear', 1988: 'bull', 1989: 'bull', 1990: 'bear',
            1991: 'bull', 1992: 'bull', 1993: 'bull', 1994: 'bear', 1995: 'bull', 1996: 'bull',
            1997: 'bull', 1998: 'bull', 1999: 'bull', 2000: 'bear', 2001: 'bear', 2002: 'bear',
            2003: 'bull', 2004: 'bull', 2005: 'bull', 2006: 'bull', 2007: 'bull', 2008: 'bear',
            2009: 'bull', 2010: 'bull', 2011: 'bear', 2012: 'bull', 2013: 'bull', 2014: 'bull',
            2015: 'bear', 2016: 'bull', 2017: 'bull', 2018: 'bear', 2019: 'bull', 2020: 'bear',
            2021: 'bull', 2022: 'bear', 2023: 'bull', 2024: 'bull', 2025: 'bull'
        };

        class BubbleGame {
            constructor() {
                console.log('Game starting...');
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                
                this.setupCanvas();
                this.initGameState();
                this.setupEventListeners();
                this.initMrMarket();
                
                this.lastTime = 0;
                this.gameLoop();
            }
            
            setupCanvas() {
                const gameArea = document.getElementById('gameArea');
                this.canvas.width = gameArea.clientWidth || 800;
                this.canvas.height = gameArea.clientHeight || 600;
                
                window.addEventListener('resize', () => {
                    const gameArea = document.getElementById('gameArea');
                    this.canvas.width = gameArea.clientWidth || 800;
                    this.canvas.height = gameArea.clientHeight || 600;
                    this.cannon.x = this.canvas.width / 2;
                    this.cannon.y = this.canvas.height - 30;
                });
            }
            
            initGameState() {
                this.year = 1955;
                this.books = 5;
                this.sugar = 60;
                this.maxSugar = 60;
                this.cash = 0;
                this.bubblesRemaining = 10;
                this.gameRunning = true;
                
                this.bubbles = [];
                this.activeBubble = null;
                this.nextBubbles = [];
                this.collectibles = [];
                
                this.portfolio = {};
                this.ownedSubsidiaries = [];
                this.ownedBooks = [];
                this.purchasedUpgrades = [];
                
                this.bubbleRadius = Math.max(12, Math.min(18, this.canvas.width / 25));
                this.scrollSpeed = 30;
                
                // Mr Market system
                this.mrMarket = {
                    x: this.canvas.width - 80,
                    y: this.canvas.height / 2,
                    width: 60,
                    height: 100,
                    shootTimer: 0,
                    shootInterval: 1.2,
                    isLoaded: false
                };
                
                this.marketCondition = marketHistory[this.year] || 'bull';
                this.columnSpacing = this.bubbleRadius * 2;
                this.nextColumnX = this.canvas.width;
                
                this.cannon = {
                    x: this.canvas.width / 2,
                    y: this.canvas.height - 30,
                    angle: -Math.PI / 2,
                    power: 300
                };
                
                this.colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6'];
                
                this.isAiming = false;
                this.trajectory = [];
                
                this.powerups = {
                    lollapalooza: 0,
                    grahamNets: 0,
                    coke: 0
                };
                
                this.specialAmmo = [];
                this.currentBubbleType = 'normal';
                
                for (let i = 0; i < 3; i++) {
                    this.nextBubbles.push(Math.floor(Math.random() * 3));
                }
                
                this.updateUI();
                this.showQuote('Welcome to 1955! Start building your capital for the journey ahead.', 'Warren Buffett', 'WISDOM');
            }
            
            setupEventListeners() {
                this.canvas.addEventListener('contextmenu', e => e.preventDefault());
                
                this.canvas.addEventListener('mousedown', (e) => this.startAiming(e));
                this.canvas.addEventListener('mousemove', (e) => this.updateAiming(e));
                this.canvas.addEventListener('mouseup', (e) => this.fire(e));
                
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.startAiming(e.touches[0]);
                });
                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    this.updateAiming(e.touches[0]);
                });
                this.canvas.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.fire(e);
                });

                document.getElementById('lollapalooza').addEventListener('click', () => {
                    if (this.powerups.lollapalooza > 0) {
                        this.powerups.lollapalooza--;
                        this.currentBubbleType = 'explosive';
                        this.showQuote('Lollapalooza loaded! Current shot will explode!', 'Charlie Munger', 'POWERUP');
                        this.updatePowerupCounts();
                    }
                });
                
                document.getElementById('grahamNets').addEventListener('click', () => {
                    if (this.powerups.grahamNets > 0) {
                        this.powerups.grahamNets--;
                        this.currentBubbleType = 'converter';
                        this.showQuote('Graham Nets loaded! Current shot creates chain reactions!', 'Benjamin Graham', 'POWERUP');
                        this.updatePowerupCounts();
                    }
                });
                
                document.getElementById('coke').addEventListener('click', () => {
                    if (this.powerups.coke > 0) {
                        this.powerups.coke--;
                        this.sugar = Math.min(this.maxSugar, this.sugar + 20);
                        this.showQuote('Refreshing Coke! Sugar restored!', 'Warren Buffett', 'POWERUP');
                        this.updatePowerupCounts();
                    }
                });

                document.getElementById('storeToInvestments').addEventListener('click', () => {
                    this.showInvestmentMenu();
                });

                document.getElementById('investmentToNext').addEventListener('click', () => {
                    this.nextYear();
                });
            }

            updatePowerupCounts() {
                document.querySelector('#lollapalooza .powerup-count').textContent = this.powerups.lollapalooza;
                document.querySelector('#grahamNets .powerup-count').textContent = this.powerups.grahamNets;
                document.querySelector('#coke .powerup-count').textContent = this.powerups.coke;
            }
            
            getPointerPos(e) {
                const rect = this.canvas.getBoundingClientRect();
                return {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            }
            
            startAiming(e) {
                if (!this.gameRunning || this.activeBubble) return;
                
                this.isAiming = true;
                this.updateAiming(e);
            }
            
            updateAiming(e) {
                if (!this.isAiming) return;
                
                const pos = this.getPointerPos(e);
                const dx = pos.x - this.cannon.x;
                const dy = pos.y - this.cannon.y;
                
                let angle = Math.atan2(dy, dx);
                
                const maxAngle = Math.PI * 0.1;
                const minAngle = -Math.PI + maxAngle;
                angle = Math.max(minAngle, Math.min(maxAngle, angle));
                
                this.cannon.angle = angle;
                this.calculateTrajectory();
            }
            
            fire(e) {
                if (!this.isAiming || this.activeBubble || this.bubblesRemaining <= 0) return;
                
                this.isAiming = false;
                this.trajectory = [];
                
                this.activeBubble = {
                    x: this.cannon.x,
                    y: this.cannon.y,
                    vx: Math.cos(this.cannon.angle) * this.cannon.power,
                    vy: Math.sin(this.cannon.angle) * this.cannon.power,
                    color: this.nextBubbles.shift(),
                    radius: this.bubbleRadius,
                    type: this.currentBubbleType
                };
                
                this.nextBubbles.push(Math.floor(Math.random() * 3));
                this.bubblesRemaining--;
                this.currentBubbleType = 'normal';
                
                this.updateUI();
            }
            
            calculateTrajectory() {
                this.trajectory = [];
                if (!this.isAiming) return;
                
                let x = this.cannon.x;
                let y = this.cannon.y;
                let vx = Math.cos(this.cannon.angle) * this.cannon.power / 60;
                let vy = Math.sin(this.cannon.angle) * this.cannon.power / 60;
                
                for (let i = 0; i < 30; i++) {
                    x += vx;
                    y += vy;
                    
                    if (x <= this.bubbleRadius || x >= this.canvas.width - this.bubbleRadius) {
                        vx = -vx;
                        x = Math.max(this.bubbleRadius, Math.min(this.canvas.width - this.bubbleRadius, x));
                    }
                    
                    this.trajectory.push({ x, y });
                    
                    if (y <= 0) break;
                }
            }
            
            initMrMarket() {
                // Wait for canvas to be ready, then initialize Mr Market
                setTimeout(() => {
                    this.mrMarket.isLoaded = true;
                    console.log('Mr Market loaded and ready to shoot bubbles');
                    this.showQuote(`${this.year} Market Condition: ${this.marketCondition.toUpperCase()} MARKET`, 'Mr Market', 'BUSINESS');
                }, 100);
            }
            
            shootColumnFromMrMarket() {
                if (!this.mrMarket.isLoaded) return;
                
                const bubblesInColumn = this.marketCondition === 'bull' ? 
                    Math.floor(Math.random() * 4) + 5 : // 5-8 bubbles
                    Math.floor(Math.random() * 3) + 2;  // 2-4 bubbles
                
                const startY = (this.canvas.height - (bubblesInColumn * this.bubbleRadius * 1.5)) / 2;
                
                for (let i = 0; i < bubblesInColumn; i++) {
                    const x = this.nextColumnX + (i % 2 ? this.bubbleRadius : 0); // Hexagonal offset
                    const y = startY + (i * this.bubbleRadius * 1.5);
                    
                    this.bubbles.push({
                        x: x,
                        y: y,
                        color: Math.floor(Math.random() * 3),
                        radius: this.bubbleRadius,
                        gridX: Math.floor(this.nextColumnX / this.columnSpacing),
                        gridY: i,
                        isGold: false
                    });
                }
                
                this.nextColumnX += this.columnSpacing;
                this.checkForGoldClusters();
            }
            
            checkForGoldClusters() {
                // Find clusters of 8+ connected bubbles and turn them gold
                const visited = new Set();
                
                for (let bubble of this.bubbles) {
                    const key = `${bubble.x},${bubble.y}`;
                    if (visited.has(key) || bubble.isGold) continue;
                    
                    const cluster = this.findCluster(bubble, visited);
                    if (cluster.length >= 8) {
                        cluster.forEach(b => {
                            b.isGold = true;
                        });
                    }
                }
            }
            
            findCluster(startBubble, visited) {
                const cluster = [];
                const stack = [startBubble];
                const clusterVisited = new Set();
                
                while (stack.length > 0) {
                    const bubble = stack.pop();
                    const key = `${bubble.x},${bubble.y}`;
                    
                    if (clusterVisited.has(key)) continue;
                    clusterVisited.add(key);
                    visited.add(key);
                    
                    if (bubble.color === startBubble.color) {
                        cluster.push(bubble);
                        
                        // Find neighbors with same color
                        const neighbors = this.bubbles.filter(b => {
                            if (b === bubble) return false;
                            const dist = Math.sqrt(
                                Math.pow(b.x - bubble.x, 2) + 
                                Math.pow(b.y - bubble.y, 2)
                            );
                            return dist < this.bubbleRadius * 2.2 && b.color === startBubble.color;
                        });
                        
                        for (let neighbor of neighbors) {
                            const neighborKey = `${neighbor.x},${neighbor.y}`;
                            if (!clusterVisited.has(neighborKey)) {
                                stack.push(neighbor);
                            }
                        }
                    }
                }
                
                return cluster;
            }
            
            update(deltaTime) {
                if (!this.gameRunning) return;
                
                this.sugar -= deltaTime;
                if (this.sugar <= 0) {
                    this.endLevel();
                    return;
                }
                
                // Scroll existing bubbles left
                this.bubbles.forEach(bubble => {
                    bubble.x -= this.scrollSpeed * deltaTime;
                });
                
                // Remove bubbles that have scrolled off screen
                this.bubbles = this.bubbles.filter(bubble => bubble.x > -this.bubbleRadius);
                
                // Mr Market shoots new columns
                this.mrMarket.shootTimer += deltaTime;
                if (this.mrMarket.shootTimer >= this.mrMarket.shootInterval) {
                    this.shootColumnFromMrMarket();
                    this.mrMarket.shootTimer = 0;
                }
                
                if (this.activeBubble) {
                    this.activeBubble.x += this.activeBubble.vx * deltaTime;
                    this.activeBubble.y += this.activeBubble.vy * deltaTime;
                    
                    if (this.activeBubble.x <= this.bubbleRadius || 
                        this.activeBubble.x >= this.canvas.width - this.bubbleRadius) {
                        this.activeBubble.vx = -this.activeBubble.vx;
                        this.activeBubble.x = Math.max(this.bubbleRadius, 
                            Math.min(this.canvas.width - this.bubbleRadius, this.activeBubble.x));
                    }
                    
                    this.checkCollisions();
                    
                    if (this.activeBubble && this.activeBubble.y <= -this.bubbleRadius) {
                        this.activeBubble = null;
                    }
                }
                
                this.collectibles.forEach(collectible => {
                    collectible.y += 100 * deltaTime;
                    
                    const dist = Math.sqrt(
                        Math.pow(collectible.x - this.cannon.x, 2) + 
                        Math.pow(collectible.y - this.cannon.y, 2)
                    );
                    
                    if (dist < 30) {
                        this.collectItem(collectible);
                        collectible.collected = true;
                    }
                });
                
                this.collectibles = this.collectibles.filter(c => !c.collected && c.y < this.canvas.height);
                
                if ((this.bubbles.length === 0 || this.bubblesRemaining <= 0) && !this.activeBubble && this.collectibles.length === 0) {
                    this.endLevel();
                }
                
                this.updateUI();
            }
            
            checkCollisions() {
                if (!this.activeBubble) return;
                
                for (let bubble of this.bubbles) {
                    const dist = Math.sqrt(
                        Math.pow(this.activeBubble.x - bubble.x, 2) + 
                        Math.pow(this.activeBubble.y - bubble.y, 2)
                    );
                    
                    if (dist < this.bubbleRadius * 1.8) {
                        this.attachBubble(bubble);
                        return;
                    }
                }
            }
            
            attachBubble(nearBubble) {
                // Check if hitting a gold cluster
                if (nearBubble.isGold) {
                    this.destroyGoldCluster(nearBubble);
                    this.activeBubble = null;
                    return;
                }
                
                const newBubble = {
                    x: this.activeBubble.x,
                    y: this.activeBubble.y,
                    color: this.activeBubble.color,
                    radius: this.bubbleRadius,
                    gridX: nearBubble.gridX,
                    gridY: nearBubble.gridY,
                    isGold: false
                };
                
                if (this.activeBubble.type === 'explosive') {
                    this.explodeBubbles(newBubble.x, newBubble.y);
                    this.activeBubble = null;
                    return;
                } else if (this.activeBubble.type === 'converter') {
                    this.convertBubblesToGrey(newBubble.x, newBubble.y);
                }
                
                this.bubbles.push(newBubble);
                this.activeBubble = null;
                
                // Check for color matches
                const matches = this.findMatches(newBubble);
                if (matches.length >= 3) {
                    this.popBubbles(matches);
                }
                
                // Check for new gold clusters after adding bubble
                this.checkForGoldClusters();
            }
            
            destroyGoldCluster(goldBubble) {
                // Find all connected gold bubbles in the cluster
                const goldCluster = [];
                const visited = new Set();
                const stack = [goldBubble];
                
                while (stack.length > 0) {
                    const bubble = stack.pop();
                    const key = `${bubble.x},${bubble.y}`;
                    
                    if (visited.has(key)) continue;
                    visited.add(key);
                    
                    if (bubble.isGold) {
                        goldCluster.push(bubble);
                        
                        // Find neighboring gold bubbles
                        const neighbors = this.bubbles.filter(b => {
                            if (b === bubble) return false;
                            const dist = Math.sqrt(
                                Math.pow(b.x - bubble.x, 2) + 
                                Math.pow(b.y - bubble.y, 2)
                            );
                            return dist < this.bubbleRadius * 2.2 && b.isGold;
                        });
                        
                        for (let neighbor of neighbors) {
                            const neighborKey = `${neighbor.x},${neighbor.y}`;
                            if (!visited.has(neighborKey)) {
                                stack.push(neighbor);
                            }
                        }
                    }
                }
                
                // Remove all bubbles in the gold cluster
                for (let bubble of goldCluster) {
                    const index = this.bubbles.indexOf(bubble);
                    if (index !== -1) {
                        this.bubbles.splice(index, 1);
                        
                        // Extra collectibles for gold clusters
                        if (Math.random() < 0.8) {
                            this.collectibles.push({
                                x: bubble.x,
                                y: bubble.y,
                                type: Math.random() < 0.3 ? 'book' : 'cash',
                                collected: false
                            });
                        }
                    }
                }
                
                if (goldCluster.length > 0) {
                    this.cash += goldCluster.length * 1000; // Premium reward for gold clusters
                    this.showQuote(`GOLD CLUSTER DESTROYED! ${goldCluster.length} bubbles worth ${(goldCluster.length * 1000).toLocaleString()}!`, 'Mr Market', 'BUSINESS');
                }
            }
            
            explodeBubbles(centerX, centerY) {
                const radius = 60;
                const bubblesInRange = [];
                
                for (let bubble of this.bubbles) {
                    const dist = Math.sqrt(
                        Math.pow(bubble.x - centerX, 2) + 
                        Math.pow(bubble.y - centerY, 2)
                    );
                    
                    if (dist <= radius) {
                        bubblesInRange.push(bubble);
                    }
                }
                
                for (let bubble of bubblesInRange) {
                    const index = this.bubbles.indexOf(bubble);
                    if (index !== -1) {
                        this.bubbles.splice(index, 1);
                        
                        if (Math.random() < 0.6) {
                            this.collectibles.push({
                                x: bubble.x,
                                y: bubble.y,
                                type: Math.random() < 0.5 ? 'cash' : 'sweet',
                                collected: false
                            });
                        }
                    }
                }
                
                if (bubblesInRange.length > 0) {
                    this.cash += bubblesInRange.length * 150;
                    this.showQuote('LOLLAPALOOZA EXPLOSION! ' + bubblesInRange.length + ' bubbles destroyed!', 'Charlie Munger', 'POWERUP');
                }
            }
            
            convertBubblesToGrey(centerX, centerY) {
                const radius = 80;
                const bubblesInRange = [];
                
                for (let bubble of this.bubbles) {
                    const dist = Math.sqrt(
                        Math.pow(bubble.x - centerX, 2) + 
                        Math.pow(bubble.y - centerY, 2)
                    );
                    
                    if (dist <= radius) {
                        bubble.isGrey = true;
                        bubblesInRange.push(bubble);
                    }
                }
                
                if (bubblesInRange.length > 0) {
                    this.showQuote('GRAHAM NETS! ' + bubblesInRange.length + ' bubbles converted for chain reactions!', 'Benjamin Graham', 'POWERUP');
                }
            }
            
            findMatches(startBubble) {
                const visited = new Set();
                const matches = [];
                const stack = [startBubble];
                
                while (stack.length > 0) {
                    const bubble = stack.pop();
                    const key = bubble.x + ',' + bubble.y;
                    
                    if (visited.has(key)) continue;
                    visited.add(key);
                    
                    if (bubble.isGrey || startBubble.isGrey || bubble.color === startBubble.color) {
                        matches.push(bubble);
                        
                        const neighbors = this.bubbles.filter(b => {
                            if (b === bubble) return false;
                            const dist = Math.sqrt(
                                Math.pow(b.x - bubble.x, 2) + 
                                Math.pow(b.y - bubble.y, 2)
                            );
                            return dist < this.bubbleRadius * 2.2;
                        });
                        
                        for (let neighbor of neighbors) {
                            const neighborKey = neighbor.x + ',' + neighbor.y;
                            if (!visited.has(neighborKey)) {
                                if (bubble.isGrey || neighbor.isGrey || neighbor.color === startBubble.color) {
                                    stack.push(neighbor);
                                }
                            }
                        }
                    }
                }
                
                return matches;
            }
            
            popBubbles(matches) {
                for (let bubble of matches) {
                    const index = this.bubbles.indexOf(bubble);
                    if (index !== -1) {
                        this.bubbles.splice(index, 1);
                        
                        const rand = Math.random();
                        if (rand < 0.05) {
                            this.collectibles.push({
                                x: bubble.x,
                                y: bubble.y,
                                type: 'book',
                                collected: false
                            });
                        } else if (rand < 0.35) {
                            this.collectibles.push({
                                x: bubble.x,
                                y: bubble.y,
                                type: 'cash',
                                collected: false
                            });
                        } else if (rand < 0.50) {
                            this.collectibles.push({
                                x: bubble.x,
                                y: bubble.y,
                                type: 'sweet',
                                collected: false
                            });
                        }
                    }
                }
                
                if (matches.length >= 15) {
                    this.showQuote('EXCEPTIONAL CLUSTER! ' + matches.length + ' bubbles!', 'Warren Buffett', 'WISDOM');
                    this.cash += matches.length * 500;
                    this.sugar = Math.min(this.maxSugar, this.sugar + 10);
                    this.books += 1;
                } else if (matches.length >= 8) {
                    this.showQuote('GREAT PATIENCE! ' + matches.length + ' bubbles!', '', 'GAME');
                    this.cash += matches.length * 200;
                    this.sugar = Math.min(this.maxSugar, this.sugar + 5);
                } else if (matches.length >= 5) {
                    this.showQuote('Good cluster! ' + matches.length + ' bubbles.', '', 'GAME');
                    this.cash += matches.length * 100;
                }
            }
            
            collectItem(collectible) {
                switch (collectible.type) {
                    case 'cash':
                        this.cash += 100;
                        break;
                    case 'sweet':
                        this.sugar = Math.min(this.maxSugar, this.sugar + 10);
                        break;
                    case 'book':
                        this.books += 1;
                        this.showQuote('Knowledge is the best investment.', 'Business Education', 'BUSINESS');
                        break;
                }
            }
            
            endLevel() {
                this.gameRunning = false;
                this.showQuote('Year ' + this.year + ' completed! Visit the store to prepare for next year.', 'Warren Buffett', 'WISDOM');
                setTimeout(() => this.showStoreMenu(), 2000);
            }

            showStoreMenu() {
                document.getElementById('storeYear').textContent = this.year;
                this.populateStore();
                document.getElementById('storeMenu').style.display = 'block';
            }

            showInvestmentMenu() {
                document.getElementById('storeMenu').style.display = 'none';
                document.getElementById('investmentYear').textContent = this.year;
                document.getElementById('investmentToNext').textContent = this.year + 1;
                this.populateInvestments();
                document.getElementById('investmentMenu').style.display = 'block';
            }

            populateStore() {
                // Powerups
                const powerupsSection = document.getElementById('powerupsSection');
                powerupsSection.innerHTML = '';
                
                Object.entries(powerups).forEach(([name, item]) => {
                    const div = document.createElement('div');
                    div.className = 'store-item';
                    div.innerHTML = `
                        <div class="item-info">
                            <h4>${name}</h4>
                            <p>${item.effect}</p>
                        </div>
                        <div class="item-price">$${item.price || item.basePrice}</div>
                        <button class="buy-btn" onclick="game.buyPowerup('${name}')">Buy</button>
                    `;
                    powerupsSection.appendChild(div);
                });

                // Books (only show next available)
                const booksSection = document.getElementById('booksSection');
                booksSection.innerHTML = '';
                
                const nextBook = this.getNextAvailableBook();
                if (nextBook) {
                    const [name, book] = nextBook;
                    const div = document.createElement('div');
                    div.className = 'store-item';
                    div.innerHTML = `
                        <div class="item-info">
                            <h4>${name}</h4>
                            <p>Unlocks: ${book.unlocks}</p>
                        </div>
                        <div class="item-price">üìö${book.price}</div>
                        <button class="buy-btn" ${this.books < book.price ? 'disabled' : ''} onclick="game.buyBook('${name}')">Buy</button>
                    `;
                    booksSection.appendChild(div);
                }

                // Acquisitions (only show next available)
                const acquisitionsSection = document.getElementById('acquisitionsSection');
                acquisitionsSection.innerHTML = '';
                
                const nextAcquisition = this.getNextAvailableAcquisition();
                if (nextAcquisition) {
                    const [name, sub] = nextAcquisition;
                    const div = document.createElement('div');
                    div.className = 'store-item';
                    div.innerHTML = `
                        <div class="item-info">
                            <h4>${name}</h4>
                            <p>${sub.perkDescription} - $${sub.yearlyIncome}/year</p>
                        </div>
                        <div class="item-price">$${sub.price.toLocaleString()}</div>
                        <button class="buy-btn" ${this.cash < sub.price ? 'disabled' : ''} onclick="game.buySubsidiary('${name}')">Buy</button>
                    `;
                    acquisitionsSection.appendChild(div);
                }
            }

            populateInvestments() {
                // Stocks
                const stocksSection = document.getElementById('stocksSection');
                stocksSection.innerHTML = '';
                
                Object.entries(stockData).forEach(([ticker, stock]) => {
                    if (this.year >= stock.startYear && stock.prices[this.year]) {
                        const price = stock.prices[this.year];
                        const owned = this.portfolio[ticker] || 0;
                        const value = owned * price;
                        
                        const div = document.createElement('div');
                        div.className = 'investment-item';
                        div.innerHTML = `
                            <div class="item-info">
                                <h4>${stock.name} (${ticker})</h4>
                                <p>Price: $${price.toFixed(2)} | Owned: ${owned} shares | Value: $${value.toFixed(2)}</p>
                            </div>
                            <div class="portfolio-controls">
                                <input type="number" class="share-input" id="shares_${ticker}" min="0" value="1">
                                <button class="buy-btn" onclick="game.buyStock('${ticker}')">Buy</button>
                                ${owned > 0 ? `<button class="sell-btn" onclick="game.sellStock('${ticker}')">Sell</button>` : ''}
                            </div>
                        `;
                        stocksSection.appendChild(div);
                    }
                });

                // Subsidiaries
                const subsidiariesSection = document.getElementById('subsidiariesSection');
                subsidiariesSection.innerHTML = '';
                
                this.ownedSubsidiaries.forEach(name => {
                    const sub = subsidiaries[name];
                    const div = document.createElement('div');
                    div.className = 'portfolio-item';
                    div.innerHTML = `
                        <div class="portfolio-info">
                            <h4>${name}</h4>
                            <p>Income: $${sub.yearlyIncome}/year | Perk: ${sub.gameplayPerk}</p>
                        </div>
                    `;
                    subsidiariesSection.appendChild(div);
                });
            }

            getNextAvailableBook() {
                const availableBooks = Object.entries(books).filter(([name]) => !this.ownedBooks.includes(name));
                return availableBooks.length > 0 ? availableBooks[0] : null;
            }

            getNextAvailableAcquisition() {
                const available = Object.entries(subsidiaries).filter(([name, sub]) => {
                    if (this.ownedSubsidiaries.includes(name)) return false;
                    if (this.year < sub.availableFrom) return false;
                    if (sub.bookRequirement && !this.ownedBooks.includes(sub.bookRequirement)) return false;
                    if (sub.requires && !sub.requires.every(req => this.ownedSubsidiaries.includes(req))) return false;
                    return true;
                });
                return available.length > 0 ? available[0] : null;
            }

            buyPowerup(name) {
                const item = powerups[name];
                if (this.cash >= item.price) {
                    this.cash -= item.price;
                    if (name === 'Coke') {
                        this.powerups.coke++;
                    } else if (name === "Munger's Lollapaloozas") {
                        this.powerups.lollapalooza++;
                    } else if (name === "Graham's Nets") {
                        this.powerups.grahamNets++;
                    }
                    this.populateStore();
                    this.updateUI();
                }
            }

            buyBook(name) {
                const book = books[name];
                if (this.books >= book.price) {
                    this.books -= book.price;
                    this.ownedBooks.push(name);
                    this.populateStore();
                    this.updateUI();
                    this.showQuote(`Acquired: ${name}. ${book.unlocks} now available!`, 'Warren Buffett', 'WISDOM');
                }
            }

            buySubsidiary(name) {
                const sub = subsidiaries[name];
                if (this.cash >= sub.price) {
                    this.cash -= sub.price;
                    this.ownedSubsidiaries.push(name);
                    this.populateStore();
                    this.updateUI();
                    this.showQuote(`Acquired ${name}! ${sub.gameplayPerk}`, 'Warren Buffett', 'BUSINESS');
                }
            }

            buyStock(ticker) {
                const sharesInput = document.getElementById(`shares_${ticker}`);
                const shares = parseInt(sharesInput.value) || 0;
                if (shares <= 0) return;
                
                const stock = stockData[ticker];
                const price = stock.prices[this.year];
                const totalCost = shares * price;
                
                if (this.cash >= totalCost) {
                    this.cash -= totalCost;
                    this.portfolio[ticker] = (this.portfolio[ticker] || 0) + shares;
                    this.populateInvestments();
                    this.updateUI();
                }
            }

            sellStock(ticker) {
                const sharesInput = document.getElementById(`shares_${ticker}`);
                const shares = parseInt(sharesInput.value) || 0;
                if (shares <= 0 || shares > (this.portfolio[ticker] || 0)) return;
                
                const stock = stockData[ticker];
                const price = stock.prices[this.year];
                const totalValue = shares * price;
                
                this.cash += totalValue;
                this.portfolio[ticker] -= shares;
                if (this.portfolio[ticker] === 0) delete this.portfolio[ticker];
                this.populateInvestments();
                this.updateUI();
            }

            nextYear() {
                document.getElementById('investmentMenu').style.display = 'none';
                
                // Calculate portfolio income and subsidiary income
                let portfolioIncome = 0;
                this.ownedSubsidiaries.forEach(name => {
                    portfolioIncome += subsidiaries[name].yearlyIncome;
                });
                
                this.cash += portfolioIncome;
                this.year++;
                
                // Update market condition for new year
                this.marketCondition = marketHistory[this.year] || 'bull';
                
                // Reset for new year
                this.sugar = this.maxSugar;
                this.bubblesRemaining = 10;
                this.activeBubble = null;
                this.bubbles = [];
                this.collectibles = [];
                this.nextColumnX = this.canvas.width;
                this.mrMarket.shootTimer = 0;
                this.gameRunning = true;
                
                this.updateUI();
                
                if (portfolioIncome > 0) {
                    this.showQuote(`Welcome to ${this.year}! Portfolio generated ${portfolioIncome.toLocaleString()} income. Market: ${this.marketCondition.toUpperCase()}`, 'Warren Buffett', 'BUSINESS');
                } else {
                    this.showQuote(`Welcome to ${this.year}! Market condition: ${this.marketCondition.toUpperCase()} MARKET`, 'Warren Buffett', 'WISDOM');
                }
            }
            
            showQuote(text, author, category) {
                document.getElementById('quoteText').textContent = text;
                document.getElementById('quoteAuthor').textContent = author ? '- ' + author : '';
                document.getElementById('quoteCategory').textContent = category || 'GAME';
                
                const categoryEl = document.getElementById('quoteCategory');
                switch(category) {
                    case 'WISDOM':
                        categoryEl.style.background = 'rgba(243, 156, 18, 0.8)';
                        break;
                    case 'BUSINESS':
                        categoryEl.style.background = 'rgba(46, 204, 113, 0.8)';
                        break;
                    case 'POWERUP':
                        categoryEl.style.background = 'rgba(155, 89, 182, 0.8)';
                        break;
                    default:
                        categoryEl.style.background = 'rgba(52, 152, 219, 0.8)';
                }
            }
            
            updateUI() {
                document.getElementById('booksValue').textContent = 'üìö ' + this.books;
                document.getElementById('yearValue').textContent = this.year;
                document.getElementById('cashValue').textContent = '$' + this.cash.toLocaleString();
                
                // Calculate portfolio value
                let portfolioValue = 0;
                Object.entries(this.portfolio).forEach(([ticker, shares]) => {
                    const stock = stockData[ticker];
                    if (stock.prices[this.year]) {
                        portfolioValue += shares * stock.prices[this.year];
                    }
                });
                document.getElementById('portfolioValue').textContent = '$' + portfolioValue.toLocaleString();
                
                document.getElementById('cannonSugarFill').style.height = ((this.sugar / this.maxSugar) * 100) + '%';
                document.getElementById('bubblesRemaining').textContent = this.bubblesRemaining;
                
                const container = document.getElementById('nextBubblesContainer');
                container.innerHTML = '';
                for (let i = 0; i < this.nextBubbles.length; i++) {
                    const bubble = document.createElement('div');
                    bubble.className = 'next-bubble';
                    bubble.style.background = this.colors[this.nextBubbles[i]];
                    bubble.textContent = i + 1;
                    container.appendChild(bubble);
                }

                this.updatePowerupCounts();
            }
            
            render() {
                this.ctx.fillStyle = '#2c3e50';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Draw Mr Market building
                this.drawMrMarket();
                
                for (let bubble of this.bubbles) {
                    this.drawBubble(bubble);
                }
                
                if (this.activeBubble) {
                    this.drawBubble(this.activeBubble);
                }
                
                if (this.isAiming && this.trajectory.length > 0) {
                    this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
                    this.ctx.lineWidth = 2;
                    this.ctx.setLineDash([5, 5]);
                    this.ctx.beginPath();
                    this.ctx.moveTo(this.cannon.x, this.cannon.y);
                    for (let point of this.trajectory) {
                        this.ctx.lineTo(point.x, point.y);
                    }
                    this.ctx.stroke();
                    this.ctx.setLineDash([]);
                }
                
                this.ctx.save();
                this.ctx.translate(this.cannon.x, this.cannon.y);
                this.ctx.rotate(this.cannon.angle);
                this.ctx.fillStyle = '#34495e';
                this.ctx.fillRect(-5, -8, 25, 6);
                this.ctx.restore();
                
                this.ctx.beginPath();
                this.ctx.arc(this.cannon.x, this.cannon.y, 15, 0, Math.PI * 2);
                this.ctx.fillStyle = '#2c3e50';
                this.ctx.fill();
                
                if (this.nextBubbles.length > 0) {
                    const loadedBubble = {
                        x: this.cannon.x,
                        y: this.cannon.y - 5,
                        radius: this.bubbleRadius * 0.8,
                        color: this.nextBubbles[0],
                        type: this.currentBubbleType
                    };
                    this.drawCannonBubble(loadedBubble);
                }
                
                for (let collectible of this.collectibles) {
                    this.ctx.beginPath();
                    this.ctx.arc(collectible.x, collectible.y, 8, 0, Math.PI * 2);
                    
                    if (collectible.type === 'cash') {
                        this.ctx.fillStyle = '#f1c40f';
                    } else if (collectible.type === 'sweet') {
                        this.ctx.fillStyle = '#e74c3c';
                    } else if (collectible.type === 'book') {
                        this.ctx.fillStyle = '#3498db';
                    }
                    
                    this.ctx.fill();
                    
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '10px Arial';
                    this.ctx.textAlign = 'center';
                    
                    if (collectible.type === 'cash') {
                        this.ctx.fillText('
            
            drawBubble(bubble) {
                this.ctx.beginPath();
                this.ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                
                if (bubble.isGold) {
                    // Gold bubble with special appearance
                    const gradient = this.ctx.createRadialGradient(
                        bubble.x, bubble.y, 0,
                        bubble.x, bubble.y, bubble.radius
                    );
                    gradient.addColorStop(0, '#ffd700');
                    gradient.addColorStop(0.7, '#ffb347');
                    gradient.addColorStop(1, '#ff8c00');
                    this.ctx.fillStyle = gradient;
                } else if (bubble.isGrey) {
                    this.ctx.fillStyle = '#7f8c8d';
                } else {
                    this.ctx.fillStyle = this.colors[bubble.color];
                }
                
                this.ctx.fill();
                
                // Highlight
                this.ctx.beginPath();
                this.ctx.arc(bubble.x - bubble.radius * 0.3, bubble.y - bubble.radius * 0.3, 
                    bubble.radius * 0.3, 0, Math.PI * 2);
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
                this.ctx.fill();
                
                // Border
                this.ctx.beginPath();
                this.ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                if (bubble.isGold) {
                    this.ctx.strokeStyle = '#ffd700';
                    this.ctx.lineWidth = 3;
                    this.ctx.stroke();
                    
                    // Add sparkle effect for gold bubbles
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '8px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText('‚ú®', bubble.x + bubble.radius * 0.3, bubble.y - bubble.radius * 0.3);
                } else if (bubble.isGrey) {
                    this.ctx.strokeStyle = '#f1c40f';
                    this.ctx.lineWidth = 2;
                    this.ctx.stroke();
                } else {
                    this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                    this.ctx.lineWidth = 1;
                    this.ctx.stroke();
                }
            }
            
            drawCannonBubble(bubble) {
                this.ctx.beginPath();
                this.ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                this.ctx.fillStyle = this.colors[bubble.color];
                this.ctx.fill();
                
                if (bubble.type === 'explosive') {
                    this.ctx.beginPath();
                    this.ctx.arc(bubble.x, bubble.y, bubble.radius + 3, 0, Math.PI * 2);
                    this.ctx.strokeStyle = '#e74c3c';
                    this.ctx.lineWidth = 3;
                    this.ctx.stroke();
                    
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '12px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText('üí•', bubble.x, bubble.y + 3);
                } else if (bubble.type === 'converter') {
                    this.ctx.beginPath();
                    this.ctx.arc(bubble.x, bubble.y, bubble.radius + 3, 0, Math.PI * 2);
                    this.ctx.strokeStyle = '#f1c40f';
                    this.ctx.lineWidth = 3;
                    this.ctx.stroke();
                    
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '12px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText('üï∏Ô∏è', bubble.x, bubble.y + 3);
                } else {
                    this.ctx.beginPath();
                    this.ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                    this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                    this.ctx.lineWidth = 1;
                    this.ctx.stroke();
                }
            }
            
            gameLoop() {
                const now = performance.now();
                const deltaTime = this.lastTime ? (now - this.lastTime) / 1000 : 0;
                this.lastTime = now;
                
                this.update(Math.min(deltaTime, 0.016));
                this.render();
                
                requestAnimationFrame(() => this.gameLoop());
            }
        }
        
        let game;

        document.addEventListener('DOMContentLoaded', function() {
            game = new BubbleGame();
        });
    </script>
</body>
</html>, collectible.x, collectible.y + 3);
                    } else if (collectible.type === 'sweet') {
                        this.ctx.fillText('‚ô•', collectible.x, collectible.y + 3);
                    } else if (collectible.type === 'book') {
                        this.ctx.fillText('üìö', collectible.x, collectible.y + 3);
                    }
                }
            }
            
            drawMrMarket() {
                // Draw Mr Market building
                this.ctx.fillStyle = '#34495e';
                this.ctx.fillRect(this.mrMarket.x - this.mrMarket.width/2, 
                                 this.mrMarket.y - this.mrMarket.height/2, 
                                 this.mrMarket.width, this.mrMarket.height);
                
                // Building details
                this.ctx.fillStyle = '#2c3e50';
                this.ctx.fillRect(this.mrMarket.x - this.mrMarket.width/2 + 5, 
                                 this.mrMarket.y - this.mrMarket.height/2 + 5, 
                                 this.mrMarket.width - 10, this.mrMarket.height - 10);
                
                // Windows
                this.ctx.fillStyle = this.marketCondition === 'bull' ? '#f39c12' : '#e74c3c';
                for (let row = 0; row < 3; row++) {
                    for (let col = 0; col < 2; col++) {
                        this.ctx.fillRect(
                            this.mrMarket.x - 20 + col * 15,
                            this.mrMarket.y - 30 + row * 20,
                            8, 8
                        );
                    }
                }
                
                // Market condition sign
                this.ctx.fillStyle = 'white';
                this.ctx.font = '8px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.fillText(this.marketCondition.toUpperCase(), 
                                 this.mrMarket.x, this.mrMarket.y + 35);
                
                // Chimney shooting bubbles effect
                if (this.mrMarket.shootTimer > this.mrMarket.shootInterval * 0.8) {
                    this.ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                    this.ctx.beginPath();
                    this.ctx.arc(this.mrMarket.x - 15, this.mrMarket.y - 45, 3, 0, Math.PI * 2);
                    this.ctx.fill();
                }
            }
            
            drawBubble(bubble) {
                this.ctx.beginPath();
                this.ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                
                if (bubble.isGrey) {
                    this.ctx.fillStyle = '#7f8c8d';
                } else {
                    this.ctx.fillStyle = this.colors[bubble.color];
                }
                
                this.ctx.fill();
                
                this.ctx.beginPath();
                this.ctx.arc(bubble.x - bubble.radius * 0.3, bubble.y - bubble.radius * 0.3, 
                    bubble.radius * 0.3, 0, Math.PI * 2);
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
                this.ctx.fill();
                
                this.ctx.beginPath();
                this.ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                if (bubble.isGrey) {
                    this.ctx.strokeStyle = '#f1c40f';
                    this.ctx.lineWidth = 2;
                } else {
                    this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                    this.ctx.lineWidth = 1;
                }
                this.ctx.stroke();
            }
            
            drawCannonBubble(bubble) {
                this.ctx.beginPath();
                this.ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                this.ctx.fillStyle = this.colors[bubble.color];
                this.ctx.fill();
                
                if (bubble.type === 'explosive') {
                    this.ctx.beginPath();
                    this.ctx.arc(bubble.x, bubble.y, bubble.radius + 3, 0, Math.PI * 2);
                    this.ctx.strokeStyle = '#e74c3c';
                    this.ctx.lineWidth = 3;
                    this.ctx.stroke();
                    
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '12px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText('üí•', bubble.x, bubble.y + 3);
                } else if (bubble.type === 'converter') {
                    this.ctx.beginPath();
                    this.ctx.arc(bubble.x, bubble.y, bubble.radius + 3, 0, Math.PI * 2);
                    this.ctx.strokeStyle = '#f1c40f';
                    this.ctx.lineWidth = 3;
                    this.ctx.stroke();
                    
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '12px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText('üï∏Ô∏è', bubble.x, bubble.y + 3);
                } else {
                    this.ctx.beginPath();
                    this.ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                    this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                    this.ctx.lineWidth = 1;
                    this.ctx.stroke();
                }
            }
            
            gameLoop() {
                const now = performance.now();
                const deltaTime = this.lastTime ? (now - this.lastTime) / 1000 : 0;
                this.lastTime = now;
                
                this.update(Math.min(deltaTime, 0.016));
                this.render();
                
                requestAnimationFrame(() => this.gameLoop());
            }
        }
        
        let game;

        document.addEventListener('DOMContentLoaded', function() {
            game = new BubbleGame();
        });
    </script>
</body>
                    </html>
