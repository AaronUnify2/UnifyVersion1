<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Warren Buffett's Bubble Pop Adventure</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            background: #1a1a1a;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            touch-action: none;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        /* Main Menu Styles - Hidden by default */
        #mainMenu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
        }

        .menu-title {
            font-size: 32px;
            color: #f39c12;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .menu-subtitle {
            font-size: 16px;
            color: #bdc3c7;
            margin-bottom: 40px;
            text-align: center;
            max-width: 80%;
        }

        .menu-button {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
        }

        .menu-button:hover {
            background: linear-gradient(45deg, #e67e22, #d35400);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* Store Menu Styles */
        #storeMenu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            display: none;
            z-index: 999;
            color: white;
            overflow-y: auto;
        }

        .store-header {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-bottom: 3px solid #f39c12;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .store-title {
            font-size: 24px;
            color: #f39c12;
            font-weight: bold;
        }

        .store-currency {
            display: flex;
            gap: 20px;
        }

        .currency-display {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 16px;
            font-weight: bold;
        }

        .store-content {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .store-section {
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
        }

        .section-title {
            font-size: 20px;
            color: #f39c12;
            margin-bottom: 15px;
            border-bottom: 2px solid #f39c12;
            padding-bottom: 5px;
        }

        .items-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .store-item {
            background: rgba(52, 73, 94, 0.8);
            border: 2px solid #7f8c8d;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .store-item:hover {
            border-color: #f39c12;
            background: rgba(243, 156, 18, 0.1);
        }

        .store-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .store-item.disabled:hover {
            border-color: #7f8c8d;
            background: rgba(52, 73, 94, 0.8);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .item-name {
            font-size: 16px;
            font-weight: bold;
            color: #ecf0f1;
        }

        .item-price {
            font-size: 14px;
            font-weight: bold;
            color: #f39c12;
        }

        .item-description {
            font-size: 12px;
            color: #bdc3c7;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .item-effect {
            font-size: 12px;
            color: #2ecc71;
            font-style: italic;
        }

        .item-requirement {
            font-size: 11px;
            color: #e74c3c;
            margin-top: 5px;
        }

        .store-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            padding: 15px;
            border-top: 2px solid #f39c12;
            display: flex;
            justify-content: center;
        }

        .advance-button {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
        }

        .advance-button:hover {
            background: linear-gradient(45deg, #229954, #27ae60);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* Game Container Styles */
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: grid;
            grid-template-areas: 
                "topbar topbar topbar"
                "game game powerups"
                "next next powerups"
                "quotes quotes quotes";
            grid-template-rows: 60px 2fr 80px 1fr;
            grid-template-columns: 1fr 1fr 80px;
        }

        #topBar {
            grid-area: topbar;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            padding: 8px;
            border-bottom: 2px solid #34495e;
        }

        .stat-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .stat-title {
            font-size: 12px;
            color: #bdc3c7;
            margin-bottom: 2px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: bold;
        }

        #booksValue { color: #3498db; }
        #yearValue { color: #f39c12; }
        #cashValue { color: #2ecc71; }

        #gameArea {
            grid-area: game;
            position: relative;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            overflow: hidden;
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
            touch-action: none;
            cursor: crosshair;
        }

        #powerUps {
            grid-area: powerups;
            background: rgba(0, 0, 0, 0.8);
            border-left: 2px solid #34495e;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 5px;
        }



        .powerup-slot {
            width: 50px;
            height: 50px;
            background: rgba(52, 73, 94, 0.5);
            border: 2px solid #7f8c8d;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .powerup-slot:hover {
            border-color: #f39c12;
            background: rgba(243, 156, 18, 0.2);
        }

        .powerup-slot.active {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.3);
        }

        .powerup-icon {
            font-size: 20px;
            line-height: 1;
        }

        .powerup-count {
            font-size: 10px;
            color: white;
            background: rgba(243, 156, 18, 0.9);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: -2px;
            right: -2px;
            font-weight: bold;
        }

        #nextBubbles {
            grid-area: next;
            background: rgba(0, 0, 0, 0.8);
            border-top: 2px solid #34495e;
            display: flex;
            align-items: center;
            padding: 10px;
        }

        .next-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .cannon-display {
            width: 60px;
            height: 40px;
            background: #34495e;
            border: 2px solid #fff;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .cannon-sugar-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(0deg, #e74c3c, #f39c12);
            transition: height 0.3s ease;
            height: 100%;
        }

        .next-bubbles-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .next-bubble {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            font-weight: bold;
        }

        .next-label {
            color: #bdc3c7;
            font-size: 12px;
            margin-right: 10px;
        }

        .bubbles-remaining {
            color: #f39c12;
            font-size: 14px;
            font-weight: bold;
            margin-left: auto;
            margin-right: 20px;
        }

        #quotes {
            grid-area: quotes;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(44, 62, 80, 0.8));
            border-top: 3px solid #f39c12;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 15px;
            overflow: hidden;
            position: relative;
        }

        #debugDisplay {
            position: fixed;
            top: 70px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            font-family: monospace;
            font-size: 11px;
            padding: 8px;
            border-radius: 5px;
            max-width: 250px;
            z-index: 1001;
            white-space: pre-wrap;
            border: 1px solid #00ff00;
        }

        #quotes::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" x="10" font-size="60" opacity="0.1" fill="%23f39c12">"</text><text y="50" x="80" font-size="60" opacity="0.1" fill="%23f39c12">"</text></svg>');
            background-size: 200px 100px;
            background-repeat: no-repeat;
            background-position: 10px center, calc(100% - 10px) center;
            pointer-events: none;
        }

        #quoteText {
            color: #ecf0f1;
            font-size: 14px;
            text-align: center;
            font-style: italic;
            line-height: 1.4;
            max-width: 90%;
            animation: fadeIn 0.5s ease-in;
            z-index: 1;
            margin-bottom: 8px;
        }

        #quoteAuthor {
            color: #f39c12;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            z-index: 1;
        }

        .quote-category {
            position: absolute;
            top: 8px;
            right: 15px;
            background: rgba(243, 156, 18, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            z-index: 1;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 600px) {
            #gameContainer {
                grid-template-columns: 1fr 1fr 60px;
                grid-template-rows: 50px 2fr 70px 1fr;
            }
            
            .stat-title { font-size: 10px; }
            .stat-value { font-size: 14px; }
            .powerup-slot { width: 40px; height: 40px; }
            .powerup-icon { font-size: 16px; }
            .powerup-count { font-size: 8px; width: 12px; height: 12px; }
            #quoteText { font-size: 12px; }
            #quoteAuthor { font-size: 10px; }
            .menu-title { font-size: 24px; }
            .items-grid { grid-template-columns: 1fr; }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Debug Display -->
    <div id="debugDisplay">Starting...</div>

    <!-- Main Menu -->
    <div id="mainMenu">
        <div class="menu-title">Warren Buffett's<br>Bubble Pop Adventure</div>
        <div class="menu-subtitle">Learn investment wisdom while popping bubbles through 70 years of market history</div>
        <button class="menu-button" onclick="startNewGame()">New Game</button>
    </div>

    <!-- Store Menu -->
    <div id="storeMenu">
        <div class="store-header">
            <div class="store-title">Buffett's Store - Year <span id="storeYear">1955</span></div>
            <div class="store-currency">
                <div class="currency-display">
                    <span>📚</span>
                    <span id="storeBooksValue">5</span>
                </div>
                <div class="currency-display">
                    <span>💰</span>
                    <span id="storeCashValue">$0</span>
                </div>
            </div>
        </div>

        <div class="store-content">
            <!-- Powerups Section -->
            <div class="store-section">
                <div class="section-title">⚡ Power-ups & Upgrades</div>
                <div class="items-grid" id="powerupsGrid">
                    <!-- Powerups will be populated here -->
                </div>
            </div>

            <!-- Books Section -->
            <div class="store-section">
                <div class="section-title">📚 Investment Books</div>
                <div class="items-grid" id="booksGrid">
                    <!-- Books will be populated here -->
                </div>
            </div>

            <!-- Subsidiaries Section -->
            <div class="store-section">
                <div class="section-title">🏢 Business Acquisitions</div>
                <div class="items-grid" id="subsidiariesGrid">
                    <!-- Subsidiaries will be populated here -->
                </div>
            </div>
        </div>

        <div class="store-footer">
            <button class="advance-button" onclick="proceedToInvestments()">Investments</button>
        </div>
    </div>

    <!-- Game Container -->
    <div id="gameContainer">
        <div id="topBar">
            <div class="stat-section">
                <div class="stat-title">BOOKS</div>
                <div class="stat-value" id="booksValue">📚 5</div>
            </div>
            <div class="stat-section">
                <div class="stat-title">YEAR</div>
                <div class="stat-value" id="yearValue">1955</div>
            </div>
            <div class="stat-section">
                <div class="stat-title">$CASH</div>
                <div class="stat-value" id="cashValue">$0</div>
            </div>
        </div>

        <div id="gameArea">
            <canvas id="gameCanvas"></canvas>
        </div>

        <div id="powerUps">
            <div class="powerup-slot" id="lollapalooza">
                <div class="powerup-icon">💥</div>
                <div class="powerup-count">1</div>
            </div>
            <div class="powerup-slot" id="grahamNets">
                <div class="powerup-icon">🕸️</div>
                <div class="powerup-count">1</div>
            </div>
            <div class="powerup-slot" id="coke">
                <div class="powerup-icon">🥤</div>
                <div class="powerup-count">1</div>
            </div>
        </div>

        <div id="nextBubbles">
            <div class="next-section">
                <div class="cannon-display">
                    <div class="cannon-sugar-fill" id="cannonSugarFill"></div>
                </div>
                <div class="next-label">Sugar:</div>
                <div class="next-bubbles-container" id="nextBubblesContainer">
                    <div class="next-bubble" style="background: #e74c3c;">1</div>
                    <div class="next-bubble" style="background: #3498db;">2</div>
                    <div class="next-bubble" style="background: #2ecc71;">3</div>
                </div>
            </div>
            <div class="bubbles-remaining">
                Shots: <span id="bubblesRemaining">3</span>
            </div>
        </div>

        <div id="quotes">
            <div class="quote-category" id="quoteCategory">WISDOM</div>
            <div id="quoteText">
                The stock market is a device for transferring money from the impatient to the patient.
            </div>
            <div id="quoteAuthor">- Warren Buffett</div>
        </div>
    </div>

    <script>
        // Debug functions
        let debugMessages = [];
        function debugLog(message) {
            console.log(message);
            debugMessages.push(message);
            const debugEl = document.getElementById('debugDisplay');
            if (debugEl) {
                debugEl.textContent = debugMessages.slice(-10).join('\n');
            }
        }

        // Test immediately when script loads
        try {
            debugLog('Script parsing...');
            debugLog('Testing objects...');
            
            // Test if our data objects are valid
            if (typeof books !== 'undefined') {
                debugLog('Books object loaded');
            } else {
                debugLog('Books object MISSING');
            }
            
            if (typeof subsidiaries !== 'undefined') {
                debugLog('Subsidiaries object loaded');
            } else {
                debugLog('Subsidiaries object MISSING');
            }
            
            debugLog('Objects test complete');
        } catch (error) {
            debugLog('Error in script parsing: ' + error.message);
        }

        // Store Data
        const books = {
            "The Intelligent Investor": {
                price: 50,
                bookValue: 50,
                effect: "Unlocks value investing strategies",
                unlocks: ["Graham's Nets powerup"]
            },
            "Common Stocks and Uncommon Profits": {
                price: 75,
                bookValue: 75,
                effect: "Teaches quality company analysis",
                unlocks: ["Better bubble color distributions"]
            },
            "Poor Charlie's Almanack": {
                price: 100,
                bookValue: 100,
                effect: "Essential for understanding mental models",
                unlocks: ["See's Candies acquisition", "Lollapalooza powerups"]
            },
            "The Little Book of Common Sense Investing": {
                price: 40,
                bookValue: 40,
                effect: "Emphasizes low-cost index investing",
                unlocks: ["Reduced transaction costs"]
            },
            "Essays of Warren Buffett": {
                price: 100,
                bookValue: 100,
                effect: "Learn directly from the Oracle",
                unlocks: ["Advanced investment opportunities"]
            }
        };

        const subsidiaries = {
            "See's Candies": {
                price: 2500,
                yearlyIncome: 150,
                gameplayPerk: "Sugar depletes 25% slower",
                perkDescription: "Quality candy extends energy",
                unlocks: ["GEICO"],
                availableFrom: 1972,
                bookRequirement: "Poor Charlie's Almanack"
            },
            "GEICO": {
                price: 8000,
                yearlyIncome: 400,
                gameplayPerk: "+2 starting bubbles per level",
                perkDescription: "Insurance provides backup shots",
                unlocks: ["Dairy Queen"],
                availableFrom: 1976,
                requires: ["See's Candies"]
            },
            "Dairy Queen": {
                price: 15000,
                yearlyIncome: 600,
                gameplayPerk: "+20% trajectory line length",
                perkDescription: "Smooth operations improve aiming precision",
                unlocks: ["Nebraska Furniture Mart"],
                availableFrom: 1998,
                requires: ["GEICO"]
            },
            "Nebraska Furniture Mart": {
                price: 25000,
                yearlyIncome: 800,
                gameplayPerk: "Remove yellow bubbles permanently from game",
                perkDescription: "Furniture efficiency eliminates one color complexity",
                unlocks: ["Fruit of the Loom"],
                availableFrom: 1983,
                requires: ["Dairy Queen"]
            },
            "Fruit of the Loom": {
                price: 40000,
                yearlyIncome: 1000,
                gameplayPerk: "Bubble scroll speed reduced by 15%",
                perkDescription: "Textile quality slows the rush of time",
                unlocks: ["Gillette"],
                availableFrom: 2002,
                requires: ["Nebraska Furniture Mart"]
            },
            "Gillette": {
                price: 65000,
                yearlyIncome: 1500,
                gameplayPerk: "Start each level with 1 Graham Net powerup",
                perkDescription: "Precision engineering provides strategic tools",
                unlocks: ["Duracell"],
                availableFrom: 2005,
                requires: ["Fruit of the Loom"]
            },
            "Duracell": {
                price: 90000,
                yearlyIncome: 2000,
                gameplayPerk: "Start each level with 1 Lollapalooza powerup",
                perkDescription: "Long-lasting power energizes explosive potential",
                unlocks: ["BNSF Railway"],
                availableFrom: 2014,
                requires: ["Gillette"]
            },
            "BNSF Railway": {
                price: 150000,
                yearlyIncome: 3500,
                gameplayPerk: "+3 starting bubbles AND remove orange bubbles permanently",
                perkDescription: "Transportation empire delivers maximum efficiency",
                availableFrom: 2009,
                requires: ["Duracell"],
                finalSubsidiary: true
            }
        };

        const powerupsStore = {
            "Munger's Lollapaloozas": {
                type: "consumable",
                effect: "Destroys 3x3 area",
                price: 200,
                requires: ["Poor Charlie's Almanack"],
                icon: "💥"
            },
            "Graham's Nets": {
                type: "consumable",
                effect: "Turns hit bubbles grey for chain pops",
                price: 300,
                requires: ["The Intelligent Investor"],
                icon: "🕸️"
            },
            "Coca-Cola": {
                type: "consumable",
                effect: "Restore 20% sugar",
                price: 50,
                icon: "🥤"
            },
            "Partner with Charlie": {
                type: "permanent",
                effect: "+1 starting bubble",
                price: 500,
                maxLevel: 1,
                icon: "🤝"
            },
            "Remove Investment Bankers": {
                type: "permanent",
                effect: "+5 explosive bubbles per level",
                price: 2000,
                icon: "🚫"
            }
        };

        // Game State
        let gameState = {
            year: 1955,
            books: 5,
            cash: 0,
            ownedBooks: [],
            ownedSubsidiaries: [],
            ownedUpgrades: {},
            gamePhase: 'menu', // 'menu', 'playing', 'store', 'investments'
            currentGame: null
        };

        // Game Functions
        function startNewGame() {
            gameState = {
                year: 1955,
                books: 5,
                cash: 0,
                ownedBooks: [],
                ownedSubsidiaries: [],
                ownedUpgrades: {},
                gamePhase: 'playing',
                currentGame: null
            };

            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('gameContainer').classList.remove('hidden');
            
            // Initialize game
            setTimeout(() => {
                gameState.currentGame = new BubbleGame();
            }, 100);
        }

        function endCurrentLevel() {
            if (gameState.currentGame) {
                gameState.currentGame.endLevel(true);
            }
            showStore();
        }

        function showStore() {
            gameState.gamePhase = 'store';
            document.getElementById('gameContainer').classList.add('hidden');
            document.getElementById('storeMenu').style.display = 'block';
            
            updateStoreDisplay();
            populateStore();
        }

        function proceedToInvestments() {
            // For now, just advance to next year since investments aren't implemented yet
            gameState.year++;
            
            // Apply subsidiary income
            let income = 0;
            for (let subName of gameState.ownedSubsidiaries) {
                if (subsidiaries[subName]) {
                    income += subsidiaries[subName].yearlyIncome;
                }
            }
            gameState.cash += income;
            
            // Return to game
            document.getElementById('storeMenu').style.display = 'none';
            document.getElementById('gameContainer').classList.remove('hidden');
            
            if (gameState.currentGame) {
                gameState.currentGame.nextLevel();
                gameState.currentGame.year = gameState.year;
                gameState.currentGame.cash = gameState.cash;
                gameState.currentGame.books = gameState.books;
                gameState.currentGame.updateUI();
            }
        }

        function updateStoreDisplay() {
            document.getElementById('storeYear').textContent = gameState.year;
            document.getElementById('storeBooksValue').textContent = gameState.books;
            document.getElementById('storeCashValue').textContent = '$' + gameState.cash.toLocaleString();
        }

        function populateStore() {
            populateBooks();
            populateSubsidiaries();
            populatePowerups();
        }

        function populateBooks() {
            const grid = document.getElementById('booksGrid');
            grid.innerHTML = '';

            // Find the cheapest unowned book
            let cheapestBook = null;
            let cheapestPrice = Infinity;
            
            for (let [name, book] of Object.entries(books)) {
                if (!gameState.ownedBooks.includes(name) && book.price < cheapestPrice) {
                    cheapestBook = name;
                    cheapestPrice = book.price;
                }
            }
            
            if (cheapestBook) {
                const book = books[cheapestBook];
                const canAfford = gameState.books >= book.price;
                
                const item = document.createElement('div');
                item.className = `store-item ${!canAfford ? 'disabled' : ''}`;
                
                item.innerHTML = `
                    <div class="item-header">
                        <div class="item-name">${cheapestBook}</div>
                        <div class="item-price">📚 ${book.price}</div>
                    </div>
                    <div class="item-description">${book.effect}</div>
                    <div class="item-effect">Unlocks: ${book.unlocks.join(', ')}</div>
                `;

                if (canAfford) {
                    item.onclick = () => purchaseBook(cheapestBook);
                }

                grid.appendChild(item);
            } else {
                const item = document.createElement('div');
                item.className = 'store-item disabled';
                item.innerHTML = `
                    <div class="item-header">
                        <div class="item-name">All Books Owned</div>
                        <div class="item-price">✅</div>
                    </div>
                    <div class="item-description">You have acquired all investment wisdom books!</div>
                `;
                grid.appendChild(item);
            }
        }

        function populateSubsidiaries() {
            const grid = document.getElementById('subsidiariesGrid');
            grid.innerHTML = '';

            // Find the cheapest available subsidiary
            let cheapestSubsidiary = null;
            let cheapestPrice = Infinity;
            
            for (let [name, subsidiary] of Object.entries(subsidiaries)) {
                if (!gameState.ownedSubsidiaries.includes(name) && 
                    checkSubsidiaryRequirements(subsidiary) && 
                    gameState.year >= subsidiary.availableFrom &&
                    subsidiary.price < cheapestPrice) {
                    cheapestSubsidiary = name;
                    cheapestPrice = subsidiary.price;
                }
            }
            
            if (cheapestSubsidiary) {
                const subsidiary = subsidiaries[cheapestSubsidiary];
                const canAfford = gameState.cash >= subsidiary.price;
                
                const item = document.createElement('div');
                item.className = `store-item ${!canAfford ? 'disabled' : ''}`;
                
                item.innerHTML = `
                    <div class="item-header">
                        <div class="item-name">${cheapestSubsidiary}</div>
                        <div class="item-price">${subsidiary.price.toLocaleString()}</div>
                    </div>
                    <div class="item-description">${subsidiary.perkDescription}</div>
                    <div class="item-effect">${subsidiary.gameplayPerk} | ${subsidiary.yearlyIncome}/year</div>
                `;

                if (canAfford) {
                    item.onclick = () => purchaseSubsidiary(cheapestSubsidiary);
                }

                grid.appendChild(item);
            } else {
                // Check if there are subsidiaries available in future years
                let futureSubsidiaryAvailable = false;
                let nextAvailableYear = Infinity;
                
                for (let [name, subsidiary] of Object.entries(subsidiaries)) {
                    if (!gameState.ownedSubsidiaries.includes(name) && 
                        checkSubsidiaryRequirements(subsidiary) && 
                        subsidiary.availableFrom > gameState.year) {
                        futureSubsidiaryAvailable = true;
                        nextAvailableYear = Math.min(nextAvailableYear, subsidiary.availableFrom);
                    }
                }
                
                const item = document.createElement('div');
                item.className = 'store-item disabled';
                
                if (futureSubsidiaryAvailable) {
                    item.innerHTML = `
                        <div class="item-header">
                            <div class="item-name">Next Acquisition Available</div>
                            <div class="item-price">${nextAvailableYear}</div>
                        </div>
                        <div class="item-description">Continue building your empire! New businesses become available over time.</div>
                    `;
                } else {
                    item.innerHTML = `
                        <div class="item-header">
                            <div class="item-name">Empire Complete</div>
                            <div class="item-price">✅</div>
                        </div>
                        <div class="item-description">You have acquired all available businesses!</div>
                    `;
                }
                
                grid.appendChild(item);
            }
        }

        function populatePowerups() {
            const grid = document.getElementById('powerupsGrid');
            grid.innerHTML = '';

            for (let [name, powerup] of Object.entries(powerupsStore)) {
                const canAfford = gameState.cash >= powerup.price;
                const meetsRequirements = !powerup.requires || powerup.requires.every(req => gameState.ownedBooks.includes(req));
                const alreadyPurchased = powerup.type === 'permanent' && gameState.ownedUpgrades[name];
                
                // Skip permanent powerups that have already been purchased
                if (alreadyPurchased) continue;
                
                const available = canAfford && meetsRequirements;
                
                const item = document.createElement('div');
                item.className = `store-item ${!available ? 'disabled' : ''}`;
                
                let requirementText = '';
                if (powerup.requires && !meetsRequirements) {
                    requirementText = `Requires: ${powerup.requires.join(', ')}`;
                }

                item.innerHTML = `
                    <div class="item-header">
                        <div class="item-name">${powerup.icon} ${name}</div>
                        <div class="item-price">${powerup.price}</div>
                    </div>
                    <div class="item-description">${powerup.effect}</div>
                    <div class="item-effect">Type: ${powerup.type}</div>
                    ${requirementText ? `<div class="item-requirement">${requirementText}</div>` : ''}
                `;

                if (available) {
                    item.onclick = () => purchasePowerup(name);
                }

                grid.appendChild(item);
            }
        }

        function checkSubsidiaryRequirements(subsidiary) {
            if (subsidiary.bookRequirement && !gameState.ownedBooks.includes(subsidiary.bookRequirement)) {
                return false;
            }
            if (subsidiary.requires && !subsidiary.requires.every(req => gameState.ownedSubsidiaries.includes(req))) {
                return false;
            }
            return true;
        }

        function purchaseBook(bookName) {
            const book = books[bookName];
            if (gameState.books >= book.price && !gameState.ownedBooks.includes(bookName)) {
                gameState.books -= book.price;
                gameState.ownedBooks.push(bookName);
                updateStoreDisplay();
                populateStore();
                
                // Show quote
                showStoreQuote(`"${bookName}" acquired! Knowledge is the best investment.`, 'Warren Buffett');
            }
        }

        function purchaseSubsidiary(subName) {
            const subsidiary = subsidiaries[subName];
            if (gameState.cash >= subsidiary.price && !gameState.ownedSubsidiaries.includes(subName)) {
                gameState.cash -= subsidiary.price;
                gameState.ownedSubsidiaries.push(subName);
                updateStoreDisplay();
                populateStore();
                
                // Apply immediate perks to game if it exists
                if (gameState.currentGame) {
                    gameState.currentGame.applySubsidiaryPerk(subName, subsidiary);
                }
                
                showStoreQuote(getAcquisitionQuote(subName), 'Warren Buffett');
            }
        }

        function purchasePowerup(powerupName) {
            const powerup = powerupsStore[powerupName];
            if (gameState.cash >= powerup.price) {
                gameState.cash -= powerup.price;
                
                if (powerup.type === 'consumable') {
                    // Add to game inventory
                    if (gameState.currentGame) {
                        if (powerupName.includes('Lollapalooza')) {
                            gameState.currentGame.powerups.lollapalooza++;
                        } else if (powerupName.includes('Graham')) {
                            gameState.currentGame.powerups.grahamNets++;
                        } else if (powerupName.includes('Coca-Cola')) {
                            gameState.currentGame.powerups.coke++;
                        }
                        gameState.currentGame.updatePowerupCounts();
                    }
                } else if (powerup.type === 'permanent') {
                    // Apply permanent upgrade
                    if (!gameState.ownedUpgrades[powerupName]) {
                        gameState.ownedUpgrades[powerupName] = 0;
                    }
                    gameState.ownedUpgrades[powerupName]++;
                    
                    if (gameState.currentGame) {
                        gameState.currentGame.applyPermanentUpgrade(powerupName, powerup);
                    }
                }
                
                updateStoreDisplay();
                populateStore();
                showStoreQuote(`${powerupName} purchased! ${powerup.effect}`, 'Store Purchase');
            }
        }

        function getAcquisitionQuote(subName) {
            const quotes = {
                "See's Candies": "See's Candies taught us the power of a brand and exceptional customer loyalty.",
                "GEICO": "GEICO's direct marketing model revolutionized the insurance industry.",
                "Dairy Queen": "Few brands have the enduring appeal of the Dairy Queen experience.",
                "Nebraska Furniture Mart": "Mrs. B built an empire on treating customers fairly and offering value.",
                "Fruit of the Loom": "Basic necessities with trusted quality never go out of style.",
                "Gillette": "Give a man a great shave and he'll be a customer for life.",
                "Duracell": "In batteries, as in business, reliability creates customer loyalty.",
                "BNSF Railway": "Railroads are the arteries of American commerce - essential and enduring."
            };
            return quotes[subName] || "A wonderful business at a fair price.";
        }

        function showStoreQuote(text, author) {
            // Update the game's quote display
            if (gameState.currentGame) {
                gameState.currentGame.showQuote(text, author, 'BUSINESS');
            }
        }

        // Original Game Class (Modified)
        class BubbleGame {
            constructor() {
                debugLog('BubbleGame constructor started...');
                this.canvas = document.getElementById('gameCanvas');
                debugLog('Canvas found: ' + !!this.canvas);
                
                if (!this.canvas) {
                    debugLog('Canvas not found!');
                    return;
                }
                
                this.ctx = this.canvas.getContext('2d');
                debugLog('Context created: ' + !!this.ctx);
                
                debugLog('Setting up canvas...');
                this.setupCanvas();
                debugLog('Initializing game state...');
                this.initGameState();
                debugLog('Setting up event listeners...');
                this.setupEventListeners();
                debugLog('Generating initial bubbles...');
                this.generateInitialBubbles();
                
                this.lastTime = 0;
                debugLog('Starting game loop...');
                this.gameLoop();
                debugLog('BubbleGame constructor finished');
            }
            
            setupCanvas() {
                const gameArea = document.getElementById('gameArea');
                this.canvas.width = gameArea.clientWidth || 800;
                this.canvas.height = gameArea.clientHeight || 600;
                
                debugLog('Canvas size: ' + this.canvas.width + 'x' + this.canvas.height);
                
                window.addEventListener('resize', () => {
                    const gameArea = document.getElementById('gameArea');
                    this.canvas.width = gameArea.clientWidth || 800;
                    this.canvas.height = gameArea.clientHeight || 600;
                    this.cannon.x = this.canvas.width / 2;
                    this.cannon.y = this.canvas.height - 30;
                });
            }
            
            initGameState() {
                debugLog('Initializing game state...');
                this.year = gameState.year;
                this.books = gameState.books;
                this.sugar = 60;
                this.maxSugar = 60;
                this.cash = gameState.cash;
                this.bubblesRemaining = 3;
                this.gameRunning = true;
                this.gameStartTime = 0; // Track how long game has been running
                
                debugLog('Game running: ' + this.gameRunning);
                
                // Apply subsidiary perks
                this.applyOwnedSubsidiaryPerks();
                
                this.bubbles = [];
                this.activeBubble = null;
                this.nextBubbles = [];
                this.collectibles = [];
                
                this.bubbleRadius = Math.max(12, Math.min(18, this.canvas.width / 25));
                this.scrollSpeed = 30;
                this.spawnTimer = 0;
                this.spawnInterval = 0.8;
                
                this.cannon = {
                    x: this.canvas.width / 2,
                    y: this.canvas.height - 30,
                    angle: -Math.PI / 2,
                    power: 300
                };
                
                this.colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6'];
                
                this.isAiming = false;
                this.trajectory = [];
                
                this.powerups = {
                    lollapalooza: 1,
                    grahamNets: 1,
                    coke: 1
                };
                
                this.specialAmmo = [];
                this.currentBubbleType = 'normal';
                
                for (let i = 0; i < 3; i++) {
                    this.nextBubbles.push(Math.floor(Math.random() * 3));
                }
                
                this.updateUI();
                this.showQuote('Welcome to ' + this.year + '! Use your limited shots wisely!', 'Warren Buffett', 'WISDOM');
                
                debugLog('Game state initialized');
            }

            applyOwnedSubsidiaryPerks() {
                // Apply perks from owned subsidiaries
                for (let subName of gameState.ownedSubsidiaries) {
                    const subsidiary = subsidiaries[subName];
                    if (subsidiary) {
                        this.applySubsidiaryPerk(subName, subsidiary);
                    }
                }
            }

            applySubsidiaryPerk(subName, subsidiary) {
                switch (subName) {
                    case "See's Candies":
                        this.sugarDepletionRate = 0.75; // 25% slower
                        break;
                    case "GEICO":
                        this.bubblesRemaining += 2;
                        break;
                    case "Dairy Queen":
                        this.trajectoryLengthMultiplier = 1.2; // 20% longer
                        break;
                    case "Nebraska Furniture Mart":
                        // Remove yellow bubbles - modify color array
                        this.colors = this.colors.filter(color => color !== '#f39c12');
                        break;
                    case "Fruit of the Loom":
                        this.scrollSpeed *= 0.85; // 15% slower
                        break;
                    case "Gillette":
                        this.powerups.grahamNets++;
                        break;
                    case "Duracell":
                        this.powerups.lollapalooza++;
                        break;
                    case "BNSF Railway":
                        this.bubblesRemaining += 3;
                        this.colors = this.colors.filter(color => color !== '#e67e22'); // Remove orange
                        break;
                }
            }

            applyPermanentUpgrade(upgradeName, upgrade) {
                switch (upgradeName) {
                    case "Partner with Charlie":
                        this.bubblesRemaining++;
                        break;
                    case "Remove Investment Bankers":
                        this.powerups.lollapalooza += 5;
                        break;
                }
            }
            
            endLevel(won) {
                this.gameRunning = false;
                
                // Update game state
                gameState.cash = this.cash;
                gameState.books = this.books;
                
                if (won) {
                    this.showQuote('Year ' + this.year + ' completed! Time for some shopping.', 'Warren Buffett', 'WISDOM');
                } else {
                    this.showQuote('Level complete! Time to visit the store.', 'Warren Buffett', 'WISDOM');
                }
                
                setTimeout(() => showStore(), 2000);
            }
            
            nextLevel() {
                this.sugar = this.maxSugar; // Always refill sugar
                this.bubblesRemaining = 3;
                this.gameStartTime = 0; // Reset game start time
                
                // Reapply subsidiary perks for new level
                this.applyOwnedSubsidiaryPerks();
                
                this.scrollSpeed += 5;
                this.generateInitialBubbles();
                this.gameRunning = true;
                this.updateUI();
            }

            // All other methods remain the same as in the original code...
            setupEventListeners() {
                this.canvas.addEventListener('contextmenu', e => e.preventDefault());
                
                this.canvas.addEventListener('mousedown', (e) => this.startAiming(e));
                this.canvas.addEventListener('mousemove', (e) => this.updateAiming(e));
                this.canvas.addEventListener('mouseup', (e) => this.fire(e));
                
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.startAiming(e.touches[0]);
                });
                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    this.updateAiming(e.touches[0]);
                });
                this.canvas.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.fire(e);
                });

                document.getElementById('lollapalooza').addEventListener('click', () => {
                    if (this.powerups.lollapalooza > 0) {
                        this.powerups.lollapalooza--;
                        
                        if (this.currentBubbleType === 'normal') {
                            this.currentBubbleType = 'explosive';
                            this.showQuote('Lollapalooza loaded! Current shot will explode!', 'Charlie Munger', 'POWERUP');
                        } else {
                            this.specialAmmo.push('explosive');
                            this.showQuote('Lollapalooza queued! Next shot will explode!', 'Charlie Munger', 'POWERUP');
                        }
                        
                        this.updatePowerupCounts();
                    }
                });
                
                document.getElementById('grahamNets').addEventListener('click', () => {
                    if (this.powerups.grahamNets > 0) {
                        this.powerups.grahamNets--;
                        
                        if (this.currentBubbleType === 'normal') {
                            this.currentBubbleType = 'converter';
                            this.showQuote('Graham Nets loaded! Current shot creates chain reactions!', 'Benjamin Graham', 'POWERUP');
                        } else {
                            this.specialAmmo.push('converter');
                            this.showQuote('Graham Nets queued! Next shot creates chain reactions!', 'Benjamin Graham', 'POWERUP');
                        }
                        
                        this.updatePowerupCounts();
                    }
                });
                
                document.getElementById('coke').addEventListener('click', () => {
                    if (this.powerups.coke > 0) {
                        this.powerups.coke--;
                        this.sugar = Math.min(this.maxSugar, this.sugar + 20);
                        this.showQuote('Refreshing Coke! Sugar restored!', 'Warren Buffett', 'POWERUP');
                        this.updatePowerupCounts();
                    }
                });
            }

            loadNextAmmo() {
                if (this.specialAmmo.length > 0) {
                    this.currentBubbleType = this.specialAmmo.shift();
                } else {
                    this.currentBubbleType = 'normal';
                }
            }

            updatePowerupCounts() {
                document.querySelector('#lollapalooza .powerup-count').textContent = this.powerups.lollapalooza;
                document.querySelector('#grahamNets .powerup-count').textContent = this.powerups.grahamNets;
                document.querySelector('#coke .powerup-count').textContent = this.powerups.coke;
            }
            
            getPointerPos(e) {
                const rect = this.canvas.getBoundingClientRect();
                return {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            }
            
            startAiming(e) {
                if (!this.gameRunning || this.activeBubble) return;
                
                this.isAiming = true;
                this.updateAiming(e);
            }
            
            updateAiming(e) {
                if (!this.isAiming) return;
                
                const pos = this.getPointerPos(e);
                const dx = pos.x - this.cannon.x;
                const dy = pos.y - this.cannon.y;
                
                let angle = Math.atan2(dy, dx);
                
                const maxAngle = Math.PI * 0.1;
                const minAngle = -Math.PI + maxAngle;
                angle = Math.max(minAngle, Math.min(maxAngle, angle));
                
                this.cannon.angle = angle;
                this.calculateTrajectory();
            }
            
            fire(e) {
                if (!this.isAiming || this.activeBubble || this.bubblesRemaining <= 0) return;
                
                this.isAiming = false;
                this.trajectory = [];
                
                this.activeBubble = {
                    x: this.cannon.x,
                    y: this.cannon.y,
                    vx: Math.cos(this.cannon.angle) * this.cannon.power,
                    vy: Math.sin(this.cannon.angle) * this.cannon.power,
                    color: this.nextBubbles.shift(),
                    radius: this.bubbleRadius,
                    type: this.currentBubbleType
                };
                
                this.nextBubbles.push(Math.floor(Math.random() * Math.min(3, this.colors.length)));
                this.bubblesRemaining--;
                
                this.loadNextAmmo();
                
                this.updateUI();
            }
            
            calculateTrajectory() {
                this.trajectory = [];
                if (!this.isAiming) return;
                
                let x = this.cannon.x;
                let y = this.cannon.y;
                let vx = Math.cos(this.cannon.angle) * this.cannon.power / 60;
                let vy = Math.sin(this.cannon.angle) * this.cannon.power / 60;
                
                const maxPoints = this.trajectoryLengthMultiplier ? Math.floor(30 * this.trajectoryLengthMultiplier) : 30;
                
                for (let i = 0; i < maxPoints; i++) {
                    x += vx;
                    y += vy;
                    
                    if (x <= this.bubbleRadius || x >= this.canvas.width - this.bubbleRadius) {
                        vx = -vx;
                        x = Math.max(this.bubbleRadius, Math.min(this.canvas.width - this.bubbleRadius, x));
                    }
                    
                    this.trajectory.push({ x, y });
                    
                    if (y <= 0) break;
                }
            }
            
            generateInitialBubbles() {
                debugLog('generateInitialBubbles called');
                this.bubbles = [];
                
                const cols = Math.floor(this.canvas.width / (this.bubbleRadius * 2)) + 5;
                const rows = 6;
                
                debugLog('Generating bubbles: ' + cols + ' cols x ' + rows + ' rows');
                debugLog('Canvas: ' + this.canvas.width + 'x' + this.canvas.height);
                debugLog('Bubble radius: ' + this.bubbleRadius);
                
                for (let col = 0; col < cols; col++) {
                    for (let row = 0; row < rows; row++) {
                        if (Math.random() < 0.7) {
                            const x = col * (this.bubbleRadius * 2) + this.bubbleRadius + (row % 2 ? this.bubbleRadius : 0);
                            const y = row * (this.bubbleRadius * 1.5) + this.bubbleRadius + 20;
                            
                            this.bubbles.push({
                                x: x,
                                y: y,
                                color: Math.floor(Math.random() * this.colors.length),
                                radius: this.bubbleRadius,
                                gridX: col,
                                gridY: row
                            });
                        }
                    }
                }
                
                debugLog('Generated ' + this.bubbles.length + ' bubbles');
                if (this.bubbles.length > 0) {
                    debugLog('First bubble: x=' + this.bubbles[0].x + ' y=' + this.bubbles[0].y);
                }
            }
            
            spawnNewColumn() {
                const rows = 6;
                const rightmostX = Math.max(...this.bubbles.map(b => b.x), this.canvas.width);
                const newCol = Math.floor((rightmostX + this.bubbleRadius * 2) / (this.bubbleRadius * 2));
                
                for (let row = 0; row < rows; row++) {
                    if (Math.random() < 0.7) {
                        const x = newCol * (this.bubbleRadius * 2) + this.bubbleRadius + (row % 2 ? this.bubbleRadius : 0);
                        const y = row * (this.bubbleRadius * 1.5) + this.bubbleRadius + 20;
                        
                        this.bubbles.push({
                            x: x,
                            y: y,
                            color: Math.floor(Math.random() * this.colors.length),
                            radius: this.bubbleRadius,
                            gridX: newCol,
                            gridY: row
                        });
                    }
                }
            }
            
            update(deltaTime) {
                if (!this.gameRunning) {
                    debugLog('Game not running, skipping update');
                    return;
                }
                
                this.gameStartTime += deltaTime;
                
                const depletionRate = this.sugarDepletionRate || 1.0;
                this.sugar -= deltaTime * depletionRate;
                
                // Log sugar depletion every 2 seconds for debugging
                if (Math.floor(this.gameStartTime * 2) !== Math.floor((this.gameStartTime - deltaTime) * 2)) {
                    debugLog('Sugar: ' + this.sugar.toFixed(1) + ' Bubbles: ' + this.bubbles.length);
                }
                
                if (this.sugar <= 0) {
                    // Update game state before going to store
                    gameState.cash = this.cash;
                    gameState.books = this.books;
                    this.showQuote('Sugar depleted! Time to visit the store.', 'Warren Buffett', 'WISDOM');
                    setTimeout(() => showStore(), 2000);
                    this.gameRunning = false;
                    return;
                }
                
                this.bubbles.forEach(bubble => {
                    bubble.x -= this.scrollSpeed * deltaTime;
                });
                
                this.bubbles = this.bubbles.filter(bubble => bubble.x > -this.bubbleRadius);
                
                this.spawnTimer += deltaTime;
                if (this.spawnTimer >= this.spawnInterval) {
                    this.spawnNewColumn();
                    this.spawnTimer = 0;
                }
                
                if (this.activeBubble) {
                    this.activeBubble.x += this.activeBubble.vx * deltaTime;
                    this.activeBubble.y += this.activeBubble.vy * deltaTime;
                    
                    if (this.activeBubble.x <= this.bubbleRadius || 
                        this.activeBubble.x >= this.canvas.width - this.bubbleRadius) {
                        this.activeBubble.vx = -this.activeBubble.vx;
                        this.activeBubble.x = Math.max(this.bubbleRadius, 
                            Math.min(this.canvas.width - this.bubbleRadius, this.activeBubble.x));
                    }
                    
                    this.checkCollisions();
                    
                    if (this.activeBubble && this.activeBubble.y <= -this.bubbleRadius) {
                        this.activeBubble = null;
                    }
                }
                
                this.collectibles.forEach(collectible => {
                    collectible.y += 100 * deltaTime;
                    
                    const dist = Math.sqrt(
                        Math.pow(collectible.x - this.cannon.x, 2) + 
                        Math.pow(collectible.y - this.cannon.y, 2)
                    );
                    
                    if (dist < 30) {
                        this.collectItem(collectible);
                        collectible.collected = true;
                    }
                });
                
                this.collectibles = this.collectibles.filter(c => !c.collected && c.y < this.canvas.height);
                
                // Only check for level end after the game has been running for at least 1 second
                if (this.gameStartTime > 1.0) {
                    if (this.bubbles.length === 0 && this.collectibles.length === 0) {
                        this.endLevel(true);
                    } else if (this.bubblesRemaining <= 0 && !this.activeBubble && this.collectibles.length === 0) {
                        this.endLevel(true);
                    }
                }
                
                this.updateUI();
            }
            
            checkCollisions() {
                if (!this.activeBubble) return;
                
                for (let bubble of this.bubbles) {
                    const dist = Math.sqrt(
                        Math.pow(this.activeBubble.x - bubble.x, 2) + 
                        Math.pow(this.activeBubble.y - bubble.y, 2)
                    );
                    
                    if (dist < this.bubbleRadius * 1.8) {
                        this.attachBubble(bubble);
                        return;
                    }
                }
            }
            
            attachBubble(nearBubble) {
                const newBubble = {
                    x: this.activeBubble.x,
                    y: this.activeBubble.y,
                    color: this.activeBubble.color,
                    radius: this.bubbleRadius,
                    gridX: nearBubble.gridX,
                    gridY: nearBubble.gridY
                };
                
                if (this.activeBubble.type === 'explosive') {
                    this.explodeBubbles(newBubble.x, newBubble.y);
                    this.activeBubble = null;
                    return;
                } else if (this.activeBubble.type === 'converter') {
                    this.convertBubblesToGrey(newBubble.x, newBubble.y);
                }
                
                this.bubbles.push(newBubble);
                this.activeBubble = null;
                
                const matches = this.findMatches(newBubble);
                if (matches.length >= 3) {
                    this.popBubbles(matches);
                }
            }
            
            explodeBubbles(centerX, centerY) {
                const radius = 60;
                const bubblesInRange = [];
                
                for (let bubble of this.bubbles) {
                    const dist = Math.sqrt(
                        Math.pow(bubble.x - centerX, 2) + 
                        Math.pow(bubble.y - centerY, 2)
                    );
                    
                    if (dist <= radius) {
                        bubblesInRange.push(bubble);
                    }
                }
                
                for (let bubble of bubblesInRange) {
                    const index = this.bubbles.indexOf(bubble);
                    if (index !== -1) {
                        this.bubbles.splice(index, 1);
                        
                        if (Math.random() < 0.6) {
                            this.collectibles.push({
                                x: bubble.x,
                                y: bubble.y,
                                type: Math.random() < 0.5 ? 'cash' : 'sweet',
                                collected: false
                            });
                        }
                    }
                }
                
                if (bubblesInRange.length > 0) {
                    this.cash += bubblesInRange.length * 150;
                    this.showQuote('LOLLAPALOOZA EXPLOSION! ' + bubblesInRange.length + ' bubbles destroyed!', 'Charlie Munger', 'POWERUP');
                }
            }
            
            convertBubblesToGrey(centerX, centerY) {
                const radius = 80;
                const bubblesInRange = [];
                
                for (let bubble of this.bubbles) {
                    const dist = Math.sqrt(
                        Math.pow(bubble.x - centerX, 2) + 
                        Math.pow(bubble.y - centerY, 2)
                    );
                    
                    if (dist <= radius) {
                        bubble.isGrey = true;
                        bubblesInRange.push(bubble);
                    }
                }
                
                if (bubblesInRange.length > 0) {
                    this.showQuote('GRAHAM NETS! ' + bubblesInRange.length + ' bubbles converted for chain reactions!', 'Benjamin Graham', 'POWERUP');
                }
            }
            
            findMatches(startBubble) {
                const visited = new Set();
                const matches = [];
                const stack = [startBubble];
                
                while (stack.length > 0) {
                    const bubble = stack.pop();
                    const key = bubble.x + ',' + bubble.y;
                    
                    if (visited.has(key)) continue;
                    visited.add(key);
                    
                    if (bubble.isGrey || startBubble.isGrey || bubble.color === startBubble.color) {
                        matches.push(bubble);
                        
                        const neighbors = this.bubbles.filter(b => {
                            if (b === bubble) return false;
                            const dist = Math.sqrt(
                                Math.pow(b.x - bubble.x, 2) + 
                                Math.pow(b.y - bubble.y, 2)
                            );
                            return dist < this.bubbleRadius * 2.2;
                        });
                        
                        for (let neighbor of neighbors) {
                            const neighborKey = neighbor.x + ',' + neighbor.y;
                            if (!visited.has(neighborKey)) {
                                if (bubble.isGrey || neighbor.isGrey || neighbor.color === startBubble.color) {
                                    stack.push(neighbor);
                                }
                            }
                        }
                    }
                }
                
                return matches;
            }
            
            popBubbles(matches) {
                for (let bubble of matches) {
                    const index = this.bubbles.indexOf(bubble);
                    if (index !== -1) {
                        this.bubbles.splice(index, 1);
                        
                        const rand = Math.random();
                        if (rand < 0.05) {
                            this.collectibles.push({
                                x: bubble.x,
                                y: bubble.y,
                                type: 'book',
                                collected: false
                            });
                        } else if (rand < 0.35) {
                            this.collectibles.push({
                                x: bubble.x,
                                y: bubble.y,
                                type: 'cash',
                                collected: false
                            });
                        } else if (rand < 0.50) {
                            this.collectibles.push({
                                x: bubble.x,
                                y: bubble.y,
                                type: 'sweet',
                                collected: false
                            });
                        }
                    }
                }
                
                if (matches.length >= 15) {
                    this.showQuote('EXCEPTIONAL CLUSTER! ' + matches.length + ' bubbles!', 'Warren Buffett', 'WISDOM');
                    this.cash += matches.length * 500;
                    this.sugar = Math.min(this.maxSugar, this.sugar + 10);
                    this.books += 1;
                } else if (matches.length >= 8) {
                    this.showQuote('GREAT PATIENCE! ' + matches.length + ' bubbles!', '', 'GAME');
                    this.cash += matches.length * 200;
                    this.sugar = Math.min(this.maxSugar, this.sugar + 5);
                } else if (matches.length >= 5) {
                    this.showQuote('Good cluster! ' + matches.length + ' bubbles.', '', 'GAME');
                    this.cash += matches.length * 100;
                } else {
                    this.showQuote('Price is what you pay. Value is what you get.', 'Warren Buffett', 'WISDOM');
                }
            }
            
            collectItem(collectible) {
                switch (collectible.type) {
                    case 'cash':
                        this.cash += 100;
                        break;
                    case 'sweet':
                        this.sugar = Math.min(this.maxSugar, this.sugar + 10);
                        break;
                    case 'book':
                        this.books += 1;
                        this.showQuote('Knowledge is the best investment.', 'Business Education', 'BUSINESS');
                        break;
                }
            }
            
            retryLevel() {
                this.sugar = this.maxSugar;
                this.bubblesRemaining = 3;
                this.applyOwnedSubsidiaryPerks();
                this.generateInitialBubbles();
                this.gameRunning = true;
            }
            
            restart() {
                // Reset game state and restart
                gameState = {
                    year: 1955,
                    books: 5,
                    cash: 0,
                    lives: 3,
                    ownedBooks: [],
                    ownedSubsidiaries: [],
                    ownedUpgrades: {},
                    gamePhase: 'playing',
                    currentGame: null
                };
                
                this.initGameState();
                this.generateInitialBubbles();
            }
            
            showQuote(text, author, category) {
                document.getElementById('quoteText').textContent = text;
                document.getElementById('quoteAuthor').textContent = author ? '- ' + author : '';
                document.getElementById('quoteCategory').textContent = category || 'GAME';
                
                const categoryEl = document.getElementById('quoteCategory');
                switch(category) {
                    case 'WISDOM':
                        categoryEl.style.background = 'rgba(243, 156, 18, 0.8)';
                        break;
                    case 'BUSINESS':
                        categoryEl.style.background = 'rgba(46, 204, 113, 0.8)';
                        break;
                    case 'POWERUP':
                        categoryEl.style.background = 'rgba(155, 89, 182, 0.8)';
                        break;
                    default:
                        categoryEl.style.background = 'rgba(52, 152, 219, 0.8)';
                }
            }
            
            updateUI() {
                document.getElementById('booksValue').textContent = '📚 ' + this.books;
                document.getElementById('yearValue').textContent = this.year;
                document.getElementById('cashValue').textContent = '
            
            render() {
                this.ctx.fillStyle = '#2c3e50';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                for (let bubble of this.bubbles) {
                    this.drawBubble(bubble);
                }
                
                if (this.activeBubble) {
                    this.drawBubble(this.activeBubble);
                }
                
                if (this.isAiming && this.trajectory.length > 0) {
                    this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
                    this.ctx.lineWidth = 2;
                    this.ctx.setLineDash([5, 5]);
                    this.ctx.beginPath();
                    this.ctx.moveTo(this.cannon.x, this.cannon.y);
                    for (let point of this.trajectory) {
                        this.ctx.lineTo(point.x, point.y);
                    }
                    this.ctx.stroke();
                    this.ctx.setLineDash([]);
                }
                
                this.ctx.save();
                this.ctx.translate(this.cannon.x, this.cannon.y);
                this.ctx.rotate(this.cannon.angle);
                this.ctx.fillStyle = '#34495e';
                this.ctx.fillRect(-5, -8, 25, 6);
                this.ctx.restore();
                
                this.ctx.beginPath();
                this.ctx.arc(this.cannon.x, this.cannon.y, 15, 0, Math.PI * 2);
                this.ctx.fillStyle = '#2c3e50';
                this.ctx.fill();
                
                if (this.nextBubbles.length > 0) {
                    const loadedBubble = {
                        x: this.cannon.x,
                        y: this.cannon.y - 5,
                        radius: this.bubbleRadius * 0.8,
                        color: this.nextBubbles[0],
                        type: this.currentBubbleType
                    };
                    this.drawCannonBubble(loadedBubble);
                    
                    if (this.specialAmmo.length > 0) {
                        this.ctx.fillStyle = 'rgba(243, 156, 18, 0.9)';
                        this.ctx.beginPath();
                        this.ctx.arc(this.cannon.x + 20, this.cannon.y - 15, 8, 0, Math.PI * 2);
                        this.ctx.fill();
                        
                        this.ctx.fillStyle = 'white';
                        this.ctx.font = 'bold 10px Arial';
                        this.ctx.textAlign = 'center';
                        this.ctx.fillText(this.specialAmmo.length, this.cannon.x + 20, this.cannon.y - 11);
                    }
                }
                
                for (let collectible of this.collectibles) {
                    this.ctx.beginPath();
                    this.ctx.arc(collectible.x, collectible.y, 8, 0, Math.PI * 2);
                    
                    if (collectible.type === 'cash') {
                        this.ctx.fillStyle = '#f1c40f';
                    } else if (collectible.type === 'sweet') {
                        this.ctx.fillStyle = '#e74c3c';
                    } else if (collectible.type === 'book') {
                        this.ctx.fillStyle = '#3498db';
                    }
                    
                    this.ctx.fill();
                    
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '10px Arial';
                    this.ctx.textAlign = 'center';
                    
                    if (collectible.type === 'cash') {
                        this.ctx.fillText('$', collectible.x, collectible.y + 3);
                    } else if (collectible.type === 'sweet') {
                        this.ctx.fillText('♥', collectible.x, collectible.y + 3);
                    } else if (collectible.type === 'book') {
                        this.ctx.fillText('📚', collectible.x, collectible.y + 3);
                    }
                }
            }
            
            drawBubble(bubble) {
                this.ctx.beginPath();
                this.ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                
                if (bubble.isGrey) {
                    this.ctx.fillStyle = '#7f8c8d';
                } else {
                    this.ctx.fillStyle = this.colors[bubble.color];
                }
                
                this.ctx.fill();
                
                this.ctx.beginPath();
                this.ctx.arc(bubble.x - bubble.radius * 0.3, bubble.y - bubble.radius * 0.3, 
                    bubble.radius * 0.3, 0, Math.PI * 2);
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
                this.ctx.fill();
                
                this.ctx.beginPath();
                this.ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                if (bubble.isGrey) {
                    this.ctx.strokeStyle = '#f1c40f';
                    this.ctx.lineWidth = 2;
                } else {
                    this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                    this.ctx.lineWidth = 1;
                }
                this.ctx.stroke();
            }
            
            drawCannonBubble(bubble) {
                this.ctx.beginPath();
                this.ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                this.ctx.fillStyle = this.colors[bubble.color];
                this.ctx.fill();
                
                if (bubble.type === 'explosive') {
                    this.ctx.beginPath();
                    this.ctx.arc(bubble.x, bubble.y, bubble.radius + 3, 0, Math.PI * 2);
                    this.ctx.strokeStyle = '#e74c3c';
                    this.ctx.lineWidth = 3;
                    this.ctx.stroke();
                    
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '12px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText('💥', bubble.x, bubble.y + 3);
                } else if (bubble.type === 'converter') {
                    this.ctx.beginPath();
                    this.ctx.arc(bubble.x, bubble.y, bubble.radius + 3, 0, Math.PI * 2);
                    this.ctx.strokeStyle = '#f1c40f';
                    this.ctx.lineWidth = 3;
                    this.ctx.stroke();
                    
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '12px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText('🕸️', bubble.x, bubble.y + 3);
                } else {
                    this.ctx.beginPath();
                    this.ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                    this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                    this.ctx.lineWidth = 1;
                    this.ctx.stroke();
                }
            }
            
            gameLoop() {
                const now = performance.now();
                const deltaTime = this.lastTime ? (now - this.lastTime) / 1000 : 0;
                this.lastTime = now;
                
                // Debug every 2 seconds to show the game loop is running
                if (Math.floor(now / 2000) !== Math.floor((now - 16) / 2000)) {
                    debugLog('Game loop running - deltaTime: ' + deltaTime.toFixed(3));
                }
                
                this.update(Math.min(deltaTime, 0.016));
                this.render();
                
                requestAnimationFrame(() => this.gameLoop());
            }
        }
        
        // Wait for DOM to be fully loaded and start game automatically
        try {
            debugLog('Registering event listener...');
            document.addEventListener('DOMContentLoaded', () => {
                debugLog('DOM loaded, starting game automatically...');
                startGame();
            });
            debugLog('Event listener registered');
        } catch (error) {
            debugLog('Error registering event listener: ' + error.message);
        }

        // Fallback - try to start game after a short delay regardless
        setTimeout(() => {
            debugLog('Fallback timer - attempting to start game...');
            if (!gameState.currentGame) {
                startGame();
            }
        }, 500);

        function startGame() {
            debugLog('startGame function called');
            
            // Initialize game state
            gameState = {
                year: 1955,
                books: 5,
                cash: 0,
                ownedBooks: [],
                ownedSubsidiaries: [],
                ownedUpgrades: {},
                gamePhase: 'playing',
                currentGame: null
            };
            
            debugLog('Game state initialized');
            
            // Start the game automatically
            setTimeout(() => {
                debugLog('Creating game...');
                try {
                    gameState.currentGame = new BubbleGame();
                    debugLog('Game created successfully');
                } catch (error) {
                    debugLog('Error creating game: ' + error.message);
                    debugLog('Error stack: ' + error.stack);
                }
            }, 100);
        // Test immediately when script loads
        try {
            debugLog('Script parsing...');
            debugLog('Testing objects...');
            
            // Test if our data objects are valid
            if (typeof books !== 'undefined') {
                debugLog('Books object loaded');
            } else {
                debugLog('Books object MISSING');
            }
            
            if (typeof subsidiaries !== 'undefined') {
                debugLog('Subsidiaries object loaded');
            } else {
                debugLog('Subsidiaries object MISSING');
            }
            
            debugLog('Objects test complete');
        } catch (error) {
            debugLog('Error in script parsing: ' + error.message);
        }

        // Check if DOM is already loaded
        if (document.readyState === 'loading') {
            debugLog('DOM still loading...');
        } else {
            debugLog('DOM already loaded!');
        }

        debugLog('End of script reached');
    </script>
</body>
</html> + this.cash.toLocaleString();
                
                document.getElementById('cannonSugarFill').style.height = ((this.sugar / this.maxSugar) * 100) + '%';
                document.getElementById('bubblesRemaining').textContent = this.bubblesRemaining;
                
                const container = document.getElementById('nextBubblesContainer');
                container.innerHTML = '';
                for (let i = 0; i < this.nextBubbles.length; i++) {
                    const bubble = document.createElement('div');
                    bubble.className = 'next-bubble';
                    bubble.style.background = this.colors[this.nextBubbles[i]];
                    bubble.textContent = i + 1;
                    container.appendChild(bubble);
                }
            }
            
            render() {
                this.ctx.fillStyle = '#2c3e50';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                for (let bubble of this.bubbles) {
                    this.drawBubble(bubble);
                }
                
                if (this.activeBubble) {
                    this.drawBubble(this.activeBubble);
                }
                
                if (this.isAiming && this.trajectory.length > 0) {
                    this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
                    this.ctx.lineWidth = 2;
                    this.ctx.setLineDash([5, 5]);
                    this.ctx.beginPath();
                    this.ctx.moveTo(this.cannon.x, this.cannon.y);
                    for (let point of this.trajectory) {
                        this.ctx.lineTo(point.x, point.y);
                    }
                    this.ctx.stroke();
                    this.ctx.setLineDash([]);
                }
                
                this.ctx.save();
                this.ctx.translate(this.cannon.x, this.cannon.y);
                this.ctx.rotate(this.cannon.angle);
                this.ctx.fillStyle = '#34495e';
                this.ctx.fillRect(-5, -8, 25, 6);
                this.ctx.restore();
                
                this.ctx.beginPath();
                this.ctx.arc(this.cannon.x, this.cannon.y, 15, 0, Math.PI * 2);
                this.ctx.fillStyle = '#2c3e50';
                this.ctx.fill();
                
                if (this.nextBubbles.length > 0) {
                    const loadedBubble = {
                        x: this.cannon.x,
                        y: this.cannon.y - 5,
                        radius: this.bubbleRadius * 0.8,
                        color: this.nextBubbles[0],
                        type: this.currentBubbleType
                    };
                    this.drawCannonBubble(loadedBubble);
                    
                    if (this.specialAmmo.length > 0) {
                        this.ctx.fillStyle = 'rgba(243, 156, 18, 0.9)';
                        this.ctx.beginPath();
                        this.ctx.arc(this.cannon.x + 20, this.cannon.y - 15, 8, 0, Math.PI * 2);
                        this.ctx.fill();
                        
                        this.ctx.fillStyle = 'white';
                        this.ctx.font = 'bold 10px Arial';
                        this.ctx.textAlign = 'center';
                        this.ctx.fillText(this.specialAmmo.length, this.cannon.x + 20, this.cannon.y - 11);
                    }
                }
                
                for (let collectible of this.collectibles) {
                    this.ctx.beginPath();
                    this.ctx.arc(collectible.x, collectible.y, 8, 0, Math.PI * 2);
                    
                    if (collectible.type === 'cash') {
                        this.ctx.fillStyle = '#f1c40f';
                    } else if (collectible.type === 'sweet') {
                        this.ctx.fillStyle = '#e74c3c';
                    } else if (collectible.type === 'book') {
                        this.ctx.fillStyle = '#3498db';
                    }
                    
                    this.ctx.fill();
                    
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '10px Arial';
                    this.ctx.textAlign = 'center';
                    
                    if (collectible.type === 'cash') {
                        this.ctx.fillText('$', collectible.x, collectible.y + 3);
                    } else if (collectible.type === 'sweet') {
                        this.ctx.fillText('♥', collectible.x, collectible.y + 3);
                    } else if (collectible.type === 'book') {
                        this.ctx.fillText('📚', collectible.x, collectible.y + 3);
                    }
                }
            }
            
            drawBubble(bubble) {
                this.ctx.beginPath();
                this.ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                
                if (bubble.isGrey) {
                    this.ctx.fillStyle = '#7f8c8d';
                } else {
                    this.ctx.fillStyle = this.colors[bubble.color];
                }
                
                this.ctx.fill();
                
                this.ctx.beginPath();
                this.ctx.arc(bubble.x - bubble.radius * 0.3, bubble.y - bubble.radius * 0.3, 
                    bubble.radius * 0.3, 0, Math.PI * 2);
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
                this.ctx.fill();
                
                this.ctx.beginPath();
                this.ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                if (bubble.isGrey) {
                    this.ctx.strokeStyle = '#f1c40f';
                    this.ctx.lineWidth = 2;
                } else {
                    this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                    this.ctx.lineWidth = 1;
                }
                this.ctx.stroke();
            }
            
            drawCannonBubble(bubble) {
                this.ctx.beginPath();
                this.ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                this.ctx.fillStyle = this.colors[bubble.color];
                this.ctx.fill();
                
                if (bubble.type === 'explosive') {
                    this.ctx.beginPath();
                    this.ctx.arc(bubble.x, bubble.y, bubble.radius + 3, 0, Math.PI * 2);
                    this.ctx.strokeStyle = '#e74c3c';
                    this.ctx.lineWidth = 3;
                    this.ctx.stroke();
                    
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '12px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText('💥', bubble.x, bubble.y + 3);
                } else if (bubble.type === 'converter') {
                    this.ctx.beginPath();
                    this.ctx.arc(bubble.x, bubble.y, bubble.radius + 3, 0, Math.PI * 2);
                    this.ctx.strokeStyle = '#f1c40f';
                    this.ctx.lineWidth = 3;
                    this.ctx.stroke();
                    
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '12px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText('🕸️', bubble.x, bubble.y + 3);
                } else {
                    this.ctx.beginPath();
                    this.ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                    this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                    this.ctx.lineWidth = 1;
                    this.ctx.stroke();
                }
            }
            
            gameLoop() {
                const now = performance.now();
                const deltaTime = this.lastTime ? (now - this.lastTime) / 1000 : 0;
                this.lastTime = now;
                
                this.update(Math.min(deltaTime, 0.016));
                this.render();
                
                requestAnimationFrame(() => this.gameLoop());
            }
        }
        
        // Wait for DOM to be fully loaded and start game automatically
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, starting game automatically...');
            
            // Initialize game state
            gameState = {
                year: 1955,
                books: 5,
                cash: 0,
                lives: 3,
                ownedBooks: [],
                ownedSubsidiaries: [],
                ownedUpgrades: {},
                gamePhase: 'playing',
                currentGame: null
            };
            
            // Start the game automatically
            setTimeout(() => {
                console.log('Creating game...');
                gameState.currentGame = new BubbleGame();
            }, 100);
        });
    </script>
</body>
                </html>
