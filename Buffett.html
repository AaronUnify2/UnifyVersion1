<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Warren Buffett's Bubble Pop Adventure</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            background: #1a1a1a;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            touch-action: none;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* Main Menu Styles */
        #mainMenuScreen {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
        }

        .menu-title {
            font-size: 36px;
            color: #f39c12;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .menu-subtitle {
            font-size: 18px;
            color: #ecf0f1;
            margin-bottom: 40px;
            max-width: 600px;
            line-height: 1.5;
        }

        .menu-button {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            border: none;
            color: white;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .menu-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }

        /* Game Screen Styles */
        #gameScreen {
            display: grid;
            grid-template-areas: 
                "topbar topbar topbar"
                "game game powerups"
                "next next powerups"
                "quotes quotes quotes";
            grid-template-rows: 60px 2fr 80px 1fr;
            grid-template-columns: 1fr 1fr 80px;
        }

        #topBar {
            grid-area: topbar;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            padding: 8px;
            border-bottom: 2px solid #34495e;
        }

        .stat-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .stat-title {
            font-size: 12px;
            color: #bdc3c7;
            margin-bottom: 2px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: bold;
        }

        #booksValue { color: #3498db; }
        #yearValue { color: #f39c12; }
        #cashValue { color: #2ecc71; }

        #gameArea {
            grid-area: game;
            position: relative;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            overflow: hidden;
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
            touch-action: none;
            cursor: crosshair;
        }

        #powerUps {
            grid-area: powerups;
            background: rgba(0, 0, 0, 0.8);
            border-left: 2px solid #34495e;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 5px;
        }

        #livesContainer {
            display: flex;
            gap: 3px;
            margin-bottom: 10px;
        }

        .life {
            width: 12px;
            height: 12px;
            background: #e74c3c;
            border-radius: 50%;
            border: 1px solid #fff;
        }

        .powerup-slot {
            width: 50px;
            height: 50px;
            background: rgba(52, 73, 94, 0.5);
            border: 2px solid #7f8c8d;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .powerup-slot:hover {
            border-color: #f39c12;
            background: rgba(243, 156, 18, 0.2);
        }

        .powerup-slot.active {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.3);
        }

        .powerup-icon {
            font-size: 20px;
            line-height: 1;
        }

        .powerup-count {
            font-size: 10px;
            color: white;
            background: rgba(243, 156, 18, 0.9);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: -2px;
            right: -2px;
            font-weight: bold;
        }

        #nextBubbles {
            grid-area: next;
            background: rgba(0, 0, 0, 0.8);
            border-top: 2px solid #34495e;
            display: flex;
            align-items: center;
            padding: 10px;
        }

        .next-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .cannon-display {
            width: 60px;
            height: 40px;
            background: #34495e;
            border: 2px solid #fff;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .cannon-sugar-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(0deg, #e74c3c, #f39c12);
            transition: height 0.3s ease;
            height: 100%;
        }

        .next-bubbles-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .next-bubble {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            font-weight: bold;
        }

        .next-label {
            color: #bdc3c7;
            font-size: 12px;
            margin-right: 10px;
        }

        .bubbles-remaining {
            color: #f39c12;
            font-size: 14px;
            font-weight: bold;
            margin-left: auto;
            margin-right: 20px;
        }

        #quotes {
            grid-area: quotes;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(44, 62, 80, 0.8));
            border-top: 3px solid #f39c12;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 15px;
            overflow: hidden;
            position: relative;
        }

        #quotes::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="50" x="10" font-size="60" opacity="0.1" fill="%23f39c12">"</text><text y="50" x="80" font-size="60" opacity="0.1" fill="%23f39c12">"</text></svg>');
            background-size: 200px 100px;
            background-repeat: no-repeat;
            background-position: 10px center, calc(100% - 10px) center;
            pointer-events: none;
        }

        #quoteText {
            color: #ecf0f1;
            font-size: 14px;
            text-align: center;
            font-style: italic;
            line-height: 1.4;
            max-width: 90%;
            animation: fadeIn 0.5s ease-in;
            z-index: 1;
            margin-bottom: 8px;
        }

        #quoteAuthor {
            color: #f39c12;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            z-index: 1;
        }

        .quote-category {
            position: absolute;
            top: 8px;
            right: 15px;
            background: rgba(243, 156, 18, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            z-index: 1;
        }

        /* Store Screen Styles */
        #storeScreen {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            overflow-y: auto;
        }

        .store-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #f39c12;
            padding-bottom: 20px;
        }

        .store-title {
            font-size: 24px;
            color: #f39c12;
            margin-bottom: 10px;
        }

        .store-cash {
            font-size: 18px;
            color: #2ecc71;
        }

        .store-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .store-category {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #34495e;
            border-radius: 10px;
            padding: 20px;
        }

        .category-title {
            font-size: 18px;
            color: #f39c12;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 1px solid #f39c12;
            padding-bottom: 5px;
        }

        .store-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(52, 73, 94, 0.3);
            border: 1px solid #7f8c8d;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .store-item:hover {
            border-color: #f39c12;
            background: rgba(243, 156, 18, 0.1);
        }

        .store-item.unavailable {
            opacity: 0.5;
            background: rgba(127, 140, 141, 0.2);
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: bold;
            color: #ecf0f1;
            margin-bottom: 5px;
        }

        .item-description {
            font-size: 12px;
            color: #bdc3c7;
            margin-bottom: 5px;
        }

        .item-effect {
            font-size: 11px;
            color: #f39c12;
            font-style: italic;
        }

        .item-price {
            color: #2ecc71;
            font-weight: bold;
            margin-right: 10px;
        }

        .item-price.books {
            color: #3498db;
        }

        .buy-button {
            background: #27ae60;
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .buy-button:hover {
            background: #2ecc71;
        }

        .buy-button:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }

        /* Investment Screen Styles */
        #investmentScreen {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 20px;
            overflow-y: auto;
        }

        .investment-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #f39c12;
            padding-bottom: 20px;
        }

        .investment-title {
            font-size: 24px;
            color: #f39c12;
            margin-bottom: 10px;
        }

        .portfolio-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #34495e;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }

        .summary-title {
            font-size: 12px;
            color: #bdc3c7;
            margin-bottom: 5px;
        }

        .summary-value {
            font-size: 16px;
            font-weight: bold;
            color: #2ecc71;
        }

        .investment-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .investment-section {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #34495e;
            border-radius: 10px;
            padding: 20px;
        }

        .section-title {
            font-size: 18px;
            color: #f39c12;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 1px solid #f39c12;
            padding-bottom: 5px;
        }

        .stock-item {
            display: grid;
            grid-template-columns: 1fr auto auto;
            align-items: center;
            background: rgba(52, 73, 94, 0.3);
            border: 1px solid #7f8c8d;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            gap: 10px;
        }

        .stock-info {
            display: flex;
            flex-direction: column;
        }

        .stock-name {
            font-weight: bold;
            color: #ecf0f1;
        }

        .stock-details {
            font-size: 12px;
            color: #bdc3c7;
        }

        .stock-actions {
            display: flex;
            gap: 5px;
        }

        .action-button {
            background: #3498db;
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            transition: background 0.3s ease;
        }

        .action-button.sell {
            background: #e74c3c;
        }

        .action-button:hover {
            opacity: 0.8;
        }

        .subsidiary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(52, 152, 219, 0.3);
            border: 1px solid #3498db;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .subsidiary-info {
            flex: 1;
        }

        .subsidiary-name {
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .subsidiary-perk {
            font-size: 12px;
            color: #f39c12;
        }

        .subsidiary-income {
            color: #2ecc71;
            font-weight: bold;
        }

        /* Level Complete Overlay */
        .level-complete-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .level-complete-content {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            border: 3px solid #f39c12;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            color: white;
            max-width: 400px;
        }

        .level-complete-title {
            font-size: 24px;
            color: #f39c12;
            margin-bottom: 20px;
        }

        .level-stats {
            margin-bottom: 20px;
        }

        .stat-line {
            margin-bottom: 10px;
            font-size: 16px;
        }

        .continue-button {
            background: #27ae60;
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        .continue-button:hover {
            background: #2ecc71;
        }

        /* Navigation during store/invest phases */
        .phase-navigation {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 10px;
            z-index: 1000;
        }

        .phase-navigation.active {
            display: flex;
        }

        .nav-button {
            background: #34495e;
            border: 2px solid #f39c12;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .nav-button:hover {
            background: #f39c12;
            color: #2c3e50;
        }

        .nav-button.current {
            background: #f39c12;
            color: #2c3e50;
        }

        .market-closed-notice {
            text-align: center;
            color: #e74c3c;
            font-size: 18px;
            font-weight: bold;
            padding: 40px;
            background: rgba(231, 76, 60, 0.1);
            border: 2px solid #e74c3c;
            border-radius: 10px;
            margin: 20px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 600px) {
            #gameScreen {
                grid-template-columns: 1fr 1fr 60px;
                grid-template-rows: 50px 2fr 70px 1fr;
            }
            
            .stat-title { font-size: 10px; }
            .stat-value { font-size: 14px; }
            .powerup-slot { width: 40px; height: 40px; }
            .powerup-icon { font-size: 16px; }
            .powerup-count { font-size: 8px; width: 12px; height: 12px; }
            #quoteText { font-size: 12px; }
            #quoteAuthor { font-size: 10px; }
            
            .store-categories {
                grid-template-columns: 1fr;
            }
            
            .investment-sections {
                grid-template-columns: 1fr;
            }
            
            .menu-title {
                font-size: 28px;
            }
            
            .menu-subtitle {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Main Menu Screen -->
    <div id="mainMenuScreen" class="screen active">
        <div class="menu-title">Warren Buffett's<br>Bubble Pop Adventure</div>
        <div class="menu-subtitle">
            Learn the power of patience and compound growth through bubble-popping gameplay<br>
            Experience 70+ years of market history while building your investment empire
        </div>
        <button class="menu-button" onclick="game.startNewGame()">New Game</button>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="screen">
        <div id="topBar">
            <div class="stat-section">
                <div class="stat-title">BOOKS</div>
                <div class="stat-value" id="booksValue">📚 5</div>
            </div>
            <div class="stat-section">
                <div class="stat-title">YEAR</div>
                <div class="stat-value" id="yearValue">1955</div>
            </div>
            <div class="stat-section">
                <div class="stat-title">$CASH</div>
                <div class="stat-value" id="cashValue">$1000</div>
            </div>
        </div>

        <div id="gameArea">
            <canvas id="gameCanvas"></canvas>
        </div>

        <div id="powerUps">
            <div id="livesContainer">
                <div class="life"></div>
                <div class="life"></div>
                <div class="life"></div>
            </div>

            <div class="powerup-slot" id="lollapalooza">
                <div class="powerup-icon">💥</div>
                <div class="powerup-count">1</div>
            </div>
            <div class="powerup-slot" id="grahamNets">
                <div class="powerup-icon">🕸️</div>
                <div class="powerup-count">1</div>
            </div>
            <div class="powerup-slot" id="coke">
                <div class="powerup-icon">🥤</div>
                <div class="powerup-count">1</div>
            </div>
        </div>

        <div id="nextBubbles">
            <div class="next-section">
                <div class="cannon-display">
                    <div class="cannon-sugar-fill" id="cannonSugarFill"></div>
                </div>
                <div class="next-label">Sugar:</div>
                <div class="next-bubbles-container" id="nextBubblesContainer">
                    <div class="next-bubble" style="background: #e74c3c;">1</div>
                    <div class="next-bubble" style="background: #3498db;">2</div>
                    <div class="next-bubble" style="background: #2ecc71;">3</div>
                </div>
            </div>
            <div class="bubbles-remaining">
                Shots: <span id="bubblesRemaining">3</span>
            </div>
        </div>

        <div id="quotes">
            <div class="quote-category" id="quoteCategory">WISDOM</div>
            <div id="quoteText">
                Welcome to 1955! Build your capital for the great opportunities ahead.
            </div>
            <div id="quoteAuthor">- Warren Buffett</div>
        </div>
    </div>

    <!-- Store Screen -->
    <div id="storeScreen" class="screen">
        <div class="store-header">
            <div class="store-title">Buffett's General Store</div>
            <div class="store-cash">Available Cash: $<span id="storeCash">0</span> | Books: 📚<span id="storeBooks">0</span></div>
        </div>

        <div class="store-categories" id="storeCategories">
            <!-- Store categories will be populated by JavaScript -->
        </div>
    </div>

    <!-- Investment Screen -->
    <div id="investmentScreen" class="screen">
        <div class="investment-header">
            <div class="investment-title">Investment Board - <span id="investmentYear">1955</span></div>
            <div class="portfolio-summary">
                <div class="summary-card">
                    <div class="summary-title">PORTFOLIO VALUE</div>
                    <div class="summary-value" id="portfolioValue">$0</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">CASH</div>
                    <div class="summary-value" id="investmentCash">$0</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">YEARLY INCOME</div>
                    <div class="summary-value" id="yearlyIncome">$0</div>
                </div>
                <div class="summary-card">
                    <div class="summary-title">TOTAL ASSETS</div>
                    <div class="summary-value" id="totalAssets">$0</div>
                </div>
            </div>
        </div>

        <div class="investment-sections">
            <div class="investment-section">
                <div class="section-title">Public Stocks</div>
                <div id="stocksList">
                    <!-- Stocks will be populated by JavaScript -->
                </div>
            </div>

            <div class="investment-section">
                <div class="section-title">Owned Subsidiaries</div>
                <div id="subsidiariesList">
                    <!-- Subsidiaries will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Level Complete Overlay -->
    <div class="level-complete-overlay" id="levelCompleteOverlay">
        <div class="level-complete-content">
            <div class="level-complete-title" id="levelCompleteTitle">Year 1955 Complete!</div>
            <div class="level-stats" id="levelStats">
                <div class="stat-line">Bubbles Popped: <span id="bubblesPopped">0</span></div>
                <div class="stat-line">Cash Earned: $<span id="cashEarned">0</span></div>
                <div class="stat-line">Books Found: <span id="booksFound">0</span></div>
            </div>
            <button class="continue-button" id="continueButton">Continue to Store</button>
        </div>
    </div>

    <!-- Phase Navigation (shown during store/invest phases) -->
    <div class="phase-navigation" id="phaseNavigation">
        <button class="nav-button current" id="storeNavBtn" onclick="game.switchToStore()">Store</button>
        <button class="nav-button" id="investNavBtn" onclick="game.switchToInvest()">Invest</button>
        <button class="nav-button" id="continueNavBtn" onclick="game.continueToNextYear()">Continue to <span id="nextYearSpan">1956</span></button>
    </div>

    <script>
        // Game Data
        const subsidiaries = {
            "See's Candies": {
                price: 25, // Cost in books
                yearlyIncome: 150,
                gameplayPerk: "Sugar depletes 25% slower",
                perkDescription: "Quality candy extends energy",
                unlocks: ["GEICO"],
                availableFrom: 1972,
                bookRequirement: "Poor Charlie's Almanack"
            },
            "GEICO": {
                price: 40,
                yearlyIncome: 400,
                gameplayPerk: "+2 starting bubbles per level",
                perkDescription: "Insurance provides backup shots",
                unlocks: ["Dairy Queen"],
                availableFrom: 1976,
                requires: ["See's Candies"]
            },
            "Dairy Queen": {
                price: 60,
                yearlyIncome: 600,
                gameplayPerk: "+20% trajectory line length",
                perkDescription: "Smooth operations improve aiming precision",
                unlocks: ["Nebraska Furniture Mart"],
                availableFrom: 1998,
                requires: ["GEICO"]
            },
            "Nebraska Furniture Mart": {
                price: 80,
                yearlyIncome: 800,
                gameplayPerk: "Remove yellow bubbles permanently from game",
                perkDescription: "Furniture efficiency eliminates one color complexity",
                unlocks: ["Fruit of the Loom"],
                availableFrom: 1983,
                requires: ["Dairy Queen"]
            },
            "Fruit of the Loom": {
                price: 100,
                yearlyIncome: 1000,
                gameplayPerk: "Bubble scroll speed reduced by 15%",
                perkDescription: "Textile quality slows the rush of time",
                unlocks: ["Gillette"],
                availableFrom: 2002,
                requires: ["Nebraska Furniture Mart"]
            },
            "Gillette": {
                price: 120,
                yearlyIncome: 1500,
                gameplayPerk: "Start each level with 1 Graham Net powerup",
                perkDescription: "Precision engineering provides strategic tools",
                unlocks: ["Duracell"],
                availableFrom: 2005,
                requires: ["Fruit of the Loom"]
            },
            "Duracell": {
                price: 150,
                yearlyIncome: 2000,
                gameplayPerk: "Start each level with 1 Lollapalooza powerup",
                perkDescription: "Long-lasting power energizes explosive potential",
                unlocks: ["BNSF Railway"],
                availableFrom: 2014,
                requires: ["Gillette"]
            },
            "BNSF Railway": {
                price: 200,
                yearlyIncome: 3500,
                gameplayPerk: "+3 starting bubbles AND remove orange bubbles permanently",
                perkDescription: "Transportation empire delivers maximum efficiency",
                availableFrom: 2009,
                requires: ["Duracell"],
                finalSubsidiary: true
            }
        };

        const books = {
            "The Intelligent Investor": { price: 10, bookValue: 50 },
            "Common Stocks and Uncommon Profits": { price: 15, bookValue: 75 },
            "Poor Charlie's Almanack": { price: 20, bookValue: 100 },
            "The Little Book of Common Sense Investing": { price: 8, bookValue: 40 },
            "Essays of Warren Buffett": { price: 25, bookValue: 100 }
        };

        const powerups = {
            "Munger's Lollapaloozas": { price: 200, effect: "Destroys 3x3 area" },
            "Graham's Nets": { price: 300, effect: "Turns hit bubbles grey for chain pops" },
            "Coke": { price: 50, effect: "Restore 20% sugar (consumable)" }
        };

        // Historical stock data with real prices by year
        const stockData = {
            "KO": { 
                name: "Coca-Cola", 
                startYear: 1963,
                prices: {
                    1963: 0.0667, 1964: 0.0768, 1965: 0.1000, 1966: 0.1338, 1967: 0.1866, 1968: 0.2870, 1969: 0.4525, 1970: 0.4774, 1971: 0.9287, 1972: 1.5990, 1973: 0.6382, 1974: 0.2887, 1975: 0.6737, 1976: 0.6382, 1977: 0.5403, 1978: 0.5420, 1979: 0.6062, 1980: 0.6923, 1981: 0.7057, 1982: 0.8725, 1983: 0.7416, 1984: 0.8596, 1985: 1.6429, 1986: 2.5311, 1987: 3.4902, 1988: 3.8974, 1989: 6.6733, 1990: 6.0778, 1991: 6.8976, 1992: 10.4214, 1993: 10.3906, 1994: 11.2914, 1995: 14.5687, 1996: 17.3528, 1997: 24.7930, 1998: 22.6800, 1999: 22.3554, 2000: 22.2690, 2001: 16.1144, 2002: 12.8429, 2003: 18.5453, 2004: 22.2960, 2005: 19.4287, 2006: 28.0288, 2007: 27.0516, 2008: 19.2999, 2009: 27.7479, 2010: 32.6266, 2011: 33.1657, 2012: 44.7114, 2013: 69.4541, 2014: 86.7151, 2015: 97.9273, 2016: 98.5853, 2017: 103.2780, 2018: 107.0040, 2019: 142.8650, 2020: 178.9690, 2021: 153.0000, 2022: 85.8198, 2023: 89.4789, 2024: 111.3500, 2025: 92.49
                }
            },
            "DIS": { 
                name: "Disney", 
                startYear: 1963,
                prices: {
                    1963: 0.07, 1964: 0.08, 1965: 0.10, 1966: 0.13, 1967: 0.19, 1968: 0.29, 1969: 0.45, 1970: 0.48, 1971: 0.93, 1972: 1.60, 1973: 0.64, 1974: 0.29, 1975: 0.67, 1976: 0.64, 1977: 0.54, 1978: 0.54, 1979: 0.61, 1980: 0.69, 1981: 0.71, 1982: 0.87, 1983: 0.74, 1984: 0.86, 1985: 1.64, 1986: 2.53, 1987: 3.49, 1988: 3.90, 1989: 6.67, 1990: 6.08, 1991: 6.90, 1992: 10.42, 1993: 10.39, 1994: 11.29, 1995: 14.57, 1996: 17.35, 1997: 24.79, 1998: 22.68, 1999: 22.36, 2000: 22.27, 2001: 16.11, 2002: 12.84, 2003: 18.55, 2004: 22.30, 2005: 19.43, 2006: 28.03, 2007: 27.05, 2008: 19.30, 2009: 27.75, 2010: 32.63, 2011: 33.17, 2012: 44.71, 2013: 69.45, 2014: 86.72, 2015: 97.93, 2016: 98.59, 2017: 103.28, 2018: 107.00, 2019: 142.87, 2020: 178.97, 2021: 153.00, 2022: 85.82, 2023: 89.48, 2024: 111.35, 2025: 92.49
                }
            },
            "AAPL": { 
                name: "Apple", 
                startYear: 1981,
                prices: {
                    1981: 0.0760, 1982: 0.1026, 1983: 0.0837, 1984: 0.1000, 1985: 0.0755, 1986: 0.1391, 1987: 0.2899, 1988: 0.2802, 1989: 0.2478, 1990: 0.3060, 1991: 0.4049, 1992: 0.4330, 1993: 0.2146, 1994: 0.2901, 1995: 0.2398, 1996: 0.1571, 1997: 0.0988, 1998: 0.3080, 1999: 0.7735, 2000: 0.2238, 2001: 0.3295, 2002: 0.2156, 2003: 0.3215, 2004: 0.9690, 2005: 2.1634, 2006: 2.5531, 2007: 5.9610, 2008: 2.5685, 2009: 6.3417, 2010: 9.7070, 2011: 12.1879, 2012: 16.1572, 2013: 17.4609, 2014: 24.5540, 2015: 23.8140, 2016: 26.7861, 2017: 39.7678, 2018: 37.6242, 2019: 71.0940, 2020: 129.6090, 2021: 174.5160, 2022: 128.4370, 2023: 191.3810, 2024: 250.1450, 2025: 202.52
                }
            },
            "BRK": { 
                name: "Berkshire Hathaway", 
                startYear: 1981,
                prices: {
                    1981: 560.00, 1982: 775.00, 1983: 1310.00, 1984: 1275.00, 1985: 2470.00, 1986: 2820.00, 1987: 2950.00, 1988: 4700.00, 1989: 8675.00, 1990: 6675.00, 1991: 9050.00, 1992: 11750.00, 1993: 16325.00, 1994: 20400.00, 1995: 32100.00, 1996: 34100.00, 1997: 46000.00, 1998: 70000.00, 1999: 56100.00, 2000: 71000.00, 2001: 75600.00, 2002: 72750.00, 2003: 84250.00, 2004: 87900.00, 2005: 88620.00, 2006: 109990.00, 2007: 141600.00, 2008: 96600.00, 2009: 99200.00, 2010: 120450.00, 2011: 114755.00, 2012: 134060.00, 2013: 177900.00, 2014: 226000.00, 2015: 197800.00, 2016: 244121.00, 2017: 297600.00, 2018: 306000.00, 2019: 339590.00, 2020: 347815.00, 2021: 450662.00, 2022: 468711.00, 2023: 542625.00, 2024: 680920.00, 2025: 795000.00
                }
            },
            "BAC": { 
                name: "Bank of America", 
                startYear: 1985,
                prices: {
                    1985: 1.8605, 1986: 1.8245, 1987: 1.5195, 1988: 2.4973, 1989: 4.3485, 1990: 2.2464, 1991: 4.1450, 1992: 5.4298, 1993: 5.3525, 1994: 5.1157, 1995: 8.1748, 1996: 11.8058, 1997: 15.0259, 1998: 15.2195, 1999: 13.0888, 2000: 12.5007, 2001: 17.8383, 2002: 20.4333, 2003: 24.5517, 2004: 29.8364, 2005: 30.5533, 2006: 36.8783, 2007: 29.9343, 2008: 11.0479, 2009: 11.8743, 2010: 10.5495, 2011: 4.4180, 2012: 9.2700, 2013: 12.4692, 2014: 14.4312, 2015: 13.7420, 2016: 18.3275, 2017: 24.8677, 2018: 21.1416, 2019: 30.9070, 2020: 27.3116, 2021: 40.8606, 2022: 31.1264, 2023: 32.6285, 2024: 43.6744, 2025: 43.20
                }
            }
        };

        class BubbleGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.gamePhase = 'menu'; // menu, playing, store, invest
                
                this.setupCanvas();
                this.setupEventListeners();
                
                this.lastTime = 0;
                this.gameLoop();
            }

            startNewGame() {
                this.initGameState();
                this.generateInitialBubbles();
                this.switchScreen('game');
                this.gamePhase = 'playing';
            }
            
            setupCanvas() {
                const gameArea = document.getElementById('gameArea');
                this.canvas.width = gameArea.clientWidth || 800;
                this.canvas.height = gameArea.clientHeight || 600;
                
                window.addEventListener('resize', () => {
                    const gameArea = document.getElementById('gameArea');
                    this.canvas.width = gameArea.clientWidth || 800;
                    this.canvas.height = gameArea.clientHeight || 600;
                    if (this.cannon) {
                        this.cannon.x = this.canvas.width / 2;
                        this.cannon.y = this.canvas.height - 30;
                    }
                });
            }
            
            initGameState() {
                this.year = 1955; // Start before stock market opens
                this.books = 5;
                this.ownedBooks = [];
                this.sugar = 60;
                this.maxSugar = 60;
                this.lives = 3;
                this.cash = 1000; // Starting cash
                this.bubblesRemaining = 3;
                this.gameRunning = true;
                
                // Investment tracking
                this.ownedStocks = {};
                this.ownedSubsidiaries = [];
                this.portfolioValue = 0;
                
                // Level stats
                this.levelStats = {
                    bubblesPopped: 0,
                    cashEarned: 0,
                    booksFound: 0
                };
                
                this.bubbles = [];
                this.activeBubble = null;
                this.nextBubbles = [];
                this.collectibles = [];
                
                this.bubbleRadius = Math.max(12, Math.min(18, this.canvas.width / 25));
                this.scrollSpeed = 30;
                this.spawnTimer = 0;
                this.spawnInterval = 0.8;
                
                this.cannon = {
                    x: this.canvas.width / 2,
                    y: this.canvas.height - 30,
                    angle: -Math.PI / 2,
                    power: 300
                };
                
                this.colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6'];
                this.availableColors = [0, 1, 2]; // Start with 3 colors
                
                this.isAiming = false;
                this.trajectory = [];
                
                this.powerups = {
                    lollapalooza: 1,
                    grahamNets: 1,
                    coke: 1
                };
                
                this.specialAmmo = [];
                this.currentBubbleType = 'normal';
                
                // Apply subsidiary perks
                this.applySubsidiaryPerks();
                
                for (let i = 0; i < 3; i++) {
                    this.nextBubbles.push(Math.floor(Math.random() * this.availableColors.length));
                }
                
                this.updateUI();
                this.showQuote('Welcome to 1955! Build your capital for the great opportunities ahead.', 'Warren Buffett', 'WISDOM');
            }

            switchScreen(screenName) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(screenName + 'Screen').classList.add('active');
                
                if (screenName === 'store') {
                    this.populateStore();
                } else if (screenName === 'investment') {
                    this.populateInvestments();
                }
            }

            getCurrentStockPrice(symbol) {
                const stock = stockData[symbol];
                if (!stock || this.year < stock.startYear) return 0;
                return stock.prices[this.year] || 0;
            }

            getYearOverYearChange(symbol) {
                const stock = stockData[symbol];
                if (!stock || this.year <= stock.startYear) return 0;
                
                const currentPrice = stock.prices[this.year];
                const lastYearPrice = stock.prices[this.year - 1];
                
                if (!currentPrice || !lastYearPrice) return 0;
                
                return ((currentPrice - lastYearPrice) / lastYearPrice) * 100;
            }

            applySubsidiaryPerks() {
                let baseBubbles = 3;
                let sugarDepletion = 1.0;
                let scrollSpeedModifier = 1.0;
                let trajectoryLength = 1.0;
                
                for (let subsidiary of this.ownedSubsidiaries) {
                    if (subsidiary === "GEICO") {
                        baseBubbles += 2;
                    } else if (subsidiary === "BNSF Railway") {
                        baseBubbles += 3;
                        this.availableColors = this.availableColors.filter(c => c !== 3); // Remove orange
                    } else if (subsidiary === "See's Candies") {
                        sugarDepletion = 0.75;
                    } else if (subsidiary === "Dairy Queen") {
                        trajectoryLength = 1.2;
                    } else if (subsidiary === "Nebraska Furniture Mart") {
                        this.availableColors = this.availableColors.filter(c => c !== 3); // Remove yellow
                    } else if (subsidiary === "Fruit of the Loom") {
                        scrollSpeedModifier = 0.85;
                    } else if (subsidiary === "Gillette") {
                        this.powerups.grahamNets += 1;
                    } else if (subsidiary === "Duracell") {
                        this.powerups.lollapalooza += 1;
                    }
                }
                
                this.bubblesRemaining = baseBubbles;
                this.sugarDepletionRate = sugarDepletion;
                this.scrollSpeedModifier = scrollSpeedModifier;
                this.trajectoryLengthModifier = trajectoryLength;
            }
            
            setupEventListeners() {
                this.canvas.addEventListener('contextmenu', e => e.preventDefault());
                
                this.canvas.addEventListener('mousedown', (e) => this.startAiming(e));
                this.canvas.addEventListener('mousemove', (e) => this.updateAiming(e));
                this.canvas.addEventListener('mouseup', (e) => this.fire(e));
                
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.startAiming(e.touches[0]);
                });
                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    this.updateAiming(e.touches[0]);
                });
                this.canvas.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.fire(e);
                });

                // Powerup buttons
                document.getElementById('lollapalooza').addEventListener('click', () => {
                    if (this.powerups.lollapalooza > 0) {
                        this.powerups.lollapalooza--;
                        
                        if (this.currentBubbleType === 'normal') {
                            this.currentBubbleType = 'explosive';
                            this.showQuote('Lollapalooza loaded! Current shot will explode!', 'Charlie Munger', 'POWERUP');
                        } else {
                            this.specialAmmo.push('explosive');
                            this.showQuote('Lollapalooza queued! Next shot will explode!', 'Charlie Munger', 'POWERUP');
                        }
                        
                        this.updatePowerupCounts();
                    }
                });
                
                document.getElementById('grahamNets').addEventListener('click', () => {
                    if (this.powerups.grahamNets > 0) {
                        this.powerups.grahamNets--;
                        
                        if (this.currentBubbleType === 'normal') {
                            this.currentBubbleType = 'converter';
                            this.showQuote('Graham Nets loaded! Current shot creates chain reactions!', 'Benjamin Graham', 'POWERUP');
                        } else {
                            this.specialAmmo.push('converter');
                            this.showQuote('Graham Nets queued! Next shot creates chain reactions!', 'Benjamin Graham', 'POWERUP');
                        }
                        
                        this.updatePowerupCounts();
                    }
                });
                
                document.getElementById('coke').addEventListener('click', () => {
                    if (this.powerups.coke > 0) {
                        this.powerups.coke--;
                        this.sugar = Math.min(this.maxSugar, this.sugar + 20);
                        this.showQuote('Refreshing Coke! Sugar restored!', 'Warren Buffett', 'POWERUP');
                        this.updatePowerupCounts();
                    }
                });

                // Continue button
                document.getElementById('continueButton').addEventListener('click', () => {
                    document.getElementById('levelCompleteOverlay').style.display = 'none';
                    this.gamePhase = 'store';
                    this.switchToStore();
                });
            }

            switchToStore() {
                this.gamePhase = 'store';
                this.switchScreen('store');
                document.getElementById('phaseNavigation').classList.add('active');
                document.getElementById('storeNavBtn').classList.add('current');
                document.getElementById('investNavBtn').classList.remove('current');
                document.getElementById('nextYearSpan').textContent = this.year + 1;
            }

            switchToInvest() {
                this.gamePhase = 'invest';
                this.switchScreen('investment');
                document.getElementById('storeNavBtn').classList.remove('current');
                document.getElementById('investNavBtn').classList.add('current');
            }

            continueToNextYear() {
                document.getElementById('phaseNavigation').classList.remove('active');
                this.nextLevel();
            }

            populateStore() {
                const container = document.getElementById('storeCategories');
                document.getElementById('storeCash').textContent = this.cash.toLocaleString();
                document.getElementById('storeBooks').textContent = this.books;
                
                container.innerHTML = `
                    <div class="store-category">
                        <div class="category-title">📚 Books</div>
                        ${this.generateBookItems()}
                    </div>
                    
                    <div class="store-category">
                        <div class="category-title">🏢 Subsidiaries</div>
                        ${this.generateSubsidiaryItems()}
                    </div>
                    
                    <div class="store-category">
                        <div class="category-title">⚡ Power-ups</div>
                        ${this.generatePowerupItems()}
                    </div>
                `;
            }

            generateBookItems() {
                return Object.entries(books).map(([name, data]) => {
                    const owned = this.ownedBooks.includes(name);
                    const canAfford = this.books >= data.price;
                    
                    return `
                        <div class="store-item ${owned ? 'unavailable' : ''}">
                            <div class="item-info">
                                <div class="item-name">${name} ${owned ? '(Owned)' : ''}</div>
                                <div class="item-description">Unlocks investment opportunities</div>
                                <div class="item-effect">Knowledge Value: ${data.bookValue}</div>
                            </div>
                            <div class="item-price books">📚${data.price}</div>
                            <button class="buy-button" ${owned || !canAfford ? 'disabled' : ''} 
                                    onclick="game.buyBook('${name}')">
                                ${owned ? 'Owned' : 'Buy'}
                            </button>
                        </div>
                    `;
                }).join('');
            }

            generateSubsidiaryItems() {
                return Object.entries(subsidiaries).map(([name, data]) => {
                    const owned = this.ownedSubsidiaries.includes(name);
                    const canAfford = this.books >= data.price;
                    const available = this.isSubsidiaryAvailable(name);
                    const bookRequired = data.bookRequirement && !this.ownedBooks.includes(data.bookRequirement);
                    
                    return `
                        <div class="store-item ${owned || !available ? 'unavailable' : ''}">
                            <div class="item-info">
                                <div class="item-name">${name} ${owned ? '(Owned)' : ''}</div>
                                <div class="item-description">${data.perkDescription}</div>
                                <div class="item-effect">
                                    ${data.gameplayPerk}<br>
                                    Income: $${data.yearlyIncome}/year
                                    ${bookRequired ? `<br>Requires: ${data.bookRequirement}` : ''}
                                    ${!available ? `<br>Available from: ${data.availableFrom}` : ''}
                                </div>
                            </div>
                            <div class="item-price books">📚${data.price}</div>
                            <button class="buy-button" 
                                    ${owned || !canAfford || !available || bookRequired ? 'disabled' : ''} 
                                    onclick="game.buySubsidiary('${name}')">
                                ${owned ? 'Owned' : bookRequired ? 'Need Book' : !available ? 'Not Yet' : 'Buy'}
                            </button>
                        </div>
                    `;
                }).join('');
            }

            generatePowerupItems() {
                return Object.entries(powerups).map(([name, data]) => {
                    const canAfford = this.cash >= data.price;
                    
                    return `
                        <div class="store-item">
                            <div class="item-info">
                                <div class="item-name">${name}</div>
                                <div class="item-description">${data.effect}</div>
                                <div class="item-effect">Single use consumable</div>
                            </div>
                            <div class="item-price">$${data.price.toLocaleString()}</div>
                            <button class="buy-button" ${!canAfford ? 'disabled' : ''} 
                                    onclick="game.buyPowerup('${name}')">
                                Buy
                            </button>
                        </div>
                    `;
                }).join('');
            }

            isSubsidiaryAvailable(name) {
                const data = subsidiaries[name];
                
                // Check year requirement
                if (this.year < data.availableFrom) return false;
                
                // Check prerequisite subsidiaries
                if (data.requires) {
                    for (let req of data.requires) {
                        if (!this.ownedSubsidiaries.includes(req)) return false;
                    }
                }
                
                return true;
            }

            buyBook(name) {
                const data = books[name];
                if (this.books >= data.price && !this.ownedBooks.includes(name)) {
                    this.books -= data.price;
                    this.ownedBooks.push(name);
                    this.showQuote(`"${name}" acquired! Knowledge is power.`, 'Warren Buffett', 'WISDOM');
                    this.populateStore();
                    this.updateUI();
                }
            }

            buySubsidiary(name) {
                const data = subsidiaries[name];
                if (this.books >= data.price && !this.ownedSubsidiaries.includes(name) && this.isSubsidiaryAvailable(name)) {
                    this.books -= data.price;
                    this.ownedSubsidiaries.push(name);
                    
                    // Apply immediate gameplay perks
                    this.applySubsidiaryPerks();
                    
                    this.showQuote(`${name} acquired! ${data.perkDescription}`, 'Warren Buffett', 'BUSINESS');
                    this.populateStore();
                    this.updateUI();
                }
            }

            buyPowerup(name) {
                const data = powerups[name];
                if (this.cash >= data.price) {
                    this.cash -= data.price;
                    
                    if (name === "Munger's Lollapaloozas") {
                        this.powerups.lollapalooza++;
                    } else if (name === "Graham's Nets") {
                        this.powerups.grahamNets++;
                    } else if (name === "Coke") {
                        this.powerups.coke++;
                    }
                    
                    this.showQuote(`${name} purchased!`, 'Warren Buffett', 'POWERUP');
                    this.populateStore();
                    this.updatePowerupCounts();
                    this.updateUI();
                }
            }

            populateInvestments() {
                document.getElementById('investmentYear').textContent = this.year;
                document.getElementById('investmentCash').textContent = '$' + this.cash.toLocaleString();
                
                // Calculate portfolio value and yearly income
                let portfolioValue = 0;
                let yearlyIncome = 0;
                
                for (let subsidiary of this.ownedSubsidiaries) {
                    yearlyIncome += subsidiaries[subsidiary].yearlyIncome;
                }
                
                for (let [symbol, holding] of Object.entries(this.ownedStocks)) {
                    const currentPrice = this.getCurrentStockPrice(symbol);
                    portfolioValue += holding.shares * currentPrice;
                }
                
                document.getElementById('portfolioValue').textContent = '$' + portfolioValue.toLocaleString();
                document.getElementById('yearlyIncome').textContent = '$' + yearlyIncome.toLocaleString();
                document.getElementById('totalAssets').textContent = '$' + (this.cash + portfolioValue).toLocaleString();
                
                // Check if stock market is open
                const marketOpen = this.year >= 1963;
                
                if (!marketOpen) {
                    document.getElementById('stocksList').innerHTML = `
                        <div class="market-closed-notice">
                            📊 Stock Market Opens in 1963<br>
                            Build your capital until then!<br>
                            Years remaining: ${1963 - this.year}
                        </div>
                    `;
                } else {
                    // Populate stocks
                    const stocksList = document.getElementById('stocksList');
                    stocksList.innerHTML = Object.entries(stockData).map(([symbol, data]) => {
                        const available = this.year >= data.startYear;
                        const owned = this.ownedStocks[symbol] || { shares: 0, avgPrice: 0 };
                        const currentPrice = this.getCurrentStockPrice(symbol);
                        const yearChange = this.getYearOverYearChange(symbol);
                        
                        const changeColor = yearChange >= 0 ? '#2ecc71' : '#e74c3c';
                        const changeText = yearChange !== 0 ? ` (${yearChange >= 0 ? '+' : ''}${yearChange.toFixed(1)}%)` : '';
                        
                        let gainLoss = '';
                        if (owned.shares > 0 && owned.avgPrice > 0) {
                            const totalGainLoss = (currentPrice - owned.avgPrice) * owned.shares;
                            const gainLossPercent = ((currentPrice - owned.avgPrice) / owned.avgPrice) * 100;
                            const glColor = totalGainLoss >= 0 ? '#2ecc71' : '#e74c3c';
                            gainLoss = `<br><span style="color: ${glColor};">P/L: $${totalGainLoss.toFixed(2)} (${gainLossPercent >= 0 ? '+' : ''}${gainLossPercent.toFixed(1)}%)</span>`;
                        }
                        
                        return `
                            <div class="stock-item ${!available ? 'unavailable' : ''}">
                                <div class="stock-info">
                                    <div class="stock-name">${symbol} - ${data.name}</div>
                                    <div class="stock-details">
                                        ${available ? 
                                            `Price: $${currentPrice.toFixed(2)}<span style="color: ${changeColor};">${changeText}</span><br>
                                             Owned: ${owned.shares} shares ${owned.shares > 0 ? `| Value: $${(owned.shares * currentPrice).toLocaleString()}` : ''}
                                             ${gainLoss}` 
                                            : `Available from ${data.startYear}`
                                        }
                                    </div>
                                </div>
                                <div class="stock-actions">
                                    <button class="action-button" ${!available || this.cash < currentPrice ? 'disabled' : ''} 
                                            onclick="game.buyStock('${symbol}', 1)">Buy 1</button>
                                    <button class="action-button" ${!available || this.cash < currentPrice * 10 ? 'disabled' : ''} 
                                            onclick="game.buyStock('${symbol}', 10)">Buy 10</button>
                                    <button class="action-button" ${!available || this.cash < currentPrice * 50 ? 'disabled' : ''} 
                                            onclick="game.buyStock('${symbol}', 50)">Buy 50</button>
                                    <button class="action-button sell" ${owned.shares === 0 ? 'disabled' : ''} 
                                            onclick="game.sellStock('${symbol}', 1)">Sell 1</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                // Populate subsidiaries
                const subsidiariesList = document.getElementById('subsidiariesList');
                subsidiariesList.innerHTML = this.ownedSubsidiaries.map(name => {
                    const data = subsidiaries[name];
                    return `
                        <div class="subsidiary-item">
                            <div class="subsidiary-info">
                                <div class="subsidiary-name">${name}</div>
                                <div class="subsidiary-perk">${data.gameplayPerk}</div>
                            </div>
                            <div class="subsidiary-income">$${data.yearlyIncome}/year</div>
                        </div>
                    `;
                }).join('');
                
                if (this.ownedSubsidiaries.length === 0) {
                    subsidiariesList.innerHTML = '<div style="text-align: center; color: #bdc3c7; padding: 20px;">No subsidiaries owned yet. Visit the store!</div>';
                }
            }

            buyStock(symbol, quantity) {
                const currentPrice = this.getCurrentStockPrice(symbol);
                if (currentPrice === 0) return; // Stock not available yet
                
                const cost = currentPrice * quantity;
                
                if (this.cash >= cost) {
                    this.cash -= cost;
                    
                    if (!this.ownedStocks[symbol]) {
                        this.ownedStocks[symbol] = { shares: 0, avgPrice: 0 };
                    }
                    
                    const holding = this.ownedStocks[symbol];
                    const totalShares = holding.shares + quantity;
                    holding.avgPrice = ((holding.avgPrice * holding.shares) + cost) / totalShares;
                    holding.shares = totalShares;
                    
                    this.showQuote(`Bought ${quantity} shares of ${symbol} for $${cost.toLocaleString()}`, 'Warren Buffett', 'BUSINESS');
                    this.populateInvestments();
                }
            }

            sellStock(symbol, quantity) {
                const holding = this.ownedStocks[symbol];
                if (holding && holding.shares >= quantity) {
                    const currentPrice = this.getCurrentStockPrice(symbol);
                    const proceeds = currentPrice * quantity;
                    
                    this.cash += proceeds;
                    holding.shares -= quantity;
                    
                    if (holding.shares === 0) {
                        delete this.ownedStocks[symbol];
                    }
                    
                    this.showQuote(`Sold ${quantity} shares of ${symbol} for $${proceeds.toLocaleString()}`, 'Warren Buffett', 'BUSINESS');
                    this.populateInvestments();
                }
            }

            loadNextAmmo() {
                if (this.specialAmmo.length > 0) {
                    this.currentBubbleType = this.specialAmmo.shift();
                } else {
                    this.currentBubbleType = 'normal';
                }
            }

            updatePowerupCounts() {
                document.querySelector('#lollapalooza .powerup-count').textContent = this.powerups.lollapalooza;
                document.querySelector('#grahamNets .powerup-count').textContent = this.powerups.grahamNets;
                document.querySelector('#coke .powerup-count').textContent = this.powerups.coke;
            }
            
            getPointerPos(e) {
                const rect = this.canvas.getBoundingClientRect();
                return {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            }
            
            startAiming(e) {
                if (!this.gameRunning || this.activeBubble || this.gamePhase !== 'playing') return;
                
                this.isAiming = true;
                this.updateAiming(e);
            }
            
            updateAiming(e) {
                if (!this.isAiming) return;
                
                const pos = this.getPointerPos(e);
                const dx = pos.x - this.cannon.x;
                const dy = pos.y - this.cannon.y;
                
                let angle = Math.atan2(dy, dx);
                
                const maxAngle = Math.PI * 0.1;
                const minAngle = -Math.PI + maxAngle;
                angle = Math.max(minAngle, Math.min(maxAngle, angle));
                
                this.cannon.angle = angle;
                this.calculateTrajectory();
            }
            
            fire(e) {
                if (!this.isAiming || this.activeBubble || this.bubblesRemaining <= 0) return;
                
                this.isAiming = false;
                this.trajectory = [];
                
                this.activeBubble = {
                    x: this.cannon.x,
                    y: this.cannon.y,
                    vx: Math.cos(this.cannon.angle) * this.cannon.power,
                    vy: Math.sin(this.cannon.angle) * this.cannon.power,
                    color: this.nextBubbles.shift(),
                    radius: this.bubbleRadius,
                    type: this.currentBubbleType
                };
                
                this.nextBubbles.push(Math.floor(Math.random() * this.availableColors.length));
                this.bubblesRemaining--;
                
                this.loadNextAmmo();
                
                this.updateUI();
            }
            
            calculateTrajectory() {
                this.trajectory = [];
                if (!this.isAiming) return;
                
                let x = this.cannon.x;
                let y = this.cannon.y;
                let vx = Math.cos(this.cannon.angle) * this.cannon.power / 60;
                let vy = Math.sin(this.cannon.angle) * this.cannon.power / 60;
                
                const maxPoints = Math.floor(30 * (this.trajectoryLengthModifier || 1));
                
                for (let i = 0; i < maxPoints; i++) {
                    x += vx;
                    y += vy;
                    
                    if (x <= this.bubbleRadius || x >= this.canvas.width - this.bubbleRadius) {
                        vx = -vx;
                        x = Math.max(this.bubbleRadius, Math.min(this.canvas.width - this.bubbleRadius, x));
                    }
                    
                    this.trajectory.push({ x, y });
                    
                    if (y <= 0) break;
                }
            }
            
            generateInitialBubbles() {
                this.bubbles = [];
                
                const cols = Math.floor(this.canvas.width / (this.bubbleRadius * 2)) + 5;
                const rows = 6;
                
                for (let col = 0; col < cols; col++) {
                    for (let row = 0; row < rows; row++) {
                        if (Math.random() < 0.7) {
                            const x = col * (this.bubbleRadius * 2) + this.bubbleRadius + (row % 2 ? this.bubbleRadius : 0);
                            const y = row * (this.bubbleRadius * 1.5) + this.bubbleRadius + 20;
                            
                            this.bubbles.push({
                                x: x,
                                y: y,
                                color: this.availableColors[Math.floor(Math.random() * this.availableColors.length)],
                                radius: this.bubbleRadius,
                                gridX: col,
                                gridY: row
                            });
                        }
                    }
                }
            }
            
            spawnNewColumn() {
                const rows = 6;
                const rightmostX = Math.max(...this.bubbles.map(b => b.x), this.canvas.width);
                const newCol = Math.floor((rightmostX + this.bubbleRadius * 2) / (this.bubbleRadius * 2));
                
                for (let row = 0; row < rows; row++) {
                    if (Math.random() < 0.7) {
                        const x = newCol * (this.bubbleRadius * 2) + this.bubbleRadius + (row % 2 ? this.bubbleRadius : 0);
                        const y = row * (this.bubbleRadius * 1.5) + this.bubbleRadius + 20;
                        
                        this.bubbles.push({
                            x: x,
                            y: y,
                            color: this.availableColors[Math.floor(Math.random() * this.availableColors.length)],
                            radius: this.bubbleRadius,
                            gridX: newCol,
                            gridY: row
                        });
                    }
                }
            }
            
            update(deltaTime) {
                if (!this.gameRunning || this.gamePhase !== 'playing') return;
                
                this.sugar -= deltaTime * (this.sugarDepletionRate || 1);
                if (this.sugar <= 0) {
                    this.endLevel(false);
                    return;
                }
                
                const adjustedScrollSpeed = this.scrollSpeed * (this.scrollSpeedModifier || 1);
                
                this.bubbles.forEach(bubble => {
                    bubble.x -= adjustedScrollSpeed * deltaTime;
                });
                
                this.bubbles = this.bubbles.filter(bubble => bubble.x > -this.bubbleRadius);
                
                this.spawnTimer += deltaTime;
                if (this.spawnTimer >= this.spawnInterval) {
                    this.spawnNewColumn();
                    this.spawnTimer = 0;
                }
                
                if (this.activeBubble) {
                    this.activeBubble.x += this.activeBubble.vx * deltaTime;
                    this.activeBubble.y += this.activeBubble.vy * deltaTime;
                    
                    if (this.activeBubble.x <= this.bubbleRadius || 
                        this.activeBubble.x >= this.canvas.width - this.bubbleRadius) {
                        this.activeBubble.vx = -this.activeBubble.vx;
                        this.activeBubble.x = Math.max(this.bubbleRadius, 
                            Math.min(this.canvas.width - this.bubbleRadius, this.activeBubble.x));
                    }
                    
                    this.checkCollisions();
                    
                    if (this.activeBubble && this.activeBubble.y <= -this.bubbleRadius) {
                        this.activeBubble = null;
                    }
                }
                
                this.collectibles.forEach(collectible => {
                    collectible.y += 100 * deltaTime;
                    
                    const dist = Math.sqrt(
                        Math.pow(collectible.x - this.cannon.x, 2) + 
                        Math.pow(collectible.y - this.cannon.y, 2)
                    );
                    
                    if (dist < 30) {
                        this.collectItem(collectible);
                        collectible.collected = true;
                    }
                });
                
                this.collectibles = this.collectibles.filter(c => !c.collected && c.y < this.canvas.height);
                
                if (this.bubbles.length === 0) {
                    this.endLevel(true);
                } else if (this.bubblesRemaining <= 0 && !this.activeBubble) {
                    this.endLevel(false);
                }
                
                this.updateUI();
            }
            
            checkCollisions() {
                if (!this.activeBubble) return;
                
                for (let bubble of this.bubbles) {
                    const dist = Math.sqrt(
                        Math.pow(this.activeBubble.x - bubble.x, 2) + 
                        Math.pow(this.activeBubble.y - bubble.y, 2)
                    );
                    
                    if (dist < this.bubbleRadius * 1.8) {
                        this.attachBubble(bubble);
                        return;
                    }
                }
            }
            
            attachBubble(nearBubble) {
                const newBubble = {
                    x: this.activeBubble.x,
                    y: this.activeBubble.y,
                    color: this.activeBubble.color,
                    radius: this.bubbleRadius,
                    gridX: nearBubble.gridX,
                    gridY: nearBubble.gridY
                };
                
                if (this.activeBubble.type === 'explosive') {
                    this.explodeBubbles(newBubble.x, newBubble.y);
                    this.activeBubble = null;
                    return;
                } else if (this.activeBubble.type === 'converter') {
                    this.convertBubblesToGrey(newBubble.x, newBubble.y);
                }
                
                this.bubbles.push(newBubble);
                this.activeBubble = null;
                
                const matches = this.findMatches(newBubble);
                if (matches.length >= 3) {
                    this.popBubbles(matches);
                }
            }
            
            explodeBubbles(centerX, centerY) {
                const radius = 60;
                const bubblesInRange = [];
                
                for (let bubble of this.bubbles) {
                    const dist = Math.sqrt(
                        Math.pow(bubble.x - centerX, 2) + 
                        Math.pow(bubble.y - centerY, 2)
                    );
                    
                    if (dist <= radius) {
                        bubblesInRange.push(bubble);
                    }
                }
                
                for (let bubble of bubblesInRange) {
                    const index = this.bubbles.indexOf(bubble);
                    if (index !== -1) {
                        this.bubbles.splice(index, 1);
                        this.levelStats.bubblesPopped++;
                        
                        if (Math.random() < 0.6) {
                            this.collectibles.push({
                                x: bubble.x,
                                y: bubble.y,
                                type: Math.random() < 0.5 ? 'cash' : 'sweet',
                                collected: false
                            });
                        }
                    }
                }
                
                if (bubblesInRange.length > 0) {
                    const cashEarned = bubblesInRange.length * 150;
                    this.cash += cashEarned;
                    this.levelStats.cashEarned += cashEarned;
                    this.showQuote('LOLLAPALOOZA EXPLOSION! ' + bubblesInRange.length + ' bubbles destroyed!', 'Charlie Munger', 'POWERUP');
                }
            }
            
            convertBubblesToGrey(centerX, centerY) {
                const radius = 80;
                const bubblesInRange = [];
                
                for (let bubble of this.bubbles) {
                    const dist = Math.sqrt(
                        Math.pow(bubble.x - centerX, 2) + 
                        Math.pow(bubble.y - centerY, 2)
                    );
                    
                    if (dist <= radius) {
                        bubble.isGrey = true;
                        bubblesInRange.push(bubble);
                    }
                }
                
                if (bubblesInRange.length > 0) {
                    this.showQuote('GRAHAM NETS! ' + bubblesInRange.length + ' bubbles converted for chain reactions!', 'Benjamin Graham', 'POWERUP');
                }
            }
            
            findMatches(startBubble) {
                const visited = new Set();
                const matches = [];
                const stack = [startBubble];
                
                while (stack.length > 0) {
                    const bubble = stack.pop();
                    const key = bubble.x + ',' + bubble.y;
                    
                    if (visited.has(key)) continue;
                    visited.add(key);
                    
                    if (bubble.isGrey || startBubble.isGrey || bubble.color === startBubble.color) {
                        matches.push(bubble);
                        
                        const neighbors = this.bubbles.filter(b => {
                            if (b === bubble) return false;
                            const dist = Math.sqrt(
                                Math.pow(b.x - bubble.x, 2) + 
                                Math.pow(b.y - bubble.y, 2)
                            );
                            return dist < this.bubbleRadius * 2.2;
                        });
                        
                        for (let neighbor of neighbors) {
                            const neighborKey = neighbor.x + ',' + neighbor.y;
                            if (!visited.has(neighborKey)) {
                                if (bubble.isGrey || neighbor.isGrey || neighbor.color === startBubble.color) {
                                    stack.push(neighbor);
                                }
                            }
                        }
                    }
                }
                
                return matches;
            }
            
            popBubbles(matches) {
                for (let bubble of matches) {
                    const index = this.bubbles.indexOf(bubble);
                    if (index !== -1) {
                        this.bubbles.splice(index, 1);
                        this.levelStats.bubblesPopped++;
                        
                        const rand = Math.random();
                        if (rand < 0.05) {
                            this.collectibles.push({
                                x: bubble.x,
                                y: bubble.y,
                                type: 'book',
                                collected: false
                            });
                        } else if (rand < 0.35) {
                            this.collectibles.push({
                                x: bubble.x,
                                y: bubble.y,
                                type: 'cash',
                                collected: false
                            });
                        } else if (rand < 0.50) {
                            this.collectibles.push({
                                x: bubble.x,
                                y: bubble.y,
                                type: 'sweet',
                                collected: false
                            });
                        }
                    }
                }
                
                let cashEarned = 0;
                
                if (matches.length >= 15) {
                    this.showQuote('EXCEPTIONAL CLUSTER! ' + matches.length + ' bubbles!', 'Warren Buffett', 'WISDOM');
                    cashEarned = matches.length * 500;
                    this.sugar = Math.min(this.maxSugar, this.sugar + 10);
                    this.books += 1;
                    this.levelStats.booksFound += 1;
                } else if (matches.length >= 8) {
                    this.showQuote('GREAT PATIENCE! ' + matches.length + ' bubbles!', '', 'GAME');
                    cashEarned = matches.length * 200;
                    this.sugar = Math.min(this.maxSugar, this.sugar + 5);
                } else if (matches.length >= 5) {
                    this.showQuote('Good cluster! ' + matches.length + ' bubbles.', '', 'GAME');
                    cashEarned = matches.length * 100;
                } else {
                    this.showQuote('Price is what you pay. Value is what you get.', 'Warren Buffett', 'WISDOM');
                    cashEarned = matches.length * 50;
                }
                
                this.cash += cashEarned;
                this.levelStats.cashEarned += cashEarned;
            }
            
            collectItem(collectible) {
                switch (collectible.type) {
                    case 'cash':
                        const cashAmount = 100;
                        this.cash += cashAmount;
                        this.levelStats.cashEarned += cashAmount;
                        break;
                    case 'sweet':
                        this.sugar = Math.min(this.maxSugar, this.sugar + 10);
                        break;
                    case 'book':
                        this.books += 1;
                        this.levelStats.booksFound += 1;
                        this.showQuote('Knowledge is the best investment.', 'Business Education', 'BUSINESS');
                        break;
                }
            }
            
            endLevel(won) {
                this.gameRunning = false;
                
                if (won) {
                    // Pay subsidiary income
                    let totalIncome = 0;
                    for (let subsidiary of this.ownedSubsidiaries) {
                        totalIncome += subsidiaries[subsidiary].yearlyIncome;
                    }
                    
                    this.cash += totalIncome;
                    if (totalIncome > 0) {
                        this.levelStats.cashEarned += totalIncome;
                    }
                    
                    // Show level complete overlay
                    document.getElementById('levelCompleteTitle').textContent = `Year ${this.year} Complete!`;
                    document.getElementById('bubblesPopped').textContent = this.levelStats.bubblesPopped;
                    document.getElementById('cashEarned').textContent = this.levelStats.cashEarned.toLocaleString();
                    document.getElementById('booksFound').textContent = this.levelStats.booksFound;
                    
                    document.getElementById('levelCompleteOverlay').style.display = 'flex';
                    
                } else {
                    this.lives--;
                    if (this.lives <= 0) {
                        this.showQuote('Game Over! Time is the friend of the wonderful business.', 'Warren Buffett', 'WISDOM');
                        setTimeout(() => this.restart(), 4000);
                    } else {
                        this.showQuote('Life lost! ' + this.lives + ' remaining.', 'Warren Buffett', 'WISDOM');
                        setTimeout(() => this.retryLevel(), 3000);
                    }
                }
            }
            
            nextLevel() {
                const oldYear = this.year;
                this.year++;
                
                // Check for new stock availability
                let newStocks = [];
                for (let [symbol, data] of Object.entries(stockData)) {
                    if (data.startYear === this.year) {
                        newStocks.push(`${symbol} (${data.name})`);
                    }
                }
                
                // Calculate and show investment performance for the year
                let portfolioPerformance = '';
                if (Object.keys(this.ownedStocks).length > 0) {
                    let totalGainLoss = 0;
                    let performanceMessages = [];
                    
                    for (let [symbol, holding] of Object.entries(this.ownedStocks)) {
                        const oldPrice = stockData[symbol].prices[oldYear];
                        const newPrice = this.getCurrentStockPrice(symbol);
                        
                        if (oldPrice && newPrice && holding.shares > 0) {
                            const gainLoss = (newPrice - oldPrice) * holding.shares;
                            totalGainLoss += gainLoss;
                            
                            const percentChange = ((newPrice - oldPrice) / oldPrice) * 100;
                            const changeColor = gainLoss >= 0 ? '📈' : '📉';
                            performanceMessages.push(`${changeColor} ${symbol}: ${percentChange >= 0 ? '+' : ''}${percentChange.toFixed(1)}% ($${gainLoss.toFixed(2)})`);
                        }
                    }
                    
                    if (performanceMessages.length > 0) {
                        portfolioPerformance = ` Portfolio Performance ${oldYear}: ${performanceMessages.join(', ')}. Total: ${totalGainLoss >= 0 ? '+' : ''}$${totalGainLoss.toFixed(2)}`;
                    }
                }
                
                this.sugar = this.maxSugar;
                this.scrollSpeed += 5;
                
                // Reset level stats
                this.levelStats = {
                    bubblesPopped: 0,
                    cashEarned: 0,
                    booksFound: 0
                };
                
                // Apply subsidiary perks again for new level
                this.applySubsidiaryPerks();
                
                this.generateInitialBubbles();
                this.gameRunning = true;
                this.gamePhase = 'playing';
                this.switchScreen('game');
                
                // Show year transition message with new stocks and portfolio performance
                let yearMessage = `Welcome to ${this.year}!`;
                
                if (this.year === 1963) {
                    yearMessage = `🎉 STOCK MARKET OPENS! Welcome to ${this.year}! Coca-Cola and Disney are now available for investment!`;
                } else if (newStocks.length > 0) {
                    yearMessage += ` NEW STOCKS AVAILABLE: ${newStocks.join(', ')}.`;
                }
                
                if (portfolioPerformance) {
                    yearMessage += portfolioPerformance;
                }
                
                this.showQuote(yearMessage, 'Warren Buffett', 'BUSINESS');
            }
            
            retryLevel() {
                this.sugar = this.maxSugar;
                this.applySubsidiaryPerks();
                this.generateInitialBubbles();
                this.gameRunning = true;
            }
            
            restart() {
                this.switchScreen('mainMenu');
                this.gamePhase = 'menu';
            }
            
            showQuote(text, author, category) {
                document.getElementById('quoteText').textContent = text;
                document.getElementById('quoteAuthor').textContent = author ? '- ' + author : '';
                document.getElementById('quoteCategory').textContent = category || 'GAME';
                
                const categoryEl = document.getElementById('quoteCategory');
                switch(category) {
                    case 'WISDOM':
                        categoryEl.style.background = 'rgba(243, 156, 18, 0.8)';
                        break;
                    case 'BUSINESS':
                        categoryEl.style.background = 'rgba(46, 204, 113, 0.8)';
                        break;
                    case 'POWERUP':
                        categoryEl.style.background = 'rgba(155, 89, 182, 0.8)';
                        break;
                    default:
                        categoryEl.style.background = 'rgba(52, 152, 219, 0.8)';
                }
            }
            
            updateUI() {
                document.getElementById('booksValue').textContent = '📚 ' + this.books;
                document.getElementById('yearValue').textContent = this.year;
                document.getElementById('cashValue').textContent = ' + this.cash.toLocaleString();
                
                document.getElementById('cannonSugarFill').style.height = ((this.sugar / this.maxSugar) * 100) + '%';
                document.getElementById('bubblesRemaining').textContent = this.bubblesRemaining;
                
                const livesContainer = document.getElementById('livesContainer');
                livesContainer.innerHTML = '';
                for (let i = 0; i < this.lives; i++) {
                    const life = document.createElement('div');
                    life.className = 'life';
                    livesContainer.appendChild(life);
                }
                
                const container = document.getElementById('nextBubblesContainer');
                container.innerHTML = '';
                for (let i = 0; i < this.nextBubbles.length; i++) {
                    const bubble = document.createElement('div');
                    bubble.className = 'next-bubble';
                    bubble.style.background = this.colors[this.availableColors[this.nextBubbles[i]]];
                    bubble.textContent = i + 1;
                    container.appendChild(bubble);
                }
            }
            
            render() {
                if (this.gamePhase !== 'playing') return;
                
                this.ctx.fillStyle = '#2c3e50';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                for (let bubble of this.bubbles) {
                    this.drawBubble(bubble);
                }
                
                if (this.activeBubble) {
                    this.drawBubble(this.activeBubble);
                }
                
                if (this.isAiming && this.trajectory.length > 0) {
                    this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
                    this.ctx.lineWidth = 2;
                    this.ctx.setLineDash([5, 5]);
                    this.ctx.beginPath();
                    this.ctx.moveTo(this.cannon.x, this.cannon.y);
                    for (let point of this.trajectory) {
                        this.ctx.lineTo(point.x, point.y);
                    }
                    this.ctx.stroke();
                    this.ctx.setLineDash([]);
                }
                
                this.ctx.save();
                this.ctx.translate(this.cannon.x, this.cannon.y);
                this.ctx.rotate(this.cannon.angle);
                this.ctx.fillStyle = '#34495e';
                this.ctx.fillRect(-5, -8, 25, 6);
                this.ctx.restore();
                
                this.ctx.beginPath();
                this.ctx.arc(this.cannon.x, this.cannon.y, 15, 0, Math.PI * 2);
                this.ctx.fillStyle = '#2c3e50';
                this.ctx.fill();
                
                if (this.nextBubbles.length > 0) {
                    const loadedBubble = {
                        x: this.cannon.x,
                        y: this.cannon.y - 5,
                        radius: this.bubbleRadius * 0.8,
                        color: this.availableColors[this.nextBubbles[0]],
                        type: this.currentBubbleType
                    };
                    this.drawCannonBubble(loadedBubble);
                    
                    if (this.specialAmmo.length > 0) {
                        this.ctx.fillStyle = 'rgba(243, 156, 18, 0.9)';
                        this.ctx.beginPath();
                        this.ctx.arc(this.cannon.x + 20, this.cannon.y - 15, 8, 0, Math.PI * 2);
                        this.ctx.fill();
                        
                        this.ctx.fillStyle = 'white';
                        this.ctx.font = 'bold 10px Arial';
                        this.ctx.textAlign = 'center';
                        this.ctx.fillText(this.specialAmmo.length, this.cannon.x + 20, this.cannon.y - 11);
                    }
                }
                
                for (let collectible of this.collectibles) {
                    this.ctx.beginPath();
                    this.ctx.arc(collectible.x, collectible.y, 8, 0, Math.PI * 2);
                    
                    if (collectible.type === 'cash') {
                        this.ctx.fillStyle = '#f1c40f';
                    } else if (collectible.type === 'sweet') {
                        this.ctx.fillStyle = '#e74c3c';
                    } else if (collectible.type === 'book') {
                        this.ctx.fillStyle = '#3498db';
                    }
                    
                    this.ctx.fill();
                    
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '10px Arial';
                    this.ctx.textAlign = 'center';
                    
                    if (collectible.type === 'cash') {
                        this.ctx.fillText(', collectible.x, collectible.y + 3);
                    } else if (collectible.type === 'sweet') {
                        this.ctx.fillText('♥', collectible.x, collectible.y + 3);
                    } else if (collectible.type === 'book') {
                        this.ctx.fillText('📚', collectible.x, collectible.y + 3);
                    }
                }
            }
            
            drawBubble(bubble) {
                this.ctx.beginPath();
                this.ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                
                if (bubble.isGrey) {
                    this.ctx.fillStyle = '#7f8c8d';
                } else {
                    this.ctx.fillStyle = this.colors[bubble.color];
                }
                
                this.ctx.fill();
                
                this.ctx.beginPath();
                this.ctx.arc(bubble.x - bubble.radius * 0.3, bubble.y - bubble.radius * 0.3, 
                    bubble.radius * 0.3, 0, Math.PI * 2);
                this.ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
                this.ctx.fill();
                
                this.ctx.beginPath();
                this.ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                if (bubble.isGrey) {
                    this.ctx.strokeStyle = '#f1c40f';
                    this.ctx.lineWidth = 2;
                } else {
                    this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                    this.ctx.lineWidth = 1;
                }
                this.ctx.stroke();
            }
            
            drawCannonBubble(bubble) {
                this.ctx.beginPath();
                this.ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                this.ctx.fillStyle = this.colors[bubble.color];
                this.ctx.fill();
                
                if (bubble.type === 'explosive') {
                    this.ctx.beginPath();
                    this.ctx.arc(bubble.x, bubble.y, bubble.radius + 3, 0, Math.PI * 2);
                    this.ctx.strokeStyle = '#e74c3c';
                    this.ctx.lineWidth = 3;
                    this.ctx.stroke();
                    
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '12px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText('💥', bubble.x, bubble.y + 3);
                } else if (bubble.type === 'converter') {
                    this.ctx.beginPath();
                    this.ctx.arc(bubble.x, bubble.y, bubble.radius + 3, 0, Math.PI * 2);
                    this.ctx.strokeStyle = '#f1c40f';
                    this.ctx.lineWidth = 3;
                    this.ctx.stroke();
                    
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '12px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText('🕸️', bubble.x, bubble.y + 3);
                } else {
                    this.ctx.beginPath();
                    this.ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                    this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                    this.ctx.lineWidth = 1;
                    this.ctx.stroke();
                }
            }
            
            gameLoop() {
                const now = performance.now();
                const deltaTime = this.lastTime ? (now - this.lastTime) / 1000 : 0;
                this.lastTime = now;
                
                this.update(Math.min(deltaTime, 0.016));
                this.render();
                
                requestAnimationFrame(() => this.gameLoop());
            }
        }
        
        // Global game instance
        let game;
        
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('Creating game...');
                game = new BubbleGame();
            }, 100);
        });
    </script>
</body>
</html>
