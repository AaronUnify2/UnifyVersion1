<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novel Storyboard â€” The Post Idealist</title>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=IBM+Plex+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-deep: #0c1021;
            --bg-primary: #111827;
            --bg-card: #161d2e;
            --bg-card-hover: #1c2538;
            --bg-input: #1a2236;
            --border-subtle: rgba(120, 119, 148, 0.2);
            --border-accent: rgba(207, 163, 84, 0.4);
            --border-accent-strong: rgba(207, 163, 84, 0.7);
            --text-primary: #d4cfc4;
            --text-heading: #e8dcc8;
            --text-muted: #7a7891;
            --text-faint: #52506a;
            --accent-amber: #cf9f4a;
            --accent-amber-dim: rgba(207, 163, 84, 0.15);
            --accent-orange: #d4783a;
            --accent-blue: #5b6fa3;
            --accent-purple: #7c6fae;
            --accent-red: #b44a4a;
            --accent-green: #5a9a6a;
            --font-display: 'Special Elite', cursive;
            --font-serif: 'Libre Baskerville', Georgia, serif;
            --font-mono: 'IBM Plex Mono', 'Courier New', monospace;
        }

        body { font-family: var(--font-mono); background: var(--bg-deep); color: var(--text-primary); min-height: 100vh; overflow-x: hidden; padding-bottom: 80px; }

        .app-header { background: var(--bg-primary); border-bottom: 1px solid var(--border-subtle); padding: 1.25rem 1rem 1rem; text-align: center; position: sticky; top: 0; z-index: 100; }
        .header-date { font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-muted); letter-spacing: 0.15em; margin-bottom: 0.5rem; }
        .app-title { font-family: var(--font-display); font-size: 1.1rem; font-weight: 400; color: var(--text-heading); letter-spacing: 0.2em; text-transform: uppercase; margin-bottom: 0.2rem; }
        .app-subtitle { font-family: var(--font-mono); font-size: 0.65rem; color: var(--text-muted); letter-spacing: 0.35em; text-transform: uppercase; }
        .header-diamonds { display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-top: 0.75rem; margin-bottom: 0.25rem; }
        .header-diamonds::before, .header-diamonds::after { content: ''; flex: 1; max-width: 120px; height: 1px; background: var(--border-subtle); }
        .diamond { width: 10px; height: 10px; transform: rotate(45deg); border: 1.5px solid var(--accent-amber); }
        .diamond.filled { background: var(--accent-amber); }
        .diamond.small { width: 7px; height: 7px; border-color: var(--text-faint); }

        .tab-nav { display: flex; background: var(--bg-primary); border-bottom: 1px solid var(--border-subtle); overflow-x: auto; }
        .tab-button { flex: 1; min-width: 80px; padding: 0.7rem 0.5rem; background: transparent; border: none; border-bottom: 2px solid transparent; color: var(--text-muted); font-family: var(--font-mono); font-size: 0.75rem; font-weight: 500; letter-spacing: 0.1em; text-transform: uppercase; cursor: pointer; transition: all 0.3s ease; }
        .tab-button.active { color: var(--text-heading); border-bottom-color: var(--accent-amber); background: rgba(207, 163, 84, 0.05); }
        .tab-button:hover:not(.active) { color: var(--text-primary); }

        .tab-content { padding: 1rem; min-height: calc(100vh - 170px); }
        .section-heading { font-family: var(--font-display); font-size: 1.4rem; color: var(--text-heading); letter-spacing: 0.08em; margin-bottom: 0.25rem; }
        .section-sub { font-family: var(--font-serif); font-style: italic; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem; }
        .section-rule { width: 60px; height: 2px; background: var(--accent-orange); border: none; margin-bottom: 1.5rem; }

        /* Sub-tabs for emotion */
        .sub-tab-nav { display: flex; gap: 0; margin-bottom: 1rem; border: 1px solid var(--border-subtle); border-radius: 3px; overflow: hidden; }
        .sub-tab-btn { flex: 1; padding: 0.6rem 0.5rem; background: transparent; border: none; border-right: 1px solid var(--border-subtle); color: var(--text-muted); font-family: var(--font-mono); font-size: 0.7rem; font-weight: 500; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; transition: all 0.2s ease; }
        .sub-tab-btn:last-child { border-right: none; }
        .sub-tab-btn.active { background: var(--accent-amber-dim); color: var(--accent-amber); }
        .sub-tab-btn:hover:not(.active) { background: rgba(120, 119, 148, 0.05); color: var(--text-primary); }

        .chapter-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 4px; margin-bottom: 1.5rem; overflow: hidden; transition: border-color 0.3s ease; }
        .chapter-card:hover { border-color: var(--border-accent); }
        .chapter-header { background: rgba(30, 38, 58, 0.8); padding: 0.85rem 1rem; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid var(--border-subtle); position: relative; }
        .chapter-number { font-family: var(--font-mono); font-size: 0.65rem; color: var(--accent-amber); letter-spacing: 0.15em; text-transform: uppercase; margin-bottom: 0.15rem; }
        .chapter-title { font-family: var(--font-display); font-size: 1.15rem; color: var(--text-heading); letter-spacing: 0.05em; }
        .chapter-stats { font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-muted); }
        .chapter-collapse-arrow { color: var(--text-faint); font-size: 0.75rem; transition: transform 0.3s ease; margin-left: 0.5rem; }
        .chapter-collapse-arrow.collapsed { transform: rotate(-90deg); }
        .chapter-header .drag-handle { position: absolute; right: 0.5rem; top: 0.35rem; font-size: 0.85rem; }

        .chapter-edit-btn {
            background: none; border: 1px solid var(--border-subtle); color: var(--text-muted);
            font-family: var(--font-mono); font-size: 0.6rem; padding: 0.25rem 0.5rem;
            border-radius: 2px; cursor: pointer; transition: all 0.2s ease;
            letter-spacing: 0.05em; text-transform: uppercase; margin-left: 0.5rem;
        }
        .chapter-edit-btn:hover { border-color: var(--accent-amber); color: var(--accent-amber); }

        .scenes-container { padding: 0.5rem 0.75rem; }

        .scene-card { background: rgba(22, 29, 46, 0.6); border: 1px solid var(--border-subtle); border-left: 3px solid var(--accent-amber); border-radius: 2px; padding: 0.85rem 1rem; margin: 0.5rem 0; cursor: pointer; transition: all 0.3s ease; position: relative; touch-action: manipulation; user-select: none; }
        .scene-card:hover { border-color: var(--border-accent); background: var(--bg-card-hover); }
        .scene-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem; }
        .scene-title { font-family: var(--font-serif); font-weight: 700; color: var(--text-heading); font-size: 0.95rem; }
        .scene-type { font-family: var(--font-mono); color: var(--accent-amber); padding: 0.15rem 0.45rem; border: 1px solid var(--border-accent); border-radius: 2px; font-size: 0.6rem; font-weight: 500; letter-spacing: 0.1em; text-transform: uppercase; }
        .scene-emotion { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-left: 0.5rem; }
        .scene-description { font-family: var(--font-serif); font-style: italic; color: var(--text-muted); font-size: 0.825rem; line-height: 1.5; margin-bottom: 0.5rem; }
        .scene-meta { display: flex; gap: 1rem; font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-faint); }

        .add-scene-btn { background: transparent; border: 1px dashed var(--border-accent); color: var(--accent-amber); font-family: var(--font-mono); font-size: 0.8rem; letter-spacing: 0.05em; padding: 0.65rem; margin: 0.5rem 0; border-radius: 2px; cursor: pointer; width: 100%; transition: all 0.3s ease; }
        .add-scene-btn:hover { background: var(--accent-amber-dim); border-style: solid; }

        .add-chapter-btn { background: transparent; border: 1px solid var(--border-accent); color: var(--accent-amber); font-family: var(--font-mono); font-size: 0.85rem; font-weight: 500; letter-spacing: 0.1em; padding: 0.85rem; margin: 0 0 1.5rem 0; border-radius: 2px; cursor: pointer; width: 100%; transition: all 0.3s ease; }
        .add-chapter-btn:hover { background: var(--accent-amber-dim); }

        .drag-handle { position: absolute; right: 0.5rem; top: 0.5rem; color: var(--text-faint); font-size: 0.85rem; user-select: none; cursor: grab; padding: 0.2rem 0.4rem; border-radius: 2px; transition: color 0.2s ease; z-index: 2; }
        .drag-handle:hover { color: var(--accent-amber); }
        .drag-handle:active { cursor: grabbing; }
        .drag-placeholder { border: 1px dashed var(--border-accent); background: var(--accent-amber-dim); border-radius: 2px; margin: 0.5rem 0; transition: height 0.2s ease; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(8, 10, 20, 0.85); backdrop-filter: blur(4px); z-index: 1000; padding: 1rem; }
        .modal-content { background: var(--bg-card); border: 1px solid var(--border-subtle); border-top: 2px solid var(--accent-amber); border-radius: 2px; padding: 1.5rem; max-width: 500px; margin: 2rem auto; max-height: calc(100vh - 4rem); overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-title { font-family: var(--font-display); font-size: 1.1rem; color: var(--text-heading); letter-spacing: 0.08em; }
        .close-btn { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; padding: 0.25rem; line-height: 1; }
        .close-btn:hover { color: var(--accent-red); }

        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.4rem; font-family: var(--font-mono); font-size: 0.75rem; color: var(--text-muted); letter-spacing: 0.08em; text-transform: uppercase; }
        .form-input, .form-select, .form-textarea { width: 100%; background: var(--bg-input); border: 1px solid var(--border-subtle); border-radius: 2px; padding: 0.7rem; color: var(--text-primary); font-family: var(--font-mono); font-size: 0.9rem; transition: border-color 0.3s ease; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent-amber); box-shadow: 0 0 0 2px var(--accent-amber-dim); }
        .form-textarea { min-height: 80px; resize: vertical; font-family: var(--font-serif); }
        .form-select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%237a7891'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.75rem center; padding-right: 2rem; }

        .emotion-slider { width: 100%; height: 6px; border-radius: 3px; background: linear-gradient(to right, var(--accent-red), var(--accent-orange), var(--accent-green), var(--accent-blue)); outline: none; -webkit-appearance: none; }
        .emotion-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--text-heading); border: 2px solid var(--accent-amber); cursor: pointer; }
        .emotion-value { text-align: center; margin-top: 0.4rem; font-family: var(--font-mono); font-weight: 600; font-size: 0.85rem; color: var(--accent-amber); }

        .modal-actions { display: flex; gap: 0.75rem; margin-top: 1.5rem; }
        .btn { flex: 1; padding: 0.7rem; border: none; border-radius: 2px; font-family: var(--font-mono); font-size: 0.8rem; font-weight: 500; letter-spacing: 0.05em; cursor: pointer; transition: all 0.3s ease; }
        .btn-primary { background: var(--accent-amber); color: var(--bg-deep); }
        .btn-primary:hover { box-shadow: 0 0 15px rgba(207, 163, 84, 0.3); }
        .btn-danger { background: var(--accent-red); color: var(--text-heading); }
        .btn-secondary { background: transparent; color: var(--text-muted); border: 1px solid var(--border-subtle); }

        .bottom-tools { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-primary); border-top: 1px solid var(--border-subtle); z-index: 98; }
        .tools-toggle { background: var(--bg-card); border: none; border-top: 1px solid var(--border-accent); color: var(--text-primary); font-family: var(--font-mono); font-size: 0.8rem; letter-spacing: 0.1em; padding: 0.85rem; width: 100%; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .tools-menu { display: none; padding: 0.75rem; background: var(--bg-card); }
        .tools-menu.show { display: block; animation: slideUp 0.25s ease; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .tool-btn { background: transparent; border: 1px solid var(--border-subtle); color: var(--text-primary); font-family: var(--font-mono); font-size: 0.8rem; padding: 0.65rem 1rem; margin: 0.2rem 0; width: 100%; border-radius: 2px; cursor: pointer; transition: all 0.3s ease; text-align: left; }
        .tool-btn:hover { border-color: var(--border-accent); background: var(--accent-amber-dim); }

        .character-card, .symbol-card { background: var(--bg-card); border: 1px solid var(--border-subtle); border-left: 3px solid var(--accent-blue); border-radius: 2px; padding: 1rem; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.3s ease; }
        .symbol-card { border-left-color: var(--accent-purple); }
        .character-card:hover, .symbol-card:hover { border-color: var(--border-accent); background: var(--bg-card-hover); }
        .character-name, .symbol-title { font-family: var(--font-serif); font-weight: 700; color: var(--text-heading); margin-bottom: 0.35rem; font-size: 0.95rem; }
        .character-stats, .symbol-connections { font-family: var(--font-mono); font-size: 0.75rem; color: var(--text-muted); }

        .emotion-chart { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 4px; padding: 1.25rem; margin-bottom: 1rem; }
        .emotion-chart h3 { font-family: var(--font-display); color: var(--text-heading); letter-spacing: 0.08em; font-size: 1rem; }
        .chart-canvas { width: 100%; height: 320px; background: rgba(22, 29, 46, 0.5); border-radius: 2px; }

        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin-top: 0.75rem; }
        .stat-box { text-align: center; padding: 0.75rem; background: rgba(22, 29, 46, 0.5); border: 1px solid var(--border-subtle); border-radius: 2px; }
        .stat-box .val { font-family: var(--font-mono); font-size: 1.4rem; font-weight: 600; }
        .stat-box .lbl { font-family: var(--font-mono); font-size: 0.65rem; color: var(--text-muted); letter-spacing: 0.08em; text-transform: uppercase; margin-top: 0.2rem; }

        /* Beat sheet items */
        .beat-item { background: var(--bg-card); border: 1px solid var(--border-subtle); border-radius: 3px; padding: 0.85rem; margin-bottom: 0.6rem; transition: border-color 0.2s; }
        .beat-item:hover { border-color: var(--border-accent); }
        .beat-item-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 0.5rem; margin-bottom: 0.35rem; }
        .beat-pct { font-family: var(--font-mono); font-size: 0.6rem; color: var(--accent-amber); background: var(--accent-amber-dim); padding: 0.15rem 0.4rem; border-radius: 2px; white-space: nowrap; }
        .beat-name { font-family: var(--font-serif); font-weight: 700; font-size: 0.85rem; color: var(--text-heading); }
        .beat-desc { font-family: var(--font-serif); font-style: italic; font-size: 0.75rem; color: var(--text-muted); line-height: 1.4; margin-bottom: 0.5rem; }
        .beat-select { width: 100%; background: var(--bg-input); border: 1px solid var(--border-subtle); border-radius: 2px; padding: 0.45rem 0.5rem; color: var(--text-primary); font-family: var(--font-mono); font-size: 0.75rem; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%237a7891'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.5rem center; padding-right: 1.5rem; }
        .beat-select:focus { outline: none; border-color: var(--accent-amber); }

        .input-with-picker { display: flex; gap: 0.5rem; align-items: flex-start; }
        .input-with-picker .form-input { flex: 1; }
        .picker-btn { background: var(--bg-input); border: 1px solid var(--border-accent); color: var(--accent-amber); font-family: var(--font-mono); font-size: 0.75rem; padding: 0.7rem 0.75rem; border-radius: 2px; cursor: pointer; transition: all 0.3s ease; white-space: nowrap; flex-shrink: 0; }
        .picker-btn:hover { background: var(--accent-amber-dim); }
        .picker-dropdown { display: none; background: var(--bg-card); border: 1px solid var(--border-accent); border-radius: 2px; margin-top: 0.5rem; max-height: 200px; overflow-y: auto; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5); }
        .picker-dropdown.show { display: block; }
        .picker-item { padding: 0.55rem 0.85rem; cursor: pointer; font-family: var(--font-mono); color: var(--text-muted); font-size: 0.8rem; transition: all 0.15s ease; display: flex; align-items: center; gap: 0.5rem; border-bottom: 1px solid rgba(120, 119, 148, 0.08); }
        .picker-item:last-child { border-bottom: none; }
        .picker-item:hover { background: var(--accent-amber-dim); color: var(--text-heading); }
        .picker-item.selected { color: var(--accent-amber); }
        .picker-item-check { width: 14px; height: 14px; border: 1.5px solid var(--border-subtle); border-radius: 2px; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; flex-shrink: 0; }
        .picker-item.selected .picker-item-check { background: var(--accent-amber); border-color: var(--accent-amber); color: var(--bg-deep); }
        .picker-empty { padding: 0.85rem; text-align: center; font-family: var(--font-serif); font-style: italic; color: var(--text-faint); font-size: 0.8rem; }

        .checkbox-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.4rem; margin-top: 0.4rem; }
        .checkbox-item { display: flex; align-items: center; gap: 0.5rem; font-family: var(--font-mono); font-size: 0.8rem; }
        .checkbox-item input[type="checkbox"] { accent-color: var(--accent-amber); }

        .empty-state { text-align: center; padding: 3rem 1rem; color: var(--text-muted); }
        .empty-state-icon { font-size: 2.5rem; margin-bottom: 0.75rem; opacity: 0.4; }
        .empty-state h3 { font-family: var(--font-display); color: var(--text-heading); letter-spacing: 0.08em; margin-bottom: 0.5rem; }
        .empty-state p { font-family: var(--font-serif); font-style: italic; font-size: 0.85rem; }

        .save-indicator { position: fixed; top: 10px; right: 10px; font-family: var(--font-mono); font-size: 0.75rem; background: rgba(90, 154, 106, 0.9); color: var(--text-heading); padding: 0.4rem 0.8rem; border-radius: 2px; z-index: 2000; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }

        @media (max-width: 768px) {
            .tab-button { font-size: 0.65rem; padding: 0.55rem 0.25rem; }
            .modal-content { margin: 1rem auto; padding: 1rem; }
            .modal-actions { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="app-header">
        <div class="header-date" id="header-date"></div>
        <div class="app-title">Novel Storyboard</div>
        <div class="app-subtitle">Scenes &bull; Structure &bull; Emotion</div>
        <div class="header-diamonds"><span class="diamond filled"></span><span class="diamond small"></span><span class="diamond filled"></span></div>
    </div>

    <nav class="tab-nav">
        <button class="tab-button active" data-tab="storyboard">Storyboard</button>
        <button class="tab-button" data-tab="characters">Characters</button>
        <button class="tab-button" data-tab="emotion">Emotion</button>
        <button class="tab-button" data-tab="symbols">Symbols</button>
    </nav>

    <div id="storyboard-tab" class="tab-content">
        <h2 class="section-heading">Storyboard</h2>
        <p class="section-sub">Chapters and scenes, in order</p><hr class="section-rule">
        <button class="add-chapter-btn" onclick="addChapter()">+ Add New Chapter</button>
        <div id="storyboard-container"></div>
    </div>

    <div id="characters-tab" class="tab-content" style="display:none;">
        <h2 class="section-heading">Characters</h2>
        <p class="section-sub">Everyone who appears in your story</p><hr class="section-rule">
        <div id="characters-container"></div>
    </div>

    <div id="emotion-tab" class="tab-content" style="display:none;">
        <h2 class="section-heading">Emotional Arc</h2>
        <p class="section-sub">Your novel's emotional landscape</p><hr class="section-rule">
        <div class="sub-tab-nav">
            <button class="sub-tab-btn active" onclick="switchEmotionSub('arc')">Your Arc</button>
            <button class="sub-tab-btn" onclick="switchEmotionSub('beats')">Beat Sheet</button>
        </div>
        <div id="emotion-arc-panel">
            <div class="emotion-chart">
                <canvas id="emotion-canvas" class="chart-canvas"></canvas>
            </div>
            <div id="emotion-stats"></div>
        </div>
        <div id="emotion-beats-panel" style="display:none;">
            <div class="emotion-chart" style="margin-bottom:1rem;">
                <h3 style="margin-bottom:0.75rem;">Save the Cat! Reference Curve</h3>
                <canvas id="beats-canvas" class="chart-canvas"></canvas>
            </div>
            <div id="beat-mapping-container"></div>
        </div>
    </div>

    <div id="symbols-tab" class="tab-content" style="display:none;">
        <h2 class="section-heading">Symbols</h2>
        <p class="section-sub">Recurring motifs and symbolic elements</p><hr class="section-rule">
        <button class="add-chapter-btn" onclick="addSymbol()">+ Add New Symbol</button>
        <div id="symbols-container"></div>
    </div>

    <!-- Scene Modal -->
    <div id="scene-modal" class="modal"><div class="modal-content">
        <div class="modal-header"><h3 class="modal-title">Edit Scene</h3><button class="close-btn" onclick="closeModal('scene-modal')">&times;</button></div>
        <form id="scene-form">
            <div class="form-group"><label class="form-label">Title</label><input type="text" id="scene-title" class="form-input" required></div>
            <div class="form-group"><label class="form-label">Type</label><select id="scene-type" class="form-select"><option value="action">Action</option><option value="dialogue">Dialogue</option><option value="introspection">Introspection</option><option value="description">Description</option><option value="flashback">Flashback</option><option value="transition">Transition</option><option value="climax">Climax</option><option value="resolution">Resolution</option></select></div>
            <div class="form-group"><label class="form-label">Emotion (-5 to +5)</label><input type="range" id="scene-emotion" class="emotion-slider" min="-5" max="5" value="0"><div class="emotion-value" id="emotion-value">0</div></div>
            <div class="form-group"><label class="form-label">Description</label><textarea id="scene-description" class="form-textarea" rows="3"></textarea></div>
            <div class="form-group"><label class="form-label">Characters</label><div class="input-with-picker"><input type="text" id="scene-characters" class="form-input" placeholder="Comma-separated"><button type="button" class="picker-btn" onclick="toggleCharacterPicker()">+ Pick</button></div><div id="character-picker" class="picker-dropdown"></div></div>
            <div class="form-group"><label class="form-label">Symbols</label><div class="input-with-picker"><input type="text" id="scene-symbols" class="form-input" placeholder="Comma-separated"><button type="button" class="picker-btn" onclick="toggleSymbolPicker()">+ Pick</button></div><div id="symbol-picker" class="picker-dropdown"></div></div>
            <div class="form-group"><label class="form-label">Notes</label><textarea id="scene-notes" class="form-textarea" rows="2"></textarea></div>
            <div class="modal-actions"><button type="button" class="btn btn-secondary" onclick="closeModal('scene-modal')">Cancel</button><button type="button" class="btn btn-danger" onclick="deleteScene()" style="display:none;" id="delete-scene-btn">Delete</button><button type="submit" class="btn btn-primary">Save</button></div>
        </form>
    </div></div>

    <!-- Chapter Modal -->
    <div id="chapter-modal" class="modal"><div class="modal-content">
        <div class="modal-header"><h3 class="modal-title" id="chapter-modal-title">Edit Chapter</h3><button class="close-btn" onclick="closeModal('chapter-modal')">&times;</button></div>
        <form id="chapter-form">
            <div class="form-group"><label class="form-label">Chapter Title</label><input type="text" id="chapter-title" class="form-input" required></div>
            <div class="modal-actions"><button type="button" class="btn btn-secondary" onclick="closeModal('chapter-modal')">Cancel</button><button type="button" class="btn btn-danger" onclick="deleteChapter()" style="display:none;" id="delete-chapter-btn">Delete</button><button type="submit" class="btn btn-primary">Save</button></div>
        </form>
    </div></div>

    <!-- Character Modal -->
    <div id="character-modal" class="modal"><div class="modal-content">
        <div class="modal-header"><h3 class="modal-title">Edit Character</h3><button class="close-btn" onclick="closeModal('character-modal')">&times;</button></div>
        <form id="character-form">
            <div class="form-group"><label class="form-label">Name</label><input type="text" id="character-name" class="form-input" required></div>
            <div class="form-group"><label class="form-label">Character Arc</label><textarea id="character-arc" class="form-textarea" rows="3"></textarea></div>
            <div class="form-group"><label class="form-label">Appearance</label><textarea id="character-appearance" class="form-textarea" rows="3"></textarea></div>
            <div class="form-group"><label class="form-label">Notes</label><textarea id="character-notes" class="form-textarea" rows="3"></textarea></div>
            <div class="modal-actions"><button type="button" class="btn btn-secondary" onclick="closeModal('character-modal')">Cancel</button><button type="submit" class="btn btn-primary">Save</button></div>
        </form>
    </div></div>

    <!-- Symbol Modal -->
    <div id="symbol-modal" class="modal"><div class="modal-content">
        <div class="modal-header"><h3 class="modal-title">Edit Symbol</h3><button class="close-btn" onclick="closeModal('symbol-modal')">&times;</button></div>
        <form id="symbol-form">
            <div class="form-group"><label class="form-label">Symbol Title</label><input type="text" id="symbol-title" class="form-input" required></div>
            <div class="form-group"><label class="form-label">Description</label><textarea id="symbol-description" class="form-textarea" rows="3"></textarea></div>
            <div class="form-group"><label class="form-label">Connected Chapters</label><div id="chapter-checkboxes" class="checkbox-group"></div></div>
            <div class="modal-actions"><button type="button" class="btn btn-secondary" onclick="closeModal('symbol-modal')">Cancel</button><button type="button" class="btn btn-danger" onclick="deleteSymbol()" style="display:none;" id="delete-symbol-btn">Delete</button><button type="submit" class="btn btn-primary">Save</button></div>
        </form>
    </div></div>

    <div class="bottom-tools">
        <button class="tools-toggle" onclick="toggleTools()">âš™ Tools <span id="tools-arrow">â–¾</span></button>
        <div class="tools-menu" id="tools-menu">
            <button class="tool-btn" onclick="exportData()">â†‘ Export Data</button>
            <button class="tool-btn" onclick="importData()">â†“ Import Data</button>
            <button class="tool-btn" onclick="clearAllData()">âœ• Clear All Data</button>
        </div>
    </div>
    <input type="file" id="import-file" accept=".json" style="display:none;" onchange="handleImport(event)">

    <script>
        let chapters=[], characters={}, symbols=[], beatMapping={}, currentTab='storyboard', emotionSub='arc';
        let currentEditingScene=null, currentEditingChapter=null, currentEditingCharacter=null, currentEditingSymbol=null;

        const STC=[
            {id:'opening_image',name:"Opening Image",pct:0,emotion:0,desc:"A snapshot of the protagonist's world \"before\" â€” sets tone and stakes."},
            {id:'theme_stated',name:"Theme Stated",pct:5,emotion:0,desc:"Someone poses a thematic question the hero doesn't yet understand."},
            {id:'setup',name:"Setup",pct:8,emotion:0,desc:"Establish the hero's world, flaws, and what needs to change."},
            {id:'catalyst',name:"Catalyst",pct:10,emotion:-1,desc:"A life-changing event that disrupts the status quo."},
            {id:'debate',name:"Debate",pct:15,emotion:-2,desc:"The hero hesitates â€” should they answer the call?"},
            {id:'break_into_two',name:"Break into Two",pct:20,emotion:1,desc:"The hero commits and enters a new, upside-down world."},
            {id:'b_story',name:"B Story",pct:22,emotion:2,desc:"A subplot begins (often love interest or mentor) that mirrors the theme."},
            {id:'fun_and_games',name:"Fun & Games",pct:35,emotion:3,desc:"The \"promise of the premise\" â€” what drew readers to this story."},
            {id:'midpoint',name:"Midpoint",pct:50,emotion:2,desc:"A false victory (or false defeat) that raises the stakes."},
            {id:'bad_guys',name:"Bad Guys Close In",pct:62,emotion:-1,desc:"External pressures tighten; internal doubts and team fractures grow."},
            {id:'all_is_lost',name:"All Is Lost",pct:75,emotion:-4,desc:"The lowest point. A \"whiff of death\" â€” something or someone is lost."},
            {id:'dark_night',name:"Dark Night of the Soul",pct:80,emotion:-5,desc:"The hero wallows in hopelessness before finding clarity."},
            {id:'break_into_three',name:"Break into Three",pct:82,emotion:-2,desc:"An \"a-ha\" moment â€” the hero synthesizes A and B stories."},
            {id:'finale',name:"Finale",pct:92,emotion:3,desc:"The hero proves transformation by confronting the problem in a new way."},
            {id:'final_image',name:"Final Image",pct:100,emotion:4,desc:"A mirror of the opening â€” proof that change has occurred."}
        ];

        let dragState={active:false,element:null,type:null,ghost:null,placeholder:null,startX:0,startY:0,offsetX:0,offsetY:0,longPressTimer:null,hasMoved:false,sceneId:null,chapterId:null};

        function init(){
            document.getElementById('header-date').textContent=new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
            setupTabs(); setupDrag(); loadFromStorage(); renderCurrentTab();
            document.getElementById('scene-emotion').addEventListener('input',function(){document.getElementById('emotion-value').textContent=this.value;document.getElementById('emotion-value').style.color=getEC(parseInt(this.value));});
            document.getElementById('scene-form').addEventListener('submit',saveScene);
            document.getElementById('chapter-form').addEventListener('submit',saveChapter);
            document.getElementById('character-form').addEventListener('submit',saveCharacter);
            document.getElementById('symbol-form').addEventListener('submit',saveSymbol);
            showStorageStatus();
        }

        function setupTabs(){document.querySelectorAll('.tab-button').forEach(b=>b.addEventListener('click',()=>switchTab(b.dataset.tab)));}
        function switchTab(t){document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));document.querySelector(`[data-tab="${t}"]`).classList.add('active');document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');document.getElementById(`${t}-tab`).style.display='block';currentTab=t;renderCurrentTab();}

        function switchEmotionSub(sub){
            emotionSub=sub;
            document.querySelectorAll('.sub-tab-btn').forEach((b,i)=>{b.classList.toggle('active',i===(sub==='arc'?0:1));});
            document.getElementById('emotion-arc-panel').style.display=sub==='arc'?'block':'none';
            document.getElementById('emotion-beats-panel').style.display=sub==='beats'?'block':'none';
            if(sub==='arc') renderUserArc();
            else renderBeatsPanel();
        }

        // DRAG
        function setupDrag(){
            document.addEventListener('contextmenu',e=>{if(e.target.closest('.drag-handle'))e.preventDefault();});
            ['touchstart'].forEach(ev=>document.addEventListener(ev,onPD,{passive:false}));
            ['touchmove'].forEach(ev=>document.addEventListener(ev,onPM,{passive:false}));
            ['touchend','touchcancel'].forEach(ev=>document.addEventListener(ev,onPU,{passive:false}));
            document.addEventListener('mousedown',onPD);document.addEventListener('mousemove',onPM);document.addEventListener('mouseup',onPU);
        }
        function gpp(e){if(e.touches&&e.touches.length)return{x:e.touches[0].clientX,y:e.touches[0].clientY};if(e.changedTouches&&e.changedTouches.length)return{x:e.changedTouches[0].clientX,y:e.changedTouches[0].clientY};return{x:e.clientX,y:e.clientY};}
        function onPD(e){const h=e.target.closest('.drag-handle');if(!h)return;const card=h.closest('.scene-card,.chapter-card');if(!card)return;const p=gpp(e);dragState.startX=p.x;dragState.startY=p.y;dragState.hasMoved=false;dragState.element=card;if(card.classList.contains('scene-card')){dragState.type='scene';dragState.sceneId=parseInt(card.dataset.sceneId);}else{dragState.type='chapter';dragState.chapterId=parseInt(card.dataset.chapterId);}if(e.touches)dragState.longPressTimer=setTimeout(()=>beginDrag(e),200);else{beginDrag(e);e.preventDefault();}}
        function beginDrag(e){const c=dragState.element;if(!c)return;dragState.active=true;const r=c.getBoundingClientRect();const g=c.cloneNode(true);g.id='drag-ghost';g.style.cssText=`position:fixed;pointer-events:none;z-index:2000;width:${r.width}px;opacity:0.85;transform:rotate(1deg) scale(1.02);box-shadow:0 12px 35px rgba(0,0,0,0.5);transition:none;`;const p=gpp(e);dragState.offsetX=p.x-r.left;dragState.offsetY=p.y-r.top;g.style.left=(p.x-dragState.offsetX)+'px';g.style.top=(p.y-dragState.offsetY)+'px';document.body.appendChild(g);dragState.ghost=g;const ph=document.createElement('div');ph.className='drag-placeholder';ph.style.height=r.height+'px';c.parentNode.insertBefore(ph,c);dragState.placeholder=ph;c.style.display='none';if(navigator.vibrate)navigator.vibrate(30);}
        function onPM(e){if(!dragState.element)return;const p=gpp(e);if(dragState.longPressTimer){if(Math.abs(p.x-dragState.startX)>8||Math.abs(p.y-dragState.startY)>8){clearTimeout(dragState.longPressTimer);dragState.longPressTimer=null;if(!dragState.active){resetDS();return;}}}if(!dragState.active)return;e.preventDefault();dragState.hasMoved=true;if(dragState.ghost){dragState.ghost.style.left=(p.x-dragState.offsetX)+'px';dragState.ghost.style.top=(p.y-dragState.offsetY)+'px';}updatePH(p.x,p.y);if(p.y<60)window.scrollBy(0,-8);else if(p.y>window.innerHeight-60)window.scrollBy(0,8);}
        function updatePH(x,y){if(!dragState.placeholder)return;if(dragState.type==='scene'){if(dragState.ghost)dragState.ghost.style.display='none';const el=document.elementFromPoint(x,y);if(dragState.ghost)dragState.ghost.style.display='';const tc=el?el.closest('.scenes-container'):null;if(tc){const cards=Array.from(tc.querySelectorAll('.scene-card:not([style*="display: none"])'));let ref=null;for(const c of cards){const r=c.getBoundingClientRect();if(y<r.top+r.height/2){ref=c;break;}}const btn=tc.querySelector('.add-scene-btn');if(ref)tc.insertBefore(dragState.placeholder,ref);else if(btn)tc.insertBefore(dragState.placeholder,btn);else tc.appendChild(dragState.placeholder);}}else{const ct=document.getElementById('storyboard-container');if(!ct)return;const cards=Array.from(ct.querySelectorAll('.chapter-card:not([style*="display: none"])'));let ref=null;for(const c of cards){const r=c.getBoundingClientRect();if(y<r.top+r.height/2){ref=c;break;}}if(ref)ct.insertBefore(dragState.placeholder,ref);else ct.appendChild(dragState.placeholder);}}
        function onPU(e){if(dragState.longPressTimer){clearTimeout(dragState.longPressTimer);dragState.longPressTimer=null;}if(!dragState.active){resetDS();return;}completeDrop();}
        function completeDrop(){if(!dragState.placeholder||!dragState.element){cancelDrag();return;}if(dragState.type==='scene')completeSD();else completeCD();if(dragState.ghost)dragState.ghost.remove();if(dragState.placeholder)dragState.placeholder.remove();if(dragState.element)dragState.element.style.display='';dragState.element=null;resetDS();saveToStorage();renderCurrentTab();}
        function completeSD(){const ph=dragState.placeholder;const ct=ph.closest('.scenes-container');if(!ct)return;const tid=parseInt(ct.dataset.chapterId);const sc=findScene(dragState.sceneId);if(!sc)return;const src=chapters.find(c=>c.scenes.some(s=>s.id===dragState.sceneId));if(src)src.scenes=src.scenes.filter(s=>s.id!==dragState.sceneId);const tgt=chapters.find(c=>c.id===tid);if(!tgt)return;let idx=0;for(const el of Array.from(ct.children)){if(el===ph)break;if(el.classList&&el.classList.contains('scene-card'))idx++;}sc.chapterId=tid;tgt.scenes.splice(idx,0,sc);}
        function completeCD(){const ct=document.getElementById('storyboard-container');if(!ct)return;const di=chapters.findIndex(c=>c.id===dragState.chapterId);if(di===-1)return;let idx=0;for(const el of Array.from(ct.children)){if(el===dragState.placeholder)break;if(el.classList&&el.classList.contains('chapter-card'))idx++;}if(idx!==di){const ch=chapters.splice(di,1)[0];if(di<idx)idx--;chapters.splice(idx,0,ch);}}
        function cancelDrag(){if(dragState.ghost)dragState.ghost.remove();if(dragState.placeholder)dragState.placeholder.remove();if(dragState.element)dragState.element.style.display='';resetDS();}
        function resetDS(){dragState={active:false,element:null,type:null,ghost:null,placeholder:null,startX:0,startY:0,offsetX:0,offsetY:0,longPressTimer:null,hasMoved:false,sceneId:null,chapterId:null};}

        // PICKERS
        function getKnownChars(){const n=new Set();chapters.forEach(ch=>ch.scenes.forEach(sc=>{if(sc.characters)sc.characters.split(',').forEach(c=>{const t=c.trim();if(t)n.add(t);});}));Object.keys(characters).forEach(k=>n.add(k));return Array.from(n).sort();}
        function getKnownSyms(){const n=new Set();chapters.forEach(ch=>ch.scenes.forEach(sc=>{if(sc.symbols)sc.symbols.split(',').forEach(s=>{const t=s.trim();if(t)n.add(t);});}));symbols.forEach(s=>n.add(s.title));return Array.from(n).sort();}
        function toggleCharacterPicker(){const p=document.getElementById('character-picker');if(p.classList.contains('show')){p.classList.remove('show');return;}const k=getKnownChars(),c=document.getElementById('scene-characters').value.split(',').map(s=>s.trim()).filter(Boolean);p.innerHTML=k.length===0?'<div class="picker-empty">No characters yet.</div>':k.map(n=>{const s=c.includes(n);return`<div class="picker-item ${s?'selected':''}" onclick="tpi('scene-characters','${n.replace(/'/g,"\\'")}',this)"><div class="picker-item-check">${s?'âœ“':''}</div><span>${n}</span></div>`;}).join('');p.classList.add('show');}
        function toggleSymbolPicker(){const p=document.getElementById('symbol-picker');if(p.classList.contains('show')){p.classList.remove('show');return;}const k=getKnownSyms(),c=document.getElementById('scene-symbols').value.split(',').map(s=>s.trim()).filter(Boolean);p.innerHTML=k.length===0?'<div class="picker-empty">No symbols yet.</div>':k.map(n=>{const s=c.includes(n);return`<div class="picker-item ${s?'selected':''}" onclick="tpi('scene-symbols','${n.replace(/'/g,"\\'")}',this)"><div class="picker-item-check">${s?'âœ“':''}</div><span>${n}</span></div>`;}).join('');p.classList.add('show');}
        function tpi(fid,name,el){const inp=document.getElementById(fid);let items=inp.value.split(',').map(s=>s.trim()).filter(Boolean);const i=items.indexOf(name);if(i>=0){items.splice(i,1);el.classList.remove('selected');el.querySelector('.picker-item-check').textContent='';}else{items.push(name);el.classList.add('selected');el.querySelector('.picker-item-check').textContent='âœ“';}inp.value=items.join(', ');}
        document.addEventListener('click',function(e){if(!e.target.closest('#character-picker')&&!e.target.closest('.picker-btn')){const p=document.getElementById('character-picker');if(p)p.classList.remove('show');}if(!e.target.closest('#symbol-picker')&&!e.target.closest('.picker-btn')){const p=document.getElementById('symbol-picker');if(p)p.classList.remove('show');}});

        // RENDER
        function renderCurrentTab(){switch(currentTab){case'storyboard':renderSB();break;case'characters':renderChars();break;case'emotion':if(emotionSub==='arc')renderUserArc();else renderBeatsPanel();break;case'symbols':renderSyms();break;}}

        function renderSB(){
            const ct=document.getElementById('storyboard-container');
            if(!chapters.length){ct.innerHTML='<div class="empty-state"><div class="empty-state-icon">ðŸ“–</div><h3>No Chapters Yet</h3><p>Click "Add New Chapter" to begin.</p></div>';return;}
            ct.innerHTML=chapters.map((ch,idx)=>`
                <div class="chapter-card" data-chapter-id="${ch.id}">
                    <div class="chapter-header" onclick="handleCHC(event,${ch.id})">
                        <div class="drag-handle" title="Drag to reorder">â‹®â‹®</div>
                        <div><div class="chapter-number">Chapter ${idx+1}</div><div class="chapter-title">${ch.title}</div></div>
                        <div style="display:flex;align-items:center;">
                            <div class="chapter-stats">${ch.scenes.length} scene${ch.scenes.length!==1?'s':''}</div>
                            <button class="chapter-edit-btn" onclick="event.stopPropagation();editChapter(${ch.id})">Edit</button>
                            <div class="chapter-collapse-arrow" id="arrow-${ch.id}">â–¾</div>
                        </div>
                    </div>
                    <div class="scenes-container" id="scenes-${ch.id}" data-chapter-id="${ch.id}">
                        ${ch.scenes.map(sc=>`
                            <div class="scene-card" data-scene-id="${sc.id}" onclick="handleSCC(event,${sc.id})">
                                <div class="drag-handle" title="Drag">â‹®â‹®</div>
                                <div class="scene-header"><div class="scene-title">${sc.title}</div><div><span class="scene-type">${sc.type}</span><span class="scene-emotion" style="background:${getEC(sc.emotion)}"></span></div></div>
                                <div class="scene-description">${sc.description}</div>
                                <div class="scene-meta">${sc.characters?`<span>â—† ${sc.characters}</span>`:''}${sc.symbols?`<span>â—‡ ${sc.symbols}</span>`:''}</div>
                            </div>`).join('')}
                        <button class="add-scene-btn" onclick="addScene(${ch.id})">+ Add Scene</button>
                    </div>
                </div>`).join('');
        }

        function handleCHC(e,id){if(e.target.closest('.drag-handle')||e.target.closest('.chapter-edit-btn'))return;toggleCS(id);}
        function toggleCS(id){const s=document.getElementById(`scenes-${id}`),a=document.getElementById(`arrow-${id}`);if(s.style.display==='none'){s.style.display='block';a.classList.remove('collapsed');}else{s.style.display='none';a.classList.add('collapsed');}}
        function handleSCC(e,id){if(e.target.closest('.drag-handle')||dragState.hasMoved)return;editScene(id);}

        function renderChars(){
            const ct=document.getElementById('characters-container');const all=getAllChars();
            if(!all.length){ct.innerHTML='<div class="empty-state"><div class="empty-state-icon">â—†</div><h3>No Characters Yet</h3><p>Add characters to scenes to see them here.</p></div>';return;}
            ct.innerHTML=all.map(c=>{const a=getCharApps(c.name),p=characters[c.name];return`<div class="character-card" onclick="editCharacter('${c.name.replace(/'/g,"\\'")}')"><div class="character-name">${c.name} ${p?'âœ¦':''}</div><div class="character-stats">${a.length} scene${a.length!==1?'s':''} / ${getCharChaps(c.name).length} chapter${getCharChaps(c.name).length!==1?'s':''}</div>${p?`<div style="font-family:var(--font-serif);font-style:italic;font-size:0.825rem;color:var(--text-muted);margin-top:0.35rem;">${p.arc||'No arc defined'}</div>`:''}</div>`;}).join('');
        }

        // ===== EMOTION: YOUR ARC =====
        function renderUserArc(){
            const canvas=document.getElementById('emotion-canvas'),ctx=canvas.getContext('2d');
            canvas.width=canvas.offsetWidth;canvas.height=canvas.offsetHeight;
            const allS=getAllSIO();
            const pad={top:30,right:20,bottom:30,left:40},cw=canvas.width-pad.left-pad.right,ch=canvas.height-pad.top-pad.bottom;
            ctx.clearRect(0,0,canvas.width,canvas.height);

            // Grid
            ctx.strokeStyle='rgba(120,119,148,0.12)';ctx.lineWidth=1;
            for(let i=-5;i<=5;i++){const y=pad.top+((5-i)/10)*ch;ctx.beginPath();ctx.moveTo(pad.left,y);ctx.lineTo(pad.left+cw,y);ctx.stroke();}
            ctx.fillStyle='#52506a';ctx.font='10px "IBM Plex Mono"';ctx.textAlign='right';
            for(let i=-5;i<=5;i+=5){ctx.fillText(i.toString(),pad.left-8,pad.top+((5-i)/10)*ch+3);}
            ctx.strokeStyle='rgba(120,119,148,0.25)';ctx.beginPath();ctx.moveTo(pad.left,pad.top+0.5*ch);ctx.lineTo(pad.left+cw,pad.top+0.5*ch);ctx.stroke();

            if(!allS.length){ctx.fillStyle='#52506a';ctx.font='14px "IBM Plex Mono"';ctx.textAlign='center';ctx.fillText('No scenes yet',canvas.width/2,canvas.height/2);renderES([]);return;}

            // Line
            if(allS.length>1){ctx.beginPath();ctx.strokeStyle='#5b6fa3';ctx.lineWidth=2.5;allS.forEach((s,i)=>{const x=pad.left+(i/(allS.length-1))*cw,y=pad.top+((5-s.emotion)/10)*ch;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});ctx.stroke();}
            // Dots
            allS.forEach((s,i)=>{const x=pad.left+(i/Math.max(1,allS.length-1))*cw,y=pad.top+((5-s.emotion)/10)*ch;ctx.fillStyle=getEC(s.emotion);ctx.beginPath();ctx.arc(x,y,5,0,2*Math.PI);ctx.fill();ctx.strokeStyle='rgba(12,16,33,0.8)';ctx.lineWidth=1.5;ctx.stroke();});
            // Chapter boundaries
            let si=0;chapters.forEach(c=>{if(c.scenes.length){const x=pad.left+(si/Math.max(1,allS.length-1))*cw;ctx.strokeStyle='rgba(124,111,174,0.3)';ctx.lineWidth=1;ctx.setLineDash([3,3]);ctx.beginPath();ctx.moveTo(x,pad.top);ctx.lineTo(x,pad.top+ch);ctx.stroke();ctx.setLineDash([]);si+=c.scenes.length;}});
            // Scene labels on x
            ctx.fillStyle='#52506a';ctx.font='8px "IBM Plex Mono"';ctx.textAlign='center';
            allS.forEach((s,i)=>{if(allS.length<=10||i%Math.ceil(allS.length/8)===0){const x=pad.left+(i/Math.max(1,allS.length-1))*cw;ctx.save();ctx.translate(x,pad.top+ch+8);ctx.rotate(Math.PI/6);ctx.fillText(s.title.length>10?s.title.substring(0,9)+'â€¦':s.title,0,0);ctx.restore();}});

            renderES(allS);
        }

        function renderES(scenes){
            const ct=document.getElementById('emotion-stats');
            if(!scenes.length){ct.innerHTML='';return;}
            const avg=scenes.reduce((s,sc)=>s+sc.emotion,0)/scenes.length;
            const range=Math.max(...scenes.map(s=>s.emotion))-Math.min(...scenes.map(s=>s.emotion));
            ct.innerHTML=`<div class="emotion-chart"><h3 style="margin-bottom:0.75rem;">Statistics</h3>
                <div class="stat-grid"><div class="stat-box"><div class="val" style="color:${getEC(Math.round(avg))}">${avg.toFixed(1)}</div><div class="lbl">Avg Emotion</div></div><div class="stat-box"><div class="val" style="color:var(--accent-blue)">${range}</div><div class="lbl">Range</div></div><div class="stat-box"><div class="val" style="color:var(--accent-purple)">${scenes.length}</div><div class="lbl">Total Scenes</div></div></div>
                <div style="margin-top:1rem;">${chapters.map(ch=>{const cs=ch.scenes;const a=cs.length?(cs.reduce((s,sc)=>s+sc.emotion,0)/cs.length).toFixed(1):'â€”';return`<div style="display:flex;justify-content:space-between;padding:0.25rem 0;font-size:0.8rem;"><span style="font-family:var(--font-serif);color:var(--text-primary)">${ch.title}</span><span style="font-family:var(--font-mono);color:${a==='â€”'?'var(--text-faint)':getEC(parseFloat(a))}">${a}</span></div>`;}).join('')}</div></div>`;
        }

        // ===== EMOTION: BEAT SHEET =====
        function renderBeatsPanel(){
            renderBeatsCanvas();
            renderBeatMapping();
        }

        function renderBeatsCanvas(){
            const canvas=document.getElementById('beats-canvas'),ctx=canvas.getContext('2d');
            canvas.width=canvas.offsetWidth;canvas.height=canvas.offsetHeight;
            const pad={top:30,right:20,bottom:30,left:40},cw=canvas.width-pad.left-pad.right,ch=canvas.height-pad.top-pad.bottom;
            ctx.clearRect(0,0,canvas.width,canvas.height);

            // Grid
            ctx.strokeStyle='rgba(120,119,148,0.12)';ctx.lineWidth=1;
            for(let i=-5;i<=5;i++){const y=pad.top+((5-i)/10)*ch;ctx.beginPath();ctx.moveTo(pad.left,y);ctx.lineTo(pad.left+cw,y);ctx.stroke();}
            ctx.fillStyle='#52506a';ctx.font='10px "IBM Plex Mono"';ctx.textAlign='right';
            for(let i=-5;i<=5;i+=5){ctx.fillText(i.toString(),pad.left-8,pad.top+((5-i)/10)*ch+3);}
            ctx.strokeStyle='rgba(120,119,148,0.25)';ctx.beginPath();ctx.moveTo(pad.left,pad.top+0.5*ch);ctx.lineTo(pad.left+cw,pad.top+0.5*ch);ctx.stroke();

            // STC curve
            ctx.beginPath();ctx.strokeStyle='rgba(207,163,84,0.6)';ctx.lineWidth=2.5;
            STC.forEach((b,i)=>{const x=pad.left+(b.pct/100)*cw,y=pad.top+((5-b.emotion)/10)*ch;i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);});
            ctx.stroke();

            // STC dots + labels
            const show=[0,3,5,7,8,10,11,13,14];
            STC.forEach((b,i)=>{
                const x=pad.left+(b.pct/100)*cw,y=pad.top+((5-b.emotion)/10)*ch;
                ctx.save();ctx.translate(x,y);ctx.rotate(Math.PI/4);ctx.fillStyle='var(--accent-amber)';ctx.fillRect(-4,-4,8,8);ctx.restore();
                if(show.includes(i)){ctx.save();ctx.translate(x,y-12);ctx.rotate(-Math.PI/6);ctx.fillStyle='rgba(207,163,84,0.7)';ctx.font='8px "IBM Plex Mono"';ctx.textAlign='left';ctx.fillText(b.name.length>16?b.name.substring(0,14)+'â€¦':b.name,0,0);ctx.restore();}
            });

            // % markers on x
            ctx.fillStyle='#52506a';ctx.font='8px "IBM Plex Mono"';ctx.textAlign='center';
            [0,25,50,75,100].forEach(p=>{const x=pad.left+(p/100)*cw;ctx.fillText(p+'%',x,pad.top+ch+14);});
        }

        function renderBeatMapping(){
            const ct=document.getElementById('beat-mapping-container');
            // Build options: all scenes grouped by chapter
            let opts='<option value="">â€” Not assigned â€”</option>';
            chapters.forEach((ch,ci)=>{
                opts+=`<optgroup label="Ch. ${ci+1}: ${ch.title}">`;
                opts+=`<option value="ch:${ch.id}">Entire Chapter ${ci+1}</option>`;
                ch.scenes.forEach(sc=>{opts+=`<option value="sc:${sc.id}">${sc.title}</option>`;});
                opts+='</optgroup>';
            });

            ct.innerHTML=STC.map(b=>{
                const val=beatMapping[b.id]||'';
                return`<div class="beat-item">
                    <div class="beat-item-header"><div class="beat-name">${b.name}</div><div class="beat-pct">${b.pct}%</div></div>
                    <div class="beat-desc">${b.desc}</div>
                    <select class="beat-select" onchange="setBeatMapping('${b.id}',this.value)">${opts.replace(`value="${val}"`,`value="${val}" selected`)}</select>
                </div>`;
            }).join('');
        }

        function setBeatMapping(beatId,val){
            if(val)beatMapping[beatId]=val;
            else delete beatMapping[beatId];
            saveToStorage();
        }

        function renderSyms(){
            const ct=document.getElementById('symbols-container');
            if(!symbols.length){ct.innerHTML='<div class="empty-state"><div class="empty-state-icon">â—‡</div><h3>No Symbols Yet</h3><p>Click "Add New Symbol" to start tracking motifs.</p></div>';return;}
            ct.innerHTML=symbols.map(s=>`<div class="symbol-card" onclick="editSymbol(${s.id})"><div class="symbol-title">${s.title}</div><div class="symbol-connections">${s.connectedChapters.length} chapter${s.connectedChapters.length!==1?'s':''}</div><div style="font-family:var(--font-serif);font-style:italic;font-size:0.825rem;color:var(--text-muted);margin-top:0.35rem;">${s.description}</div></div>`).join('');
        }

        // MODALS
        function openModal(id){document.getElementById(id).style.display='block';}
        function closeModal(id){document.getElementById(id).style.display='none';currentEditingScene=currentEditingChapter=currentEditingCharacter=currentEditingSymbol=null;['character-picker','symbol-picker'].forEach(pid=>{const p=document.getElementById(pid);if(p)p.classList.remove('show');});}

        // SCENE CRUD
        function addScene(cid){currentEditingScene=null;['scene-title','scene-description','scene-characters','scene-symbols','scene-notes'].forEach(id=>document.getElementById(id).value='');document.getElementById('scene-type').value='action';document.getElementById('scene-emotion').value='0';document.getElementById('emotion-value').textContent='0';document.getElementById('emotion-value').style.color=getEC(0);document.getElementById('delete-scene-btn').style.display='none';document.getElementById('scene-form').dataset.chapterId=cid;openModal('scene-modal');}
        function editScene(sid){const sc=findScene(sid);if(!sc)return;currentEditingScene=sc;document.getElementById('scene-title').value=sc.title;document.getElementById('scene-type').value=sc.type;document.getElementById('scene-emotion').value=sc.emotion;document.getElementById('emotion-value').textContent=sc.emotion;document.getElementById('emotion-value').style.color=getEC(sc.emotion);document.getElementById('scene-description').value=sc.description;document.getElementById('scene-characters').value=sc.characters;document.getElementById('scene-symbols').value=sc.symbols;document.getElementById('scene-notes').value=sc.notes;document.getElementById('delete-scene-btn').style.display='block';openModal('scene-modal');}
        function saveScene(e){e.preventDefault();const fd={title:document.getElementById('scene-title').value,type:document.getElementById('scene-type').value,emotion:parseInt(document.getElementById('scene-emotion').value),description:document.getElementById('scene-description').value,characters:document.getElementById('scene-characters').value,symbols:document.getElementById('scene-symbols').value,notes:document.getElementById('scene-notes').value};if(currentEditingScene)Object.assign(currentEditingScene,fd);else{const cid=parseInt(document.getElementById('scene-form').dataset.chapterId);const ch=chapters.find(c=>c.id===cid);if(ch)ch.scenes.push({id:Date.now(),chapterId:cid,...fd});}saveToStorage();closeModal('scene-modal');renderCurrentTab();}
        function deleteScene(){if(!currentEditingScene||!confirm('Delete this scene?'))return;const ch=chapters.find(c=>c.id===currentEditingScene.chapterId);if(ch)ch.scenes=ch.scenes.filter(s=>s.id!==currentEditingScene.id);saveToStorage();closeModal('scene-modal');renderCurrentTab();}

        // CHAPTER CRUD
        function addChapter(){currentEditingChapter=null;document.getElementById('chapter-title').value='';document.getElementById('delete-chapter-btn').style.display='none';document.getElementById('chapter-modal-title').textContent='New Chapter';openModal('chapter-modal');}
        function editChapter(id){const ch=chapters.find(c=>c.id===id);if(!ch)return;currentEditingChapter=ch;document.getElementById('chapter-title').value=ch.title;document.getElementById('delete-chapter-btn').style.display='block';document.getElementById('chapter-modal-title').textContent='Edit Chapter';openModal('chapter-modal');}
        function saveChapter(e){e.preventDefault();const t=document.getElementById('chapter-title').value;if(currentEditingChapter)currentEditingChapter.title=t;else chapters.push({id:Date.now(),title:t,scenes:[]});saveToStorage();closeModal('chapter-modal');renderCurrentTab();}
        function deleteChapter(){if(!currentEditingChapter||!confirm('Delete "'+currentEditingChapter.title+'" and all its scenes?'))return;chapters=chapters.filter(c=>c.id!==currentEditingChapter.id);saveToStorage();closeModal('chapter-modal');renderCurrentTab();}

        // CHARACTER CRUD
        function editCharacter(n){currentEditingCharacter=n;const c=characters[n]||{arc:'',appearance:'',notes:''};document.getElementById('character-name').value=n;document.getElementById('character-arc').value=c.arc;document.getElementById('character-appearance').value=c.appearance;document.getElementById('character-notes').value=c.notes;openModal('character-modal');}
        function saveCharacter(e){e.preventDefault();characters[document.getElementById('character-name').value]={arc:document.getElementById('character-arc').value,appearance:document.getElementById('character-appearance').value,notes:document.getElementById('character-notes').value};saveToStorage();closeModal('character-modal');renderCurrentTab();}

        // SYMBOL CRUD
        function addSymbol(){currentEditingSymbol=null;document.getElementById('symbol-title').value='';document.getElementById('symbol-description').value='';document.getElementById('delete-symbol-btn').style.display='none';updateCCB([]);openModal('symbol-modal');}
        function editSymbol(id){const s=symbols.find(x=>x.id===id);if(!s)return;currentEditingSymbol=s;document.getElementById('symbol-title').value=s.title;document.getElementById('symbol-description').value=s.description;document.getElementById('delete-symbol-btn').style.display='block';updateCCB(s.connectedChapters);openModal('symbol-modal');}
        function updateCCB(conn=[]){document.getElementById('chapter-checkboxes').innerHTML=chapters.map((ch,i)=>`<div class="checkbox-item"><input type="checkbox" id="ch-${ch.id}" value="${ch.id}" ${conn.includes(ch.id)?'checked':''}><label for="ch-${ch.id}" style="color:var(--text-primary)">Ch. ${i+1}: ${ch.title}</label></div>`).join('');}
        function saveSymbol(e){e.preventDefault();const fd={title:document.getElementById('symbol-title').value,description:document.getElementById('symbol-description').value,connectedChapters:Array.from(document.querySelectorAll('#chapter-checkboxes input:checked')).map(i=>parseInt(i.value))};if(currentEditingSymbol)Object.assign(currentEditingSymbol,fd);else symbols.push({id:Date.now(),...fd});saveToStorage();closeModal('symbol-modal');renderCurrentTab();}
        function deleteSymbol(){if(!currentEditingSymbol||!confirm('Delete this symbol?'))return;symbols=symbols.filter(s=>s.id!==currentEditingSymbol.id);saveToStorage();closeModal('symbol-modal');renderCurrentTab();}

        // UTILS
        function findScene(id){for(const ch of chapters){const s=ch.scenes.find(x=>x.id===id);if(s)return s;}return null;}
        function getEC(e){if(e<=-3)return'#b44a4a';if(e<=-1)return'#d4783a';if(e===0)return'#52506a';if(e<=2)return'#5a9a6a';return'#5b6fa3';}
        function getAllChars(){const cc={};chapters.forEach(ch=>ch.scenes.forEach(sc=>{if(sc.characters)sc.characters.split(',').forEach(c=>{const n=c.trim();if(n)cc[n]=(cc[n]||0)+1;});}));return Object.keys(cc).map(n=>({name:n,count:cc[n]}));}
        function getCharApps(n){const a=[];chapters.forEach(ch=>ch.scenes.forEach(sc=>{if(sc.characters&&sc.characters.includes(n))a.push({chapter:ch.title,scene:sc.title});}));return a;}
        function getCharChaps(n){const ids=new Set();chapters.forEach(ch=>ch.scenes.forEach(sc=>{if(sc.characters&&sc.characters.includes(n))ids.add(ch.id);}));return Array.from(ids);}
        function getAllSIO(){const a=[];chapters.forEach(ch=>ch.scenes.forEach(sc=>a.push(sc)));return a;}

        // TOOLS
        function toggleTools(){const m=document.getElementById('tools-menu'),a=document.getElementById('tools-arrow');m.classList.contains('show')?(m.classList.remove('show'),a.textContent='â–¾'):(m.classList.add('show'),a.textContent='â–´');}
        function exportData(){const d={chapters,characters,symbols,beatMapping,timestamp:new Date().toISOString()};const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=`novel-storyboard-${new Date().toISOString().split('T')[0]}.json`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);toggleTools();}
        function importData(){document.getElementById('import-file').click();toggleTools();}
        function handleImport(ev){const f=ev.target.files[0];if(!f)return;const r=new FileReader();r.onload=function(e){try{const d=JSON.parse(e.target.result);if(d.chapters)chapters=d.chapters;if(d.characters)characters=d.characters;if(d.symbols)symbols=d.symbols;if(d.beatMapping)beatMapping=d.beatMapping;saveToStorage();renderCurrentTab();alert('Imported!');}catch(err){alert('Invalid file format');}};r.readAsText(f);ev.target.value='';}
        function clearAllData(){if(confirm('Clear all data?')&&confirm('Delete EVERYTHING?')){chapters=[];characters={};symbols={};beatMapping={};saveToStorage();renderCurrentTab();toggleTools();}}

        // STORAGE
        function saveToStorage(){try{localStorage.setItem('novel-storyboard-data',JSON.stringify({chapters,characters,symbols,beatMapping,timestamp:new Date().toISOString(),version:'3.0'}));showSI();}catch(e){}}
        function loadFromStorage(){try{const d=localStorage.getItem('novel-storyboard-data');if(d){const p=JSON.parse(d);if(p.chapters)chapters=p.chapters;if(p.characters)characters=p.characters;if(p.symbols)symbols=p.symbols;if(p.beatMapping)beatMapping=p.beatMapping;return true;}}catch(e){}loadSample();return false;}
        function showSI(){let ind=document.getElementById('save-indicator');if(!ind){ind=document.createElement('div');ind.id='save-indicator';ind.className='save-indicator';ind.textContent='âœ“ Saved';document.body.appendChild(ind);}ind.style.opacity='1';setTimeout(()=>{ind.style.opacity='0';},1500);}
        function showStorageStatus(){try{localStorage.setItem('test','test');localStorage.removeItem('test');const h=document.querySelector('.app-header');const d=document.createElement('div');d.style.cssText='font-family:var(--font-mono);font-size:0.65rem;color:var(--accent-green);margin-top:0.35rem;letter-spacing:0.08em;';d.textContent='âœ“ Auto-save enabled';h.appendChild(d);}catch(e){}}

        function loadSample(){
            chapters=[
                {id:1,title:"The Beginning",scenes:[
                    {id:1,title:"Opening Scene",type:"description",emotion:-2,description:"A dark and stormy night sets the mood.",characters:"Protagonist, Mysterious Figure",symbols:"Storm, Darkness",notes:"Establish tone",chapterId:1},
                    {id:2,title:"The Call",type:"dialogue",emotion:1,description:"An unexpected phone call changes everything.",characters:"Protagonist, Voice on Phone",symbols:"Phone",notes:"Inciting incident",chapterId:1}
                ]},
                {id:2,title:"The Journey",scenes:[
                    {id:3,title:"Departure",type:"action",emotion:3,description:"The protagonist leaves home.",characters:"Protagonist",symbols:"Journey, Door",notes:"First plot point",chapterId:2}
                ]}
            ];
            characters={"Protagonist":{arc:"Reluctant hero to confident leader",appearance:"Tall, dark hair, green eyes",notes:"Mysterious past"}};
            symbols=[{id:1,title:"The Storm",description:"Internal conflict and chaos",connectedChapters:[1]}];
            beatMapping={};
        }

        init();
    </script>
</body>
</html>
