<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novel Storyboard â€” The Post Idealist</title>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=IBM+Plex+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-deep: #0c1021;
            --bg-primary: #111827;
            --bg-card: #161d2e;
            --bg-card-hover: #1c2538;
            --bg-input: #1a2236;
            --border-subtle: rgba(120, 119, 148, 0.2);
            --border-accent: rgba(207, 163, 84, 0.4);
            --border-accent-strong: rgba(207, 163, 84, 0.7);
            --text-primary: #d4cfc4;
            --text-heading: #e8dcc8;
            --text-muted: #7a7891;
            --text-faint: #52506a;
            --accent-amber: #cf9f4a;
            --accent-amber-dim: rgba(207, 163, 84, 0.15);
            --accent-orange: #d4783a;
            --accent-blue: #5b6fa3;
            --accent-purple: #7c6fae;
            --accent-red: #b44a4a;
            --accent-green: #5a9a6a;
            --font-display: 'Special Elite', cursive;
            --font-serif: 'Libre Baskerville', Georgia, serif;
            --font-mono: 'IBM Plex Mono', 'Courier New', monospace;
        }

        body {
            font-family: var(--font-mono);
            background: var(--bg-deep);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: 80px;
        }

        /* ===== HEADER ===== */
        .app-header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-subtle);
            padding: 1.25rem 1rem 1rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-date {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--text-muted);
            letter-spacing: 0.15em;
            margin-bottom: 0.5rem;
        }

        .app-title {
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-weight: 400;
            color: var(--text-heading);
            letter-spacing: 0.2em;
            text-transform: uppercase;
            margin-bottom: 0.2rem;
        }

        .app-subtitle {
            font-family: var(--font-mono);
            font-size: 0.65rem;
            color: var(--text-muted);
            letter-spacing: 0.35em;
            text-transform: uppercase;
        }

        .header-diamonds {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            margin-bottom: 0.25rem;
        }

        .header-diamonds::before,
        .header-diamonds::after {
            content: '';
            flex: 1;
            max-width: 120px;
            height: 1px;
            background: var(--border-subtle);
        }

        .diamond { width: 10px; height: 10px; transform: rotate(45deg); border: 1.5px solid var(--accent-amber); }
        .diamond.filled { background: var(--accent-amber); }
        .diamond.small { width: 7px; height: 7px; border-color: var(--text-faint); }

        /* ===== TABS ===== */
        .tab-nav {
            display: flex;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-subtle);
            overflow-x: auto;
        }

        .tab-button {
            flex: 1;
            min-width: 80px;
            padding: 0.7rem 0.5rem;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
            font-family: var(--font-mono);
            font-size: 0.75rem;
            font-weight: 500;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            color: var(--text-heading);
            border-bottom-color: var(--accent-amber);
            background: rgba(207, 163, 84, 0.05);
        }

        .tab-button:hover:not(.active) { color: var(--text-primary); }

        /* ===== CONTENT ===== */
        .tab-content { padding: 1rem; min-height: calc(100vh - 170px); }

        .section-heading {
            font-family: var(--font-display);
            font-size: 1.4rem;
            color: var(--text-heading);
            letter-spacing: 0.08em;
            margin-bottom: 0.25rem;
        }

        .section-sub {
            font-family: var(--font-serif);
            font-style: italic;
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .section-rule { width: 60px; height: 2px; background: var(--accent-orange); border: none; margin-bottom: 1.5rem; }

        /* ===== CHAPTER CARD ===== */
        .chapter-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: border-color 0.3s ease;
        }

        .chapter-card:hover { border-color: var(--border-accent); }

        .chapter-header {
            background: rgba(30, 38, 58, 0.8);
            padding: 0.85rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid var(--border-subtle);
            position: relative;
        }

        .chapter-number {
            font-family: var(--font-mono);
            font-size: 0.65rem;
            color: var(--accent-amber);
            letter-spacing: 0.15em;
            text-transform: uppercase;
            margin-bottom: 0.15rem;
        }

        .chapter-title {
            font-family: var(--font-display);
            font-size: 1.15rem;
            color: var(--text-heading);
            letter-spacing: 0.05em;
        }

        .chapter-stats {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .chapter-collapse-arrow {
            color: var(--text-faint);
            font-size: 0.75rem;
            transition: transform 0.3s ease;
            margin-left: 0.5rem;
        }

        .chapter-collapse-arrow.collapsed { transform: rotate(-90deg); }

        .chapter-header .drag-handle { position: absolute; right: 0.5rem; top: 0.35rem; font-size: 0.85rem; }

        /* ===== SCENES ===== */
        .scenes-container { padding: 0.5rem 0.75rem; }

        .scene-card {
            background: rgba(22, 29, 46, 0.6);
            border: 1px solid var(--border-subtle);
            border-left: 3px solid var(--accent-amber);
            border-radius: 2px;
            padding: 0.85rem 1rem;
            margin: 0.5rem 0;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            touch-action: manipulation;
            user-select: none;
        }

        .scene-card:hover { border-color: var(--border-accent); background: var(--bg-card-hover); }

        .scene-card.dragging { transform: rotate(1deg) scale(1.02); opacity: 0.8; z-index: 1000; box-shadow: 0 8px 25px rgba(0,0,0,0.4); }

        .scene-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.4rem; }

        .scene-title { font-family: var(--font-serif); font-weight: 700; color: var(--text-heading); font-size: 0.95rem; }

        .scene-type {
            font-family: var(--font-mono);
            color: var(--accent-amber);
            padding: 0.15rem 0.45rem;
            border: 1px solid var(--border-accent);
            border-radius: 2px;
            font-size: 0.6rem;
            font-weight: 500;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .scene-emotion { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-left: 0.5rem; }

        .scene-description { font-family: var(--font-serif); font-style: italic; color: var(--text-muted); font-size: 0.825rem; line-height: 1.5; margin-bottom: 0.5rem; }

        .scene-meta { display: flex; gap: 1rem; font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-faint); }

        /* ===== BUTTONS ===== */
        .add-scene-btn {
            background: transparent;
            border: 1px dashed var(--border-accent);
            color: var(--accent-amber);
            font-family: var(--font-mono);
            font-size: 0.8rem;
            letter-spacing: 0.05em;
            padding: 0.65rem;
            margin: 0.5rem 0;
            border-radius: 2px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }

        .add-scene-btn:hover { background: var(--accent-amber-dim); border-style: solid; }

        .add-chapter-btn {
            background: transparent;
            border: 1px solid var(--border-accent);
            color: var(--accent-amber);
            font-family: var(--font-mono);
            font-size: 0.85rem;
            font-weight: 500;
            letter-spacing: 0.1em;
            padding: 0.85rem;
            margin: 0 0 1.5rem 0;
            border-radius: 2px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        }

        .add-chapter-btn:hover { background: var(--accent-amber-dim); box-shadow: 0 0 20px rgba(207, 163, 84, 0.1); }

        .drag-handle {
            position: absolute; right: 0.5rem; top: 0.5rem;
            color: var(--text-faint); font-size: 0.85rem;
            user-select: none; cursor: grab;
            padding: 0.2rem 0.4rem; border-radius: 2px;
            transition: color 0.2s ease; z-index: 2;
        }

        .drag-handle:hover { color: var(--accent-amber); }
        .drag-handle:active { cursor: grabbing; }

        .drag-placeholder {
            border: 1px dashed var(--border-accent);
            background: var(--accent-amber-dim);
            border-radius: 2px;
            margin: 0.5rem 0;
            transition: height 0.2s ease;
        }

        /* ===== MODALS ===== */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(8, 10, 20, 0.85); backdrop-filter: blur(4px);
            z-index: 1000; padding: 1rem;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-top: 2px solid var(--accent-amber);
            border-radius: 2px;
            padding: 1.5rem;
            max-width: 500px;
            margin: 2rem auto;
            max-height: calc(100vh - 4rem);
            overflow-y: auto;
        }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }

        .modal-title { font-family: var(--font-display); font-size: 1.1rem; color: var(--text-heading); letter-spacing: 0.08em; }

        .close-btn { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; padding: 0.25rem; line-height: 1; }
        .close-btn:hover { color: var(--accent-red); }

        /* ===== FORMS ===== */
        .form-group { margin-bottom: 1rem; }

        .form-label {
            display: block; margin-bottom: 0.4rem;
            font-family: var(--font-mono); font-size: 0.75rem;
            color: var(--text-muted); letter-spacing: 0.08em; text-transform: uppercase;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%; background: var(--bg-input);
            border: 1px solid var(--border-subtle); border-radius: 2px;
            padding: 0.7rem; color: var(--text-primary);
            font-family: var(--font-mono); font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none; border-color: var(--accent-amber);
            box-shadow: 0 0 0 2px var(--accent-amber-dim);
        }

        .form-textarea { min-height: 80px; resize: vertical; font-family: var(--font-serif); }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%237a7891'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            padding-right: 2rem;
        }

        .emotion-slider {
            width: 100%; height: 6px; border-radius: 3px;
            background: linear-gradient(to right, var(--accent-red), var(--accent-orange), var(--accent-green), var(--accent-blue));
            outline: none; -webkit-appearance: none;
        }

        .emotion-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%;
            background: var(--text-heading); border: 2px solid var(--accent-amber); cursor: pointer;
        }

        .emotion-value { text-align: center; margin-top: 0.4rem; font-family: var(--font-mono); font-weight: 600; font-size: 0.85rem; color: var(--accent-amber); }

        .modal-actions { display: flex; gap: 0.75rem; margin-top: 1.5rem; }

        .btn {
            flex: 1; padding: 0.7rem; border: none; border-radius: 2px;
            font-family: var(--font-mono); font-size: 0.8rem; font-weight: 500;
            letter-spacing: 0.05em; cursor: pointer; transition: all 0.3s ease;
        }

        .btn-primary { background: var(--accent-amber); color: var(--bg-deep); }
        .btn-primary:hover { box-shadow: 0 0 15px rgba(207, 163, 84, 0.3); }
        .btn-danger { background: var(--accent-red); color: var(--text-heading); }
        .btn-secondary { background: transparent; color: var(--text-muted); border: 1px solid var(--border-subtle); }
        .btn-secondary:hover { border-color: var(--text-muted); }

        /* ===== BOTTOM TOOLS ===== */
        .bottom-tools { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-primary); border-top: 1px solid var(--border-subtle); z-index: 98; }

        .tools-toggle {
            background: var(--bg-card); border: none; border-top: 1px solid var(--border-accent);
            color: var(--text-primary); font-family: var(--font-mono); font-size: 0.8rem; letter-spacing: 0.1em;
            padding: 0.85rem; width: 100%; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }

        .tools-menu { display: none; padding: 0.75rem; background: var(--bg-card); }
        .tools-menu.show { display: block; animation: slideUp 0.25s ease; }

        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .tool-btn {
            background: transparent; border: 1px solid var(--border-subtle);
            color: var(--text-primary); font-family: var(--font-mono); font-size: 0.8rem;
            padding: 0.65rem 1rem; margin: 0.2rem 0; width: 100%; border-radius: 2px;
            cursor: pointer; transition: all 0.3s ease; text-align: left;
        }

        .tool-btn:hover { border-color: var(--border-accent); background: var(--accent-amber-dim); }

        /* ===== CARDS ===== */
        .character-card, .symbol-card {
            background: var(--bg-card); border: 1px solid var(--border-subtle);
            border-left: 3px solid var(--accent-blue); border-radius: 2px;
            padding: 1rem; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.3s ease;
        }

        .symbol-card { border-left-color: var(--accent-purple); }
        .character-card:hover, .symbol-card:hover { border-color: var(--border-accent); background: var(--bg-card-hover); }

        .character-name, .symbol-title { font-family: var(--font-serif); font-weight: 700; color: var(--text-heading); margin-bottom: 0.35rem; font-size: 0.95rem; }
        .character-stats, .symbol-connections { font-family: var(--font-mono); font-size: 0.75rem; color: var(--text-muted); }

        /* ===== EMOTION CHART ===== */
        .emotion-chart {
            background: var(--bg-card); border: 1px solid var(--border-subtle);
            border-radius: 4px; padding: 1.25rem; margin-bottom: 1rem;
        }

        .emotion-chart h3 { font-family: var(--font-display); color: var(--text-heading); letter-spacing: 0.08em; font-size: 1rem; }

        .chart-canvas { width: 100%; height: 320px; background: rgba(22, 29, 46, 0.5); border-radius: 2px; }

        .beat-toggle { display: flex; align-items: center; gap: 0.5rem; margin: 0.75rem 0; cursor: pointer; }
        .beat-toggle input { accent-color: var(--accent-amber); }
        .beat-toggle label { font-family: var(--font-mono); font-size: 0.75rem; color: var(--text-muted); cursor: pointer; letter-spacing: 0.05em; }

        .beat-legend { margin-top: 1rem; }
        .beat-legend-title { font-family: var(--font-mono); font-size: 0.7rem; color: var(--accent-amber); letter-spacing: 0.15em; text-transform: uppercase; margin-bottom: 0.75rem; padding-bottom: 0.35rem; border-bottom: 1px solid var(--border-subtle); }

        .beat-item { display: flex; gap: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid rgba(120, 119, 148, 0.08); align-items: flex-start; }
        .beat-item:last-child { border-bottom: none; }
        .beat-pct { font-family: var(--font-mono); font-size: 0.65rem; color: var(--accent-amber); min-width: 32px; text-align: right; padding-top: 0.1rem; }
        .beat-name { font-family: var(--font-serif); font-weight: 700; font-size: 0.8rem; color: var(--text-heading); margin-bottom: 0.15rem; }
        .beat-desc { font-family: var(--font-serif); font-style: italic; font-size: 0.75rem; color: var(--text-muted); line-height: 1.4; }

        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin-top: 0.75rem; }
        .stat-box { text-align: center; padding: 0.75rem; background: rgba(22, 29, 46, 0.5); border: 1px solid var(--border-subtle); border-radius: 2px; }
        .stat-box .val { font-family: var(--font-mono); font-size: 1.4rem; font-weight: 600; }
        .stat-box .lbl { font-family: var(--font-mono); font-size: 0.65rem; color: var(--text-muted); letter-spacing: 0.08em; text-transform: uppercase; margin-top: 0.2rem; }

        /* ===== PICKER ===== */
        .input-with-picker { display: flex; gap: 0.5rem; align-items: flex-start; }
        .input-with-picker .form-input { flex: 1; }

        .picker-btn {
            background: var(--bg-input); border: 1px solid var(--border-accent);
            color: var(--accent-amber); font-family: var(--font-mono); font-size: 0.75rem;
            padding: 0.7rem 0.75rem; border-radius: 2px; cursor: pointer; transition: all 0.3s ease;
            white-space: nowrap; flex-shrink: 0;
        }

        .picker-btn:hover { background: var(--accent-amber-dim); }

        .picker-dropdown {
            display: none; background: var(--bg-card); border: 1px solid var(--border-accent);
            border-radius: 2px; margin-top: 0.5rem; max-height: 200px; overflow-y: auto;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
        }

        .picker-dropdown.show { display: block; }

        .picker-item {
            padding: 0.55rem 0.85rem; cursor: pointer; font-family: var(--font-mono);
            color: var(--text-muted); font-size: 0.8rem; transition: all 0.15s ease;
            display: flex; align-items: center; gap: 0.5rem;
            border-bottom: 1px solid rgba(120, 119, 148, 0.08);
        }

        .picker-item:last-child { border-bottom: none; }
        .picker-item:hover { background: var(--accent-amber-dim); color: var(--text-heading); }
        .picker-item.selected { color: var(--accent-amber); }

        .picker-item-check {
            width: 14px; height: 14px; border: 1.5px solid var(--border-subtle);
            border-radius: 2px; display: flex; align-items: center; justify-content: center;
            font-size: 0.6rem; flex-shrink: 0;
        }

        .picker-item.selected .picker-item-check { background: var(--accent-amber); border-color: var(--accent-amber); color: var(--bg-deep); }

        .picker-empty { padding: 0.85rem; text-align: center; font-family: var(--font-serif); font-style: italic; color: var(--text-faint); font-size: 0.8rem; }

        .checkbox-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.4rem; margin-top: 0.4rem; }
        .checkbox-item { display: flex; align-items: center; gap: 0.5rem; font-family: var(--font-mono); font-size: 0.8rem; }
        .checkbox-item input[type="checkbox"] { accent-color: var(--accent-amber); }

        .empty-state { text-align: center; padding: 3rem 1rem; color: var(--text-muted); }
        .empty-state-icon { font-size: 2.5rem; margin-bottom: 0.75rem; opacity: 0.4; }
        .empty-state h3 { font-family: var(--font-display); color: var(--text-heading); letter-spacing: 0.08em; margin-bottom: 0.5rem; }
        .empty-state p { font-family: var(--font-serif); font-style: italic; font-size: 0.85rem; }

        .save-indicator {
            position: fixed; top: 10px; right: 10px;
            font-family: var(--font-mono); font-size: 0.75rem;
            background: rgba(90, 154, 106, 0.9); color: var(--text-heading);
            padding: 0.4rem 0.8rem; border-radius: 2px; z-index: 2000;
            opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
        }

        @media (max-width: 768px) {
            .tab-button { font-size: 0.65rem; padding: 0.55rem 0.25rem; }
            .modal-content { margin: 1rem auto; padding: 1rem; }
            .modal-actions { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="app-header">
        <div class="header-date" id="header-date"></div>
        <div class="app-title">Novel Storyboard</div>
        <div class="app-subtitle">Scenes &bull; Structure &bull; Emotion</div>
        <div class="header-diamonds">
            <span class="diamond filled"></span>
            <span class="diamond small"></span>
            <span class="diamond filled"></span>
        </div>
    </div>

    <nav class="tab-nav">
        <button class="tab-button active" data-tab="storyboard">Storyboard</button>
        <button class="tab-button" data-tab="characters">Characters</button>
        <button class="tab-button" data-tab="emotion">Emotion</button>
        <button class="tab-button" data-tab="symbols">Symbols</button>
    </nav>

    <div id="storyboard-tab" class="tab-content">
        <h2 class="section-heading">Storyboard</h2>
        <p class="section-sub">Chapters and scenes, in order</p>
        <hr class="section-rule">
        <button class="add-chapter-btn" onclick="addChapter()">+ Add New Chapter</button>
        <div id="storyboard-container"></div>
    </div>

    <div id="characters-tab" class="tab-content" style="display:none;">
        <h2 class="section-heading">Characters</h2>
        <p class="section-sub">Everyone who appears in your story</p>
        <hr class="section-rule">
        <div id="characters-container"></div>
    </div>

    <div id="emotion-tab" class="tab-content" style="display:none;">
        <h2 class="section-heading">Emotional Arc</h2>
        <p class="section-sub">Your novel's emotional landscape</p>
        <hr class="section-rule">
        <div class="emotion-chart">
            <div class="beat-toggle">
                <input type="checkbox" id="show-beats" checked>
                <label for="show-beats">Show Save the Cat! beat sheet overlay</label>
            </div>
            <canvas id="emotion-canvas" class="chart-canvas"></canvas>
        </div>
        <div id="emotion-stats"></div>
        <div id="beat-sheet-legend"></div>
    </div>

    <div id="symbols-tab" class="tab-content" style="display:none;">
        <h2 class="section-heading">Symbols</h2>
        <p class="section-sub">Recurring motifs and symbolic elements</p>
        <hr class="section-rule">
        <button class="add-chapter-btn" onclick="addSymbol()">+ Add New Symbol</button>
        <div id="symbols-container"></div>
    </div>

    <!-- Scene Modal -->
    <div id="scene-modal" class="modal"><div class="modal-content">
        <div class="modal-header"><h3 class="modal-title">Edit Scene</h3><button class="close-btn" onclick="closeModal('scene-modal')">&times;</button></div>
        <form id="scene-form">
            <div class="form-group"><label class="form-label">Title</label><input type="text" id="scene-title" class="form-input" required></div>
            <div class="form-group"><label class="form-label">Type</label>
                <select id="scene-type" class="form-select">
                    <option value="action">Action</option><option value="dialogue">Dialogue</option>
                    <option value="introspection">Introspection</option><option value="description">Description</option>
                    <option value="flashback">Flashback</option><option value="transition">Transition</option>
                    <option value="climax">Climax</option><option value="resolution">Resolution</option>
                </select>
            </div>
            <div class="form-group"><label class="form-label">Emotion (-5 to +5)</label>
                <input type="range" id="scene-emotion" class="emotion-slider" min="-5" max="5" value="0">
                <div class="emotion-value" id="emotion-value">0</div>
            </div>
            <div class="form-group"><label class="form-label">Description</label><textarea id="scene-description" class="form-textarea" rows="3"></textarea></div>
            <div class="form-group"><label class="form-label">Characters</label>
                <div class="input-with-picker"><input type="text" id="scene-characters" class="form-input" placeholder="Comma-separated"><button type="button" class="picker-btn" onclick="toggleCharacterPicker()">+ Pick</button></div>
                <div id="character-picker" class="picker-dropdown"></div>
            </div>
            <div class="form-group"><label class="form-label">Symbols</label>
                <div class="input-with-picker"><input type="text" id="scene-symbols" class="form-input" placeholder="Comma-separated"><button type="button" class="picker-btn" onclick="toggleSymbolPicker()">+ Pick</button></div>
                <div id="symbol-picker" class="picker-dropdown"></div>
            </div>
            <div class="form-group"><label class="form-label">Notes</label><textarea id="scene-notes" class="form-textarea" rows="2"></textarea></div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('scene-modal')">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deleteScene()" style="display:none;" id="delete-scene-btn">Delete</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div></div>

    <!-- Chapter Modal -->
    <div id="chapter-modal" class="modal"><div class="modal-content">
        <div class="modal-header"><h3 class="modal-title">Edit Chapter</h3><button class="close-btn" onclick="closeModal('chapter-modal')">&times;</button></div>
        <form id="chapter-form">
            <div class="form-group"><label class="form-label">Chapter Title</label><input type="text" id="chapter-title" class="form-input" required></div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('chapter-modal')">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deleteChapter()" style="display:none;" id="delete-chapter-btn">Delete</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div></div>

    <!-- Character Modal -->
    <div id="character-modal" class="modal"><div class="modal-content">
        <div class="modal-header"><h3 class="modal-title">Edit Character</h3><button class="close-btn" onclick="closeModal('character-modal')">&times;</button></div>
        <form id="character-form">
            <div class="form-group"><label class="form-label">Name</label><input type="text" id="character-name" class="form-input" required></div>
            <div class="form-group"><label class="form-label">Character Arc</label><textarea id="character-arc" class="form-textarea" rows="3"></textarea></div>
            <div class="form-group"><label class="form-label">Appearance</label><textarea id="character-appearance" class="form-textarea" rows="3"></textarea></div>
            <div class="form-group"><label class="form-label">Notes</label><textarea id="character-notes" class="form-textarea" rows="3"></textarea></div>
            <div class="modal-actions"><button type="button" class="btn btn-secondary" onclick="closeModal('character-modal')">Cancel</button><button type="submit" class="btn btn-primary">Save</button></div>
        </form>
    </div></div>

    <!-- Symbol Modal -->
    <div id="symbol-modal" class="modal"><div class="modal-content">
        <div class="modal-header"><h3 class="modal-title">Edit Symbol</h3><button class="close-btn" onclick="closeModal('symbol-modal')">&times;</button></div>
        <form id="symbol-form">
            <div class="form-group"><label class="form-label">Symbol Title</label><input type="text" id="symbol-title" class="form-input" required></div>
            <div class="form-group"><label class="form-label">Description</label><textarea id="symbol-description" class="form-textarea" rows="3"></textarea></div>
            <div class="form-group"><label class="form-label">Connected Chapters</label><div id="chapter-checkboxes" class="checkbox-group"></div></div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('symbol-modal')">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deleteSymbol()" style="display:none;" id="delete-symbol-btn">Delete</button>
                <button type="submit" class="btn btn-primary">Save</button>
            </div>
        </form>
    </div></div>

    <div class="bottom-tools">
        <button class="tools-toggle" onclick="toggleTools()">âš™ Tools <span id="tools-arrow">â–¾</span></button>
        <div class="tools-menu" id="tools-menu">
            <button class="tool-btn" onclick="exportData()">â†‘ Export Data</button>
            <button class="tool-btn" onclick="importData()">â†“ Import Data</button>
            <button class="tool-btn" onclick="clearAllData()">âœ• Clear All Data</button>
        </div>
    </div>
    <input type="file" id="import-file" accept=".json" style="display:none;" onchange="handleImport(event)">

    <script>
        let chapters=[], characters={}, symbols=[], currentTab='storyboard';
        let currentEditingScene=null, currentEditingChapter=null, currentEditingCharacter=null, currentEditingSymbol=null;

        const STC_BEATS = [
            {name:"Opening Image",pct:0,emotion:0,desc:"A snapshot of the protagonist's world \"before\" â€” sets tone and stakes."},
            {name:"Theme Stated",pct:5,emotion:0,desc:"Someone poses a thematic question the hero doesn't yet understand."},
            {name:"Setup",pct:8,emotion:0,desc:"Establish the hero's world, flaws, and what needs to change."},
            {name:"Catalyst",pct:10,emotion:-1,desc:"A life-changing event that disrupts the status quo."},
            {name:"Debate",pct:15,emotion:-2,desc:"The hero hesitates â€” should they answer the call?"},
            {name:"Break into Two",pct:20,emotion:1,desc:"The hero commits and enters a new, upside-down world."},
            {name:"B Story",pct:22,emotion:2,desc:"A subplot begins (often love interest or mentor) that mirrors the theme."},
            {name:"Fun & Games",pct:35,emotion:3,desc:"The \"promise of the premise\" â€” what drew readers to this story."},
            {name:"Midpoint",pct:50,emotion:2,desc:"A false victory (or false defeat) that raises the stakes."},
            {name:"Bad Guys Close In",pct:62,emotion:-1,desc:"External pressures tighten; internal doubts and team fractures grow."},
            {name:"All Is Lost",pct:75,emotion:-4,desc:"The lowest point. A \"whiff of death\" â€” something or someone is lost."},
            {name:"Dark Night of the Soul",pct:80,emotion:-5,desc:"The hero wallows in hopelessness before finding clarity."},
            {name:"Break into Three",pct:82,emotion:-2,desc:"An \"a-ha\" moment â€” the hero synthesizes A and B stories."},
            {name:"Finale",pct:92,emotion:3,desc:"The hero proves transformation by confronting the problem in a new way."},
            {name:"Final Image",pct:100,emotion:4,desc:"A mirror of the opening â€” proof that change has occurred."}
        ];

        let dragState={active:false,element:null,type:null,ghost:null,placeholder:null,startX:0,startY:0,offsetX:0,offsetY:0,longPressTimer:null,hasMoved:false,sourceChapterId:null,sceneId:null,chapterId:null};

        function init(){
            const now=new Date();
            document.getElementById('header-date').textContent=now.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
            setupTabs(); setupDragAndDrop(); loadFromStorage(); renderCurrentTab();
            document.getElementById('scene-emotion').addEventListener('input',function(){document.getElementById('emotion-value').textContent=this.value;document.getElementById('emotion-value').style.color=getEmotionColor(parseInt(this.value));});
            document.getElementById('scene-form').addEventListener('submit',saveScene);
            document.getElementById('chapter-form').addEventListener('submit',saveChapter);
            document.getElementById('character-form').addEventListener('submit',saveCharacter);
            document.getElementById('symbol-form').addEventListener('submit',saveSymbol);
            document.getElementById('show-beats').addEventListener('change',()=>{if(currentTab==='emotion')renderEmotionChart();});
            showStorageStatus();
        }

        function setupTabs(){document.querySelectorAll('.tab-button').forEach(b=>b.addEventListener('click',()=>switchTab(b.dataset.tab)));}
        function switchTab(t){document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));document.querySelector(`[data-tab="${t}"]`).classList.add('active');document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');document.getElementById(`${t}-tab`).style.display='block';currentTab=t;renderCurrentTab();}

        // DRAG
        function setupDragAndDrop(){
            document.addEventListener('contextmenu',e=>{if(e.target.closest('.drag-handle'))e.preventDefault();});
            document.addEventListener('touchstart',onPD,{passive:false});document.addEventListener('touchmove',onPM,{passive:false});
            document.addEventListener('touchend',onPU,{passive:false});document.addEventListener('touchcancel',onPU,{passive:false});
            document.addEventListener('mousedown',onPD);document.addEventListener('mousemove',onPM);document.addEventListener('mouseup',onPU);
        }
        function gpp(e){if(e.touches&&e.touches.length)return{x:e.touches[0].clientX,y:e.touches[0].clientY};if(e.changedTouches&&e.changedTouches.length)return{x:e.changedTouches[0].clientX,y:e.changedTouches[0].clientY};return{x:e.clientX,y:e.clientY};}

        function onPD(e){
            const h=e.target.closest('.drag-handle');if(!h)return;
            const card=h.closest('.scene-card,.chapter-card');if(!card)return;
            const p=gpp(e);dragState.startX=p.x;dragState.startY=p.y;dragState.hasMoved=false;dragState.element=card;
            if(card.classList.contains('scene-card')){dragState.type='scene';dragState.sceneId=parseInt(card.dataset.sceneId);const c=card.closest('.scenes-container');dragState.sourceChapterId=c?parseInt(c.dataset.chapterId):null;}
            else{dragState.type='chapter';dragState.chapterId=parseInt(card.dataset.chapterId);}
            if(e.touches){dragState.longPressTimer=setTimeout(()=>beginDrag(e),200);}else{beginDrag(e);e.preventDefault();}
        }
        function beginDrag(e){
            const card=dragState.element;if(!card)return;dragState.active=true;
            const r=card.getBoundingClientRect();const g=card.cloneNode(true);g.id='drag-ghost';
            g.style.cssText=`position:fixed;pointer-events:none;z-index:2000;width:${r.width}px;opacity:0.85;transform:rotate(1deg) scale(1.02);box-shadow:0 12px 35px rgba(0,0,0,0.5);transition:none;`;
            const p=gpp(e);dragState.offsetX=p.x-r.left;dragState.offsetY=p.y-r.top;
            g.style.left=(p.x-dragState.offsetX)+'px';g.style.top=(p.y-dragState.offsetY)+'px';
            document.body.appendChild(g);dragState.ghost=g;
            const ph=document.createElement('div');ph.className='drag-placeholder';ph.style.height=r.height+'px';
            card.parentNode.insertBefore(ph,card);dragState.placeholder=ph;card.style.display='none';
            if(navigator.vibrate)navigator.vibrate(30);
        }
        function onPM(e){
            if(!dragState.element)return;const p=gpp(e);
            if(dragState.longPressTimer){if(Math.abs(p.x-dragState.startX)>8||Math.abs(p.y-dragState.startY)>8){clearTimeout(dragState.longPressTimer);dragState.longPressTimer=null;if(!dragState.active){resetDS();return;}}}
            if(!dragState.active)return;e.preventDefault();dragState.hasMoved=true;
            if(dragState.ghost){dragState.ghost.style.left=(p.x-dragState.offsetX)+'px';dragState.ghost.style.top=(p.y-dragState.offsetY)+'px';}
            updatePH(p.x,p.y);
            if(p.y<60)window.scrollBy(0,-8);else if(p.y>window.innerHeight-60)window.scrollBy(0,8);
        }
        function updatePH(x,y){
            if(!dragState.placeholder)return;
            if(dragState.type==='scene'){
                if(dragState.ghost)dragState.ghost.style.display='none';const el=document.elementFromPoint(x,y);if(dragState.ghost)dragState.ghost.style.display='';
                const tc=el?el.closest('.scenes-container'):null;
                if(tc){const cards=Array.from(tc.querySelectorAll('.scene-card:not([style*="display: none"])'));let ref=null;
                for(const c of cards){const r=c.getBoundingClientRect();if(y<r.top+r.height/2){ref=c;break;}}
                const btn=tc.querySelector('.add-scene-btn');
                if(ref)tc.insertBefore(dragState.placeholder,ref);else if(btn)tc.insertBefore(dragState.placeholder,btn);else tc.appendChild(dragState.placeholder);}
            }else if(dragState.type==='chapter'){
                const ct=document.getElementById('storyboard-container');if(!ct)return;
                const cards=Array.from(ct.querySelectorAll('.chapter-card:not([style*="display: none"])'));let ref=null;
                for(const c of cards){const r=c.getBoundingClientRect();if(y<r.top+r.height/2){ref=c;break;}}
                if(ref)ct.insertBefore(dragState.placeholder,ref);else ct.appendChild(dragState.placeholder);
            }
        }
        function onPU(e){if(dragState.longPressTimer){clearTimeout(dragState.longPressTimer);dragState.longPressTimer=null;}if(!dragState.active){resetDS();return;}completeDrop();}
        function completeDrop(){
            if(!dragState.placeholder||!dragState.element){cancelDrag();return;}
            if(dragState.type==='scene')completeSD();else if(dragState.type==='chapter')completeCD();
            if(dragState.ghost)dragState.ghost.remove();if(dragState.placeholder)dragState.placeholder.remove();
            if(dragState.element)dragState.element.style.display='';dragState.element=null;resetDS();saveToStorage();renderCurrentTab();
        }
        function completeSD(){
            const ph=dragState.placeholder;const ct=ph.closest('.scenes-container');if(!ct)return;
            const tid=parseInt(ct.dataset.chapterId);const sc=findScene(dragState.sceneId);if(!sc)return;
            const src=chapters.find(c=>c.scenes.some(s=>s.id===dragState.sceneId));if(src)src.scenes=src.scenes.filter(s=>s.id!==dragState.sceneId);
            const tgt=chapters.find(c=>c.id===tid);if(!tgt)return;
            let idx=0;for(const el of Array.from(ct.children)){if(el===ph)break;if(el.classList&&el.classList.contains('scene-card'))idx++;}
            sc.chapterId=tid;tgt.scenes.splice(idx,0,sc);
        }
        function completeCD(){
            const ph=dragState.placeholder;const ct=document.getElementById('storyboard-container');if(!ct)return;
            const di=chapters.findIndex(c=>c.id===dragState.chapterId);if(di===-1)return;
            let idx=0;for(const el of Array.from(ct.children)){if(el===ph)break;if(el.classList&&el.classList.contains('chapter-card'))idx++;}
            if(idx!==di){const ch=chapters.splice(di,1)[0];if(di<idx)idx--;chapters.splice(idx,0,ch);}
        }
        function cancelDrag(){if(dragState.ghost)dragState.ghost.remove();if(dragState.placeholder)dragState.placeholder.remove();if(dragState.element)dragState.element.style.display='';resetDS();}
        function resetDS(){dragState={active:false,element:null,type:null,ghost:null,placeholder:null,startX:0,startY:0,offsetX:0,offsetY:0,longPressTimer:null,hasMoved:false,sourceChapterId:null,sceneId:null,chapterId:null};}

        // PICKERS
        function getKnownChars(){const n=new Set();chapters.forEach(ch=>ch.scenes.forEach(sc=>{if(sc.characters)sc.characters.split(',').forEach(c=>{const t=c.trim();if(t)n.add(t);});}));Object.keys(characters).forEach(k=>n.add(k));return Array.from(n).sort();}
        function getKnownSyms(){const n=new Set();chapters.forEach(ch=>ch.scenes.forEach(sc=>{if(sc.symbols)sc.symbols.split(',').forEach(s=>{const t=s.trim();if(t)n.add(t);});}));symbols.forEach(s=>n.add(s.title));return Array.from(n).sort();}
        function getCFI(id){return document.getElementById(id).value.split(',').map(s=>s.trim()).filter(Boolean);}
        function toggleCharacterPicker(){const p=document.getElementById('character-picker');if(p.classList.contains('show')){p.classList.remove('show');return;}const k=getKnownChars(),c=getCFI('scene-characters');p.innerHTML=k.length===0?'<div class="picker-empty">No characters found yet.</div>':k.map(n=>{const s=c.includes(n);return`<div class="picker-item ${s?'selected':''}" onclick="tpi('scene-characters','${n.replace(/'/g,"\\'")}',this)"><div class="picker-item-check">${s?'âœ“':''}</div><span>${n}</span></div>`;}).join('');p.classList.add('show');}
        function toggleSymbolPicker(){const p=document.getElementById('symbol-picker');if(p.classList.contains('show')){p.classList.remove('show');return;}const k=getKnownSyms(),c=getCFI('scene-symbols');p.innerHTML=k.length===0?'<div class="picker-empty">No symbols found yet.</div>':k.map(n=>{const s=c.includes(n);return`<div class="picker-item ${s?'selected':''}" onclick="tpi('scene-symbols','${n.replace(/'/g,"\\'")}',this)"><div class="picker-item-check">${s?'âœ“':''}</div><span>${n}</span></div>`;}).join('');p.classList.add('show');}
        function tpi(fid,name,el){const inp=document.getElementById(fid);let items=inp.value.split(',').map(s=>s.trim()).filter(Boolean);const i=items.indexOf(name);if(i>=0){items.splice(i,1);el.classList.remove('selected');el.querySelector('.picker-item-check').textContent='';}else{items.push(name);el.classList.add('selected');el.querySelector('.picker-item-check').textContent='âœ“';}inp.value=items.join(', ');}
        document.addEventListener('click',function(e){if(!e.target.closest('#character-picker')&&!e.target.closest('.picker-btn')){const p=document.getElementById('character-picker');if(p)p.classList.remove('show');}if(!e.target.closest('#symbol-picker')&&!e.target.closest('.picker-btn')){const p=document.getElementById('symbol-picker');if(p)p.classList.remove('show');}});

        // RENDER
        function renderCurrentTab(){switch(currentTab){case'storyboard':renderSB();break;case'characters':renderChars();break;case'emotion':renderEC();break;case'symbols':renderSyms();break;}}

        function renderSB(){
            const ct=document.getElementById('storyboard-container');
            if(chapters.length===0){ct.innerHTML='<div class="empty-state"><div class="empty-state-icon">ðŸ“–</div><h3>No Chapters Yet</h3><p>Click "Add New Chapter" above to begin your story.</p></div>';return;}
            ct.innerHTML=chapters.map((ch,idx)=>`
                <div class="chapter-card" data-chapter-id="${ch.id}">
                    <div class="chapter-header" onclick="handleCHC(event,${ch.id})">
                        <div class="drag-handle" title="Drag to reorder">â‹®â‹®</div>
                        <div>
                            <div class="chapter-number">Chapter ${idx+1}</div>
                            <div class="chapter-title">${ch.title}</div>
                        </div>
                        <div style="display:flex;align-items:center;gap:0.5rem;">
                            <div class="chapter-stats">${ch.scenes.length} scene${ch.scenes.length!==1?'s':''}</div>
                            <div class="chapter-collapse-arrow" id="arrow-${ch.id}">â–¾</div>
                        </div>
                    </div>
                    <div class="scenes-container" id="scenes-${ch.id}" data-chapter-id="${ch.id}">
                        ${ch.scenes.map(sc=>`
                            <div class="scene-card" data-scene-id="${sc.id}" onclick="handleSCC(event,${sc.id})">
                                <div class="drag-handle" title="Drag to reorder">â‹®â‹®</div>
                                <div class="scene-header">
                                    <div class="scene-title">${sc.title}</div>
                                    <div><span class="scene-type">${sc.type}</span><span class="scene-emotion" style="background:${getEmotionColor(sc.emotion)}"></span></div>
                                </div>
                                <div class="scene-description">${sc.description}</div>
                                <div class="scene-meta">${sc.characters?`<span>â—† ${sc.characters}</span>`:''}${sc.symbols?`<span>â—‡ ${sc.symbols}</span>`:''}</div>
                            </div>
                        `).join('')}
                        <button class="add-scene-btn" onclick="addScene(${ch.id})">+ Add Scene</button>
                    </div>
                </div>
            `).join('');
        }

        function handleCHC(e,id){if(e.target.closest('.drag-handle'))return;toggleCS(id);}
        function toggleCS(id){const s=document.getElementById(`scenes-${id}`),a=document.getElementById(`arrow-${id}`);if(s.style.display==='none'){s.style.display='block';a.classList.remove('collapsed');}else{s.style.display='none';a.classList.add('collapsed');}}
        function handleSCC(e,id){if(e.target.closest('.drag-handle')||dragState.hasMoved)return;editScene(id);}

        function renderChars(){
            const ct=document.getElementById('characters-container');const all=getAllChars();
            if(all.length===0){ct.innerHTML='<div class="empty-state"><div class="empty-state-icon">â—†</div><h3>No Characters Yet</h3><p>Add characters to your scenes to see them here.</p></div>';return;}
            ct.innerHTML=all.map(c=>{const a=getCharApps(c.name),p=characters[c.name];
                return`<div class="character-card" onclick="editCharacter('${c.name.replace(/'/g,"\\'")}')"><div class="character-name">${c.name} ${p?'âœ¦':''}</div><div class="character-stats">${a.length} scene${a.length!==1?'s':''} across ${getCharChaps(c.name).length} chapter${getCharChaps(c.name).length!==1?'s':''}</div>${p?`<div style="font-family:var(--font-serif);font-style:italic;font-size:0.825rem;color:var(--text-muted);margin-top:0.35rem;">${p.arc||'No arc defined'}</div>`:''}</div>`;
            }).join('');
        }

        function renderEC(){
            const canvas=document.getElementById('emotion-canvas'),ctx=canvas.getContext('2d');
            canvas.width=canvas.offsetWidth;canvas.height=canvas.offsetHeight;
            const showBeats=document.getElementById('show-beats').checked;
            const allS=getAllSIO();
            const pad={top:35,right:20,bottom:35,left:40};
            const cw=canvas.width-pad.left-pad.right,ch=canvas.height-pad.top-pad.bottom;

            ctx.clearRect(0,0,canvas.width,canvas.height);

            // Grid
            ctx.strokeStyle='rgba(120,119,148,0.12)';ctx.lineWidth=1;
            for(let i=-5;i<=5;i++){const y=pad.top+((5-i)/10)*ch;ctx.beginPath();ctx.moveTo(pad.left,y);ctx.lineTo(pad.left+cw,y);ctx.stroke();}

            // Y labels
            ctx.fillStyle='#52506a';ctx.font='10px "IBM Plex Mono"';ctx.textAlign='right';
            for(let i=-5;i<=5;i+=5){const y=pad.top+((5-i)/10)*ch;ctx.fillText(i.toString(),pad.left-8,y+3);}

            // Zero line
            ctx.strokeStyle='rgba(120,119,148,0.25)';const zy=pad.top+0.5*ch;ctx.beginPath();ctx.moveTo(pad.left,zy);ctx.lineTo(pad.left+cw,zy);ctx.stroke();

            // Beat sheet
            if(showBeats){
                ctx.beginPath();ctx.strokeStyle='rgba(207,163,84,0.35)';ctx.lineWidth=2;ctx.setLineDash([4,4]);
                STC_BEATS.forEach((b,i)=>{const x=pad.left+(b.pct/100)*cw,y=pad.top+((5-b.emotion)/10)*ch;if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);});
                ctx.stroke();ctx.setLineDash([]);

                const show=[0,3,5,7,8,10,11,13,14];
                STC_BEATS.forEach((b,i)=>{
                    const x=pad.left+(b.pct/100)*cw,y=pad.top+((5-b.emotion)/10)*ch;
                    ctx.save();ctx.translate(x,y);ctx.rotate(Math.PI/4);ctx.fillStyle='rgba(207,163,84,0.5)';ctx.fillRect(-3,-3,6,6);ctx.restore();
                    if(show.includes(i)){ctx.save();ctx.translate(x,y-10);ctx.rotate(-Math.PI/6);ctx.fillStyle='rgba(207,163,84,0.5)';ctx.font='8px "IBM Plex Mono"';ctx.textAlign='left';ctx.fillText(b.name.length>14?b.name.substring(0,12)+'â€¦':b.name,0,0);ctx.restore();}
                });
            }

            // User arc
            if(allS.length>0){
                if(allS.length>1){ctx.beginPath();ctx.strokeStyle='#5b6fa3';ctx.lineWidth=2.5;allS.forEach((s,i)=>{const x=pad.left+(i/(allS.length-1))*cw,y=pad.top+((5-s.emotion)/10)*ch;if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);});ctx.stroke();}
                allS.forEach((s,i)=>{const x=pad.left+(i/Math.max(1,allS.length-1))*cw,y=pad.top+((5-s.emotion)/10)*ch;ctx.fillStyle=getEmotionColor(s.emotion);ctx.beginPath();ctx.arc(x,y,5,0,2*Math.PI);ctx.fill();ctx.strokeStyle='rgba(12,16,33,0.8)';ctx.lineWidth=1.5;ctx.stroke();});
                let si=0;chapters.forEach(c=>{if(c.scenes.length>0){const x=pad.left+(si/Math.max(1,allS.length-1))*cw;ctx.strokeStyle='rgba(124,111,174,0.3)';ctx.lineWidth=1;ctx.setLineDash([3,3]);ctx.beginPath();ctx.moveTo(x,pad.top);ctx.lineTo(x,pad.top+ch);ctx.stroke();ctx.setLineDash([]);si+=c.scenes.length;}});
            }else{ctx.fillStyle='#52506a';ctx.font='14px "IBM Plex Mono"';ctx.textAlign='center';ctx.fillText('No scenes to display',canvas.width/2,canvas.height/2);}

            renderES(allS);renderBSL();
        }

        function renderES(scenes){
            const ct=document.getElementById('emotion-stats');if(scenes.length===0){ct.innerHTML='';return;}
            const avg=scenes.reduce((s,sc)=>s+sc.emotion,0)/scenes.length;
            const range=Math.max(...scenes.map(s=>s.emotion))-Math.min(...scenes.map(s=>s.emotion));
            ct.innerHTML=`<div class="emotion-chart"><h3 style="margin-bottom:0.75rem;">Statistics</h3>
                <div class="stat-grid">
                    <div class="stat-box"><div class="val" style="color:${getEmotionColor(Math.round(avg))}">${avg.toFixed(1)}</div><div class="lbl">Avg Emotion</div></div>
                    <div class="stat-box"><div class="val" style="color:var(--accent-blue)">${range}</div><div class="lbl">Range</div></div>
                    <div class="stat-box"><div class="val" style="color:var(--accent-purple)">${scenes.length}</div><div class="lbl">Total Scenes</div></div>
                </div>
                <div style="margin-top:1rem;">${chapters.map(ch=>{const cs=ch.scenes;const a=cs.length?(cs.reduce((s,sc)=>s+sc.emotion,0)/cs.length).toFixed(1):'â€”';return`<div style="display:flex;justify-content:space-between;padding:0.25rem 0;font-size:0.8rem;"><span style="font-family:var(--font-serif);color:var(--text-primary)">${ch.title}</span><span style="font-family:var(--font-mono);color:${a==='â€”'?'var(--text-faint)':getEmotionColor(parseFloat(a))}">${a}</span></div>`;}).join('')}</div></div>`;
        }

        function renderBSL(){
            const ct=document.getElementById('beat-sheet-legend');
            if(!document.getElementById('show-beats').checked){ct.innerHTML='';return;}
            ct.innerHTML=`<div class="emotion-chart"><div class="beat-legend"><div class="beat-legend-title">Save the Cat! Beat Sheet</div>${STC_BEATS.map(b=>`<div class="beat-item"><div class="beat-pct">${b.pct}%</div><div><div class="beat-name">${b.name}</div><div class="beat-desc">${b.desc}</div></div></div>`).join('')}</div></div>`;
        }

        function renderSyms(){
            const ct=document.getElementById('symbols-container');
            if(symbols.length===0){ct.innerHTML='<div class="empty-state"><div class="empty-state-icon">â—‡</div><h3>No Symbols Yet</h3><p>Click "Add New Symbol" to start tracking motifs.</p></div>';return;}
            ct.innerHTML=symbols.map(s=>`<div class="symbol-card" onclick="editSymbol(${s.id})"><div class="symbol-title">${s.title}</div><div class="symbol-connections">${s.connectedChapters.length} chapter${s.connectedChapters.length!==1?'s':''}</div><div style="font-family:var(--font-serif);font-style:italic;font-size:0.825rem;color:var(--text-muted);margin-top:0.35rem;">${s.description}</div></div>`).join('');
        }

        // MODALS
        function openModal(id){document.getElementById(id).style.display='block';}
        function closeModal(id){document.getElementById(id).style.display='none';currentEditingScene=currentEditingChapter=currentEditingCharacter=currentEditingSymbol=null;const cp=document.getElementById('character-picker'),sp=document.getElementById('symbol-picker');if(cp)cp.classList.remove('show');if(sp)sp.classList.remove('show');}

        // SCENE CRUD
        function addScene(cid){currentEditingScene=null;['scene-title','scene-description','scene-characters','scene-symbols','scene-notes'].forEach(id=>document.getElementById(id).value='');document.getElementById('scene-type').value='action';document.getElementById('scene-emotion').value='0';document.getElementById('emotion-value').textContent='0';document.getElementById('emotion-value').style.color=getEmotionColor(0);document.getElementById('delete-scene-btn').style.display='none';document.getElementById('scene-form').dataset.chapterId=cid;openModal('scene-modal');}
        function editScene(sid){const sc=findScene(sid);if(!sc)return;currentEditingScene=sc;document.getElementById('scene-title').value=sc.title;document.getElementById('scene-type').value=sc.type;document.getElementById('scene-emotion').value=sc.emotion;document.getElementById('emotion-value').textContent=sc.emotion;document.getElementById('emotion-value').style.color=getEmotionColor(sc.emotion);document.getElementById('scene-description').value=sc.description;document.getElementById('scene-characters').value=sc.characters;document.getElementById('scene-symbols').value=sc.symbols;document.getElementById('scene-notes').value=sc.notes;document.getElementById('delete-scene-btn').style.display='block';openModal('scene-modal');}
        function saveScene(e){e.preventDefault();const fd={title:document.getElementById('scene-title').value,type:document.getElementById('scene-type').value,emotion:parseInt(document.getElementById('scene-emotion').value),description:document.getElementById('scene-description').value,characters:document.getElementById('scene-characters').value,symbols:document.getElementById('scene-symbols').value,notes:document.getElementById('scene-notes').value};if(currentEditingScene)Object.assign(currentEditingScene,fd);else{const cid=parseInt(document.getElementById('scene-form').dataset.chapterId);const ch=chapters.find(c=>c.id===cid);if(ch)ch.scenes.push({id:Date.now(),chapterId:cid,...fd});}saveToStorage();closeModal('scene-modal');renderCurrentTab();}
        function deleteScene(){if(!currentEditingScene||!confirm('Delete this scene?'))return;const ch=chapters.find(c=>c.id===currentEditingScene.chapterId);if(ch)ch.scenes=ch.scenes.filter(s=>s.id!==currentEditingScene.id);saveToStorage();closeModal('scene-modal');renderCurrentTab();}

        // CHAPTER CRUD
        function addChapter(){currentEditingChapter=null;document.getElementById('chapter-title').value='';document.getElementById('delete-chapter-btn').style.display='none';openModal('chapter-modal');}
        function editChapter(id){const ch=chapters.find(c=>c.id===id);if(!ch)return;currentEditingChapter=ch;document.getElementById('chapter-title').value=ch.title;document.getElementById('delete-chapter-btn').style.display='block';openModal('chapter-modal');}
        function saveChapter(e){e.preventDefault();const t=document.getElementById('chapter-title').value;if(currentEditingChapter)currentEditingChapter.title=t;else chapters.push({id:Date.now(),title:t,scenes:[]});saveToStorage();closeModal('chapter-modal');renderCurrentTab();}
        function deleteChapter(){if(!currentEditingChapter||!confirm('Delete this chapter and all its scenes?'))return;chapters=chapters.filter(c=>c.id!==currentEditingChapter.id);saveToStorage();closeModal('chapter-modal');renderCurrentTab();}

        // CHARACTER CRUD
        function editCharacter(n){currentEditingCharacter=n;const c=characters[n]||{arc:'',appearance:'',notes:''};document.getElementById('character-name').value=n;document.getElementById('character-arc').value=c.arc;document.getElementById('character-appearance').value=c.appearance;document.getElementById('character-notes').value=c.notes;openModal('character-modal');}
        function saveCharacter(e){e.preventDefault();characters[document.getElementById('character-name').value]={arc:document.getElementById('character-arc').value,appearance:document.getElementById('character-appearance').value,notes:document.getElementById('character-notes').value};saveToStorage();closeModal('character-modal');renderCurrentTab();}

        // SYMBOL CRUD
        function addSymbol(){currentEditingSymbol=null;document.getElementById('symbol-title').value='';document.getElementById('symbol-description').value='';document.getElementById('delete-symbol-btn').style.display='none';updateCCB([]);openModal('symbol-modal');}
        function editSymbol(id){const s=symbols.find(x=>x.id===id);if(!s)return;currentEditingSymbol=s;document.getElementById('symbol-title').value=s.title;document.getElementById('symbol-description').value=s.description;document.getElementById('delete-symbol-btn').style.display='block';updateCCB(s.connectedChapters);openModal('symbol-modal');}
        function updateCCB(conn=[]){document.getElementById('chapter-checkboxes').innerHTML=chapters.map((ch,i)=>`<div class="checkbox-item"><input type="checkbox" id="ch-${ch.id}" value="${ch.id}" ${conn.includes(ch.id)?'checked':''}><label for="ch-${ch.id}" style="color:var(--text-primary)">Ch. ${i+1}: ${ch.title}</label></div>`).join('');}
        function saveSymbol(e){e.preventDefault();const fd={title:document.getElementById('symbol-title').value,description:document.getElementById('symbol-description').value,connectedChapters:Array.from(document.querySelectorAll('#chapter-checkboxes input:checked')).map(i=>parseInt(i.value))};if(currentEditingSymbol)Object.assign(currentEditingSymbol,fd);else symbols.push({id:Date.now(),...fd});saveToStorage();closeModal('symbol-modal');renderCurrentTab();}
        function deleteSymbol(){if(!currentEditingSymbol||!confirm('Delete this symbol?'))return;symbols=symbols.filter(s=>s.id!==currentEditingSymbol.id);saveToStorage();closeModal('symbol-modal');renderCurrentTab();}

        // UTILS
        function findScene(id){for(const ch of chapters){const s=ch.scenes.find(x=>x.id===id);if(s)return s;}return null;}
        function getEmotionColor(e){if(e<=-3)return'#b44a4a';if(e<=-1)return'#d4783a';if(e===0)return'#52506a';if(e<=2)return'#5a9a6a';return'#5b6fa3';}
        function getAllChars(){const cc={};chapters.forEach(ch=>ch.scenes.forEach(sc=>{if(sc.characters)sc.characters.split(',').forEach(c=>{const n=c.trim();if(n)cc[n]=(cc[n]||0)+1;});}));return Object.keys(cc).map(n=>({name:n,count:cc[n]}));}
        function getCharApps(n){const a=[];chapters.forEach(ch=>ch.scenes.forEach(sc=>{if(sc.characters&&sc.characters.includes(n))a.push({chapter:ch.title,scene:sc.title});}));return a;}
        function getCharChaps(n){const ids=new Set();chapters.forEach(ch=>ch.scenes.forEach(sc=>{if(sc.characters&&sc.characters.includes(n))ids.add(ch.id);}));return Array.from(ids);}
        function getAllSIO(){const a=[];chapters.forEach(ch=>ch.scenes.forEach(sc=>a.push(sc)));return a;}

        // TOOLS
        function toggleTools(){const m=document.getElementById('tools-menu'),a=document.getElementById('tools-arrow');if(m.classList.contains('show')){m.classList.remove('show');a.textContent='â–¾';}else{m.classList.add('show');a.textContent='â–´';}}
        function exportData(){const d={chapters,characters,symbols,timestamp:new Date().toISOString()};const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=`novel-storyboard-${new Date().toISOString().split('T')[0]}.json`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);toggleTools();}
        function importData(){document.getElementById('import-file').click();toggleTools();}
        function handleImport(ev){const f=ev.target.files[0];if(!f)return;const r=new FileReader();r.onload=function(e){try{const d=JSON.parse(e.target.result);if(d.chapters&&Array.isArray(d.chapters))chapters=d.chapters;if(d.characters&&typeof d.characters==='object')characters=d.characters;if(d.symbols&&Array.isArray(d.symbols))symbols=d.symbols;saveToStorage();renderCurrentTab();alert('Imported successfully!');}catch(err){alert('Error: Invalid file format');}};r.readAsText(f);ev.target.value='';}
        function clearAllData(){if(confirm('Clear all data? This cannot be undone.')&&confirm('Delete ALL chapters, scenes, characters, and symbols?')){chapters=[];characters={};symbols=[];saveToStorage();renderCurrentTab();toggleTools();}}

        // STORAGE
        function saveToStorage(){try{localStorage.setItem('novel-storyboard-data',JSON.stringify({chapters,characters,symbols,timestamp:new Date().toISOString(),version:'2.0'}));showSaveInd();}catch(e){console.warn('Save error:',e);}}
        function loadFromStorage(){try{const d=localStorage.getItem('novel-storyboard-data');if(d){const p=JSON.parse(d);if(p.chapters&&Array.isArray(p.chapters))chapters=p.chapters;if(p.characters&&typeof p.characters==='object')characters=p.characters;if(p.symbols&&Array.isArray(p.symbols))symbols=p.symbols;return true;}}catch(e){console.warn('Load error:',e);}loadSample();return false;}
        function showSaveInd(){let ind=document.getElementById('save-indicator');if(!ind){ind=document.createElement('div');ind.id='save-indicator';ind.className='save-indicator';ind.textContent='âœ“ Saved';document.body.appendChild(ind);}ind.style.opacity='1';setTimeout(()=>{ind.style.opacity='0';},1500);}
        function showStorageStatus(){try{localStorage.setItem('test','test');localStorage.removeItem('test');const h=document.querySelector('.app-header');const d=document.createElement('div');d.style.cssText='font-family:var(--font-mono);font-size:0.65rem;color:var(--accent-green);margin-top:0.35rem;letter-spacing:0.08em;';d.textContent='âœ“ Auto-save enabled';h.appendChild(d);}catch(e){const h=document.querySelector('.app-header');const d=document.createElement('div');d.style.cssText='font-family:var(--font-mono);font-size:0.65rem;color:var(--accent-orange);margin-top:0.35rem;letter-spacing:0.08em;';d.textContent='âš  Auto-save unavailable';h.appendChild(d);}}

        function loadSample(){
            chapters=[
                {id:1,title:"The Beginning",scenes:[
                    {id:1,title:"Opening Scene",type:"description",emotion:-2,description:"A dark and stormy night sets the mood for our story.",characters:"Protagonist, Mysterious Figure",symbols:"Storm, Darkness",notes:"Establish tone and atmosphere",chapterId:1},
                    {id:2,title:"The Call",type:"dialogue",emotion:1,description:"The protagonist receives an unexpected phone call that changes everything.",characters:"Protagonist, Voice on Phone",symbols:"Phone",notes:"Inciting incident",chapterId:1}
                ]},
                {id:2,title:"The Journey",scenes:[
                    {id:3,title:"Departure",type:"action",emotion:3,description:"The protagonist leaves home and begins their adventure.",characters:"Protagonist",symbols:"Journey, Door",notes:"First plot point",chapterId:2}
                ]}
            ];
            characters={"Protagonist":{arc:"From reluctant hero to confident leader",appearance:"Tall, dark hair, piercing green eyes",notes:"Central character with mysterious past"}};
            symbols=[{id:1,title:"The Storm",description:"Represents internal conflict and chaos",connectedChapters:[1]}];
        }

        // Double-click chapter header to edit
        document.addEventListener('dblclick',function(e){const h=e.target.closest('.chapter-header');if(h&&!e.target.closest('.drag-handle')){const c=h.closest('.chapter-card');if(c)editChapter(parseInt(c.dataset.chapterId));}});

        init();
    </script>
</body>
</html>
