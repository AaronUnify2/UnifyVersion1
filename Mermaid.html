<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mermaid Diagram Builder</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
        h1, h2, h3 {
            font-family: 'Syne', sans-serif;
        }
        
        .node-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.8) 100%);
            border: 1px solid rgba(148, 163, 184, 0.2);
            transition: all 0.3s ease;
        }
        
        .node-card:hover {
            border-color: rgba(148, 163, 184, 0.4);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }
        
        .connection-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.6) 100%);
            border: 1px solid rgba(168, 85, 247, 0.2);
        }
        
        input, textarea, select {
            background: rgba(2, 6, 23, 0.8) !important;
            border: 1px solid rgba(148, 163, 184, 0.2) !important;
            color: white !important;
        }
        
        input:focus, textarea:focus, select:focus {
            border-color: rgba(96, 165, 250, 0.5) !important;
            background: rgba(2, 6, 23, 0.9) !important;
            outline: none;
        }

        #diagram-container {
            background: linear-gradient(135deg, rgba(51, 65, 85, 0.1) 0%, rgba(30, 41, 59, 0.1) 100%);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 12px;
            overflow: hidden;
        }

        #diagram-container svg {
            display: block;
            margin: auto;
            max-width: 100%;
            height: auto;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .notification {
            animation: slideIn 0.3s ease;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-950 via-slate-900 to-slate-800 min-h-screen">
    <div id="app"></div>

    <script>
        // Initialize Mermaid
        mermaid.initialize({ startOnLoad: true, theme: 'dark' });

        class MermaidBuilder {
            constructor() {
                this.orientation = null;
                this.nodes = [];
                this.connections = [];
                this.showCode = false;
                this.notification = '';
                this.render();
            }

            generateNodeId() {
                return `node_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            }

            generateMermaidCode() {
                if (!this.orientation || this.nodes.length === 0) {
                    return '';
                }

                let code = `graph ${this.orientation === 'landscape' ? 'LR' : 'TD'}\n`;
                
                // Add nodes
                this.nodes.forEach(node => {
                    const label = node.text ? `${node.title}<br/><i>${node.text}</i>` : node.title;
                    code += `    ${node.id}["${label}"]\n`;
                });

                // Add connections
                this.connections.forEach(conn => {
                    code += `    ${conn.from} -->|${conn.label}| ${conn.to}\n`;
                });

                return code;
            }

            async renderDiagram() {
                const mermaidCode = this.generateMermaidCode();
                const container = document.getElementById('diagram-container');
                
                if (!mermaidCode) {
                    container.innerHTML = '<p class="text-slate-500">Add nodes to see diagram</p>';
                    return;
                }

                try {
                    const { svg } = await mermaid.render('diagram', mermaidCode);
                    container.innerHTML = svg;
                } catch (e) {
                    console.error('Mermaid render error:', e);
                    container.innerHTML = '<div style="padding: 20px; color: #666;">Diagram rendering error</div>';
                }
            }

            addNode() {
                const newNode = {
                    id: this.generateNodeId(),
                    title: 'New Node',
                    text: ''
                };
                this.nodes.push(newNode);
                this.render();
            }

            updateNode(id, field, value) {
                const node = this.nodes.find(n => n.id === id);
                if (node) {
                    node[field] = value;
                    this.render();
                    this.renderDiagram();
                }
            }

            deleteNode(id) {
                this.nodes = this.nodes.filter(n => n.id !== id);
                this.connections = this.connections.filter(c => c.from !== id && c.to !== id);
                this.render();
                this.renderDiagram();
            }

            addConnection() {
                if (this.nodes.length < 2) {
                    this.showNotification('You need at least 2 nodes to create a connection');
                    return;
                }
                const newConnection = {
                    id: this.generateNodeId(),
                    from: this.nodes[0].id,
                    to: this.nodes[1].id,
                    label: 'connects to'
                };
                this.connections.push(newConnection);
                this.render();
                this.renderDiagram();
            }

            updateConnection(id, field, value) {
                const conn = this.connections.find(c => c.id === id);
                if (conn) {
                    conn[field] = value;
                    this.render();
                    this.renderDiagram();
                }
            }

            deleteConnection(id) {
                this.connections = this.connections.filter(c => c.id !== id);
                this.render();
                this.renderDiagram();
            }

            showNotification(message) {
                this.notification = message;
                this.render();
                setTimeout(() => {
                    this.notification = '';
                    this.render();
                }, 3000);
            }

            async downloadImage() {
                const container = document.getElementById('diagram-container');
                if (!container.querySelector('svg')) {
                    this.showNotification('No diagram to download');
                    return;
                }

                try {
                    const svg = container.querySelector('svg');
                    const svgData = new XMLSerializer().serializeToString(svg);
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();

                    canvas.width = svg.clientWidth + 20;
                    canvas.height = svg.clientHeight + 20;

                    img.onload = () => {
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 10, 10);
                        const link = document.createElement('a');
                        link.href = canvas.toDataURL('image/png');
                        link.download = 'mermaid-diagram.png';
                        link.click();
                        this.showNotification('Diagram downloaded!');
                    };

                    img.src = 'data:image/svg+xml;base64,' + btoa(svgData);
                } catch (e) {
                    this.showNotification('Error downloading image');
                }
            }

            copyCode() {
                const code = this.generateMermaidCode();
                navigator.clipboard.writeText(code).then(() => {
                    this.showNotification('Code copied to clipboard!');
                });
            }

            render() {
                const app = document.getElementById('app');
                
                if (!this.orientation) {
                    app.innerHTML = `
                        <div class="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-800 flex items-center justify-center p-4">
                            <div class="text-center">
                                <h1 class="text-5xl font-bold text-white mb-2" style="font-family: 'Syne', sans-serif;">Mermaid Builder</h1>
                                <p class="text-slate-400 mb-12 text-lg">Choose your canvas orientation</p>
                                <div class="flex gap-8 justify-center flex-wrap">
                                    <button onclick="app.setOrientation('portrait')" class="group relative px-8 py-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg hover:shadow-blue-500/50">
                                        <div class="text-sm opacity-75 mb-2">↕️</div>
                                        Portrait (TD)
                                    </button>
                                    <button onclick="app.setOrientation('landscape')" class="group relative px-8 py-4 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg hover:shadow-purple-500/50">
                                        <div class="text-sm opacity-75 mb-2">↔️</div>
                                        Landscape (LR)
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }

                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-800">
                        <div class="max-w-7xl mx-auto p-6">
                            <!-- Header -->
                            <div class="mb-8 flex items-center justify-between flex-wrap gap-4">
                                <div>
                                    <h1 class="text-4xl font-bold text-white mb-1" style="font-family: 'Syne', sans-serif;">Mermaid Builder</h1>
                                    <p class="text-slate-400">
                                        ${this.orientation === 'landscape' ? '→ Landscape (Left to Right)' : '↓ Portrait (Top to Bottom)'}
                                    </p>
                                </div>
                                <button onclick="app.resetProject()" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors">
                                    New Project
                                </button>
                            </div>

                            <!-- Main Grid -->
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                                <!-- Left Panel - Nodes -->
                                <div class="lg:col-span-1">
                                    <div class="node-card rounded-xl p-6">
                                        <div class="flex items-center justify-between mb-4">
                                            <h2 class="text-xl font-bold text-white">Nodes</h2>
                                            <button onclick="app.addNode()" class="p-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors" title="Add new node">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>

                                        <div class="space-y-3 max-h-96 overflow-y-auto">
                                            ${this.nodes.length === 0 ? '<p class="text-slate-400 text-sm py-8 text-center">No nodes yet. Click + to add one.</p>' : ''}
                                            ${this.nodes.map(node => `
                                                <div class="bg-slate-800 border border-slate-700 rounded-lg p-3 space-y-2">
                                                    <input type="text" value="${node.title}" onchange="app.updateNode('${node.id}', 'title', this.value)" placeholder="Node Title" class="w-full px-3 py-2 rounded text-sm" />
                                                    <textarea onchange="app.updateNode('${node.id}', 'text', this.value)" placeholder="Node Description (optional)" class="w-full px-3 py-2 rounded text-sm h-16 resize-none">${node.text}</textarea>
                                                    <button onclick="app.deleteNode('${node.id}')" class="w-full py-1 bg-red-900/30 hover:bg-red-900/50 text-red-300 rounded text-sm transition-colors flex items-center justify-center gap-1">
                                                        <i class="fas fa-trash"></i>
                                                        Delete
                                                    </button>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>

                                <!-- Center Panel - Diagram -->
                                <div class="lg:col-span-1">
                                    <div id="diagram-container" class="w-full h-96 flex items-center justify-center">
                                        <p class="text-slate-500">Add nodes to see diagram</p>
                                    </div>
                                </div>

                                <!-- Right Panel - Connections -->
                                <div class="lg:col-span-1">
                                    <div class="node-card rounded-xl p-6">
                                        <div class="flex items-center justify-between mb-4">
                                            <h2 class="text-xl font-bold text-white">Connections</h2>
                                            <button onclick="app.addConnection()" class="p-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-colors" title="Add new connection">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>

                                        <div class="space-y-3 max-h-96 overflow-y-auto">
                                            ${this.connections.length === 0 ? '<p class="text-slate-400 text-sm py-8 text-center">No connections yet. Click + to add one.</p>' : ''}
                                            ${this.connections.map(conn => `
                                                <div class="connection-card rounded-lg p-3 space-y-2">
                                                    <select onchange="app.updateConnection('${conn.id}', 'from', this.value)" class="w-full px-3 py-2 rounded text-sm">
                                                        ${this.nodes.map(node => `<option value="${node.id}" ${conn.from === node.id ? 'selected' : ''}>${node.title || 'Unnamed'}</option>`).join('')}
                                                    </select>
                                                    <input type="text" value="${conn.label}" onchange="app.updateConnection('${conn.id}', 'label', this.value)" placeholder="Connection Label" class="w-full px-3 py-2 rounded text-sm" />
                                                    <select onchange="app.updateConnection('${conn.id}', 'to', this.value)" class="w-full px-3 py-2 rounded text-sm">
                                                        ${this.nodes.map(node => `<option value="${node.id}" ${conn.to === node.id ? 'selected' : ''}>${node.title || 'Unnamed'}</option>`).join('')}
                                                    </select>
                                                    <button onclick="app.deleteConnection('${conn.id}')" class="w-full py-1 bg-red-900/30 hover:bg-red-900/50 text-red-300 rounded text-sm transition-colors flex items-center justify-center gap-1">
                                                        <i class="fas fa-trash"></i>
                                                        Delete
                                                    </button>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Bottom Panel - Preview & Export -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <!-- Full Diagram Preview -->
                                <div class="node-card rounded-xl p-6">
                                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                                        <i class="fas fa-eye"></i>
                                        Diagram Preview
                                    </h3>
                                    <div class="bg-slate-800 rounded-lg p-4 h-64 overflow-auto flex items-center justify-center">
                                        <div id="diagram-container" class="w-full">
                                            ${!this.generateMermaidCode() ? '<p class="text-slate-500 text-center">Add nodes and connections to preview</p>' : ''}
                                        </div>
                                    </div>
                                </div>

                                <!-- Code & Export -->
                                <div class="node-card rounded-xl p-6">
                                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                                        <i class="fas fa-code"></i>
                                        Export
                                    </h3>
                                    
                                    <div class="space-y-3">
                                        <button onclick="app.toggleCode()" class="w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors flex items-center justify-center gap-2">
                                            <i class="fas fa-code"></i>
                                            ${this.showCode ? 'Hide' : 'Show'} Code
                                        </button>

                                        ${this.showCode ? `
                                            <div class="bg-slate-800 rounded-lg p-3 max-h-32 overflow-auto border border-slate-700">
                                                <pre class="text-slate-300 text-xs whitespace-pre-wrap break-words">${this.generateMermaidCode()}</pre>
                                            </div>
                                        ` : ''}

                                        <button onclick="app.copyCode()" ${!this.generateMermaidCode() ? 'disabled' : ''} class="w-full py-2 bg-slate-600 hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-lg transition-colors flex items-center justify-center gap-2">
                                            <i class="fas fa-copy"></i>
                                            Copy Code
                                        </button>

                                        <button onclick="app.downloadImage()" ${!this.generateMermaidCode() ? 'disabled' : ''} class="w-full py-2 bg-green-600 hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-lg transition-colors flex items-center justify-center gap-2">
                                            <i class="fas fa-download"></i>
                                            Download as PNG
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notification Toast -->
                        ${this.notification ? `
                            <div class="fixed bottom-6 right-6 bg-slate-800 border border-slate-700 text-slate-200 px-6 py-3 rounded-lg shadow-lg notification">
                                ${this.notification}
                            </div>
                        ` : ''}
                    </div>
                `;

                this.renderDiagram();
            }

            setOrientation(orientation) {
                this.orientation = orientation;
                this.render();
                this.renderDiagram();
            }

            resetProject() {
                this.orientation = null;
                this.nodes = [];
                this.connections = [];
                this.showCode = false;
                this.render();
            }

            toggleCode() {
                this.showCode = !this.showCode;
                this.render();
            }
        }

        // Initialize the app
        const app = new MermaidBuilder();
    </script>
</body>
</html>
