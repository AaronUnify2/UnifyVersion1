<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Process Mapper</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            height: 100vh;
            overflow: hidden;
        }

        .toolbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1000;
            box-shadow: 0 1px 20px rgba(0, 0, 0, 0.03);
        }

        .toolbar-left {
            display: flex;
            align-items: center;
        }

        .toolbar-right {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .toolbar button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 122, 255, 0.2);
            letter-spacing: -0.01em;
        }

        .toolbar button:hover {
            background: #0056CC;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.25);
        }

        .toolbar button.secondary {
            background: #F2F2F7;
            color: #1D1D1F;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .toolbar button.secondary:hover {
            background: #E5E5EA;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .canvas-container {
            position: relative;
            height: calc(100vh - 80px);
            overflow: auto;
            background: #F8F9FA;
        }

        .canvas {
            position: relative;
            min-width: 2000px;
            min-height: 2000px;
            background-image: 
                radial-gradient(circle, #E5E5EA 1px, transparent 1px);
            background-size: 24px 24px;
        }

        .card {
            position: absolute;
            width: 200px;
            min-height: 100px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.06);
            border-radius: 12px;
            padding: 1rem;
            cursor: move;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.2s ease;
            z-index: 100;
        }

        .card:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            border-color: rgba(0, 122, 255, 0.3);
            transform: translateY(-2px);
        }

        .card.dragging {
            opacity: 0.95;
            transform: rotate(1deg) scale(1.02);
            z-index: 1000;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .card-number {
            position: absolute;
            top: -10px;
            left: -10px;
            background: #007AFF;
            color: white;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }

        .card-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.8);
            width: 100%;
            font-size: 1rem;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.2s ease;
            color: #1D1D1F;
        }

        .card-title:focus {
            border-color: #007AFF;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
            background: white;
        }

        .card-controls {
            position: absolute;
            top: -10px;
            right: -10px;
            display: flex;
            gap: 6px;
        }

        .card-btn {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .delete-btn {
            background: #FF3B30;
            color: white;
        }

        .delete-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);
        }

        .connect-btn {
            background: #34C759;
            color: white;
        }

        .connect-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3);
        }

        .arrow {
            position: absolute;
            pointer-events: none;
            z-index: 50;
        }

        .arrow-line {
            stroke-width: 3;
            fill: none;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.1));
        }

        .card.source-card {
            border: 2px solid #34C759;
            box-shadow: 0 0 0 4px rgba(52, 199, 89, 0.15);
        }

        .card.can-connect {
            border: 2px solid #FF9500;
            box-shadow: 0 0 0 4px rgba(255, 149, 0, 0.15);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(20px);
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 2.5rem;
            border-radius: 16px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .edit-modal {
            width: 500px;
        }

        .edit-modal h3 {
            color: #1D1D1F;
            margin-bottom: 1.5rem;
            font-size: 1.75rem;
            font-weight: 700;
            text-align: center;
            letter-spacing: -0.02em;
        }

        .edit-modal .form-group {
            margin-bottom: 1.5rem;
        }

        .edit-modal label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #1D1D1F;
            font-size: 0.95rem;
            letter-spacing: -0.01em;
        }

        .edit-modal input, .edit-modal textarea, .edit-modal select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.8);
            color: #1D1D1F;
        }

        .edit-modal input:focus, .edit-modal textarea:focus, .edit-modal select:focus {
            border-color: #007AFF;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
            background: white;
        }

        .edit-modal textarea {
            height: 90px;
            resize: vertical;
        }

        .edit-modal .button-group {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .edit-modal button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
            letter-spacing: -0.01em;
        }

        .edit-modal button:hover {
            background: #0056CC;
            transform: translateY(-1px);
        }

        .edit-modal button.secondary {
            background: #F2F2F7;
            color: #1D1D1F;
        }

        .edit-modal button.secondary:hover {
            background: #E5E5EA;
        }

        .arrow-details-btn {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 122, 255, 0.3);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            cursor: pointer;
            z-index: 200;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            color: #007AFF;
            letter-spacing: -0.01em;
        }

        .arrow-details-btn:hover {
            background: white;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            border-color: #007AFF;
            transform: translateY(-1px);
        }

        .collapsible-section {
            margin: 1.5rem 0;
        }

        .collapsible-header {
            background: rgba(248, 249, 250, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
            color: #1D1D1F;
            letter-spacing: -0.01em;
        }

        .collapsible-header:hover {
            background: rgba(229, 229, 234, 0.8);
            transform: translateY(-1px);
        }

        .collapsible-content {
            display: none;
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 8px;
            padding: 1.5rem;
            background: rgba(248, 249, 250, 0.5);
        }

        .collapsible-content.show {
            display: block;
        }

        .field-with-checkbox {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        .field-with-checkbox input[type="checkbox"] {
            margin-top: 0.75rem;
            width: 18px;
            height: 18px;
            accent-color: #007AFF;
        }

        .field-content {
            flex: 1;
        }

        .wait-time-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .wait-time-group input[type="number"] {
            width: 100px;
        }

        .wait-time-group select {
            width: 120px;
        }

        .budget-group {
            display: flex;
            gap: 0.5rem;
        }

        .budget-group input {
            flex: 1;
        }

        .file-input {
            display: none;
        }

        @media (max-width: 768px) {
            .toolbar {
                padding: 1rem;
                flex-wrap: wrap;
                gap: 1rem;
            }
            
            .toolbar-left, .toolbar-right {
                flex: 1;
                justify-content: center;
            }
            
            .toolbar-right {
                gap: 0.5rem;
            }
            
            .toolbar button {
                padding: 0.75rem 1.25rem;
                font-size: 0.85rem;
            }
            
            .card {
                width: 180px;
                min-height: 90px;
                padding: 0.8rem;
            }
            
            .canvas-container {
                height: calc(100vh - 100px);
            }
            
            .edit-modal {
                width: 95%;
                padding: 2rem 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <div class="toolbar-left">
            <button onclick="addCard()">Add Step</button>
        </div>
        <div class="toolbar-right">
            <button onclick="exportProject()" class="secondary">Export JSON</button>
            <button onclick="document.getElementById('importFile').click()" class="secondary">Import JSON</button>
        </div>
        <input type="file" id="importFile" class="file-input" accept=".json" onchange="importProject(event)">
        <span id="modeIndicator"></span>
    </div>

    <div class="canvas-container">
        <div class="canvas" id="canvas">
            <svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                <defs>
                    <marker id="arrowhead-blue" markerWidth="10" markerHeight="7" 
                            refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#007AFF"/>
                    </marker>
                    <marker id="arrowhead-green" markerWidth="10" markerHeight="7" 
                            refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#34C759"/>
                    </marker>
                </defs>
            </svg>
        </div>
    </div>

    <div class="modal" id="cardModal">
        <div class="modal-content edit-modal">
            <h3>Edit Step Details</h3>
            <div class="form-group">
                <label>Step Title:</label>
                <input type="text" id="cardTitle" placeholder="Enter step title">
            </div>
            <div class="form-group">
                <label>Person Responsible:</label>
                <input type="text" id="cardResponsible" placeholder="Person or team responsible">
            </div>
            <div class="form-group">
                <label>People Expected to Assist:</label>
                <input type="text" id="cardAssistants" placeholder="Who will help with this step">
            </div>
            <div class="form-group">
                <label>Resources Specific to Task:</label>
                <textarea id="cardResources" placeholder="Equipment, materials, budget, tools needed..."></textarea>
            </div>
            <div class="form-group">
                <label>Methodology:</label>
                <textarea id="cardMethodology" placeholder="How this step is performed..."></textarea>
            </div>
            <div class="form-group">
                <label>Conditions for Success:</label>
                <textarea id="cardConditions" placeholder="How do you know this step is complete?"></textarea>
            </div>
            
            <!-- New Planning Fields -->
            <div class="form-group">
                <label>Risk Level:</label>
                <select id="cardRiskLevel">
                    <option value="low">Low - Minimal risk</option>
                    <option value="medium">Medium - Some risk</option>
                    <option value="high">High - Significant risk</option>
                    <option value="critical">Critical - Major risk</option>
                </select>
            </div>
            <div class="form-group">
                <label>Quality Standards:</label>
                <textarea id="cardQualityStandards" placeholder="What standards must be met for this step?"></textarea>
            </div>
            <div class="form-group">
                <label>Estimated Duration:</label>
                <div class="wait-time-group">
                    <input type="number" id="cardEstimatedDuration" placeholder="0" min="0">
                    <select id="cardEstimatedDurationUnit">
                        <option value="minutes">Minutes</option>
                        <option value="hours" selected>Hours</option>
                        <option value="days">Days</option>
                        <option value="weeks">Weeks</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Priority Level:</label>
                <select id="cardPriorityLevel">
                    <option value="low">Low Priority</option>
                    <option value="medium" selected>Medium Priority</option>
                    <option value="high">High Priority</option>
                    <option value="critical">Critical Priority</option>
                </select>
            </div>
            
            <div class="button-group">
                <button onclick="closeCardModal()" class="secondary">Cancel</button>
                <button onclick="saveCard()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="connectionModal">
        <div class="modal-content edit-modal">
            <h3>Preparation Step Details</h3>
            
            <!-- Core Fields (Always Visible) -->
            <div class="field-with-checkbox">
                <div class="field-content">
                    <label>Manager/Supervisor Approval:</label>
                    <input type="text" id="managerApproval" placeholder="Who needs to approve this step?">
                </div>
                <input type="checkbox" id="managerApprovalChecked" onchange="updateCheckboxStatus()">
            </div>

            <div class="field-with-checkbox">
                <div class="field-content">
                    <label>Resources Required:</label>
                    <textarea id="resourcesRequired" placeholder="Equipment, materials, budget, tools needed..."></textarea>
                </div>
                <input type="checkbox" id="resourcesRequiredChecked" onchange="updateCheckboxStatus()">
            </div>

            <div class="field-with-checkbox">
                <div class="field-content">
                    <label>Wait Time:</label>
                    <div class="wait-time-group">
                        <input type="number" id="waitTime" placeholder="0" min="0">
                        <select id="waitTimeUnit">
                            <option value="minutes">Minutes</option>
                            <option value="hours" selected>Hours</option>
                            <option value="days">Days</option>
                            <option value="weeks">Weeks</option>
                        </select>
                    </div>
                </div>
                <input type="checkbox" id="waitTimeChecked" onchange="updateCheckboxStatus()">
            </div>

            <!-- Collapsible Advanced Section -->
            <div class="collapsible-section">
                <div class="collapsible-header" onclick="toggleAdvanced()">
                    <span>Advanced Requirements (4 fields)</span>
                    <span id="advancedToggle">▼</span>
                </div>
                <div class="collapsible-content" id="advancedContent">
                    <div class="field-with-checkbox">
                        <div class="field-content">
                            <label>Documentation Required:</label>
                            <textarea id="documentationRequired" placeholder="Forms, reports, certificates to complete..."></textarea>
                        </div>
                        <input type="checkbox" id="documentationRequiredChecked" onchange="updateCheckboxStatus()">
                    </div>

                    <div class="field-with-checkbox">
                        <div class="field-content">
                            <label>Quality/Safety Checks:</label>
                            <textarea id="qualitySafetyChecks" placeholder="Inspections, validations, safety requirements..."></textarea>
                        </div>
                        <input type="checkbox" id="qualitySafetyChecksChecked" onchange="updateCheckboxStatus()">
                    </div>

                    <div class="field-with-checkbox">
                        <div class="field-content">
                            <label>Budget/Cost Approval:</label>
                            <div class="budget-group">
                                <input type="text" id="budgetAmount" placeholder="Amount ($)">
                                <input type="text" id="budgetApprover" placeholder="Approver">
                            </div>
                        </div>
                        <input type="checkbox" id="budgetChecked" onchange="updateCheckboxStatus()">
                    </div>

                    <div class="field-with-checkbox">
                        <div class="field-content">
                            <label>Skills/Training Required:</label>
                            <textarea id="skillsTraining" placeholder="Specific competencies or certifications needed..."></textarea>
                        </div>
                        <input type="checkbox" id="skillsTrainingChecked" onchange="updateCheckboxStatus()">
                    </div>
                </div>
            </div>

            <!-- Communication Fields (Always Visible) -->
            <div class="field-with-checkbox">
                <div class="field-content">
                    <label>Notifications Required:</label>
                    <textarea id="notificationsRequired" placeholder="Who needs to be informed before proceeding?"></textarea>
                </div>
                <input type="checkbox" id="notificationsRequiredChecked" onchange="updateCheckboxStatus()">
            </div>

            <div class="field-with-checkbox">
                <div class="field-content">
                    <label>External Dependencies:</label>
                    <textarea id="externalDependencies" placeholder="Third-party deliverables, vendor requirements..."></textarea>
                </div>
                <input type="checkbox" id="externalDependenciesChecked" onchange="updateCheckboxStatus()">
            </div>

            <div class="button-group">
                <button onclick="closeConnectionModal()" class="secondary">Cancel</button>
                <button onclick="saveConnection()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <h3>Project Data</h3>
            <textarea id="modalContent" rows="20" cols="60" readonly></textarea>
            <br><br>
            <button onclick="closeModal()">Close</button>
        </div>
    </div>

    <script>
        let cardCounter = 0;
        let sourceCard = null;
        let cards = [];
        let connections = [];
        let draggedCard = null;
        let dragOffset = { x: 0, y: 0 };
        let currentEditingCard = null;
        let currentEditingConnection = null;

        // In a real environment, uncomment these lines for localStorage:
        // function saveToStorage() {
        //     localStorage.setItem('processMapperData', JSON.stringify({ cards, connections, cardCounter }));
        // }
        
        // function loadFromStorage() {
        //     const saved = localStorage.getItem('processMapperData');
        //     if (saved) {
        //         const data = JSON.parse(saved);
        //         cards = data.cards || [];
        //         connections = data.connections || [];
        //         cardCounter = data.cardCounter || 0;
        //         renderAll();
        //     }
        // }

        function updateCardField(cardId, field, value) {
            const card = cards.find(c => c.id === cardId);
            if (card) {
                card[field] = value;
                console.log(`Updated ${field} for ${cardId}: ${value}`);
                // saveToStorage();
            }
        }

        function addCard() {
            cardCounter++;
            const card = {
                id: `card-${cardCounter}`,
                title: `New step`,
                responsible: '',
                assistants: '',
                resources: '',
                methodology: '',
                conditions: '',
                riskLevel: 'low',
                qualityStandards: '',
                estimatedDuration: '',
                estimatedDurationUnit: 'hours',
                priorityLevel: 'medium',
                x: 100 + (cardCounter * 50) % 800,
                y: 100 + Math.floor(cardCounter / 16) * 150,
                number: ''
            };
            cards.push(card);
            renderCard(card);
            calculateNumbers();
            // saveToStorage();
        }

        function renderCard(card) {
            const cardEl = document.createElement('div');
            cardEl.className = 'card';
            cardEl.id = card.id;
            cardEl.style.left = card.x + 'px';
            cardEl.style.top = card.y + 'px';
            
            cardEl.innerHTML = `
                <div class="card-number">${card.number}</div>
                <div class="card-controls">
                    <button class="card-btn connect-btn" onclick="startConnection('${card.id}')" title="Connect">→</button>
                    <button class="card-btn delete-btn" onclick="deleteCard('${card.id}')" title="Delete">×</button>
                </div>
                <input class="card-title" value="${card.title}" 
                       onchange="updateCardField('${card.id}', 'title', this.value)" 
                       placeholder="Step title">
                <div style="margin: 0.5rem 0;">
                    <input value="${card.responsible}" 
                           onchange="updateCardField('${card.id}', 'responsible', this.value)"
                           placeholder="Who's responsible" 
                           style="width: 100%; border: 1px solid rgba(0, 0, 0, 0.1); border-radius: 6px; padding: 0.5rem; font-size: 0.8rem; transition: border-color 0.2s ease; background: rgba(255, 255, 255, 0.8); color: #1D1D1F;">
                </div>
                <button onclick="editCard('${card.id}')" 
                        style="width: 100%; background: #007AFF; color: white; border: none; padding: 0.5rem; border-radius: 6px; font-size: 0.8rem; cursor: pointer; font-weight: 600; transition: all 0.2s ease; letter-spacing: -0.01em;">
                    Edit Details
                </button>
            `;

            // Add drag functionality
            let isDragging = false;
            
            cardEl.addEventListener('mousedown', startDrag);
            cardEl.addEventListener('touchstart', startDrag, { passive: false });

            function startDrag(e) {
                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') {
                    return;
                }
                
                e.preventDefault();
                isDragging = true;
                draggedCard = card;
                cardEl.classList.add('dragging');
                
                const rect = cardEl.getBoundingClientRect();
                const clientX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
                const clientY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
                
                dragOffset.x = clientX - rect.left;
                dragOffset.y = clientY - rect.top;

                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', stopDrag);
                document.addEventListener('touchmove', drag, { passive: false });
                document.addEventListener('touchend', stopDrag);
            }

            function drag(e) {
                if (!isDragging) return;
                e.preventDefault();
                
                const canvas = document.getElementById('canvas');
                const canvasRect = canvas.getBoundingClientRect();
                const clientX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
                const clientY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
                
                const x = clientX - canvasRect.left - dragOffset.x;
                const y = clientY - canvasRect.top - dragOffset.y;
                
                card.x = Math.max(0, x);
                card.y = Math.max(0, y);
                
                cardEl.style.left = card.x + 'px';
                cardEl.style.top = card.y + 'px';
                
                drawConnections();
            }

            function stopDrag() {
                if (isDragging) {
                    isDragging = false;
                    draggedCard = null;
                    cardEl.classList.remove('dragging');
                    // saveToStorage();
                }
                
                document.removeEventListener('mousemove', drag);
                document.removeEventListener('mouseup', stopDrag);
                document.removeEventListener('touchmove', drag);
                document.removeEventListener('touchend', stopDrag);
            }

            document.getElementById('canvas').appendChild(cardEl);
            console.log(`Rendered card: ${card.title}`);
        }

        function editCard(cardId) {
            const card = cards.find(c => c.id === cardId);
            if (!card) return;
            
            currentEditingCard = card;
            document.getElementById('cardTitle').value = card.title || '';
            document.getElementById('cardResponsible').value = card.responsible || '';
            document.getElementById('cardAssistants').value = card.assistants || '';
            document.getElementById('cardResources').value = card.resources || '';
            document.getElementById('cardMethodology').value = card.methodology || '';
            document.getElementById('cardConditions').value = card.conditions || '';
            
            // New planning fields
            document.getElementById('cardRiskLevel').value = card.riskLevel || 'low';
            document.getElementById('cardQualityStandards').value = card.qualityStandards || '';
            document.getElementById('cardEstimatedDuration').value = card.estimatedDuration || '';
            document.getElementById('cardEstimatedDurationUnit').value = card.estimatedDurationUnit || 'hours';
            document.getElementById('cardPriorityLevel').value = card.priorityLevel || 'medium';
            
            document.getElementById('cardModal').style.display = 'flex';
        }

        function saveCard() {
            if (!currentEditingCard) return;
            
            currentEditingCard.title = document.getElementById('cardTitle').value;
            currentEditingCard.responsible = document.getElementById('cardResponsible').value;
            currentEditingCard.assistants = document.getElementById('cardAssistants').value;
            currentEditingCard.resources = document.getElementById('cardResources').value;
            currentEditingCard.methodology = document.getElementById('cardMethodology').value;
            currentEditingCard.conditions = document.getElementById('cardConditions').value;
            
            // New planning fields
            currentEditingCard.riskLevel = document.getElementById('cardRiskLevel').value;
            currentEditingCard.qualityStandards = document.getElementById('cardQualityStandards').value;
            currentEditingCard.estimatedDuration = document.getElementById('cardEstimatedDuration').value;
            currentEditingCard.estimatedDurationUnit = document.getElementById('cardEstimatedDurationUnit').value;
            currentEditingCard.priorityLevel = document.getElementById('cardPriorityLevel').value;
            
            // Re-render the card to update the inline fields
            const cardEl = document.getElementById(currentEditingCard.id);
            if (cardEl) {
                const titleInput = cardEl.querySelector('.card-title');
                const responsibleInput = cardEl.querySelector('input[placeholder="Who\'s responsible"]');
                if (titleInput) titleInput.value = currentEditingCard.title;
                if (responsibleInput) responsibleInput.value = currentEditingCard.responsible;
            }
            
            closeCardModal();
            // saveToStorage();
        }

        function closeCardModal() {
            document.getElementById('cardModal').style.display = 'none';
            currentEditingCard = null;
        }

        function deleteCard(cardId) {
            cards = cards.filter(c => c.id !== cardId);
            connections = connections.filter(c => c.from !== cardId && c.to !== cardId);
            
            const cardEl = document.getElementById(cardId);
            if (cardEl) cardEl.remove();
            
            calculateNumbers();
            drawConnections();
            // saveToStorage();
        }

        function startConnection(cardId) {
            // If we already have a source card, create the connection
            if (sourceCard && sourceCard !== cardId) {
                addConnection(sourceCard, cardId);
                // Clear the connection state
                sourceCard = null;
                document.querySelectorAll('.card').forEach(c => {
                    c.classList.remove('source-card', 'can-connect');
                });
                document.getElementById('modeIndicator').textContent = '';
            } else {
                // Set this as the source card
                // Clear any previous selections
                document.querySelectorAll('.card').forEach(c => {
                    c.classList.remove('source-card', 'can-connect');
                });
                
                sourceCard = cardId;
                document.getElementById(cardId).classList.add('source-card');
                document.querySelectorAll('.card').forEach(c => {
                    if (c.id !== cardId) c.classList.add('can-connect');
                });
                document.getElementById('modeIndicator').textContent = 'Now click the arrow of the target card';
            }
        }

        function addConnection(fromId, toId) {
            if (!connections.find(c => c.from === fromId && c.to === toId)) {
                connections.push({ 
                    from: fromId, 
                    to: toId, 
                    id: `conn-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    // Core fields (always visible)
                    managerApproval: '',
                    managerApprovalChecked: false,
                    resourcesRequired: '',
                    resourcesRequiredChecked: false,
                    waitTime: '',
                    waitTimeUnit: 'hours',
                    waitTimeChecked: false,
                    // Advanced fields (collapsible)
                    documentationRequired: '',
                    documentationRequiredChecked: false,
                    qualitySafetyChecks: '',
                    qualitySafetyChecksChecked: false,
                    budgetAmount: '',
                    budgetApprover: '',
                    budgetChecked: false,
                    skillsTraining: '',
                    skillsTrainingChecked: false,
                    // Communication fields (always visible)
                    notificationsRequired: '',
                    notificationsRequiredChecked: false,
                    externalDependencies: '',
                    externalDependenciesChecked: false
                });
                calculateNumbers();
                drawConnections();
                // saveToStorage();
                console.log(`Connection added: ${fromId} -> ${toId}`);
            }
        }

        function calculateNumbers() {
            // Reset all numbers
            cards.forEach(card => card.number = '');
            
            // Find starting cards (no incoming connections)
            const startingCards = cards.filter(card => 
                !connections.some(conn => conn.to === card.id)
            );
            
            // If no starting cards, mark all as starting
            if (startingCards.length === 0 && cards.length > 0) {
                startingCards.push(...cards);
            }
            
            // BFS to calculate levels
            const levels = new Map();
            const queue = startingCards.map(card => ({ card, level: 1 }));
            
            startingCards.forEach(card => levels.set(card.id, 1));
            
            while (queue.length > 0) {
                const { card, level } = queue.shift();
                
                // Find cards this card connects to
                const nextCards = connections
                    .filter(conn => conn.from === card.id)
                    .map(conn => cards.find(c => c.id === conn.to))
                    .filter(c => c);
                
                nextCards.forEach(nextCard => {
                    const currentLevel = levels.get(nextCard.id) || 0;
                    const newLevel = Math.max(currentLevel, level + 1);
                    levels.set(nextCard.id, newLevel);
                    queue.push({ card: nextCard, level: newLevel });
                });
            }
            
            // Group by levels and assign letters
            const levelGroups = new Map();
            cards.forEach(card => {
                const level = levels.get(card.id) || 1;
                if (!levelGroups.has(level)) {
                    levelGroups.set(level, []);
                }
                levelGroups.get(level).push(card);
            });
            
            // Assign numbers with letters for same-level cards
            levelGroups.forEach((cardsInLevel, level) => {
                if (cardsInLevel.length === 1) {
                    cardsInLevel[0].number = level.toString();
                } else {
                    cardsInLevel.forEach((card, index) => {
                        const letter = String.fromCharCode(97 + index); // a, b, c...
                        card.number = `${level}${letter}`;
                    });
                }
            });
            
            // Update UI
            cards.forEach(card => {
                const cardEl = document.getElementById(card.id);
                if (cardEl) {
                    const numberEl = cardEl.querySelector('.card-number');
                    if (numberEl) numberEl.textContent = card.number;
                }
            });
        }

        function drawConnections() {
            const svg = document.querySelector('svg');
            const canvas = document.getElementById('canvas');
            
            // Clear existing arrows and details buttons but keep the defs
            const existingLines = svg.querySelectorAll('line');
            const existingBtns = canvas.querySelectorAll('.arrow-details-btn');
            existingLines.forEach(line => line.remove());
            existingBtns.forEach(btn => btn.remove());
            
            connections.forEach(conn => {
                const fromCard = document.getElementById(conn.from);
                const toCard = document.getElementById(conn.to);
                
                if (fromCard && toCard) {
                    const fromRect = fromCard.getBoundingClientRect();
                    const toRect = toCard.getBoundingClientRect();
                    const canvasRect = canvas.getBoundingClientRect();
                    
                    // Calculate center points
                    const fromCenter = {
                        x: fromRect.left - canvasRect.left + fromRect.width / 2,
                        y: fromRect.top - canvasRect.top + fromRect.height / 2
                    };
                    const toCenter = {
                        x: toRect.left - canvasRect.left + toRect.width / 2,
                        y: toRect.top - canvasRect.top + toRect.height / 2
                    };
                    
                    // Calculate edge intersection points
                    const fromEdge = getEdgeIntersection(fromCenter, toCenter, {
                        x: fromRect.left - canvasRect.left,
                        y: fromRect.top - canvasRect.top,
                        width: fromRect.width,
                        height: fromRect.height
                    });
                    
                    const toEdge = getEdgeIntersection(toCenter, fromCenter, {
                        x: toRect.left - canvasRect.left,
                        y: toRect.top - canvasRect.top,
                        width: toRect.width,
                        height: toRect.height
                    });
                    
                    // Check if all checkboxes are completed
                    const allChecked = conn.managerApprovalChecked && 
                                     conn.resourcesRequiredChecked && 
                                     conn.waitTimeChecked &&
                                     conn.documentationRequiredChecked && 
                                     conn.qualitySafetyChecksChecked && 
                                     conn.budgetChecked &&
                                     conn.skillsTrainingChecked && 
                                     conn.notificationsRequiredChecked && 
                                     conn.externalDependenciesChecked;
                    
                    // Draw the arrow line with color based on completion status
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', fromEdge.x);
                    line.setAttribute('y1', fromEdge.y);
                    line.setAttribute('x2', toEdge.x);
                    line.setAttribute('y2', toEdge.y);
                    line.setAttribute('class', 'arrow-line');
                    line.setAttribute('stroke', allChecked ? '#34C759' : '#007AFF');
                    line.setAttribute('marker-end', allChecked ? 'url(#arrowhead-green)' : 'url(#arrowhead-blue)');
                    
                    svg.appendChild(line);
                    
                    // Add clickable Details button
                    const midX = (fromEdge.x + toEdge.x) / 2;
                    const midY = (fromEdge.y + toEdge.y) / 2;
                    
                    const detailsBtn = document.createElement('div');
                    detailsBtn.className = 'arrow-details-btn';
                    detailsBtn.style.left = (midX - 30) + 'px';
                    detailsBtn.style.top = (midY - 12) + 'px';
                    detailsBtn.textContent = 'Details';
                    detailsBtn.onclick = () => editConnection(conn.id);
                    
                    canvas.appendChild(detailsBtn);
                }
            });
        }
        
        function getEdgeIntersection(center, target, rect) {
            // Calculate direction vector
            const dx = target.x - center.x;
            const dy = target.y - center.y;
            
            // Calculate intersections with all four edges
            const intersections = [];
            
            // Top edge
            if (dy < 0) {
                const t = -rect.height / 2 / dy;
                const x = center.x + dx * t;
                if (x >= rect.x && x <= rect.x + rect.width) {
                    intersections.push({ x, y: rect.y });
                }
            }
            
            // Bottom edge
            if (dy > 0) {
                const t = rect.height / 2 / dy;
                const x = center.x + dx * t;
                if (x >= rect.x && x <= rect.x + rect.width) {
                    intersections.push({ x, y: rect.y + rect.height });
                }
            }
            
            // Left edge
            if (dx < 0) {
                const t = -rect.width / 2 / dx;
                const y = center.y + dy * t;
                if (y >= rect.y && y <= rect.y + rect.height) {
                    intersections.push({ x: rect.x, y });
                }
            }
            
            // Right edge
            if (dx > 0) {
                const t = rect.width / 2 / dx;
                const y = center.y + dy * t;
                if (y >= rect.y && y <= rect.y + rect.height) {
                    intersections.push({ x: rect.x + rect.width, y });
                }
            }
            
            // Return the closest intersection to the target
            if (intersections.length > 0) {
                return intersections.reduce((closest, current) => {
                    const closestDist = Math.hypot(closest.x - target.x, closest.y - target.y);
                    const currentDist = Math.hypot(current.x - target.x, current.y - target.y);
                    return currentDist < closestDist ? current : closest;
                });
            }
            
            // Fallback to center if no intersection found
            return center;
        }

        function editConnection(connectionId) {
            const connection = connections.find(c => c.id === connectionId);
            if (!connection) return;
            
            currentEditingConnection = connection;
            
            // Populate all fields
            document.getElementById('managerApproval').value = connection.managerApproval || '';
            document.getElementById('managerApprovalChecked').checked = connection.managerApprovalChecked || false;
            
            document.getElementById('resourcesRequired').value = connection.resourcesRequired || '';
            document.getElementById('resourcesRequiredChecked').checked = connection.resourcesRequiredChecked || false;
            
            document.getElementById('waitTime').value = connection.waitTime || '';
            document.getElementById('waitTimeUnit').value = connection.waitTimeUnit || 'hours';
            document.getElementById('waitTimeChecked').checked = connection.waitTimeChecked || false;
            
            document.getElementById('documentationRequired').value = connection.documentationRequired || '';
            document.getElementById('documentationRequiredChecked').checked = connection.documentationRequiredChecked || false;
            
            document.getElementById('qualitySafetyChecks').value = connection.qualitySafetyChecks || '';
            document.getElementById('qualitySafetyChecksChecked').checked = connection.qualitySafetyChecksChecked || false;
            
            document.getElementById('budgetAmount').value = connection.budgetAmount || '';
            document.getElementById('budgetApprover').value = connection.budgetApprover || '';
            document.getElementById('budgetChecked').checked = connection.budgetChecked || false;
            
            document.getElementById('skillsTraining').value = connection.skillsTraining || '';
            document.getElementById('skillsTrainingChecked').checked = connection.skillsTrainingChecked || false;
            
            document.getElementById('notificationsRequired').value = connection.notificationsRequired || '';
            document.getElementById('notificationsRequiredChecked').checked = connection.notificationsRequiredChecked || false;
            
            document.getElementById('externalDependencies').value = connection.externalDependencies || '';
            document.getElementById('externalDependenciesChecked').checked = connection.externalDependenciesChecked || false;
            
            document.getElementById('connectionModal').style.display = 'flex';
        }

        function saveConnection() {
            if (!currentEditingConnection) return;
            
            // Save all field values
            currentEditingConnection.managerApproval = document.getElementById('managerApproval').value;
            currentEditingConnection.managerApprovalChecked = document.getElementById('managerApprovalChecked').checked;
            
            currentEditingConnection.resourcesRequired = document.getElementById('resourcesRequired').value;
            currentEditingConnection.resourcesRequiredChecked = document.getElementById('resourcesRequiredChecked').checked;
            
            currentEditingConnection.waitTime = document.getElementById('waitTime').value;
            currentEditingConnection.waitTimeUnit = document.getElementById('waitTimeUnit').value;
            currentEditingConnection.waitTimeChecked = document.getElementById('waitTimeChecked').checked;
            
            currentEditingConnection.documentationRequired = document.getElementById('documentationRequired').value;
            currentEditingConnection.documentationRequiredChecked = document.getElementById('documentationRequiredChecked').checked;
            
            currentEditingConnection.qualitySafetyChecks = document.getElementById('qualitySafetyChecks').value;
            currentEditingConnection.qualitySafetyChecksChecked = document.getElementById('qualitySafetyChecksChecked').checked;
            
            currentEditingConnection.budgetAmount = document.getElementById('budgetAmount').value;
            currentEditingConnection.budgetApprover = document.getElementById('budgetApprover').value;
            currentEditingConnection.budgetChecked = document.getElementById('budgetChecked').checked;
            
            currentEditingConnection.skillsTraining = document.getElementById('skillsTraining').value;
            currentEditingConnection.skillsTrainingChecked = document.getElementById('skillsTrainingChecked').checked;
            
            currentEditingConnection.notificationsRequired = document.getElementById('notificationsRequired').value;
            currentEditingConnection.notificationsRequiredChecked = document.getElementById('notificationsRequiredChecked').checked;
            
            currentEditingConnection.externalDependencies = document.getElementById('externalDependencies').value;
            currentEditingConnection.externalDependenciesChecked = document.getElementById('externalDependenciesChecked').checked;
            
            closeConnectionModal();
            drawConnections(); // Redraw to update the arrow color
            // saveToStorage();
        }

        function toggleAdvanced() {
            const content = document.getElementById('advancedContent');
            const toggle = document.getElementById('advancedToggle');
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                toggle.textContent = '▼';
            } else {
                content.classList.add('show');
                toggle.textContent = '▲';
            }
        }

        function updateCheckboxStatus() {
            // This function can be used for real-time updates if needed
            // For now, it's just a placeholder for the onchange events
        }

        function closeConnectionModal() {
            document.getElementById('connectionModal').style.display = 'none';
            currentEditingConnection = null;
        }

        function clearAll() {
            if (confirm('Clear all cards and connections?')) {
                cards = [];
                connections = [];
                cardCounter = 0;
                document.getElementById('canvas').innerHTML = `
                    <svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                        <defs>
                            <marker id="arrowhead-blue" markerWidth="10" markerHeight="7" 
                                    refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#007AFF"/>
                            </marker>
                            <marker id="arrowhead-green" markerWidth="10" markerHeight="7" 
                                    refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#34C759"/>
                            </marker>
                        </defs>
                    </svg>
                `;
                // saveToStorage();
            }
        }

        function exportProject() {
            const data = {
                cards,
                connections,
                cardCounter,
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'process-map.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importProject(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        cards = data.cards || [];
                        connections = data.connections || [];
                        cardCounter = data.cardCounter || 0;
                        renderAll();
                        // saveToStorage();
                    } catch (error) {
                        alert('Error importing file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }

        function renderAll() {
            document.getElementById('canvas').innerHTML = `
                <svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                    <defs>
                        <marker id="arrowhead-blue" markerWidth="10" markerHeight="7" 
                                refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#007AFF"/>
                        </marker>
                        <marker id="arrowhead-green" markerWidth="10" markerHeight="7" 
                                refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#34C759"/>
                        </marker>
                    </defs>
                </svg>
            `;
            
            // Ensure connections have all required fields for compatibility
            connections.forEach(conn => {
                if (!conn.id) {
                    conn.id = `conn-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                }
                // Add new fields if they don't exist (backward compatibility)
                if (conn.managerApproval === undefined) {
                    conn.managerApproval = '';
                    conn.managerApprovalChecked = false;
                    conn.resourcesRequired = '';
                    conn.resourcesRequiredChecked = false;
                    conn.waitTime = '';
                    conn.waitTimeUnit = 'hours';
                    conn.waitTimeChecked = false;
                    conn.documentationRequired = '';
                    conn.documentationRequiredChecked = false;
                    conn.qualitySafetyChecks = '';
                    conn.qualitySafetyChecksChecked = false;
                    conn.budgetAmount = '';
                    conn.budgetApprover = '';
                    conn.budgetChecked = false;
                    conn.skillsTraining = '';
                    conn.skillsTrainingChecked = false;
                    conn.notificationsRequired = '';
                    conn.notificationsRequiredChecked = false;
                    conn.externalDependencies = '';
                    conn.externalDependenciesChecked = false;
                }
            });
            
            // Ensure cards have all fields for backward compatibility
            cards.forEach(card => {
                if (!card.assistants) card.assistants = '';
                if (!card.resources) card.resources = '';
                if (!card.riskLevel) card.riskLevel = 'low';
                if (!card.qualityStandards) card.qualityStandards = '';
                if (!card.estimatedDuration) card.estimatedDuration = '';
                if (!card.estimatedDurationUnit) card.estimatedDurationUnit = 'hours';
                if (!card.priorityLevel) card.priorityLevel = 'medium';
            });
            
            cards.forEach(renderCard);
            calculateNumbers();
            drawConnections();
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            setTimeout(drawConnections, 100);
        });

        // Close modals when clicking outside or pressing Escape
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                if (e.target.id === 'cardModal') closeCardModal();
                if (e.target.id === 'connectionModal') closeConnectionModal();
                if (e.target.id === 'modal') closeModal();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeCardModal();
                closeConnectionModal();
                closeModal();
            }
        });

        // Initialize
        // loadFromStorage();
        
        // Add a sample card to get started
        if (cards.length === 0) {
            addCard();
        }
    </script>
</body>
</html>
